                <table class="table">
                    <thead>
                        <tr>
                            <th>اسم المناسبة</th>
                            <th>التاريخ</th>
                            <th>الوصف</th>
                            <th>المكافأة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${events.map(event => `
                            <tr>
                                <td>${event.name}</td>
                                <td>${new Date(event.date).toLocaleDateString('ar')}</td>
                                <td>${event.description}</td>
                                <td>${event.reward} نقطة</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-warning" onclick="editEvent(${event.id})">تعديل</button>
                                        <button class="btn btn-danger" onclick="deleteEvent(${event.id})">حذف</button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function loadBirthdaysList() {
            const container = document.getElementById('birthdaysList');
            if (!container) return;
            
            const membersWithBirthdays = members.filter(m => m.birthday);
            
            container.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>الاسم</th>
                            <th>تاريخ الميلاد</th>
                            <th>العمر</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${membersWithBirthdays.map(member => {
                            const birthday = new Date(member.birthday);
                            const age = new Date().getFullYear() - birthday.getFullYear();
                            return `
                                <tr>
                                    <td>${member.name}</td>
                                    <td>${birthday.toLocaleDateString('ar')}</td>
                                    <td>${age} سنة</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function loadSecurityLogs() {
            const container = document.getElementById('securityLogs');
            if (!container) return;
            
            container.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>الوقت</th>
                            <th>الإجراء</th>
                            <th>المستخدم</th>
                            <th>التفاصيل</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${securityLogs.slice(-20).reverse().map(log => `
                            <tr>
                                <td>${new Date(log.timestamp).toLocaleString('ar')}</td>
                                <td>${log.action}</td>
                                <td>${log.user}</td>
                                <td>${log.details}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function updateTalantonMemberSelect() {
            const select = document.getElementById('talantonMember');
            if (!select) return;
            
            select.innerHTML = '<option value="">اختر العضو</option>' + 
                members.map(member => `<option value="${member.id}">${member.name}</option>`).join('');
        }

        function updateBirthdayMemberSelect() {
            const select = document.getElementById('birthdayMember');
            if (!select) return;
            
            select.innerHTML = '<option value="">اختر العضو</option>' + 
                members.map(member => `<option value="${member.id}">${member.name}</option>`).join('');
        }

        function showTalantonModal() {
            updateTalantonMemberSelect();
            showModal('talantonModal');
        }

        function manageTalanton() {
            const memberId = parseInt(document.getElementById('talantonMember').value);
            const action = document.getElementById('talantonAction').value;
            const amount = parseInt(document.getElementById('talantonAmount').value);
            const reason = document.getElementById('talantonReason').value.trim();

            if (!memberId || !amount || !reason) {
                showMessage('يرجى ملء جميع الحقول', 'error');
                return;
            }

            const member = members.find(m => m.id === memberId);
            if (!member) {
                showMessage('العضو غير موجود', 'error');
                return;
            }

            if (action === 'add') {
                member.talanton += amount;
            } else {
                if (member.talanton < amount) {
                    showMessage('رصيد العضو غير كافي', 'error');
                    return;
                }
                member.talanton -= amount;
            }

            // Add to history
            const newTalantonRecord = {
                id: Date.now(),
                memberId: member.id,
                memberName: member.name,
                amount: amount,
                type: action,
                reason: reason,
                date: new Date().toISOString().split('T')[0],
                timestamp: new Date().toISOString()
            };
            
            talantonHistory.push(newTalantonRecord);
            saveDataToFirebase('talantonHistory', talantonHistory);

            // Update member
            const memberIndex = members.findIndex(m => m.id === memberId);
            if (memberIndex !== -1) {
                members[memberIndex] = member;
                saveDataToFirebase('members', members);
            }

            showMessage(`تم ${action === 'add' ? 'إضافة' : 'خصم'} ${amount} نقطة ${action === 'add' ? 'إلى' : 'من'} ${member.name}`, 'success');
            closeModal('talantonModal');
            loadTalantonHistory();
            updateUI();
            
            // Reset form
            document.getElementById('talantonMember').value = '';
            document.getElementById('talantonAmount').value = '';
            document.getElementById('talantonReason').value = '';
        }

        function showAddProductModal() { showModal('addProductModal'); }

        function addProduct(event) {
            event.preventDefault();
            
            const name = document.getElementById('productName').value.trim();
            const price = parseInt(document.getElementById('productPrice').value);
            const description = document.getElementById('productDescription').value.trim();

            if (!name || !price) {
                showMessage('يرجى ملء الحقول المطلوبة', 'error');
                return;
            }

            const newId = Math.max(...products.map(p => p.id), 0) + 1;
            const newProduct = {
                id: newId,
                name: name,
                price: price,
                description: description
            };

            products.push(newProduct);
            saveDataToFirebase('products', products);

            showMessage('تم إضافة المنتج بنجاح!', 'success');
            closeModal('addProductModal');
            loadStoreProducts();
            
            // Reset form
            document.getElementById('productName').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productDescription').value = '';
        }

        function showAddWeekModal() { showModal('addWeekModal'); }

        function addWeek(event) {
            event.preventDefault();
            
            const name = document.getElementById('weekName').value.trim();
            const startDate = document.getElementById('weekStartDate').value;
            const endDate = document.getElementById('weekEndDate').value;
            const reward = parseInt(document.getElementById('weekReward').value);

            if (!name || !startDate || !endDate) {
                showMessage('يرجى ملء جميع الحقول', 'error');
                return;
            }

            const newId = Math.max(...weeks.map(w => w.id), 0) + 1;
            const newWeek = {
                id: newId,
                name: name,
                startDate: startDate,
                endDate: endDate,
                reward: reward
            };

            weeks.push(newWeek);
            saveDataToFirebase('weeks', weeks);

            showMessage('تم إضافة الأسبوع بنجاح!', 'success');
            closeModal('addWeekModal');
            loadWeeksList();
            
            // Reset form
            document.getElementById('weekName').value = '';
            document.getElementById('weekStartDate').value = '';
            document.getElementById('weekEndDate').value = '';
            document.getElementById('weekReward').value = '50';
        }

        function showAddEventModal() { showModal('addEventModal'); }

        function addEvent(event) {
            event.preventDefault();
            
            const name = document.getElementById('eventName').value.trim();
            const date = document.getElementById('eventDate').value;
            const description = document.getElementById('eventDescription').value.trim();
            const reward = parseInt(document.getElementById('eventReward').value);

            if (!name || !date) {
                showMessage('يرجى ملء الحقول المطلوبة', 'error');
                return;
            }

            const newId = Math.max(...events.map(e => e.id), 0) + 1;
            const newEvent = {
                id: newId,
                name: name,
                date: date,
                description: description,
                reward: reward
            };

            events.push(newEvent);
            saveDataToFirebase('events', events);

            showMessage('تم إضافة المناسبة بنجاح!', 'success');
            closeModal('addEventModal');
            loadEventsList();
            
            // Reset form
            document.getElementById('eventName').value = '';
            document.getElementById('eventDate').value = '';
            document.getElementById('eventDescription').value = '';
            document.getElementById('eventReward').value = '0';
        }

        function addBirthday() {
            const memberId = parseInt(document.getElementById('birthdayMember').value);
            const birthdayDate = document.getElementById('birthdayDate').value;

            if (!memberId || !birthdayDate) {
                showMessage('يرجى ملء جميع الحقول', 'error');
                return;
            }

            const member = members.find(m => m.id === memberId);
            if (member) {
                member.birthday = birthdayDate;
                saveDataToFirebase('members', members);
                showMessage('تم إضافة عيد الميلاد بنجاح!', 'success');
                closeModal('addBirthdayModal');
                loadBirthdaysList();
            }
        }

        function showAddTaskModal() {
            showModal('addTaskModal');
        }

        function addTask(event) {
            event.preventDefault();
            
            const name = document.getElementById('taskName').value.trim();
            const description = document.getElementById('taskDescription').value.trim();
            const points = parseInt(document.getElementById('taskPoints').value);
            const type = document.getElementById('taskType').value;

            if (!name || points <= 0) {
                showMessage('يرجى ملء جميع الحقول المطلوبة بشكل صحيح', 'error');
                return;
            }

            const newId = Math.max(...tasks.map(t => t.id), 0) + 1;
            const newTask = {
                id: newId,
                name: name,
                description: description,
                points: points,
                type: type
            };

            tasks.push(newTask);
            saveDataToFirebase('tasks', tasks);

            showMessage('تم إضافة المهمة بنجاح!', 'success');
            closeModal('addTaskModal');
            displayTasks();
            
            // Reset form
            document.getElementById('taskName').value = '';
            document.getElementById('taskDescription').value = '';
            document.getElementById('taskPoints').value = '';
            document.getElementById('taskType').value = 'daily';
        }

        function generateMonthlyReport() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            const monthlyAttendance = attendance.filter(a => {
                const date = new Date(a.date);
                return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
            });
            
            const monthlyTalanton = talantonHistory.filter(t => {
                const date = new Date(t.date);
                return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
            });
            
            const report = `
التقرير الشهري - ${now.toLocaleDateString('ar', { year: 'numeric', month: 'long' })}

إحصائيات الحضور:
- إجمالي أيام الحضور: ${monthlyAttendance.length}
- عدد الأعضاء الحاضرين: ${new Set(monthlyAttendance.map(a => a.memberId)).size}
- نسبة الحضور: ${Math.round((new Set(monthlyAttendance.map(a => a.memberId)).size / members.length) * 100)}%

إحصائيات النقاط:
- إجمالي النقاط المضافة: ${monthlyTalanton.filter(t => t.type === 'add').reduce((sum, t) => sum + t.amount, 0)}
- إجمالي النقاط المستخدمة: ${monthlyTalanton.filter(t => t.type === 'deduct').reduce((sum, t) => sum + t.amount, 0)}
- عدد العمليات: ${monthlyTalanton.length}

أفضل 5 أعضاء هذا الشهر:
${members.sort((a, b) => b.talanton - a.talanton).slice(0, 5).map((member, index) => 
    `${index + 1}. ${member.name}: ${member.talanton} نقطة`
).join('\n')}
            `;
            
            const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `التقرير_الشهري_${now.getFullYear()}_${now.getMonth() + 1}.txt`;
            link.click();
            window.URL.revokeObjectURL(url);
            
            showMessage('تم إنشاء التقرير الشهري', 'success');
        }

        function generateMemberReport() {
            if (!currentMember) return;
            
            const memberAttendance = attendance.filter(a => a.memberId === currentMember.id);
            const memberHistory = talantonHistory.filter(t => t.memberId === currentMember.id);
            
            const report = {
                member: currentMember,
                totalAttendance: memberAttendance.length,
                totalEarned: memberHistory.filter(t => t.type === 'add').reduce((sum, t) => sum + t.amount, 0),
                totalSpent: memberHistory.filter(t => t.type === 'deduct').reduce((sum, t) => sum + t.amount, 0),
                level: calculateLevel(currentMember.talanton),
                recentActivity: memberHistory.slice(-10)
            };
            
            const reportContent = `
تقرير العضو: ${report.member.name}
الرقم التسلسلي: ${report.member.id}
المستوى: ${report.level.name}
الرصيد الحالي: ${report.member.talanton} نقطة
إجمالي أيام الحضور: ${report.totalAttendance}
إجمالي النقاط المكتسبة: ${report.totalEarned}
إجمالي النقاط المستخدمة: ${report.totalSpent}
تاريخ الانضمام: ${new Date(report.member.joinDate).toLocaleDateString('ar')}

النشاط الأخير:
${report.recentActivity.map(activity => 
    `${new Date(activity.date).toLocaleDateString('ar')}: ${activity.type === 'add' ? '+' : '-'}${activity.amount} - ${activity.reason}`
).join('\n')}
            `;
            
            const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `تقرير_${report.member.name}.txt`;
            link.click();
            window.URL.revokeObjectURL(url);
        }

        // وظائف التعديل والحذف
        function editMember(id) {
            const member = members.find(m => m.id === id);
            if (!member) return;
            
            showAddMemberModal();
            
            // تعبئة النموذج ببيانات العضو
            setTimeout(() => {
                document.getElementById('memberName').value = member.name;
                document.getElementById('memberPass').value = member.password;
                document.getElementById('memberEmail').value = member.email || '';
                document.getElementById('memberBirthday').value = member.birthday || '';
                document.getElementById('initialTalanton').value = member.talanton;
                
                // تغيير نص الزر إلى "تحديث"
                const submitBtn = document.querySelector('#addMemberModal button[type="submit"]');
                submitBtn.textContent = 'تحديث العضو';
                
                // تغيير وظيفة النموذج لتحديث العضو بدلاً من إضافة جديد
                const form = document.querySelector('#addMemberModal form');
                form.onsubmit = function(e) {
                    e.preventDefault();
                    updateMember(id);
                };
            }, 100);
        }

        function updateMember(id) {
            const name = document.getElementById('memberName').value.trim();
            const password = document.getElementById('memberPass').value.trim();
            const email = document.getElementById('memberEmail').value.trim();
            const birthday = document.getElementById('memberBirthday').value;
            const talanton = parseInt(document.getElementById('initialTalanton').value) || 0;

            if (!name || !password) {
                showMessage('يرجى ملء الحقول المطلوبة', 'error');
                return;
            }

            const memberIndex = members.findIndex(m => m.id === id);
            if (memberIndex !== -1) {
                members[memberIndex] = {
                    ...members[memberIndex],
                    name: name,
                    password: password,
                    email: email,
                    birthday: birthday,
                    talanton: talanton
                };
                
                saveDataToFirebase('members', members);
                showMessage('تم تحديث العضو بنجاح!', 'success');
                closeModal('addMemberModal');
                loadMembersTable();
                updateUI();
                
                // إعادة تعيين النموذج
                const form = document.querySelector('#addMemberModal form');
                form.onsubmit = function(e) {
                    e.preventDefault();
                    addMember(e);
                };
                
                const submitBtn = document.querySelector('#addMemberModal button[type="submit"]');
                submitBtn.textContent = 'إضافة العضو';
            }
        }

        function deleteMember(id) {
            if (!confirm('هل أنت متأكد من حذف هذا العضو؟ سيتم حذف جميع بياناته أيضًا.')) {
                return;
            }
            
            members = members.filter(m => m.id !== id);
            attendance = attendance.filter(a => a.memberId !== id);
            talantonHistory = talantonHistory.filter(t => t.memberId !== id);
            
            saveDataToFirebase('members', members);
            saveDataToFirebase('attendance', attendance);
            saveDataToFirebase('talantonHistory', talantonHistory);
            
            showMessage('تم حذف العضو', 'success');
            loadMembersTable();
            updateUI();
        }

        function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;
            
            showAddProductModal();
            
            // تعبئة النموذج ببيانات المنتج
            setTimeout(() => {
                document.getElementById('productName').value = product.name;
                document.getElementById('productPrice').value = product.price;
                document.getElementById('productDescription').value = product.description || '';
                
                // تغيير نص الزر إلى "تحديث"
                const submitBtn = document.querySelector('#addProductModal button[type="submit"]');
                submitBtn.textContent = 'تحديث المنتج';
                
                // تغيير وظيفة النموذج لتحديث المنتج بدلاً من إضافة جديد
                const form = document.querySelector('#addProductModal form');
                form.onsubmit = function(e) {
                    e.preventDefault();
                    updateProduct(id);
                };
            }, 100);
        }

        function updateProduct(id) {
            const name = document.getElementById('productName').value.trim();
            const price = parseInt(document.getElementById('productPrice').value);
            const description = document.getElementById('productDescription').value.trim();

            if (!name || !price) {
                showMessage('يرجى ملء الحقول المطلوبة', 'error');
                return;
            }

            const productIndex = products.findIndex(p => p.id === id);
            if (productIndex !== -1) {
                products[productIndex] = {
                    ...products[productIndex],
                    name: name,
                    price: price,
                    description: description
                };
                
                saveDataToFirebase('products', products);
                showMessage('تم تحديث المنتج بنجاح!', 'success');
                closeModal('addProductModal');
                loadStoreProducts();
                
                // إعادة تعيين النموذج
                const form = document.querySelector('#addProductModal form');
                form.onsubmit = function(e) {
                    e.preventDefault();
                    addProduct(e);
                };
                
                const submitBtn = document.querySelector('#addProductModal button[type="submit"]');
                submitBtn.textContent = 'إضافة المنتج';
            }
        }

        function deleteProduct(id) {
            if (confirm('هل أنت متأكد من حذف هذا المنتج؟')) {
                products = products.filter(p => p.id !== id);
                saveDataToFirebase('products', products);
                loadStoreProducts();
                showMessage('تم حذف المنتج', 'success');
            }
        }

        function editWeek(id) {
            const week = weeks.find(w => w.id === id);
            if (!week) return;
            
            showAddWeekModal();
            
            // تعبئة النموذج ببيانات الأسبوع
            setTimeout(() => {
                document.getElementById('weekName').value = week.name;
                document.getElementById('weekStartDate').value = week.startDate;
                document.getElementById('weekEndDate').value = week.endDate;
                document.getElementById('weekReward').value = week.reward;
                
                // تغيير نص الزر إلى "تحديث"
                const submitBtn = document.querySelector('#addWeekModal button[type="submit"]');
                submitBtn.textContent = 'تحديث الأسبوع';
                
                // تغيير وظيفة النموذج لتحديث الأسبوع بدلاً من إضافة جديد
                const form = document.querySelector('#addWeekModal form');
                form.onsubmit = function(e) {
                    e.preventDefault();
                    updateWeek(id);
                };
            }, 100);
        }

        function updateWeek(id) {
            const name = document.getElementById('weekName').value.trim();
            const startDate = document.getElementById('weekStartDate').value;
            const endDate = document.getElementById('weekEndDate').value;
            const reward = parseInt(document.getElementById('weekReward').value);

            if (!name || !startDate || !endDate) {
                showMessage('يرجى ملء جميع الحقول', 'error');
                return;
            }

            const weekIndex = weeks.findIndex(w => w.id === id);
            if (weekIndex !== -1) {
                weeks[weekIndex] = {
                    ...weeks[weekIndex],
                    name: name,
                    startDate: startDate,
                    endDate: endDate,
                    reward: reward
                };
                
                saveDataToFirebase('weeks', weeks);
                showMessage('تم تحديث الأسبوع بنجاح!', 'success');
                closeModal('addWeekModal');
                loadWeeksList();
                
                // إعادة تعيين النموذج
                const form = document.querySelector('#addWeekModal form');
                form.onsubmit = function(e) {
                    e.preventDefault();
                    addWeek(e);
                };
                
                const submitBtn = document.querySelector('#addWeekModal button[type="submit"]');
                submitBtn.textContent = 'إضافة الأسبوع';
            }
        }

        function deleteWeek(id) {
            if (confirm('هل أنت متأكد من حذف هذا الأسبوع؟')) {
                weeks = weeks.filter(w => w.id !== id);
                saveDataToFirebase('weeks', weeks);
                loadWeeksList();
                showMessage('تم حذف الأسبوع', 'success');
            }
        }

        function editEvent(id) {
            const event = events.find(e => e.id === id);
            if (!event) return;
            
            showAddEventModal();
            
            // تعبئة النموذج ببيانات المناسبة
            setTimeout(() => {
                document.getElementById('eventName').value = event.name;
                document.getElementById('eventDate').value = event.date;
                document.getElementById('eventDescription').value = event.description || '';
                document.getElementById('eventReward').value = event.reward;
                
                // تغيير نص الزر إلى "تحديث"
                const submitBtn = document.querySelector('#addEventModal button[type="submit"]');
                submitBtn.textContent = 'تحديث المناسبة';
                
                // تغيير وظيفة النموذج لتحديث المناسبة بدلاً من إضافة جديد
                const form = document.querySelector('#addEventModal form');
                form.onsubmit = function(e) {
                    e.preventDefault();
                    updateEvent(id);
                };
            }, 100);
        }

        function updateEvent(id) {
            const name = document.getElementById('eventName').value.trim();
            const date = document.getElementById('eventDate').value;
            const description = document.getElementById('eventDescription').value.trim();
            const reward = parseInt(document.getElementById('eventReward').value);

            if (!name || !date) {
                showMessage('يرجى ملء الحقول المطلوبة', 'error');
                return;
            }

            const eventIndex = events.findIndex(e => e.id === id);
            if (eventIndex !== -1) {
                events[eventIndex] = {
                    ...events[eventIndex],
                    name: name,
                    date: date,
                    description: description,
                    reward: reward
                };
                
                saveDataToFirebase('events', events);
                showMessage('تم تحديث المناسبة بنجاح!', 'success');
                closeModal('addEventModal');
                loadEventsList();
                
                // إعادة تعيين النموذج
                const form = document.querySelector('#addEventModal form');
                form.onsubmit = function(e) {
                    e.preventDefault();
                    addEvent(e);
                };
                
                const submitBtn = document.querySelector('#addEventModal button[type="submit"]');
                submitBtn.textContent = 'إضافة المناسبة';
            }
        }

        function deleteEvent(id) {
            if (confirm('هل أنت متأكد من حذف هذه المناسبة؟')) {
                events = events.filter(e => e.id !== id);
                saveDataToFirebase('events', events);
                loadEventsList();
                showMessage('تم حذف المناسبة', 'success');
            }
        }

        // تهيئة البيانات الأولية إذا كانت فارغة
        function initializeDemoData() {
            if (members.length === 0) {
                const demoMembers = [
                    { id: 1, name: 'أحمد محمد', password: '1234', email: 'ahmed@example.com', talanton: 250, joinDate: '2024-01-15', birthday: '1995-03-15' },
                    { id: 2, name: 'فاطمة علي', password: '1234', email: 'fatima@example.com', talanton: 320, joinDate: '2024-01-20', birthday: '1998-07-22' },
                    { id: 3, name: 'محمد حسن', password: '1234', email: 'mohamed@example.com', talanton: 180, joinDate: '2024-02-01', birthday: '1997-11-08' }
                ];
                
                demoMembers.forEach(member => {
                    members.push(member);
                });
                
                saveDataToFirebase('members', members);
            }

            if (products.length === 0) {
                const demoProducts = [
                    { id: 1, name: 'كتاب ديني', price: 50, description: 'كتاب في التربية الروحية' },
                    { id: 2, name: 'مسبحة', price: 30, description: 'مسبحة خشبية جميلة' },
                    { id: 3, name: 'صليب صغير', price: 25, description: 'صليب للتذكار' }
                ];
                
                demoProducts.forEach(product => {
                    products.push(product);
                });
                
                saveDataToFirebase('products', products);
            }

            if (tasks.length === 0) {
                saveDataToFirebase('tasks', defaultTasks);
            }
        }

        // استدعاء تهيئة البيانات إذا كانت جميع الجداول فارغة
        if (members.length === 0 && products.length === 0) {
            initializeDemoData();
        }
    </script>
</body>
</html>
