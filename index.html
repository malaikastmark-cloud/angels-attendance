<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Angels Attendance</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    body { background: linear-gradient(to right, #6a11cb, #2575fc); font-family: 'Segoe UI', sans-serif; color: #fff; }
    .container { margin-top: 50px; }
    .card { background: rgba(255,255,255,0.1); border-radius: 15px; padding: 20px; }
    select, input, button { margin: 5px 0; }
    .btn-primary { background-color: #ff7e5f; border: none; }
    .btn-primary:hover { background-color: #feb47b; }
    .btn-admin { background-color: #2ecc71; }
    .btn-admin:hover { background-color: #27ae60; }
    .member-img { width: 40px; height: 40px; border-radius: 50%; }
    .top-member-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; background: rgba(255,255,255,0.1); padding: 5px 10px; border-radius: 8px; }
    .tab-content { display: none; margin-top: 20px; }
    .tab-content.active { display: block; }
    .tab { cursor: pointer; padding: 10px 20px; display: inline-block; background: rgba(0,0,0,0.2); border-radius: 10px; margin-right: 5px; }
    .tab.active { background: rgba(255,255,255,0.3); }
    #notification { position: fixed; top: 20px; right: 20px; padding: 10px 20px; border-radius: 10px; display: none; z-index: 1000; }
</style>
</head>
<body>
<div class="container">
    <div class="card text-center">
        <h2 id="title">نظام الحضور - Angels Attendance</h2>
        <div class="row mt-4">
            <div class="col-md-5">
                <select id="selectMember" class="form-select">
                    <option value="">-- اختر اسمك --</option>
                </select>
            </div>
            <div class="col-md-5">
                <select id="weekSelect" class="form-select">
                    <option value="">-- اختر الأسبوع --</option>
                </select>
            </div>
            <div class="col-md-2">
                <button id="markPresent" class="btn btn-primary w-100">تسجيل الحضور</button>
            </div>
        </div>
        <div class="mt-3">
            <button id="adminLoginBtn" class="btn btn-admin">تسجيل دخول الأدمن</button>
        </div>
    </div>

    <!-- نافذة الأدمن -->
    <div id="adminLoginModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center;">
        <div class="card text-dark p-4" style="background:white; color:black; width:300px;">
            <h4>دخول الأدمن</h4>
            <input type="password" id="adminPassword" class="form-control" placeholder="كلمة السر">
            <div class="mt-3 text-end">
                <button id="confirmAdminLogin" class="btn btn-primary">تأكيد</button>
                <button id="cancelAdminLogin" class="btn btn-secondary">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="adminTabs" style="display:none;">
        <div>
            <span class="tab active" data-tab="membersTab">الأعضاء</span>
            <span class="tab" data-tab="weeksTab">الأسابيع</span>
            <span class="tab" data-tab="attendance">الحضور</span>
            <span class="tab" data-tab="reports">التقارير</span>
        </div>

        <div id="membersTab" class="tab-content active">
            <h4>إدارة الأعضاء</h4>
            <input type="text" id="newMemberName" placeholder="اسم العضو" class="form-control">
            <input type="text" id="newMemberImage" placeholder="رابط الصورة (اختياري)" class="form-control">
            <button id="addMemberBtn" class="btn btn-primary mt-2">إضافة عضو</button>
            <table class="table table-dark mt-3">
                <thead><tr><th>#</th><th>الصورة</th><th>الاسم</th><th>تعديل</th><th>حذف</th></tr></thead>
                <tbody id="membersTableBody"></tbody>
            </table>
        </div>

        <div id="weeksTab" class="tab-content">
            <h4>إدارة الأسابيع</h4>
            <input type="text" id="newWeekName" placeholder="اسم الأسبوع" class="form-control">
            <input type="date" id="newWeekStart" class="form-control">
            <input type="date" id="newWeekEnd" class="form-control">
            <button id="addWeekBtn" class="btn btn-primary mt-2">إضافة أسبوع</button>
            <table class="table table-dark mt-3">
                <thead><tr><th>#</th><th>الاسم</th><th>من</th><th>إلى</th><th>تعديل</th><th>حذف</th></tr></thead>
                <tbody id="weeksTableBody"></tbody>
            </table>
        </div>

        <div id="attendance" class="tab-content">
            <h4>سجلات الحضور</h4>
            <table class="table table-dark mt-3">
                <thead><tr><th>#</th><th>العضو</th><th>الأسبوع</th><th>التاريخ</th><th>حذف</th></tr></thead>
                <tbody id="attendanceRecordsBody"></tbody>
            </table>
        </div>

        <div id="reports" class="tab-content">
            <h4>التقارير</h4>
            <canvas id="attendanceChart" height="100"></canvas>
            <div id="topMembersList" class="mt-3"></div>
        </div>
    </div>
</div>

<div id="notification"></div>

<script>
const adminPass = "admin123";

// بيانات Firebase Realtime Database
const firebaseConfig = {
    apiKey: "AIzaSyBCQIqdCsxSvhfYOs00AetoVWpFhj4XNAQ",
    authDomain: "angels-attendance.firebaseapp.com",
    databaseURL: "https://angels-attendance-default-rtdb.firebaseio.com",
    projectId: "angels-attendance",
    storageBucket: "angels-attendance.firebasestorage.app",
    messagingSenderId: "157249026489",
    appId: "1:157249026489:web:db2b420203bd81d9a19e68",
    measurementId: "G-2YDPSFPQYT"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let members = [];
let weeks = [];
let attendanceRecords = [];

// وظيفة الإشعارات
function showNotification(msg, success=true){
    const n = document.getElementById("notification");
    n.textContent = msg;
    n.style.background = success ? "#2ecc71" : "#e74c3c";
    n.style.display = "block";
    setTimeout(()=>{ n.style.display = "none"; }, 3000);
}

// تحميل البيانات من Firebase
function loadData(){
    db.ref("/members").once("value").then(snapshot => {
        members = snapshot.val() ? Object.values(snapshot.val()) : [];
        populateMembersSelect();
        populateAdminMembers();
        updateChart();
    });
    db.ref("/weeks").once("value").then(snapshot => {
        weeks = snapshot.val() ? Object.values(snapshot.val()) : [];
        populateWeeksSelect();
        populateAdminWeeks();
        updateChart();
    });
    db.ref("/attendance").once("value").then(snapshot => {
        attendanceRecords = snapshot.val() ? Object.values(snapshot.val()) : [];
        populateAttendanceTable();
        updateChart();
    });
}

// حفظ البيانات في Firebase
function saveData(ref, data){
    db.ref(ref).set(data);
}

// وظائف الواجهة
function populateMembersSelect(){
    const sel = document.getElementById("selectMember");
    sel.innerHTML = "<option value=''>-- اختر اسمك --</option>";
    members.forEach(m => {
        const opt = document.createElement("option");
        opt.value = m.id;
        opt.textContent = m.name;
        sel.appendChild(opt);
    });
}
function populateWeeksSelect(){
    const sel = document.getElementById("weekSelect");
    sel.innerHTML = "<option value=''>-- اختر الأسبوع --</option>";
    weeks.forEach(w => {
        const opt = document.createElement("option");
        opt.value = w.id;
        opt.textContent = w.name;
        sel.appendChild(opt);
    });
}
function populateAdminMembers(){
    const tbody = document.getElementById("membersTableBody");
    tbody.innerHTML = "";
    members.forEach((m,i)=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${i+1}</td>
        <td><img src="${m.image}" class="member-img"></td>
        <td>${m.name}</td>
        <td><button class='editMember btn btn-primary btn-sm'>تعديل</button></td>
        <td><button class='deleteMember btn btn-danger btn-sm'>حذف</button></td>`;
        tbody.appendChild(tr);
    });
}
function populateAdminWeeks(){
    const tbody = document.getElementById("weeksTableBody");
    tbody.innerHTML = "";
    weeks.forEach((w,i)=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${i+1}</td>
        <td>${w.name}</td><td>${w.from}</td><td>${w.to}</td>
        <td><button class='editWeek btn btn-primary btn-sm'>تعديل</button></td>
        <td><button class='deleteWeek btn btn-danger btn-sm'>حذف</button></td>`;
        tbody.appendChild(tr);
    });
}
function populateAttendanceTable(){
    const tbody = document.getElementById("attendanceRecordsBody");
    tbody.innerHTML = "";
    attendanceRecords.forEach((r,i)=>{
        const member = members.find(m=>m.id===r.memberId);
        const week = weeks.find(w=>w.id===r.weekId);
        if(member && week){
            const tr = document.createElement("tr");
            tr.innerHTML = `<td>${i+1}</td><td>${member.name}</td><td>${week.name}</td><td>${new Date(r.date).toLocaleString()}</td>
            <td><button class='deleteAttendance btn btn-danger btn-sm' data-index='${i}'>حذف</button></td>`;
            tbody.appendChild(tr);
        }
    });
}

// تسجيل الحضور
function markAttendance(){
    const memberId = parseInt(document.getElementById("selectMember").value);
    const weekId = parseInt(document.getElementById("weekSelect").value);
    if(!memberId || !weekId){ alert("اختر العضو والأسبوع"); return; }
    const exists = attendanceRecords.find(ar=>ar.memberId===memberId && ar.weekId===weekId);
    if(exists){ showNotification("تم تسجيل هذا العضو بالفعل", false); return; }
    const record = {memberId, weekId, date:new Date().toISOString()};
    attendanceRecords.push(record);
    saveData("/attendance", attendanceRecords);
    populateAttendanceTable();
    updateChart();
    showNotification("تم تسجيل الحضور بنجاح");
}

// الرسم البياني
const ctx = document.getElementById("attendanceChart").getContext("2d");
let chart = new Chart(ctx, {type:'bar', data:{labels:[], datasets:[{label:'الحضور', data:[], backgroundColor:'#ff7e5f'}]}, options:{responsive:true, plugins:{legend:{display:false}}}});
function updateChart(){
    const selectedWeekId = document.getElementById("weekSelect").value;
    chart.data.labels = members.map(m=>m.name);
    chart.data.datasets[0].data = members.map(m=>{
        return attendanceRecords.some(ar=>ar.memberId===m.id && ar.weekId==selectedWeekId)?1:0;
    });
    chart.update();
}

// أحداث الأزرار
document.getElementById("markPresent").addEventListener("click", markAttendance);
document.getElementById("adminLoginBtn").addEventListener("click", ()=>{document.getElementById("adminLoginModal").style.display="flex";});
document.getElementById("cancelAdminLogin").addEventListener("click", ()=>{document.getElementById("adminLoginModal").style.display="none";});
document.getElementById("confirmAdminLogin").addEventListener("click", ()=>{
    const pwd = document.getElementById("adminPassword").value;
    if(pwd===adminPass){
        document.getElementById("adminLoginModal").style.display="none";
        document.getElementById("adminTabs").style.display="block";
        showNotification("تم تسجيل دخول الأدمن بنجاح");
    } else alert("كلمة السر خاطئة!");
});

// تبويبات الأدمن
document.querySelectorAll("#adminTabs .tab").forEach(tab=>{
    tab.addEventListener("click", ()=>{
        document.querySelectorAll("#adminTabs .tab").forEach(t=>t.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
        tab.classList.add("active");
        document.getElementById(tab.dataset.tab).classList.add("active");
    });
});

// إضافة أعضاء وأسابيع
document.getElementById("addMemberBtn").addEventListener("click", ()=>{
    const name=document.getElementById("newMemberName").value;
    const img=document.getElementById("newMemberImage").value||`https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=3498db&color=fff`;
    if(!name){ alert("ادخل اسم العضو"); return; }
    const id=members.length?Math.max(...members.map(m=>m.id))+1:1;
    members.push({id,name,image:img});
    saveData("/members",members);
    populateMembersSelect();
    populateAdminMembers();
    document.getElementById("newMemberName").value="";
    document.getElementById("newMemberImage").value="";
    showNotification("تم إضافة العضو");
});

document.getElementById("addWeekBtn").addEventListener("click", ()=>{
    const name=document.getElementById("newWeekName").value;
    const from=document.getElementById("newWeekStart").value;
    const to=document.getElementById("newWeekEnd").value;
    if(!name||!from||!to){ alert("املأ كل الحقول"); return; }
    const id=weeks.length?Math.max(...weeks.map(w=>w.id))+1:1;
    weeks.push({id,name,from,to});
    saveData("/weeks",weeks);
    populateWeeksSelect();
    populateAdminWeeks();
    document.getElementById("newWeekName").value="";
    document.getElementById("newWeekStart").value="";
    document.getElementById("newWeekEnd").value="";
    showNotification("تم إضافة الأسبوع");
});

// حذف الحضور
document.addEventListener("click", e=>{
    if(e.target.classList.contains("deleteAttendance")){
        const index=parseInt(e.target.dataset.index);
        if(confirm("هل تريد حذف هذا التسجيل؟")){
            attendanceRecords.splice(index,1);
            saveData("/attendance",attendanceRecords);
            populateAttendanceTable();
            updateChart();
            showNotification("تم حذف التسجيل");
        }
    }
});

// تحميل البيانات عند بدء التشغيل
document.addEventListener("DOMContentLoaded", loadData);
document.getElementById("weekSelect").addEventListener("change", updateChart);
</script>
</body>
</html>
