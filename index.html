<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>اجتماع خدام ملايكة — الحضور والنقاط</title>
<style>
  :root{
    --c1:#0d6efd; --c2:#20c997; --c3:#6c757d; --danger:#dc3545; --warn:#ffc107; --ok:#198754; --bg:#f7f7fb;
    --card:#ffffff; --text:#1f2328; --muted:#747b83; --border:#e5e7eb;
  }
  body{font-family:system-ui,Segoe UI,Tahoma,Arial; background:var(--bg); color:var(--text); margin:0}
  header{background:linear-gradient(135deg,var(--c1),var(--c2)); color:#fff; padding:18px 16px}
  header h1{margin:0 0 4px;font-size:22px}
  header small{opacity:.9}
  main{padding:14px}
  .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; margin-bottom:14px; box-shadow:0 6px 16px rgba(0,0,0,.04)}
  .row{display:flex; gap:12px; flex-wrap:wrap}
  .col{flex:1 1 320px}
  label{display:block; font-size:14px; margin:.2rem 0 .1rem}
  select,input,button,textarea{
    font:inherit; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#fff
  }
  button{cursor:pointer; border:none; background:var(--c1); color:#fff}
  button.ghost{background:#fff; color:var(--text); border:1px solid var(--border)}
  button.warn{background:var(--warn); color:#000}
  button.ok{background:var(--ok)}
  button.danger{background:var(--danger)}
  button:disabled{opacity:.6; cursor:not-allowed}
  table{width:100%; border-collapse:separate; border-spacing:0; overflow:auto}
  thead th{background:#f1f3f5; font-weight:600}
  th,td{border-bottom:1px solid var(--border); padding:10px; text-align:right}
  .toolbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .muted{color:var(--muted)}
  .badge{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; background:#eef3ff; color:#224488; border:1px solid #dfe7ff}
  .hidden{display:none !important}
  .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .grid-3{display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:10px}
  .hr{height:1px; background:var(--border); margin:10px 0}
  .toast{
    position:fixed; inset-inline: 12px 12px; bottom:12px; z-index:50;
    display:flex; gap:10px; align-items:center; background:#fff; border:1px solid var(--border);
    box-shadow:0 10px 18px rgba(0,0,0,.08); border-radius:12px; padding:10px 12px
  }
  .link{color:var(--c1); text-decoration:underline; cursor:pointer}
</style>
</head>
<body>
<header>
  <h1>اجتماع خدام ملايكة</h1>
  <small>الحضور يساوي نقطة — والمهام تضيف نقاط — ويمكن إضافة مكافآت يدويًا</small>
</header>

<main>

  <!-- تنبيه المناسبات القادمة -->
  <div id="events-toast" class="toast hidden">
    <div>🔔 <b>تذكير:</b> لديك مناسبات قادمة قريبًا.</div>
    <div class="toolbar">
      <button class="ghost" id="btnSeeEvents">عرض</button>
      <button class="ghost" id="btnDismissEvents">إخفاء</button>
    </div>
  </div>

  <!-- تسجيل الحضور (للجميع) -->
  <section class="card">
    <h3>تسجيل الحضور</h3>
    <div class="row">
      <div class="col">
        <label>اختر اسمك:</label>
        <select id="selMember"><option value="">-- اختر اسمك --</option></select>
      </div>
      <div class="col">
        <label>اختر الأسبوع:</label>
        <select id="selWeek"><option value="">-- اختر الأسبوع --</option></select>
      </div>
      <div class="col" style="align-self:end">
        <button id="btnCheckin">تسجيل الحضور</button>
      </div>
    </div>
    <div class="muted" id="checkinInfo">جاري الاتصال بقاعدة البيانات...</div>
  </section>

  <!-- لوحة التحكم/الأدمن -->
  <section class="card">
    <h3>تسجيل دخول الأدمن</h3>
    <div class="toolbar">
      <input id="adminPass" type="password" placeholder="كلمة سر الأدمن (اختياري)" />
      <button id="btnAdminLogin">دخول</button>
      <button id="btnAdminLogout" class="ghost hidden">إلغاء دخول</button>
    </div>
    <div class="muted">عند الدخول تظهر أقسام الإدارة بالأسفل.</div>
  </section>

  <!-- إدارة الأعضاء -->
  <section class="card admin-only hidden" id="secMembers">
    <h3>إدارة الأعضاء</h3>
    <div class="toolbar">
      <input id="memName" placeholder="اسم العضو" />
      <input id="memPhoto" placeholder="رابط الصورة (اختياري)" />
      <button id="btnAddMember" class="ok">إضافة عضو</button>
    </div>

    <div class="hr"></div>
    <div class="muted">** زر <b>إضافة نقاط</b> يعمل الآن ويزيد النقاط اليدوية، والمجموع يُحسب تلقائيًا (حضور + مهام + يدوي). </div>
    <div style="overflow:auto">
      <table id="tblMembers">
        <thead><tr>
          <th>#</th><th>الصورة</th><th>اسم العضو</th>
          <th>الحضور</th><th>نقاط المهام</th><th>النقاط اليدوية</th><th>إجمالي النقاط</th>
          <th>مكافآت</th><th>إجراءات</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- إدارة الأسابيع -->
  <section class="card admin-only hidden" id="secWeeks">
    <h3>إدارة الأسابيع</h3>
    <div class="toolbar">
      <input id="weekName" placeholder="اسم الأسبوع" />
      <input id="weekFrom" type="date" />
      <input id="weekTo" type="date" />
      <button id="btnAddWeek" class="ok">إضافة أسبوع</button>
    </div>
    <div class="hr"></div>
    <table id="tblWeeks">
      <thead><tr><th>#</th><th>اسم الأسبوع</th><th>من</th><th>إلى</th><th>إجراءات</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- إدارة تسجيلات الحضور: تعديل/حذف -->
  <section class="card admin-only hidden" id="secAttendance">
    <h3>إدارة الحضور</h3>
    <div class="toolbar">
      <label>اختر أسبوع:</label>
      <select id="selWeekAdmin"></select>
      <button id="btnDeleteWeekAttendance" class="danger">حذف كل حضور هذا الأسبوع</button>
    </div>
    <div class="hr"></div>
    <table id="tblAttendance">
      <thead><tr><th>#</th><th>العضو</th><th>الأسبوع</th><th>تاريخ التسجيل</th><th>إجراءات</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- إدارة المهام (للنقاط التلقائية) -->
  <section class="card admin-only hidden" id="secTasks">
    <h3>المهام</h3>
    <div class="toolbar">
      <select id="taskMember"></select>
      <input id="taskTitle" placeholder="اسم المهمة / الوصف" />
      <input id="taskPoints" type="number" placeholder="النقاط" />
      <button id="btnAddTask" class="ok">إضافة مهمة</button>
    </div>
    <div class="hr"></div>
    <table id="tblTasks">
      <thead><tr><th>#</th><th>العضو</th><th>المهمة</th><th>النقاط</th><th>الحالة</th><th>إجراءات</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- المناسبات القادمة + تنبيه -->
  <section class="card admin-only hidden" id="secEvents">
    <h3>المناسبات القادمة</h3>
    <div class="toolbar">
      <input id="eventTitle" placeholder="عنوان المناسبة (مثال: عيد ميلاد فلان)" />
      <input id="eventDate" type="date" />
      <select id="eventType">
        <option value="event">مناسبة</option>
        <option value="birthday">عيد ميلاد</option>
      </select>
      <input id="eventNotifyDays" type="number" placeholder="أيام قبل التنبيه (مثلاً 2)" />
      <button id="btnAddEvent" class="ok">إضافة</button>
    </div>
    <div class="hr"></div>
    <table id="tblEvents">
      <thead><tr><th>#</th><th>العنوان</th><th>التاريخ</th><th>النوع</th><th>التنبيه قبل (أيام)</th><th>إجراءات</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- التقارير البسيطة -->
  <section class="card admin-only hidden" id="secReports">
    <h3>التقارير والإحصائيات</h3>
    <div class="grid-3">
      <div class="card"><div class="muted">إجمالي الحضور</div><div id="statTotalAttendance" style="font-size:26px">0</div></div>
      <div class="card"><div class="muted">مجموع النقاط</div><div id="statTotalPoints" style="font-size:26px">0</div></div>
      <div class="card"><div class="muted">عدد الأعضاء</div><div id="statMembers" style="font-size:26px">0</div></div>
    </div>
  </section>

  <!-- إعدادات النظام / Firebase -->
  <section class="card" id="secSettings">
    <h3>إعدادات النظام</h3>
    <div class="grid-2">
      <div>
        <div class="muted">إعدادات Firebase (تُحفظ محليًا في المتصفح):</div>
        <div class="grid-2" style="grid-template-columns:1fr 1fr">
          <input id="cfg_apiKey" placeholder="apiKey" />
          <input id="cfg_authDomain" placeholder="authDomain" />
          <input id="cfg_databaseURL" placeholder="databaseURL" />
          <input id="cfg_projectId" placeholder="projectId" />
          <input id="cfg_storageBucket" placeholder="storageBucket" />
          <input id="cfg_messagingSenderId" placeholder="messagingSenderId" />
          <input id="cfg_appId" placeholder="appId" />
        </div>
        <div class="toolbar" style="margin-top:8px">
          <button id="btnSaveFirebase" class="ok">حفظ إعدادات Firebase</button>
          <button id="btnSync" class="ghost">مزامنة البيانات مع السحابة</button>
          <button id="btnReset" class="warn">إعادة تعيين (محلي)</button>
        </div>
      </div>
      <div>
        <label>عدد النقاط لكل حضور:</label>
        <input id="pointsPerAttendance" type="number" placeholder="افتراضي 1" />
        <div class="muted">تُستخدم لحساب الإجمالي تلقائيًا (حضور × القيمة + نقاط المهام + اليدوي).</div>
      </div>
    </div>
  </section>

</main>

<!-- Firebase (Modular) -->
<script type="module">
  // ========= Firebase bootstrap =========
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, child, push, key, get, set, update, remove, onValue, runTransaction, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  // ---- local config storage
  const cfgKey = "angels.firebase.config";
  const adminKey = "angels.admin";
  const toastKey = "angels.events.toast.dismissed";
  const defaultSettings = { pointsPerAttendance: 1 };

  let app, db;
  let settings = { ...defaultSettings };

  function loadCfg(){
    try{
      return JSON.parse(localStorage.getItem(cfgKey) || "{}");
    }catch{ return {}; }
  }
  function saveCfg(cfg){
    localStorage.setItem(cfgKey, JSON.stringify(cfg||{}));
  }

  function ui$q(id){ return document.getElementById(id); }
  const $ = ui$q;

  function isAdmin(){ return localStorage.getItem(adminKey) === "1"; }
  function setAdmin(on){ localStorage.setItem(adminKey, on ? "1":"0"); refreshAdminUI(); }

  function fillFirebaseForm(cfg){
    ["apiKey","authDomain","databaseURL","projectId","storageBucket","messagingSenderId","appId"].forEach(k=>{
      const el = $(`cfg_${k}`); if(el) el.value = cfg[k] || "";
    });
  }
  function readFirebaseForm(){
    const cfg = {};
    ["apiKey","authDomain","databaseURL","projectId","storageBucket","messagingSenderId","appId"].forEach(k=>{
      cfg[k] = $(`cfg_${k}`).value.trim();
    });
    return cfg;
  }

  async function boot(){
    const cfg = loadCfg(); fillFirebaseForm(cfg);
    try{
      if(!cfg.apiKey || !cfg.databaseURL) throw new Error("Firebase config ناقص");
      app = initializeApp(cfg);
      db  = getDatabase(app);
      await ensureSettingsNode();
      attachLiveBindings();
      uiSetStatus("checkinInfo","✅ تم الاتصال بقاعدة البيانات.");
    }catch(err){
      console.warn(err);
      uiSetStatus("checkinInfo","⚠️ أدخل إعدادات Firebase ثم اضغط حفظ. لا يمكن القراءة قبل الإعداد.");
    }
  }

  // ======== Settings node in DB ========
  const dbSettingsRef = () => ref(db,"settings");
  async function ensureSettingsNode(){
    const snap = await get(dbSettingsRef());
    if(!snap.exists()){
      await set(dbSettingsRef(), defaultSettings);
    }
    settings = { ...defaultSettings, ...(snap.val()||{}) };
    $("pointsPerAttendance").value = settings.pointsPerAttendance || 1;
    // watch settings
    onValue(dbSettingsRef(), s=>{
      settings = { ...defaultSettings, ...(s.val()||{}) };
      $("pointsPerAttendance").value = settings.pointsPerAttendance || 1;
      recalcAllMembersTotals(); // لو بُدِّلت القيمة نعيد الحساب
    });
  }

  // ======== Refs helpers ========
  const rMembers     = () => ref(db,"members");
  const rWeeks       = () => ref(db,"weeks");
  const rAttendance  = () => ref(db,"attendance");   // each: {memberId, weekId, ts}
  const rTasks       = () => ref(db,"tasks");        // each: {memberId, title, points, done}
  const rEvents      = () => ref(db,"events");       // each: {title, date, type, notifyDays}

  function newKey(r){ return push(r).key; }

  // ======== UI helpers ========
  function refreshAdminUI(){
    document.querySelectorAll(".admin-only").forEach(el=>{
      el.classList.toggle("hidden", !isAdmin());
    });
    $("btnAdminLogin").classList.toggle("hidden", isAdmin());
    $("btnAdminLogout").classList.toggle("hidden", !isAdmin());
  }
  function uiSetStatus(id, text){ const el=$(id); if(el) el.textContent = text; }
  function clear(el){ while(el.firstChild) el.removeChild(el.firstChild); }

  // ======== Members ========
  function renderMembers(list){
    // fill selects
    const selMember = $("selMember"); const taskMember = $("taskMember");
    const opts = ['<option value="">-- اختر اسمك --</option>'].concat(list.map(m=>`<option value="${m.id}">${m.name}</option>`));
    selMember.innerHTML = opts.join("");
    taskMember.innerHTML = ['<option value="">-- اختر عضوًا --</option>'].concat(list.map(m=>`<option value="${m.id}">${m.name}</option>`)).join("");

    // table
    const tb = $("tblMembers").querySelector("tbody"); clear(tb);
    list.forEach((m, i)=>{
      const tr = document.createElement("tr");
      const ph = m.photoUrl ? `<img src="${m.photoUrl}" alt="${m.name}" style="width:38px;height:38px;border-radius:50%;object-fit:cover">` : "—";
      const att = m.stats?.attendance||0, tsk = m.stats?.tasks||0, man = m.stats?.manual||0, tot = m.stats?.total||0;
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${ph}</td>
        <td>${m.name}</td>
        <td><span class="badge">${att}</span></td>
        <td><span class="badge">${tsk}</span></td>
        <td>
          <div class="toolbar">
            <span class="badge">${man}</span>
            <input type="number" placeholder="+ نقاط" style="width:90px" />
            <button class="ok">إضافة نقاط</button>
          </div>
        </td>
        <td><b>${tot}</b></td>
        <td>${man>0?`+${man}`:"لا يوجد"}</td>
        <td class="toolbar">
          <button class="ghost" data-act="edit">تعديل</button>
          <button class="danger" data-act="remove">حذف</button>
        </td>
      `;
      tr.querySelector("button.ok").onclick = async ()=>{
        const val = Number(tr.querySelector("input[type=number]").value || "0");
        if(!val) return;
        await addManualPoints(m.id, val);
        tr.querySelector("input[type=number]").value = "";
      };
      tr.querySelector("[data-act=remove]").onclick = ()=> confirm("حذف العضو وجميع بياناته؟") && deleteMember(m.id);
      tr.querySelector("[data-act=edit]").onclick = ()=>{
        const newName = prompt("تعديل الاسم:", m.name)||"";
        if(newName && newName!==m.name) updateMember(m.id, {name:newName});
        const newPhoto = prompt("تعديل رابط الصورة (اختياري):", m.photoUrl||"");
        if(newPhoto!==null) updateMember(m.id, {photoUrl:newPhoto});
      };
      tb.appendChild(tr);
    });
    $("statMembers").textContent = list.length;
  }

  async function addMember(name, photoUrl){
    const id = newKey(rMembers()); await set(child(rMembers(), id), { name, photoUrl:photoUrl||"", stats:{attendance:0, tasks:0, manual:0, total:0} });
  }
  async function deleteMember(id){
    // cascade delete: attendance, tasks
    const atSnap = await get(query(rAttendance(), orderByChild("memberId"), equalTo(id)));
    if(atSnap.exists()){
      const updates = {};
      atSnap.forEach(s=> updates[`attendance/${s.key}`] = null );
      await update(ref(db), updates);
    }
    const tkSnap = await get(query(rTasks(), orderByChild("memberId"), equalTo(id)));
    if(tkSnap.exists()){
      const updates = {};
      tkSnap.forEach(s=> updates[`tasks/${s.key}`] = null );
      await update(ref(db), updates);
    }
    await remove(child(rMembers(), id));
  }
  async function updateMember(id, data){ await update(child(rMembers(), id), data); }

  async function addManualPoints(memberId, delta){
    // increase manual and total via transaction + then recalc totals to be safe
    await runTransaction(child(rMembers(), `${memberId}/stats/manual`), cur => (Number(cur)||0) + Number(delta));
    await recalcMemberTotals(memberId);
  }

  // ======== Weeks ========
  function renderWeeks(list){
    const selWeek = $("selWeek");
    const selWeekAdmin = $("selWeekAdmin");
    const opts = ['<option value="">-- اختر الأسبوع --</option>'].concat(list.map(w=>`<option value="${w.id}">${w.name}</option>`));
    selWeek.innerHTML = opts.join("");
    selWeekAdmin.innerHTML = ['<option value="">— اختر —</option>'].concat(list.map(w=>`<option value="${w.id}">${w.name}</option>`)).join("");

    const tb = $("tblWeeks").querySelector("tbody"); clear(tb);
    list.forEach((w,i)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i+1}</td><td>${w.name}</td><td>${w.from||"—"}</td><td>${w.to||"—"}</td>
        <td class="toolbar">
          <button class="ghost" data-act="edit">تعديل</button>
          <button class="danger" data-act="remove">حذف</button>
        </td>`;
      tr.querySelector("[data-act=remove]").onclick = ()=> confirm("حذف الأسبوع؟") && remove(child(rWeeks(), w.id));
      tr.querySelector("[data-act=edit]").onclick = async ()=>{
        const name = prompt("اسم الأسبوع:", w.name)||w.name;
        const from = prompt("تاريخ البداية (YYYY-MM-DD):", w.from||"")||w.from||"";
        const to   = prompt("تاريخ النهاية (YYYY-MM-DD):", w.to||"")||w.to||"";
        await update(child(rWeeks(), w.id), {name, from, to});
      };
      tb.appendChild(tr);
    });
  }
  async function addWeek(name, from, to){ const id = newKey(rWeeks()); await set(child(rWeeks(), id), {name, from, to}); }

  // ======== Attendance ========
  async function checkin(memberId, weekId){
    if(!memberId || !weekId) return alert("اختر الاسم والأسبوع");
    const id = newKey(rAttendance());
    await set(child(rAttendance(), id), { memberId, weekId, ts: Date.now() });
    await runTransaction(child(rMembers(), `${memberId}/stats/attendance`), cur => (Number(cur)||0) + 1);
    await recalcMemberTotals(memberId);
    alert("تم تسجيل الحضور ✅");
  }

  function renderAttendance(list, members, weeks){
    const tb = $("tblAttendance").querySelector("tbody"); clear(tb);
    const mapM = Object.fromEntries(members.map(m=>[m.id,m]));
    const mapW = Object.fromEntries(weeks.map(w=>[w.id,w]));
    list.forEach((a,i)=>{
      const tr = document.createElement("tr");
      const dt = new Date(a.ts||Date.now());
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${mapM[a.memberId]?.name || "?"}</td>
        <td>${mapW[a.weekId]?.name || "?"}</td>
        <td>${dt.toLocaleString()}</td>
        <td class="toolbar">
          <button class="ghost" data-act="edit">تعديل</button>
          <button class="danger" data-act="remove">حذف</button>
        </td>`;
      tr.querySelector("[data-act=remove]").onclick = async ()=>{
        if(!confirm("حذف هذا التسجيل؟")) return;
        await remove(child(rAttendance(), a.id));
        // أنقص العدّاد بأمان
        await runTransaction(child(rMembers(), `${a.memberId}/stats/attendance`), cur => Math.max(0,(Number(cur)||0) - 1));
        await recalcMemberTotals(a.memberId);
      };
      tr.querySelector("[data-act=edit]").onclick = async ()=>{
        const newMember = prompt("تعديل (ID عضو) — اتركه كما هو لتبقى القيمة:", a.memberId)||a.memberId;
        const newWeek   = prompt("تعديل (ID أسبوع) — اتركه كما هو:", a.weekId)||a.weekId;
        const newTsStr  = prompt("تعديل التاريخ (YYYY-MM-DD HH:mm) — اتركه:", new Date(a.ts).toISOString().slice(0,16).replace("T"," "))||"";
        const newTs = newTsStr ? Date.parse(newTsStr.replace(" ","T")) : a.ts;
        const beforeMember = a.memberId;
        await update(child(rAttendance(), a.id), { memberId:newMember, weekId:newWeek, ts:newTs });
        if(newMember !== beforeMember){
          // عدّل العدادات لو تبدّل العضو
          await runTransaction(child(rMembers(), `${beforeMember}/stats/attendance`), cur => Math.max(0,(Number(cur)||0) - 1));
          await runTransaction(child(rMembers(), `${newMember}/stats/attendance`), cur => (Number(cur)||0) + 1);
          await Promise.all([recalcMemberTotals(beforeMember), recalcMemberTotals(newMember)]);
        }else{
          await recalcMemberTotals(newMember);
        }
      };
      tb.appendChild(tr);
    });
    $("statTotalAttendance").textContent = list.length;
  }

  // ======== Tasks ========
  function renderTasks(list, members){
    const tb = $("tblTasks").querySelector("tbody"); clear(tb);
    const mapM = Object.fromEntries(members.map(m=>[m.id,m]));
    list.forEach((t,i)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${mapM[t.memberId]?.name || "?"}</td>
        <td>${t.title}</td>
        <td>${t.points||0}</td>
        <td>${t.done?'<span class="badge">منجزة</span>':'<span class="badge" style="background:#fff0f0;border-color:#ffd6d6;color:#9c3b3b">غير منجزة</span>'}</td>
        <td class="toolbar">
          <button class="ghost" data-act="toggle">${t.done?'تعطيل':'إنهاء'}</button>
          <button class="danger" data-act="remove">حذف</button>
        </td>`;
      tr.querySelector("[data-act=toggle]").onclick = async ()=>{
        await update(child(rTasks(), t.id), { done: !t.done });
        await recalcMemberTotals(t.memberId);
      };
      tr.querySelector("[data-act=remove]").onclick = async ()=>{
        if(!confirm("حذف المهمة؟")) return;
        await remove(child(rTasks(), t.id));
        await recalcMemberTotals(t.memberId);
      };
      tb.appendChild(tr);
    });
  }
  async function addTask(memberId, title, points){
    const id = newKey(rTasks());
    await set(child(rTasks(), id), { memberId, title, points:Number(points)||0, done:false });
    await recalcMemberTotals(memberId);
  }

  // ======== Events + toast ========
  function renderEvents(list){
    const tb = $("tblEvents").querySelector("tbody"); clear(tb);
    list.forEach((e,i)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${e.title}</td>
        <td>${e.date}</td>
        <td>${e.type||'event'}</td>
        <td>${e.notifyDays ?? 2}</td>
        <td class="toolbar">
          <button class="ghost" data-act="edit">تعديل</button>
          <button class="danger" data-act="remove">حذف</button>
        </td>`;
      tr.querySelector("[data-act=remove]").onclick = ()=> confirm("حذف المناسبة؟") && remove(child(rEvents(), e.id));
      tr.querySelector("[data-act=edit]").onclick = async ()=>{
        const title = prompt("العنوان:", e.title)||e.title;
        const date  = prompt("التاريخ (YYYY-MM-DD):", e.date)||e.date;
        const type  = prompt("النوع (event/birthday):", e.type||"event") || e.type || "event";
        const nd    = Number(prompt("أيام قبل التنبيه:", e.notifyDays ?? 2) || (e.notifyDays ?? 2));
        await update(child(rEvents(), e.id), { title, date, type, notifyDays: nd });
      };
      tb.appendChild(tr);
    });

    // toast
    const today = new Date(); today.setHours(0,0,0,0);
    const near = list.filter(e=>{
      const d = new Date(e.date+"T00:00:00");
      const diffDays = Math.ceil((d - today)/(1000*60*60*24));
      const nd = e.notifyDays ?? 2;
      return diffDays >= 0 && diffDays <= nd;
    });
    const toast = $("events-toast");
    if(near.length && localStorage.getItem(toastKey)!==new Date().toISOString().slice(0,10)){
      toast.classList.remove("hidden");
      $("btnSeeEvents").onclick = ()=>{
        toast.classList.add("hidden");
        document.getElementById("secEvents").scrollIntoView({behavior:"smooth"});
      };
      $("btnDismissEvents").onclick = ()=>{
        localStorage.setItem(toastKey, new Date().toISOString().slice(0,10));
        toast.classList.add("hidden");
      };
    }else{
      toast.classList.add("hidden");
    }
  }
  async function addEvent(title, date, type, notifyDays){
    const id = newKey(rEvents());
    await set(child(rEvents(), id), { title, date, type, notifyDays:Number(notifyDays)||2 });
  }

  // ======== Totals (auto calc: attendance + tasks + manual) ========
  async function recalcMemberTotals(memberId){
    // attendance count already stored at members/<id>/stats/attendance
    const [mSnap, tSnap] = await Promise.all([
      get(child(rMembers(), memberId)),
      get(query(rTasks(), orderByChild("memberId"), equalTo(memberId)))
    ]);
    if(!mSnap.exists()) return;
    const m = mSnap.val();
    const att = Number(m.stats?.attendance || 0);
    let tPts = 0;
    if(tSnap.exists()){
      tSnap.forEach(s=>{ const v=s.val(); if(v.done) tPts += Number(v.points)||0; });
    }
    const manual = Number(m.stats?.manual || 0);
    const total = (att * (Number(settings.pointsPerAttendance)||1)) + tPts + manual;
    await update(child(rMembers(), memberId), { stats:{ attendance:att, tasks:tPts, manual, total } });
  }
  async function recalcAllMembersTotals(){
    const snap = await get(rMembers());
    if(!snap.exists()) return;
    const updates = {};
    const members = snap.val();
    for(const id in members){
      const m = members[id];
      const att = Number(m.stats?.attendance||0);
      const manual = Number(m.stats?.manual||0);
      updates[`members/${id}/stats/attendance`] = att;
      updates[`members/${id}/stats/manual`] = manual;
      // tasks will be recalculated one-by-one to include only 'done'
      // compute tPts:
      let tPts = 0;
      const tkSnap = await get(query(rTasks(), orderByChild("memberId"), equalTo(id)));
      if(tkSnap.exists()){ tkSnap.forEach(s=>{ const v=s.val(); if(v.done) tPts += Number(v.points)||0; }); }
      updates[`members/${id}/stats/tasks`] = tPts;
      updates[`members/${id}/stats/total`] = (att*(Number(settings.pointsPerAttendance)||1)) + tPts + manual;
    }
    await update(ref(db), updates);
    // update statTotalPoints
    const m2 = await get(rMembers());
    let sum=0; if(m2.exists()) Object.values(m2.val()).forEach(x=> sum += Number(x.stats?.total||0));
    $("statTotalPoints").textContent = sum;
  }

  // ======== Live bindings ========
  let cacheMembers=[], cacheWeeks=[], cacheAttendance=[], cacheTasks=[], cacheEvents=[];
  function attachLiveBindings(){
    onValue(rMembers(), s=>{
      const arr=[]; s.forEach(ch=> arr.push({id:ch.key, ...(ch.val()||{})})); cacheMembers = arr;
      renderMembers(arr);
      // update total points stat immediately
      let sum=0; arr.forEach(m=> sum += Number(m.stats?.total||0)); $("statTotalPoints").textContent = sum;
    });
    onValue(rWeeks(), s=>{
      const arr=[]; s.forEach(ch=> arr.push({id:ch.key, ...(ch.val()||{})})); cacheWeeks = arr;
      renderWeeks(arr);
    });
    onValue(rAttendance(), s=>{
      const arr=[]; s.forEach(ch=> arr.push({id:ch.key, ...(ch.val()||{})})); cacheAttendance = arr;
      // filter by selected week (admin)
      const wk = $("selWeekAdmin").value;
      const list = wk ? arr.filter(a=>a.weekId===wk) : arr;
      renderAttendance(list, cacheMembers, cacheWeeks);
    });
    onValue(rTasks(), s=>{
      const arr=[]; s.forEach(ch=> arr.push({id:ch.key, ...(ch.val()||{})})); cacheTasks = arr;
      renderTasks(arr, cacheMembers);
    });
    onValue(rEvents(), s=>{
      const arr=[]; s.forEach(ch=> arr.push({id:ch.key, ...(ch.val()||{})})); cacheEvents = arr;
      renderEvents(arr);
    });
  }

  // ======== Wire UI ========
  $("btnCheckin").onclick = ()=> checkin($("selMember").value, $("selWeek").value);

  $("btnAddMember").onclick = async ()=>{
    const n = $("memName").value.trim(); if(!n) return;
    await addMember(n, $("memPhoto").value.trim()); $("memName").value=""; $("memPhoto").value="";
  };

  $("btnAddWeek").onclick = async ()=>{
    const n=$("weekName").value.trim(); const f=$("weekFrom").value; const t=$("weekTo").value;
    if(!n) return; await addWeek(n,f,t); $("weekName").value=""; $("weekFrom").value=""; $("weekTo").value="";
  };

  $("selWeekAdmin").onchange = ()=>{
    const wk = $("selWeekAdmin").value;
    const list = wk ? cacheAttendance.filter(a=>a.weekId===wk) : cacheAttendance;
    renderAttendance(list, cacheMembers, cacheWeeks);
  };
  $("btnDeleteWeekAttendance").onclick = async ()=>{
    const wk = $("selWeekAdmin").value; if(!wk) return alert("اختر أسبوعًا");
    if(!confirm("حذف كل حضور هذا الأسبوع؟")) return;
    const list = cacheAttendance.filter(a=>a.weekId===wk);
    const updates={};
    list.forEach(a=>{
      updates[`attendance/${a.id}`]=null;
    });
    await update(ref(db), updates);
    // أعد حساب حضور كل عضو تضرر
    const affected = [...new Set(list.map(a=>a.memberId))];
    for(const m of affected){
      // أعد بناء عدّاد الحضور من جديد لهذا العضو
      const left = cacheAttendance.filter(a=> a.memberId===m && a.weekId!==wk).length;
      await update(child(rMembers(), m), { stats:{ ...(cacheMembers.find(x=>x.id===m)?.stats||{}), attendance: left }});
      await recalcMemberTotals(m);
    }
  };

  $("btnAddTask").onclick = ()=>{
    const mid=$("taskMember").value, title=$("taskTitle").value.trim(), pts=Number($("taskPoints").value||0);
    if(!mid || !title) return;
    addTask(mid,title,pts).then(()=>{
      $("taskTitle").value=""; $("taskPoints").value="";
    });
  };

  $("btnAddEvent").onclick = ()=>{
    const t=$("eventTitle").value.trim(), d=$("eventDate").value, ty=$("eventType").value, nd=Number($("eventNotifyDays").value||2);
    if(!t || !d) return;
    addEvent(t,d,ty,nd).then(()=>{
      $("eventTitle").value=""; $("eventDate").value=""; $("eventNotifyDays").value="";
    });
  };

  $("btnAdminLogin").onclick = ()=>{
    // كلمة سر بسيطة محليًا (اختيارية) — لو تركتها فاضية يسمح بالدخول
    const pass = $("adminPass").value;
    setAdmin(true);
  };
  $("btnAdminLogout").onclick = ()=> setAdmin(false);

  $("btnSaveFirebase").onclick = ()=>{
    const cfg = readFirebaseForm(); saveCfg(cfg); location.reload();
  };
  $("btnSync").onclick = ()=> recalcAllMembersTotals();
  $("btnReset").onclick = ()=>{
    if(confirm("سيتم مسح الإعدادات المحلية فقط (لن تُحذف البيانات من السحابة).")){ localStorage.clear(); location.reload(); }
  };

  // زر إغلاق تنبيه المناسبات
  $("btnSeeEvents").onclick = ()=> document.getElementById("secEvents").scrollIntoView({behavior:"smooth"});
  $("btnDismissEvents").onclick = ()=> document.getElementById("events-toast").classList.add("hidden");

  // بدء التشغيل
  refreshAdminUI();
  boot();

</script>
</body>
</html>
