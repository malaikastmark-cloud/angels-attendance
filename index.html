<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <title>نظام خدام ملايكة</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; direction: rtl; }
        .btn { padding: 5px 10px; margin: 2px; cursor: pointer; }
        .btn-primary { background-color: #3498db; color: white; border: none; border-radius: 4px; }
        .btn-danger { background-color: #e74c3c; color: white; border: none; border-radius: 4px; }
        .btn-success { background-color: #2ecc71; color: white; border: none; border-radius: 4px; }
        .ranking-medal { font-size: 1.5em; }
        #notification { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); padding: 10px 20px; color: white; display: none; border-radius: 5px; z-index: 1000; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <div id="notification"></div>
    
    <!-- مثال جدول الأعضاء -->
    <h2>الأعضاء</h2>
    <table id="membersTable">
        <thead>
            <tr>
                <th>#</th>
                <th>الاسم</th>
                <th>النقاط</th>
                <th>الحضور</th>
                <th>رصيد Talanton</th>
                <th>كلمة السر</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    
    <!-- مخطط نقاط الأعضاء -->
    <canvas id="pointsChart" height="150"></canvas>
    
    <!-- مخطط الحضور -->
    <canvas id="attendanceChart" height="150"></canvas>
    
    <script>
        // إعداد Firebase
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            databaseURL: "YOUR_DATABASE_URL",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // البيانات المحلية
        let members = [];
        let weeks = [];
        let attendanceRecords = [];
        let contests = [];
        let birthdays = [];
        let events = [];
        let tasks = [];
        
        // جلب البيانات من Firebase
        function fetchData() {
            database.ref('members').on('value', snapshot => {
                members = [];
                snapshot.forEach(child => {
                    const data = child.val();
                    data.id = child.key;
                    if (data.talanton === undefined) data.talanton = 0; // إضافة Talanton إذا غير موجود
                    members.push(data);
                });
                updateMembersTable();
                updateCharts();
            });
            
            database.ref('weeks').on('value', snapshot => {
                weeks = [];
                snapshot.forEach(child => {
                    const data = child.val();
                    data.id = child.key;
                    weeks.push(data);
                });
                updateCharts();
            });
            
            database.ref('attendance').on('value', snapshot => {
                attendanceRecords = [];
                snapshot.forEach(child => {
                    const data = child.val();
                    data.id = child.key;
                    attendanceRecords.push(data);
                });
                updateMembersTable();
                updateCharts();
            });
            
            database.ref('contests').on('value', snapshot => {
                contests = [];
                snapshot.forEach(child => {
                    const data = child.val();
                    data.id = child.key;
                    contests.push(data);
                });
                updateMembersTable();
            });
        }
        
        // تحديث جدول الأعضاء
        function updateMembersTable() {
            const tbody = document.querySelector('#membersTable tbody');
            tbody.innerHTML = '';
            members.forEach((member, index) => {
                const attendanceCount = attendanceRecords.filter(ar => ar.memberId === member.id).length;
                const totalTalanton = calculateTalanton(member);
                tbody.innerHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${member.name}</td>
                        <td>${member.points || 0}</td>
                        <td>${attendanceCount}</td>
                        <td>${totalTalanton}</td>
                        <td>${member.password}</td>
                    </tr>
                `;
            });
        }
        
        // حساب Talanton للعضو
        function calculateTalanton(member) {
            let talanton = member.talanton || 0;
            
            // نقاط من الحضور
            const attendanceCount = attendanceRecords.filter(ar => ar.memberId === member.id).length;
            talanton += attendanceCount;
            
            // نقاط من المسابقات
            const contestPoints = contests.filter(c => c.memberId === member.id)
                                         .reduce((sum, c) => sum + (c.points || 0), 0);
            talanton += contestPoints;
            
            return talanton;
        }
        
        // تحديث المخططات
        function updateCharts() {
            updatePointsChart();
            updateAttendanceChart();
        }
        
        function updatePointsChart() {
            const ctx = document.getElementById('pointsChart').getContext('2d');
            const memberNames = members.map(m => m.name);
            const memberPoints = members.map(m => m.points || 0);
            
            if (window.pointsChartInstance) window.pointsChartInstance.destroy();
            
            window.pointsChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: memberNames,
                    datasets: [{
                        label: 'النقاط',
                        data: memberPoints,
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
        
        function updateAttendanceChart() {
            const ctx = document.getElementById('attendanceChart').getContext('2d');
            const weekNames = weeks.map(w => w.name);
            const attendanceByWeek = weeks.map(w => attendanceRecords.filter(ar => ar.weekId === w.id).length);
            
            if (window.attendanceChartInstance) window.attendanceChartInstance.destroy();
            
            window.attendanceChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: weekNames,
                    datasets: [{
                        label: 'عدد الحضور',
                        data: attendanceByWeek,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
        
        document.addEventListener('DOMContentLoaded', fetchData);
    </script>
</body>
</html>
