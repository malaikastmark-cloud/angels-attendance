  // حذف مسابقة - الإصدار المصحح
function deleteContest(id) {
    if (confirm('هل تريد حذف هذه المسابقة؟ سيتم خصم النقاط من العضو.')) {
        const contestRef = database.ref('contests/' + id);
        
        contestRef.once('value').then((snapshot) => {
            const contest = snapshot.val();
            if (!contest) return;
            
            const memberRef = database.ref('members/' + contest.memberId);
            memberRef.once('value').then((snapshot) => {
                const memberData = snapshot.val();
                if (memberData) {
                    // خصم النقاط مع ضمان عدم النزول تحت الصفر
                    const newPoints = Math.max(0, (memberData.points || 0) - (contest.points || 0));
                    memberRef.update({ points: newPoints })
                        .then(() => {
                            contestRef.remove().then(() => {
                                showNotification('تم حذف المسابقة وخصم النقاط من العضو');
                            }).catch((error) => {
                                console.error("Error deleting contest:", error);
                                showNotification('فشل في حذف المسابقة: ' + error.message, false);
                            });
                        }).catch((error) => {
                            console.error("Error updating points:", error);
                            showNotification('فشل في تحديث النقاط: ' + error.message, false);
                        });
                } else {
                    // العضو غير موجود => حذف المسابقة فقط
                    contestRef.remove().then(() => {
                        showNotification('تم حذف المسابقة');
                    }).catch((error) => {
                        console.error("Error deleting contest:", error);
                        showNotification('فشل في حذف المسابقة: ' + error.message, false);
                    });
                }
            });
        });
    }
}

        // تحديث جدول المسابقات
        function updateContestsTable() {
            const tbody = document.querySelector('#contestsTable tbody');
            tbody.innerHTML = '';
            
            if (contests.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="6" style="text-align:center;">لا توجد مسابقات حتى الآن</td>`;
                tbody.appendChild(tr);
                return;
            }
            
            contests.forEach((contest, index) => {
                const member = members.find(m => m.id === contest.memberId);
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="member-number">${index + 1}</td>
                    <td>${member ? member.name : 'عضو محذوف'}</td>
                    <td>${contest.contestName}</td>
                    <td>${contest.points}</td>
                    <td>${new Date(contest.date).toLocaleDateString('ar-EG')}</td>
                    <td><button class='btn btn-danger deleteContest' data-id='${contest.id}'>حذف</button></td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // إضافة عيد ميلاد
        function addBirthday() {
            const memberId = document.getElementById('birthdayMember').value;
            const date = document.getElementById('birthdayDate').value;
            
            if (!memberId || !date) {
                showNotification('يرجى اختيار العضو وتاريخ الميلاد', false);
                return;
            }
            
            const member = members.find(m => m.id === memberId);
            if (!member) {
                showNotification('العضو المحدد غير موجود', false);
                return;
            }
            
            const birthdaysRef = database.ref('birthdays');
            const newBirthdayRef = birthdaysRef.push();
            
            newBirthdayRef.set({
                memberId: memberId,
                date: date
            }).then(() => {
                showNotification(`تم إضافة عيد ميلاد لـ ${member.name}`);
                
                document.getElementById('birthdayDate').value = '';
            }).catch((error) => {
                console.error("Error adding birthday:", error);
                showNotification('فشل في إضافة عيد الميلاد: ' + error.message, false);
            });
        }
        
        // تعديل عيد ميلاد
        function editBirthday(id) {
            const birthdayRef = database.ref('birthdays/' + id);
            
            birthdayRef.once('value').then((snapshot) => {
                const birthday = snapshot.val();
                if (!birthday) return;
                
                const newDate = prompt('عدل تاريخ الميلاد:', birthday.date);
                
                if (newDate) {
                    birthdayRef.update({
                        date: newDate
                    }).then(() => {
                        showNotification('تم تعديل تاريخ الميلاد');
                    }).catch((error) => {
                        console.error("Error updating birthday:", error);
                        showNotification('فشل في تعديل تاريخ الميلاد: ' + error.message, false);
                    });
                }
            });
        }
        
        // حذف عيد ميلاد
        function deleteBirthday(id) {
            if (confirm('هل تريد حذف تاريخ الميلاد؟')) {
                const birthdayRef = database.ref('birthdays/' + id);
                
                birthdayRef.remove().then(() => {
                    showNotification('تم حذف تاريخ الميلاد');
                }).catch((error) => {
                    console.error("Error deleting birthday:", error);
                    showNotification('فشل في حذف تاريخ الميلاد: ' + error.message, false);
                });
            }
        }
        
        // حساب الأيام المتبقية لعيد الميلاد
        function daysUntilBirthday(birthdayDate) {
            const today = new Date();
            const nextBirthday = new Date(birthdayDate);
            nextBirthday.setFullYear(today.getFullYear());
            
            if (nextBirthday < today) {
                nextBirthday.setFullYear(today.getFullYear() + 1);
            }
            
            const diffTime = nextBirthday - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            return diffDays;
        }
        
        // تحديث جدول أعياد الميلاد
        function updateBirthdaysTable() {
            const tbody = document.querySelector('#birthdaysTable tbody');
            tbody.innerHTML = '';
            
            if (birthdays.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="6" style="text-align:center;">لا توجد أعياد ميلاد مسجلة حتى الآن</td>`;
                tbody.appendChild(tr);
                return;
            }
            
            birthdays.forEach((birthday, index) => {
                const member = members.find(m => m.id === birthday.memberId);
                const daysLeft = daysUntilBirthday(birthday.date);
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="member-number">${index + 1}</td>
                    <td>${member ? member.name : 'عضو محذوف'}</td>
                    <td>${new Date(birthday.date).toLocaleDateString('ar-EG')}</td>
                    <td>${daysLeft} يوم</td>
                    <td><button class='btn btn-primary editBirthday' data-id='${birthday.id}'>تعديل</button></td>
                    <td><button class='btn btn-danger deleteBirthday' data-id='${birthday.id}'>حذف</button></td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // تحديث أعياد الميلاد القادمة
        function updateUpcomingBirthdays() {
            const upcomingBirthdaysDiv = document.getElementById('upcomingBirthdays');
            upcomingBirthdaysDiv.innerHTML = '';
            
            if (birthdays.length === 0) {
                upcomingBirthdaysDiv.innerHTML = '<p>لا توجد أعياد ميلاد مسجلة</p>';
                return;
            }
            
            const today = new Date();
            const upcoming = [];
            
            birthdays.forEach(birthday => {
                const member = members.find(m => m.id === birthday.memberId);
                if (!member) return;
                
                const daysLeft = daysUntilBirthday(birthday.date);
                
                if (daysLeft <= 30) { // عرض الأعياد في الشهر القادم فقط
                    upcoming.push({
                        memberName: member.name,
                        date: birthday.date,
                        daysLeft: daysLeft
                    });
                }
            });
            
            // ترتيب حسب الأيام المتبقية
            upcoming.sort((a, b) => a.daysLeft - b.daysLeft);
            
            if (upcoming.length === 0) {
                upcomingBirthdaysDiv.innerHTML = '<p>لا توجد أعياد ميلاد قريبة</p>';
                return;
            }
            
            upcoming.forEach(bday => {
                const bdayItem = document.createElement('div');
                bdayItem.className = 'birthday-item';
                
                let message = '';
                if (bday.daysLeft === 0) {
                    message = `اليوم هو عيد ميلاد ${bday.memberName}! 🎉`;
                } else if (bday.daysLeft === 1) {
                    message = `غداً عيد ميلاد ${bday.memberName}`;
                } else {
                    message = `باقي ${bday.daysLeft} يوم على عيد ميلاد ${bday.memberName}`;
                }
                
                bdayItem.innerHTML = `
                    <span>${message}</span>
                    <span>${new Date(bday.date).toLocaleDateString('ar-EG')}</span>
                `;
                
                upcomingBirthdaysDiv.appendChild(bdayItem);
            });
        }
        
        // إضافة مناسبة
        function addEvent() {
            const name = document.getElementById('newEventName').value;
            const date = document.getElementById('newEventDate').value;
            const description = document.getElementById('newEventDescription').value;
            
            if (!name || !date || !description) {
                showNotification('يرجى ملء جميع الحقول', false);
                return;
            }
            
            const eventsRef = database.ref('events');
            const newEventRef = eventsRef.push();
            
            newEventRef.set({
                name: name,
                date: date,
                description: description
            }).then(() => {
                showNotification('تم إضافة المناسبة بنجاح');
                
                document.getElementById('newEventName').value = '';
                document.getElementById('newEventDate').value = '';
                document.getElementById('newEventDescription').value = '';
            }).catch((error) => {
                console.error("Error adding event:", error);
                showNotification('فشل في إضافة المناسبة: ' + error.message, false);
            });
        }
        
        // تعديل مناسبة
        function editEvent(id) {
            const eventRef = database.ref('events/' + id);
            
            eventRef.once('value').then((snapshot) => {
                const event = snapshot.val();
                if (!event) return;
                
                const newName = prompt('عدل اسم المناسبة:', event.name);
                const newDate = prompt('عدل تاريخ المناسبة:', event.date);
                const newDescription = prompt('عدل وصف المناسبة:', event.description);
                
                if (newName && newDate && newDescription) {
                    eventRef.update({
                        name: newName,
                        date: newDate,
                        description: newDescription
                    }).then(() => {
                        showNotification('تم تعديل بيانات المناسبة');
                    }).catch((error) => {
                        console.error("Error updating event:", error);
                        showNotification('فشل في تعديل المناسبة: ' + error.message, false);
                    });
                }
            });
        }
        
        // حذف مناسبة
        function deleteEvent(id) {
            if (confirm('هل تريد حذف المناسبة؟')) {
                const eventRef = database.ref('events/' + id);
                
                eventRef.remove().then(() => {
                    showNotification('تم حذف المناسبة');
                }).catch((error) => {
                    console.error("Error deleting event:", error);
                    showNotification('فشل في حذف المناسبة: ' + error.message, false);
                });
            }
        }
        
        // تحديث جدول المناسبات
        function updateEventsTable() {
            const tbody = document.querySelector('#eventsTable tbody');
            tbody.innerHTML = '';
            
            if (events.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="6" style="text-align:center;">لا توجد مناسبات حتى الآن</td>`;
                tbody.appendChild(tr);
                return;
            }
            
            events.forEach((event, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="member-number">${index + 1}</td>
                    <td>${event.name}</td>
                    <td>${new Date(event.date).toLocaleDateString('ar-EG')}</td>
                    <td>${event.description}</td>
                    <td><button class='btn btn-primary editEvent' data-id='${event.id}'>تعديل</button></td>
                    <td><button class='btn btn-danger deleteEvent' data-id='${event.id}'>حذف</button></td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // إضافة مهمة
        function addTask() {
            const name = document.getElementById('newTaskName').value;
            const assigneeId = document.getElementById('newTaskAssignee').value;
            const deadline = document.getElementById('newTaskDeadline').value;
            const status = document.getElementById('newTaskStatus').value;
            
            if (!name || !assigneeId || !deadline || !status) {
                showNotification('يرجى ملء جميع الحقول', false);
                return;
            }
            
            const assignee = members.find(m => m.id === assigneeId);
            if (!assignee) {
                showNotification('العضو المحدد غير موجود', false);
                return;
            }
            
            const tasksRef = database.ref('tasks');
            const newTaskRef = tasksRef.push();
            
            newTaskRef.set({
                name: name,
                assigneeId: assigneeId,
                assigneeName: assignee.name,
                deadline: deadline,
                status: status
            }).then(() => {
                showNotification('تم إضافة المهمة بنجاح');
                
                document.getElementById('newTaskName').value = '';
                document.getElementById('newTaskAssignee').value = '';
                document.getElementById('newTaskDeadline').value = '';
                document.getElementById('newTaskStatus').value = 'قيد التنفيذ';
            }).catch((error) => {
                console.error("Error adding task:", error);
                showNotification('فشل في إضافة المهمة: ' + error.message, false);
            });
        }
        
        // تعديل مهمة
        function editTask(id) {
            const taskRef = database.ref('tasks/' + id);
            
            taskRef.once('value').then((snapshot) => {
                const task = snapshot.val();
                if (!task) return;
                
                const newName = prompt('عدل اسم المهمة:', task.name);
                const newDeadline = prompt('عدل الموعد النهائي:', task.deadline);
                const newStatus = prompt('عدل الحالة:', task.status);
                
                if (newName && newDeadline && newStatus) {
                    taskRef.update({
                        name: newName,
                        deadline: newDeadline,
                        status: newStatus
                    }).then(() => {
                        showNotification('تم تعديل بيانات المهمة');
                    }).catch((error) => {
                        console.error("Error updating task:", error);
                        showNotification('فشل في تعديل المهمة: ' + error.message, false);
                    });
                }
            });
        }
        
        // حذف مهمة
        function deleteTask(id) {
            if (confirm('هل تريد حذف المهمة؟')) {
                const taskRef = database.ref('tasks/' + id);
                
                taskRef.remove().then(() => {
                    showNotification('تم حذف المهمة');
                }).catch((error) => {
                    console.error("Error deleting task:", error);
                    showNotification('فشل في حذف المهمة: ' + error.message, false);
                });
            }
        }
        
        // تحديث جدول المهمات
        function updateTasksTable() {
            const tbody = document.querySelector('#tasksTable tbody');
            tbody.innerHTML = '';
            
            if (tasks.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="7" style="text-align:center;">لا توجد مهمات حتى الآن</td>`;
                tbody.appendChild(tr);
                return;
            }
            
            tasks.forEach((task, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="member-number">${index + 1}</td>
                    <td>${task.name}</td>
                    <td>${task.assigneeName}</td>
                    <td>${new Date(task.deadline).toLocaleDateString('ar-EG')}</td>
                    <td>${task.status}</td>
                    <td><button class='btn btn-primary editTask' data-id='${task.id}'>تعديل</button></td>
                    <td><button class='btn btn-danger deleteTask' data-id='${task.id}'>حذف</button></td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // حفظ إعدادات الأمان
        function saveSecuritySettings() {
            const securityLevel = document.getElementById('securityLevel').value;
            
            const settingsRef = database.ref('systemSettings');
            settingsRef.update({
                securityLevel: securityLevel
            }).then(() => {
                showNotification('تم حفظ إعدادات الأمان بنجاح');
            }).catch((error) => {
                console.error("Error saving security settings:", error);
                showNotification('فشل في حفظ الإعدادات: ' + error.message, false);
            });
        }
        
        // إعادة تعيين كلمة السر من الأدمن
        function resetPasswordFromAdmin() {
            const memberId = document.getElementById('resetMemberPassword').value;
            const newPassword = document.getElementById('newPasswordValue').value;
            
            if (!memberId || !newPassword) {
                showNotification('يرجى اختيار العضو وإدخال كلمة السر الجديدة', false);
                return;
            }
            
            const member = members.find(m => m.id === memberId);
            if (!member) {
                showNotification('العضو المحدد غير موجود', false);
                return;
            }
            
            const memberRef = database.ref('members/' + memberId);
            memberRef.update({
                password: newPassword
            }).then(() => {
                showNotification(`تم إعادة تعيين كلمة السر لـ ${member.name}`);
                document.getElementById('newPasswordValue').value = '';
            }).catch((error) => {
                console.error("Error resetting password:", error);
                showNotification('فشل في إعادة تعيين كلمة السر: ' + error.message, false);
            });
        }
        
        // تحديث جدول سجلات الأمان
        function updateSecurityLogsTable() {
            const tbody = document.querySelector('#securityLogsTable tbody');
            tbody.innerHTML = '';
            
            if (securityLogs.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="5" style="text-align:center;">لا توجد سجلات أمان حتى الآن</td>`;
                tbody.appendChild(tr);
                return;
            }
            
            // عرض آخر 50 سجل فقط
            const recentLogs = securityLogs.slice(-50).reverse();
            
            recentLogs.forEach((log, index) => {
                const member = members.find(m => m.id === log.memberId);
                const tr = document.createElement('tr');
                
                let statusColor = '';
                if (log.status === 'success') statusColor = '#2ecc71';
                else if (log.status === 'failed') statusColor = '#e74c3c';
                else statusColor = '#f39c12';
                
                tr.innerHTML = `
                    <td class="member-number">${index + 1}</td>
                    <td>${member ? member.name : 'عضو محذوف'}</td>
                    <td>${new Date(log.timestamp).toLocaleString('ar-EG')}</td>
                    <td>${log.type === 'biometric' ? 'بصمة/وجه' : 'كلمة سر'}</td>
                    <td style="color: ${statusColor}; font-weight: bold;">${log.status === 'success' ? 'نجاح' : log.status === 'failed' ? 'فشل' : 'خطأ'}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // تحديث التقارير
        function updateReports() {
            document.getElementById('reportAttendance').textContent = attendanceRecords.length;
            document.getElementById('reportPoints').textContent = members.reduce((sum, member) => sum + (member.points || 0), 0);
            document.getElementById('reportMembers').textContent = members.length;
            document.getElementById('reportWeeks').textContent = weeks.length;
            
            updateTopMembers();
            updateCharts();
        }
        
        // تحديث تقارير المستخدم
        function updateUserReports() {
            if (!currentUser) return;
            
            // إجمالي أيام الحضور
            const userAttendance = attendanceRecords.filter(ar => ar.memberId === currentUser.id).length;
            document.getElementById('userTotalAttendance').textContent = userAttendance;
            
            // إجمالي النقاط
            document.getElementById('userTotalPoints').textContent = currentUser.points || 0;
            
           // ترتيب المستخدم حسب النقاط - التصحيح هنا
const sortedByPoints = [...members].sort((a, b) => (b.points || 0) - (a.points || 0));
const userRank = sortedByPoints.findIndex(m => m.id === currentUser.id) + 1;
document.getElementById('userRank').textContent = userRank;
            
            // معدل الحضور
            const totalWeeks = weeks.length;
            const attendanceRate = totalWeeks > 0 ? Math.round((userAttendance / totalWeeks) * 100) : 0;
            document.getElementById('userPerformance').textContent = `${attendanceRate}%`;
            
            // إضافة ميدالية حسب الترتيب
            const rankingMedal = document.getElementById('userRankingMedal');
            rankingMedal.innerHTML = '';
            
            if (userRank === 1) {
                rankingMedal.innerHTML = '<span class="ranking-medal">🥇</span>';
            } else if (userRank === 2) {
                rankingMedal.innerHTML = '<span class="ranking-medal">🥈</span>';
            } else if (userRank === 3) {
                rankingMedal.innerHTML = '<span class="ranking-medal">🥉</span>';
            }
            
            // تحديث مخطط نقاط المستخدم
            updateUserPointsChart();
        }
        
        // تحديث مخطط نقاط المستخدم
        function updateUserPointsChart() {
            const ctx = document.getElementById('userPointsChart').getContext('2d');
            
            // تجهيز البيانات للمخطط
            const userPointsByWeek = [];
            
            weeks.forEach(week => {
                const attendance = attendanceRecords.find(ar => 
                    ar.memberId === currentUser.id && ar.weekId === week.id
                );
                userPointsByWeek.push(attendance ? 1 : 0);
            });
            
            // تراكم النقاط
            let cumulativePoints = 0;
            const cumulativePointsData = userPointsByWeek.map(points => {
                cumulativePoints += points;
                return cumulativePoints;
            });
            
            // إذا كان هناك مخطط موجود، قم بتدميره أولاً
            if (window.userPointsChartInstance) {
                window.userPointsChartInstance.destroy();
            }
            
            // إنشاء مخطط جديد
            window.userPointsChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: weeks.map(w => w.name),
                    datasets: [{
                        label: 'تراكم النقاط',
                        data: cumulativePointsData,
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'النقاط'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'الأسابيع'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'تطور النقاط خلال الأسابيع'
                        }
                    }
                }
            });
        }
        
        // تحديث المخططات البيانية
        function updateCharts() {
            updatePointsChart();
            updateAttendanceChart();
        }
        
       // تحديث مخطط النقاط
function updatePointsChart() {
    const ctx = document.getElementById('pointsChart').getContext('2d');

    // تجهيز البيانات للمخطط
    const memberNames = members.map(m => m.name);
    const memberPoints = members.map(m => m.points || 0);

    // إذا كان هناك مخطط موجود، قم بتدميره أولاً
    if (window.pointsChartInstance) {
        window.pointsChartInstance.destroy();
    }

    // إنشاء مخطط جديد
    window.pointsChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: memberNames,
            datasets: [{
                label: 'النقاط',
                data: memberPoints,
                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'النقاط'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'الأعضاء'
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'توزيع النقاط بين الأعضاء'
                },
                legend: {
                    display: false
                }
            }
        }
    });
}

// تحديث مخطط الحضور
function updateAttendanceChart() {
    const ctx = document.getElementById('attendanceChart').getContext('2d');

    // تجهيز البيانات للمخطط
    const weekNames = weeks.map(w => w.name);
    const attendanceByWeek = weeks.map(week => {
        return attendanceRecords.filter(ar => ar.weekId === week.id).length;
    });

    // إذا كان هناك مخطط موجود، قم بتدميره أولاً
    if (window.attendanceChartInstance) {
        window.attendanceChartInstance.destroy();
    }

    // إنشاء مخطط جديد
    window.attendanceChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: weekNames,
            datasets: [{
                label: 'عدد الحضور',
                data: attendanceByWeek,
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 2,
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'عدد الحضور'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'الأسابيع'
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'الحضور خلال الأسابيع'
                }
            }
        }
    });
}
        // تحديث قائمة الـ 10 الأوائل
        function updateTopMembers() {
            const memberPoints = members.map(member => {
                return { name: member.name, points: member.points || 0 };
            });
            
            memberPoints.sort((a, b) => b.points - a.points);
            
            const top10 = memberPoints.slice(0, 10);
            
            const topMembersList = document.getElementById('topMembersList');
            topMembersList.innerHTML = '';
            
            if (top10.length === 0) {
                topMembersList.innerHTML = '<p>لا توجد بيانات حتى الآن</p>';
                return;
            }
            
            top10.forEach((member, index) => {
                const item = document.createElement('div');
                item.className = 'top-member-item';
                
                let medal = '';
                if (index === 0) medal = '<span class="medal medal-gold">🥇</span>';
                else if (index === 1) medal = '<span class="medal medal-silver">🥈</span>';
                else if (index === 2) medal = '<span class="medal medal-bronze">🥉</span>';
                
                item.innerHTML = `
                    <div class="top-member-name">${medal} ${member.name}</div>
                    <div class="top-member-points">${member.points} نقطة</div>
                `;
                topMembersList.appendChild(item);
            });
        }
        
        // تصدير البيانات
        function exportData() {
            // إنشاء كائن يحتوي على جميع البيانات
            const data = {
                members: members,
                weeks: weeks,
                attendance: attendanceRecords,
                contests: contests,
                birthdays: birthdays,
                events: events,
                tasks: tasks,
                exportDate: new Date().toISOString()
            };
            
            // تحويل البيانات إلى JSON
            const jsonData = JSON.stringify(data, null, 2);
            
            // إنشاء ملف للتحميل
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            // إنشاء رابط للتحميل
            const a = document.createElement('a');
            a.href = url;
            a.download = `angels_attendance_backup_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            
            // تنظيف
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
            
            showNotification('تم تصدير البيانات بنجاح');
        }
        
        // نسخ احتياطي
        function backupData() {
            exportData(); // حالياً نفس وظيفة التصدير
            showNotification('تم إنشاء نسخة احتياطية بنجاح');
        }
        
        // تصدير تقرير الحضور
        function exportAttendanceReport() {
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            
            // عنوان التقرير
            csvContent += "تقرير الحضور - نظام خدام ملايكة\r\n";
            csvContent += `تاريخ التصدير: ${new Date().toLocaleDateString('ar-EG')}\r\n\r\n`;
            
            // بيانات الأعضاء
            csvContent += "الرقم,اسم العضو,النقاط,عدد أيام الحضور\r\n";
            
            members.forEach((member, index) => {
                const attendanceCount = attendanceRecords.filter(ar => ar.memberId === member.id).length;
                csvContent += `${index + 1},${member.name},${member.points || 0},${attendanceCount}\r\n`;
            });
            
            // إنشاء رابط للتحميل
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `تقرير_الحضور_${new Date().toISOString().slice(0, 10)}.csv`);
            document.body.appendChild(link);
            
            link.click();
            document.body.removeChild(link);
            
            showNotification('تم تصدير تقرير الحضور بنجاح');
        }
        
        // تصدير بيانات الأعضاء
        function exportMembersReport() {
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            
            // عنوان التقرير
            csvContent += "بيانات الأعضاء - نظام خدام ملايكة\r\n";
            csvContent += `تاريخ التصدير: ${new Date().toLocaleDateString('ar-EG')}\r\n\r\n`;
            
            // بيانات الأعضاء
            csvContent += "الرقم,اسم العضو,النقاط,كلمة السر\r\n";
            
            members.forEach((member, index) => {
                csvContent += `${index + 1},${member.name},${member.points || 0},${member.password}\r\n`;
            });
            
            // إنشاء رابط للتحميل
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `بيانات_الأعضاء_${new Date().toISOString().slice(0, 10)}.csv`);
            document.body.appendChild(link);
            
            link.click();
            document.body.removeChild(link);
            
            showNotification('تم تصدير بيانات الأعضاء بنجاح');
        }
        
        // عرض الإشعارات
        function showNotification(message, isSuccess = true) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.background = isSuccess ? '#2ecc71' : '#e74c3c';
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        // بدء التطبيق عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
