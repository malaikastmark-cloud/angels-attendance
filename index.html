<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Angels Attendance</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #74ABE2, #5563DE); color:#fff;}
.container {margin-top: 30px;}
.card {background-color: rgba(0,0,0,0.6); border-radius: 15px; padding:20px;}
button {border-radius: 10px;}
.nav-tabs .nav-link.active {background-color:#3498db; color:#fff;}
.member-img {width:40px; height:40px; border-radius:50%;}
.notification {position: fixed; top:20px; right:20px; padding:15px; border-radius:10px; display:none; z-index:9999;}
</style>
</head>
<body>
<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Angels Attendance</h2>
    <button id="adminLoginBtn" class="btn btn-warning">دخول الأدمن</button>
  </div>
  <div id="userInterface" class="card">
    <div class="mb-3">
      <label>اختر اسمك:</label>
      <select id="selectMember" class="form-select"></select>
    </div>
    <div class="mb-3">
      <label>اختر الأسبوع:</label>
      <select id="weekSelect" class="form-select"></select>
    </div>
    <button id="markPresent" class="btn btn-success w-100">تسجيل الحضور</button>
  </div>

  <div id="adminInterface" class="card mt-4" style="display:none;">
    <ul class="nav nav-tabs" id="adminTabs">
      <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#membersTab">الأعضاء</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#weeksTab">الأسابيع</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#attendanceTab">الحضور</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#reportsTab">التقارير</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#eventsTab">المناسبات</a></li>
    </ul>
    <div class="tab-content mt-3">
      <div class="tab-pane fade show active" id="membersTab">
        <h4>إدارة الأعضاء</h4>
        <div class="mb-3 d-flex gap-2">
          <input id="newMemberName" type="text" class="form-control" placeholder="اسم العضو">
          <input id="newMemberImage" type="text" class="form-control" placeholder="رابط الصورة">
          <button id="addMemberBtn" class="btn btn-primary">إضافة</button>
        </div>
        <table class="table table-dark table-striped">
          <thead><tr><th>#</th><th>الصورة</th><th>الاسم</th><th>الإجراءات</th></tr></thead>
          <tbody id="membersTableBody"></tbody>
        </table>
      </div>
      <div class="tab-pane fade" id="weeksTab">
        <h4>إدارة الأسابيع</h4>
        <div class="mb-3 d-flex gap-2">
          <input id="newWeekName" type="text" class="form-control" placeholder="اسم الأسبوع">
          <input id="newWeekStart" type="date" class="form-control">
          <input id="newWeekEnd" type="date" class="form-control">
          <button id="addWeekBtn" class="btn btn-primary">إضافة</button>
        </div>
        <table class="table table-dark table-striped">
          <thead><tr><th>#</th><th>اسم الأسبوع</th><th>من</th><th>إلى</th><th>الإجراءات</th></tr></thead>
          <tbody id="weeksTableBody"></tbody>
        </table>
      </div>
      <div class="tab-pane fade" id="attendanceTab">
        <h4>الحضور</h4>
        <table class="table table-dark table-striped">
          <thead><tr><th>#</th><th>العضو</th><th>الأسبوع</th><th>تاريخ</th><th>الإجراء</th></tr></thead>
          <tbody id="attendanceRecordsBody"></tbody>
        </table>
      </div>
      <div class="tab-pane fade" id="reportsTab">
        <h4>التقارير</h4>
        <canvas id="attendanceChart"></canvas>
        <div id="top10List" class="mt-3"></div>
      </div>
      <div class="tab-pane fade" id="eventsTab">
        <h4>المناسبات والأعياد</h4>
        <p>إضافة أحداث، مهام، أو أعياد ميلاد مع إشعارات داخل الصفحة</p>
      </div>
    </div>
  </div>
</div>
<div id="notification" class="notification"></div>

<script>
// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyBCQIqdCsxSvhfYOs00AetoVWpFhj4XNAQ",
  authDomain: "angels-attendance.firebaseapp.com",
  databaseURL: "https://angels-attendance-default-rtdb.firebaseio.com",
  projectId: "angels-attendance",
  storageBucket: "angels-attendance.firebasestorage.app",
  messagingSenderId: "157249026489",
  appId: "1:157249026489:web:db2b420203bd81d9a19e68",
  measurementId: "G-2YDPSFPQYT"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let members = [];
let weeks = [];
let attendanceRecords = [];
const adminPass = 'admin123';

function showNotification(msg) {
  const note = document.getElementById('notification');
  note.textContent = msg;
  note.style.display = 'block';
  setTimeout(()=>{ note.style.display='none'; }, 3000);
}

// Load data
function loadData() {
  db.ref('/members').once('value').then(snapshot=>{ members = snapshot.val() || []; populateMembersTable(); populateMemberSelect(); });
  db.ref('/weeks').once('value').then(snapshot=>{ weeks = snapshot.val() || []; populateWeeksTable(); populateWeekSelect(); });
  db.ref('/attendance').once('value').then(snapshot=>{ attendanceRecords = snapshot.val() || []; populateAttendanceTable(); updateChart(); });
}

function populateMemberSelect() {
  const sel = document.getElementById('selectMember');
  sel.innerHTML = '<option value="">-- اختر اسمك --</option>';
  members.forEach(m=>{ sel.innerHTML += `<option value='${m.id}'>${m.name}</option>`; });
}

function populateWeekSelect() {
  const sel = document.getElementById('weekSelect');
  sel.innerHTML='';
  weeks.forEach(w=>{ sel.innerHTML += `<option value='${w.id}'>${w.name}</option>`; });
}

function populateMembersTable() {
  const tbody = document.getElementById('membersTableBody');
  tbody.innerHTML='';
  members.forEach((m,i)=>{ 
    tbody.innerHTML += `<tr><td>${i+1}</td><td><img src='${m.image}' class='member-img'></td><td>${m.name}</td><td><button class='btn btn-sm btn-warning editMember' data-id='${m.id}'>تعديل</button> <button class='btn btn-sm btn-danger deleteMember' data-id='${m.id}'>حذف</button></td></tr>`;
  });
}

function populateWeeksTable() {
  const tbody = document.getElementById('weeksTableBody');
  tbody.innerHTML='';
  weeks.forEach((w,i)=>{ 
    tbody.innerHTML += `<tr><td>${i+1}</td><td>${w.name}</td><td>${w.from}</td><td>${w.to}</td><td><button class='btn btn-sm btn-warning editWeek' data-id='${w.id}'>تعديل</button> <button class='btn btn-sm btn-danger deleteWeek' data-id='${w.id}'>حذف</button></td></tr>`;
  });
}

function populateAttendanceTable() {
  const tbody = document.getElementById('attendanceRecordsBody');
  tbody.innerHTML='';
  attendanceRecords.forEach((a,i)=>{ 
    const member = members.find(m=>m.id===a.memberId);
    const week = weeks.find(w=>w.id===a.weekId);
    if(member && week){
      tbody.innerHTML += `<tr><td>${i+1}</td><td>${member.name}</td><td>${week.name}</td><td>${new Date(a.date).toLocaleString()}</td><td><button class='btn btn-sm btn-danger deleteAttendance' data-index='${i}'>حذف</button></td></tr>`;
    }
  });
}

function markAttendance(){
  const memberId = parseInt(document.getElementById('selectMember').value);
  const weekId = parseInt(document.getElementById('weekSelect').value);
  if(!memberId || !weekId){ alert('اختر العضو والأسبوع'); return;}
  const exists = attendanceRecords.find(a=>a.memberId===memberId && a.weekId===weekId);
  if(exists){ showNotification('تم تسجيل الحضور مسبقاً'); return;}
  const newRecord = {memberId, weekId, date: new Date().toISOString()};
  attendanceRecords.push(newRecord);
  db.ref('/attendance').set(attendanceRecords).then(()=>{ showNotification('تم تسجيل الحضور'); populateAttendanceTable(); updateChart(); updateTop10(); });
}

document.getElementById('markPresent').addEventListener('click', markAttendance);

// Admin login
document.getElementById('adminLoginBtn').addEventListener('click', ()=>{
  const pwd = prompt('أدخل كلمة سر الأدمن:');
  if(pwd===adminPass){ document.getElementById('adminInterface').style.display='block'; document.getElementById('userInterface').style.display='none'; showNotification('تم تسجيل دخول الأدمن'); }
  else alert('كلمة السر خاطئة');
});

// Add member
document.getElementById('addMemberBtn').addEventListener('click', ()=>{
  const name=document.getElementById('newMemberName').value;
  const image=document.getElementById('newMemberImage').value || 'https://ui-avatars.com/api/?name='+encodeURIComponent(name);
  if(!name){alert('أدخل اسم العضو'); return;}
  const id = members.length? Math.max(...members.map(m=>m.id))+1 :1;
  members.push({id,name,image});
  db.ref('/members').set(members).then(()=>{ populateMembersTable(); populateMemberSelect(); showNotification('تم إضافة العضو'); });
});

// Add week
document.getElementById('addWeekBtn').addEventListener('click', ()=>{
  const name=document.getElementById('newWeekName').value;
  const from=document.getElementById('newWeekStart').value;
  const to=document.getElementById('newWeekEnd').value;
  if(!name || !from || !to){alert('املأ جميع الحقول'); return;}
  const id = weeks.length? Math.max(...weeks.map(w=>w.id))+1 :1;
  weeks.push({id,name,from,to});
  db.ref('/weeks').set(weeks).then(()=>{ populateWeeksTable(); populateWeekSelect(); showNotification('تم إضافة الأسبوع'); });
});

// Chart and Top10
const ctx = document.getElementById('attendanceChart').getContext('2d');
let chart = new Chart(ctx,{type:'bar',data:{labels:[], datasets:[{label:'الحضور',data:[],backgroundColor:'#3498db'}]}, options:{responsive:true}});
function updateChart(){
  chart.data.labels = members.map(m=>m.name);
  chart.data.datasets[0].data = members.map(m=>attendanceRecords.filter(a=>a.memberId===m.id).length);
  chart.update();
}
function updateTop10(){
  const topDiv = document.getElementById('top10List');
  const memberPoints = members.map(m=>({name:m.name, points:attendanceRecords.filter(a=>a.memberId===m.id).length}));
  memberPoints.sort((a,b)=>b.points-a.points);
  topDiv.innerHTML='';
  memberPoints.slice(0,10).forEach((m,i)=>{ topDiv.innerHTML+=`<p>${i+1} - ${m.name} : ${m.points} نقاط</p>`; });
}

loadData();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
