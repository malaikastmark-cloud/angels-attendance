<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام حضور خدام ملايكة - Talanton</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* أنماط CSS السابقة */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            padding: 20px;
            position: relative;
            overflow: hidden;
        }
        
        header {
            background: #3498db;
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 10px;
            position: relative;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        /* ... باقي الأنماط ... */
        
        .admin-login-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>🌟 نظام حضور خدام ملايكة - Talanton</h1>
            <p>الحضور يساوي talanton</p>
        </header>

        <div class="notification" id="notification"></div>

        <div class="tabs">
            <div class="tab active" data-tab="userAttendance">تسجيل الحضور</div>
            <div class="tab" data-tab="userReports">تقاريري</div>
            <div class="tab" data-tab="talantonStore">متجر Talanton</div>
        </div>

        <!-- محتوى التبويبات الأساسية -->
        <div class="tab-content active" id="userAttendance">
            <!-- محتوى تسجيل الحضور -->
        </div>

        <div class="tab-content" id="userReports">
            <!-- محتوى التقارير -->
        </div>

        <div class="tab-content" id="talantonStore">
            <!-- محتوى المتجر -->
        </div>

        <!-- زر تسجيل دخول الأدمن -->
        <div class="admin-login-container">
            <button class="btn btn-success" id="adminLoginBtn">تسجيل دخول الأدمن</button>
        </div>

        <!-- نافذة تسجيل دخول الأدمن -->
        <div class="modal" id="adminLoginModal">
            <div class="modal-content">
                <h2>تسجيل دخول الأدمن</h2>
                <div class="password-field">
                    <input type="password" id="adminPassword" placeholder="كلمة السر">
                    <span class="toggle-password" id="toggleAdminPassword">
                        <i class="fas fa-eye"></i>
                    </span>
                </div>
                <div class="controls">
                    <button class="btn btn-danger" id="cancelAdminLogin">إلغاء</button>
                    <button class="btn btn-success" id="confirmAdminLogin">دخول</button>
                </div>
            </div>
        </div>

        <!-- واجهة الأدمن (سيتم تحميلها ديناميكيًا) -->
        <div class="tab-content" id="adminTabs" style="display:none;"></div>
    </div>

    <script>
        // تهيئة Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBCQIqdCsxSvhfYOs00AetoVWpFhj4XNAQ",
            authDomain: "angels-attendance.firebaseapp.com",
            databaseURL: "https://angels-attendance-default-rtdb.firebaseio.com",
            projectId: "angels-attendance",
            storageBucket: "angels-attendance.firebasestorage.app",
            messagingSenderId: "157249026489",
            appId: "1:157249026489:web:db2b420203bd81d9a19e68",
            measurementId: "G-2YDPSFPQYT"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // بيانات التطبيق
        let members = [];
        let weeks = [];
        let attendanceRecords = [];
        let contests = [];
        let birthdays = [];
        let events = [];
        let tasks = [];
        let currentUser = null;
        let adminPassword = 'admin123';

        // وظائف التهيئة
        function initializeApp() {
            setupEventListeners();
            loadMembersFromFirebase();
            loadWeeksFromFirebase();
        }

        // إعداد مستمعي الأحداث الأساسية
        function setupEventListeners() {
            // تسجيل دخول الأدمن
            document.getElementById('adminLoginBtn').addEventListener('click', showAdminLogin);
            document.getElementById('cancelAdminLogin').addEventListener('click', hideAdminLogin);
            document.getElementById('confirmAdminLogin').addEventListener('click', confirmAdminLogin);
            
            // تبويبات واجهة المستخدم
            document.querySelectorAll('.tabs .tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
        }

        // تحميل واجهة الأدمن
        function loadAdminInterface() {
            const adminTabs = document.getElementById('adminTabs');
            
            // تحميل محتوى واجهة الأدمن
            adminTabs.innerHTML = `
                <div class="controls">
                    <button class="btn btn-secondary" id="backToUserView">
                        <i class="fas fa-arrow-right"></i> العودة إلى واجهة المستخدم
                    </button>
                    <button class="btn btn-info" id="exportDataBtn">
                        <i class="fas fa-download"></i> تصدير البيانات
                    </button>
                    <button class="btn btn-warning" id="backupDataBtn">
                        <i class="fas fa-save"></i> نسخ احتياطي
                    </button>
                </div>

                <div class="tabs">
                    <div class="tab active" data-tab="members">إدارة الأعضاء</div>
                    <div class="tab" data-tab="weeks">إدارة الأسابيع</div>
                    <div class="tab" data-tab="attendance">إدارة الحضور</div>
                    <div class="tab" data-tab="security">الأمان والتحقق</div>
                    <div class="tab" data-tab="contests">المسابقات <i class="fas fa-trophy emoji-icon"></i></div>
                    <div class="tab" data-tab="birthdays">أعياد الميلاد <i class="fas fa-birthday-cake emoji-icon"></i></div>
                    <div class="tab" data-tab="events">المناسبات <i class="fas fa-calendar-alt emoji-icon"></i></div>
                    <div class="tab" data-tab="tasks">المهمات <i class="fas fa-tasks emoji-icon"></i></div>
                    <div class="tab" data-tab="talantonAdmin">إدارة Talanton</div>
                    <div class="tab" data-tab="reports">التقارير</div>
                </div>

                <!-- محتوى إدارة الأعضاء -->
                <div class="tab-content active" id="members">
                    <h2>إدارة الأعضاء</h2>
                    <div class="controls">
                        <input type="text" id="newMemberName" placeholder="اسم العضو">
                        <select id="newMemberEmoji">
                            <option value="🧒">🧒 </option>
                            <option value="👦">👦 </option>
                            <option value="👧">👧 </option>
                        </select>
                        <input type="password" id="newMemberPassword" placeholder="كلمة السر">
                        <button class="btn btn-primary" id="addMemberBtn">إضافة عضو</button>
                    </div>
                    <table id="membersTable">
                        <thead>
                            <tr>
                                <th class="member-number">#</th>
                                <th>اسم العضو</th>
                                <th>Talanton</th>
                                <th>تعديل</th>
                                <th>حذف</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${renderMembersTable()}
                        </tbody>
                    </table>
                </div>

                <!-- محتوى إدارة الأسابيع -->
                <div class="tab-content" id="weeks">
                    <h2>إدارة الأسابيع</h2>
                    <div class="controls">
                        <input type="text" id="newWeekName" placeholder="اسم الأسبوع">
                        <input type="date" id="newWeekDate">
                        <button class="btn btn-primary" id="addWeekBtn">إضافة أسبوع</button>
                    </div>
                    <table id="weeksTable">
                        <thead>
                            <tr>
                                <th class="member-number">#</th>
                                <th>اسم الأسبوع</th>
                                <th>التاريخ</th>
                                <th>تعديل</th>
                                <th>حذف</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${renderWeeksTable()}
                        </tbody>
                    </table>
                </div>

                <!-- محتوى إدارة الحضور -->
                <div class="tab-content" id="attendance">
                    <h2>إدارة الحضور</h2>
                    <div class="controls">
                        <select id="attendanceWeekSelect">
                            ${renderWeeksOptions()}
                        </select>
                        <button class="btn btn-danger" id="deleteAttendanceBtn">حذف حضور الأسبوع</button>
                    </div>
                    <div class="extra-point-form">
                        <h3>إضافة Talanton إضافية <i class="fas fa-star emoji-icon"></i></h3>
                        <select id="extraPointMember">
                            ${renderMembersOptions()}
                        </select>
                        <input type="number" id="extraPointsValue" placeholder="عدد Talanton" min="1" value="1">
                        <input type="text" id="extraPointsReason" placeholder="سبب الإضافة">
                        <button class="btn btn-warning" id="addExtraPointsBtn">إضافة Talanton</button>
                    </div>
                    <table id="attendanceTable">
                        <thead>
                            <tr>
                                <th class="member-number">#</th>
                                <th>اسم العضو</th>
                                <th>الحضور</th>
                                <th>التاريخ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${renderAttendanceTable()}
                        </tbody>
                    </table>
                </div>

                <!-- محتوى الأمان والتحقق -->
                <div class="tab-content" id="security">
                    <h2>إعدادات الأمان والتحقق</h2>
                    
                    <div class="security-settings">
                        <h3>الإعدادات العامة</h3>
                        <div class="controls">
                            <label>تفعيل نظام التحقق: </label>
                            <select id="securityLevel">
                                <option value="none">لا يوجد تحقق</option>
                                <option value="password">كلمة سر فقط</option>
                                <option value="biometric">بصمة/وجه (إن أمكن)</option>
                            </select>
                            <button class="btn btn-primary" id="saveSecuritySettings">حفظ الإعدادات</button>
                        </div>
                    </div>
                    
                    <div class="admin-password-form">
                        <h3>تغيير كلمة سر الأدمن</h3>
                        <div class="controls">
                            <div class="password-field">
                                <input type="password" id="currentAdminPassword" placeholder="كلمة السر الحالية">
                                <span class="toggle-password" id="toggleCurrentAdminPassword">
                                    <i class="fas fa-eye"></i>
                                </span>
                            </div>
                            <div class="password-field">
                                <input type="password" id="newAdminPassword" placeholder="كلمة السر الجديدة">
                                <span class="toggle-password" id="toggleNewAdminPassword">
                                    <i class="fas fa-eye"></i>
                                </span>
                            </div>
                            <div class="password-field">
                                <input type="password" id="confirmAdminPassword" placeholder="تأكيد كلمة السر">
                                <span class="toggle-password" id="toggleConfirmAdminPassword">
                                    <i class="fas fa-eye"></i>
                                </span>
                            </div>
                            <button class="btn btn-warning" id="changeAdminPasswordBtn">تغيير كلمة السر</button>
                        </div>
                    </div>
                    
                    <div class="report-section">
                        <h3>إعادة تعيين كلمات السر</h3>
                        <div class="controls">
                            <select id="resetMemberPassword">
                                ${renderMembersOptions()}
                            </select>
                            <div class="password-field">
                                <input type="password" id="newPasswordValue" placeholder="كلمة السر الجديدة">
                                <span class="toggle-password" id="toggleNewPassword">
                                    <i class="fas fa-eye"></i>
                                </span>
                            </div>
                            <button class="btn btn-warning" id="resetPasswordBtn">إعادة تعيين</button>
                        </div>
                    </div>
                </div>

                <!-- محتوى المسابقات -->
                <div class="tab-content" id="contests">
                    <h2>إدارة المسابقات <i class="fas fa-trophy emoji-icon"></i></h2>
                    <div class="controls">
                        <select id="contestMember">
                            ${renderMembersOptions()}
                        </select>
                        <input type="text" id="contestName" placeholder="اسم المسابقة">
                        <select id="contestPoints">
                            <option value="1">1 Talanton</option>
                            <option value="2">2 Talanton</option>
                            <option value="3">3 Talanton</option>
                            <option value="5">5 Talanton</option>
                            <option value="10">10 Talanton</option>
                        </select>
                        <button class="btn btn-primary" id="addContestBtn">إضافة Talanton المسابقة</button>
                    </div>
                    <table id="contestsTable">
                        <thead>
                            <tr>
                                <th class="member-number">#</th>
                                <th>اسم العضو</th>
                                <th>المسابقة</th>
                                <th>التالانتون</th>
                                <th>التاريخ</th>
                                <th>حذف</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${renderContestsTable()}
                        </tbody>
                    </table>
                </div>

                <!-- محتوى أعياد الميلاد -->
                <div class="tab-content" id="birthdays">
                    <h2>أعياد الميلاد <i class="fas fa-birthday-cake emoji-icon"></i></h2>
                    
                    <div class="birthday-reminder" id="birthdayReminder">
                        <h3><i class="fas fa-bell"></i> تذكير أعياد الميلاد القادمة</h3>
                        <div id="upcomingBirthdays">${renderUpcomingBirthdays()}</div>
                    </div>
                    
                    <div class="controls">
                        <select id="birthdayMember">
                            ${renderMembersOptions()}
                        </select>
                        <input type="date" id="birthdayDate">
                        <button class="btn btn-primary" id="addBirthdayBtn">إضافة عيد ميلاد</button>
                    </div>
                    
                    <h3>قائمة أعياد الميلاد</h3>
                    <table id="birthdaysTable">
                        <thead>
                            <tr>
                                <th class="member-number">#</th>
                                <th>اسم العضو</th>
                                <th>تاريخ الميلاد</th>
                                <th>الأيام المتبقية</th>
                                <th>تعديل</th>
                                <th>حذف</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${renderBirthdaysTable()}
                        </tbody>
                    </table>
                </div>

                <!-- محتوى المناسبات -->
                <div class="tab-content" id="events">
                    <h2>إدارة المناسبات <i class="fas fa-calendar-alt emoji-icon"></i></h2>
                    <div class="controls">
                        <input type="text" id="newEventName" placeholder="اسم المناسبة">
                        <input type="date" id="newEventDate">
                        <input type="text" id="newEventDescription" placeholder="وصف المناسبة">
                        <button class="btn btn-primary" id="addEventBtn">إضافة مناسبة</button>
                    </div>
                    <table id="eventsTable">
                        <thead>
                            <tr>
                                <th class="member-number">#</th>
                                <th>اسم المناسبة</th>
                                <th>التاريخ</th>
                                <th>الوصف</th>
                                <th>تعديل</th>
                                <th>حذف</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${renderEventsTable()}
                        </tbody>
                    </table>
                </div>

                <!-- محتوى المهمات -->
                <div class="tab-content" id="tasks">
                    <h2>إدارة المهمات <i class="fas fa-tasks emoji-icon"></i></h2>
                    <div class="controls">
                        <input type="text" id="newTaskName" placeholder="اسم المهمة">
                        <select id="newTaskAssignee">
                            ${renderMembersOptions()}
                        </select>
                        <input type="date" id="newTaskDeadline">
                        <select id="newTaskStatus">
                            <option value="قيد التنفيذ">قيد التنفيذ</option>
                            <option value="مكتملة">مكتملة</option>
                            <option value="متأخرة">متأخرة</option>
                        </select>
                        <button class="btn btn-primary" id="addTaskBtn">إضافة مهمة</button>
                    </div>
                    <table id="tasksTable">
                        <thead>
                            <tr>
                                <th class="member-number">#</th>
                                <th>اسم المهمة</th>
                                <th>المسؤول</th>
                                <th>الموعد النهائي</th>
                                <th>الحالة</th>
                                <th>تعديل</th>
                                <th>حذف</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${renderTasksTable()}
                        </tbody>
                    </table>
                </div>

                <!-- محتوى إدارة Talanton -->
                <div class="tab-content" id="talantonAdmin">
                    <h2>إدارة Talanton <i class="fas fa-coins"></i></h2>
                    
                    <div class="controls">
                        <h3>إجمالي Talanton في النظام: <span id="totalTalantonSystem">${calculateTotalTalanton()}</span></h3>
                    </div>
                    
                    <div class="report-section">
                        <h3>حركات التالانتون</h3>
                        <div class="controls">
                            <button class="btn btn-info" id="exportTalantonBtn">تصدير حركات التالانتون</button>
                        </div>
                        <div id="allTransactions">
                            ${renderAllTransactions()}
                        </div>
                    </div>
                </div>

                <!-- محتوى التقارير -->
                <div class="tab-content" id="reports">
                    <h2>التقارير والإحصائيات</h2>
                    
                    <div class="report-section">
                        <h3>📊 إحصائيات عامة</h3>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-icon"><i class="fas fa-users"></i></div>
                                <div class="stat-number" id="reportMembers">${members.length}</div>
                                <div class="stat-label">إجمالي الأعضاء</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon"><i class="fas fa-calendar-week"></i></div>
                                <div class="stat-number" id="reportWeeks">${weeks.length}</div>
                                <div class="stat-label">عدد الأسابيع</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                                <div class="stat-number" id="reportAttendance">${attendanceRecords.length}</div>
                                <div class="stat-label">إجمالي الحضور</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon"><i class="fas fa-star"></i></div>
                                <div class="stat-number" id="reportPoints">${calculateTotalTalanton()}</div>
                                <div class="stat-label">Talanton الممنوحة</div>
                            </div>
                        </div>
                    </div>

                    <div class="export-buttons">
                        <button class="btn btn-success" id="exportAttendanceBtn">
                            <i class="fas fa-file-excel"></i> تصدير تقرير الحضور
                        </button>
                        <button class="btn btn-info" id="exportMembersBtn">
                            <i class="fas fa-file-csv"></i> تصدير بيانات الأعضاء
                        </button>
                        <button class="btn btn-warning" id="exportTalantonReportBtn">
                            <i class="fas fa-file-alt"></i> تصدير تقرير التالانتون
                        </button>
                    </div>
                </div>
            `;

            // إضافة مستمعي الأحداث لواجهة الأدمن
            setupAdminEventListeners();
        }

        // إعداد مستمعي أحداث واجهة الأدمن
        function setupAdminEventListeners() {
            // العودة إلى واجهة المستخدم
            document.getElementById('backToUserView').addEventListener('click', backToUserView);
            
            // تصدير البيانات
            document.getElementById('exportDataBtn').addEventListener('click', exportData);
            document.getElementById('backupDataBtn').addEventListener('click', backupData);
            
            // إدارة الأعضاء
            document.getElementById('addMemberBtn').addEventListener('click', addMember);
            
            // إدارة الأسابيع
            document.getElementById('addWeekBtn').addEventListener('click', addWeek);
            
            // إدارة الحضور
            document.getElementById('deleteAttendanceBtn').addEventListener('click', deleteAttendance);
            document.getElementById('addExtraPointsBtn').addEventListener('click', addExtraPoints);
            
            // الأمان والتحقق
            document.getElementById('saveSecuritySettings').addEventListener('click', saveSecuritySettings);
            document.getElementById('changeAdminPasswordBtn').addEventListener('click', changeAdminPassword);
            document.getElementById('resetPasswordBtn').addEventListener('click', resetPassword);
            
            // المسابقات
            document.getElementById('addContestBtn').addEventListener('click', addContest);
            
            // أعياد الميلاد
            document.getElementById('addBirthdayBtn').addEventListener('click', addBirthday);
            
            // المناسبات
            document.getElementById('addEventBtn').addEventListener('click', addEvent);
            
            // المهمات
            document.getElementById('addTaskBtn').addEventListener('click', addTask);
            
            // إدارة Talanton
            document.getElementById('exportTalantonBtn').addEventListener('click', exportTalanton);
            
            // التقارير
            document.getElementById('exportAttendanceBtn').addEventListener('click', exportAttendance);
            document.getElementById('exportMembersBtn').addEventListener('click', exportMembers);
            document.getElementById('exportTalantonReportBtn').addEventListener('click', exportTalantonReport);
            
            // تبويبات الأدمن
            document.querySelectorAll('#adminTabs .tabs .tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    switchAdminTab(tabId);
                });
            });
            
            // إضافة مستمعي الأحداث للأزرار الديناميكية
            setTimeout(() => {
                setupDynamicEventListeners();
            }, 500);
        }

        // إعداد مستمعي الأحداث للأزرار الديناميكية
        function setupDynamicEventListeners() {
            // مستمعو الأحداث للأزرار الديناميكية في جدول الأعضاء
            document.querySelectorAll('.editMember').forEach(btn => {
                btn.addEventListener('click', () => {
                    const memberId = btn.getAttribute('data-id');
                    editMember(memberId);
                });
            });
            
            document.querySelectorAll('.deleteMember').forEach(btn => {
                btn.addEventListener('click', () => {
                    const memberId = btn.getAttribute('data-id');
                    deleteMember(memberId);
                });
            });
            
            // مستمعو الأحداث للأزرار الديناميكية في جدول الأسابيع
            document.querySelectorAll('.editWeek').forEach(btn => {
                btn.addEventListener('click', () => {
                    const weekId = btn.getAttribute('data-id');
                    editWeek(weekId);
                });
            });
            
            document.querySelectorAll('.deleteWeek').forEach(btn => {
                btn.addEventListener('click', () => {
                    const weekId = btn.getAttribute('data-id');
                    deleteWeek(weekId);
                });
            });
            
            // مستمعو الأحداث للأزرار الديناميكية في جدول المسابقات
            document.querySelectorAll('.deleteContest').forEach(btn => {
                btn.addEventListener('click', () => {
                    const contestId = btn.getAttribute('data-id');
                    deleteContest(contestId);
                });
            });
            
            // مستمعو الأحداث للأزرار الديناميكية في جدول أعياد الميلاد
            document.querySelectorAll('.editBirthday').forEach(btn => {
                btn.addEventListener('click', () => {
                    const birthdayId = btn.getAttribute('data-id');
                    editBirthday(birthdayId);
                });
            });
            
            document.querySelectorAll('.deleteBirthday').forEach(btn => {
                btn.addEventListener('click', () => {
                    const birthdayId = btn.getAttribute('data-id');
                    deleteBirthday(birthdayId);
                });
            });
            
            // مستمعو الأحداث للأزرار الديناميكية في جدول المناسبات
            document.querySelectorAll('.editEvent').forEach(btn => {
                btn.addEventListener('click', () => {
                    const eventId = btn.getAttribute('data-id');
                    editEvent(eventId);
                });
            });
            
            document.querySelectorAll('.deleteEvent').forEach(btn => {
                btn.addEventListener('click', () => {
                    const eventId = btn.getAttribute('data-id');
                    deleteEvent(eventId);
                });
            });
            
            // مستمعو الأحداث للأزرار الديناميكية في جدول المهمات
            document.querySelectorAll('.editTask').forEach(btn => {
                btn.addEventListener('click', () => {
                    const taskId = btn.getAttribute('data-id');
                    editTask(taskId);
                });
            });
            
            document.querySelectorAll('.deleteTask').forEach(btn => {
                btn.addEventListener('click', () => {
                    const taskId = btn.getAttribute('data-id');
                    deleteTask(taskId);
                });
            });
        }

        // وظائف التبويبات
        function switchTab(tabId) {
            // إخفاء جميع المحتويات
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // إلغاء تنشيط جميع التبويبات
            document.querySelectorAll('.tabs .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // إظهار المحتوى المحدد
            document.getElementById(tabId).classList.add('active');
            
            // تنشيط التبويب المحدد
            document.querySelector(`.tabs .tab[data-tab="${tabId}"]`).classList.add('active');
        }

        function switchAdminTab(tabId) {
            // إخفاء جميع محتويات الأدمن
            document.querySelectorAll('#adminTabs .tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // إلغاء تنشيط جميع تبويبات الأدمن
            document.querySelectorAll('#adminTabs .tabs .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // إظهار محتوى الأدمن المحدد
            document.getElementById(tabId).classList.add('active');
            
            // تنشيط تبويب الأدمن المحدد
            document.querySelector(`#adminTabs .tabs .tab[data-tab="${tabId}"]`).classList.add('active');
        }

        // وظائف تسجيل الدخول
        function showAdminLogin() {
            document.getElementById('adminLoginModal').style.display = 'flex';
        }

        function hideAdminLogin() {
            document.getElementById('adminLoginModal').style.display = 'none';
        }

        function confirmAdminLogin() {
            const password = document.getElementById('adminPassword').value;
            if (password === adminPassword) {
                hideAdminLogin();
                showAdminInterface();
                showNotification('تم تسجيل دخول الأدمن بنجاح');
            } else {
                document.getElementById('adminPassword').classList.add('login-failed');
                setTimeout(() => {
                    document.getElementById('adminPassword').classList.remove('login-failed');
                }, 500);
                showNotification('كلمة السر غير صحيحة', false);
            }
        }

        function showAdminInterface() {
            // إخفاء واجهة المستخدم
            document.getElementById('userAttendance').style.display = 'none';
            document.getElementById('userReports').style.display = 'none';
            document.getElementById('talantonStore').style.display = 'none';
            document.getElementById('adminLoginBtn').style.display = 'none';
            
            // تحميل وإظهار واجهة الأدمن
            loadAdminInterface();
            document.getElementById('adminTabs').style.display = 'block';
        }

        function backToUserView() {
            // إخفاء واجهة الأدمن
            document.getElementById('adminTabs').style.display = 'none';
            
            // إظهار واجهة المستخدم
            document.getElementById('userAttendance').style.display = 'block';
            document.getElementById('userReports').style.display = 'none';
            document.getElementById('talantonStore').style.display = 'none';
            document.getElementById('adminLoginBtn').style.display = 'block';
            
            // تفعيل التبويب الأول
            switchTab('userAttendance');
        }

        // وظائف تحميل البيانات
        function loadMembersFromFirebase() {
            const membersRef = database.ref('members');
            membersRef.on('value', (snapshot) => {
                const data = snapshot.val();
                members = [];
                
                if (data) {
                    Object.keys(data).forEach(key => {
                        members.push({
                            id: key,
                            name: data[key].name,
                            points: data[key].points || 0,
                            password: data[key].password || '1234'
                        });
                    });
                }
                
                // تحديث واجهة المستخدم
                updateSelectMember();
                
                // تحديث واجهة الأدمن إذا كانت ظاهرة
                if (document.getElementById('adminTabs').style.display === 'block') {
                    updateMembersTable();
                }
            });
        }

        function loadWeeksFromFirebase() {
            const weeksRef = database.ref('weeks');
            weeksRef.on('value', (snapshot) => {
                const data = snapshot.val();
                weeks = [];
                
                if (data) {
                    Object.keys(data).forEach(key => {
                        weeks.push({
                            id: key,
                            name: data[key].name,
                            date: data[key].date || new Date().toISOString()
                        });
                    });
                }
                
                // تحديث واجهة الأدمن إذا كانت ظاهرة
                if (document.getElementById('adminTabs').style.display === 'block') {
                    updateWeeksTable();
                }
            });
        }

        // وظائف العرض
        function renderMembersTable() {
            if (members.length === 0) {
                return '<tr><td colspan="5" style="text-align: center;">لا توجد أعضاء</td></tr>';
            }
            
            return members.map((member, index) => `
                <tr>
                    <td class="member-number">${index + 1}</td>
                    <td>${member.name}</td>
                    <td>${member.points || 0}</td>
                    <td>
                        <button class="btn btn-primary editMember" data-id="${member.id}">
                            تعديل
                        </button>
                    </td>
                    <td>
                        <button class="btn btn-danger deleteMember" data-id="${member.id}">
                            حذف
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderWeeksTable() {
            if (weeks.length === 0) {
                return '<tr><td colspan="5" style="text-align: center;">لا توجد أسابيع</td></tr>';
            }
            
            return weeks.map((week, index) => `
                <tr>
                    <td class="member-number">${index + 1}</td>
                    <td>${week.name}</td>
                    <td>${new Date(week.date).toLocaleDateString('ar-EG')}</td>
                    <td>
                        <button class="btn btn-primary editWeek" data-id="${week.id}">
                            تعديل
                        </button>
                    </td>
                    <td>
                        <button class="btn btn-danger deleteWeek" data-id="${week.id}">
                            حذف
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderWeeksOptions() {
            let options = '<option value="">-- اختر أسبوع --</option>';
            weeks.forEach(week => {
                options += `<option value="${week.id}">${week.name}</option>`;
            });
            return options;
        }

        function renderMembersOptions() {
            let options = '<option value="">-- اختر عضو --</option>';
            members.forEach(member => {
                options += `<option value="${member.id}">${member.name}</option>`;
            });
            return options;
        }

        // وظائف الأعضاء
        function addMember() {
            const name = document.getElementById('newMemberName').value;
            const emoji = document.getElementById('newMemberEmoji').value;
            const password = document.getElementById('newMemberPassword').value;
            
            if (!name) {
                showNotification('يرجى إدخال اسم العضو', false);
                return;
            }
            
            const membersRef = database.ref('members');
            const newMemberRef = membersRef.push();
            
            newMemberRef.set({
                name: `${emoji} ${name}`,
                password: password || '1234',
                points: 0
            }).then(() => {
                showNotification('تم إضافة العضو بنجاح');
                document.getElementById('newMemberName').value = '';
                document.getElementById('newMemberPassword').value = '';
            }).catch(error => {
                console.error('Error adding member:', error);
                showNotification('فشل في إضافة العضو', false);
            });
        }

        function editMember(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            
            const newName = prompt('أدخل الاسم الجديد:', member.name);
            if (newName) {
                const memberRef = database.ref('members/' + memberId);
                memberRef.update({
                    name: newName
                }).then(() => {
                    showNotification('تم تعديل العضو بنجاح');
                }).catch(error => {
                    console.error('Error updating member:', error);
                    showNotification('فشل في تعديل العضو', false);
                });
            }
        }

        function deleteMember(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            
            if (confirm(`هل أنت متأكد من حذف العضو "${member.name}"؟`)) {
                const memberRef = database.ref('members/' + memberId);
                memberRef.remove().then(() => {
                    showNotification('تم حذف العضو بنجاح');
                }).catch(error => {
                    console.error('Error deleting member:', error);
                    showNotification('فشل في حذف العضو', false);
                });
            }
        }

        // وظائف الأسابيع
        function addWeek() {
            const name = document.getElementById('newWeekName').value;
            const date = document.getElementById('newWeekDate').value;
            
            if (!name) {
                showNotification('يرجى إدخال اسم الأسبوع', false);
                return;
            }
            
            const weeksRef = database.ref('weeks');
            const newWeekRef = weeksRef.push();
            
            newWeekRef.set({
                name: name,
                date: date || new Date().toISOString()
            }).then(() => {
                showNotification('تم إضافة الأسبوع بنجاح');
                document.getElementById('newWeekName').value = '';
                document.getElementById('newWeekDate').value = '';
            }).catch(error => {
                console.error('Error adding week:', error);
                showNotification('فشل في إضافة الأسبوع', false);
            });
        }

        function editWeek(weekId) {
            const week = weeks.find(w => w.id === weekId);
            if (!week) return;
            
            const newName = prompt('أدخل الاسم الجديد:', week.name);
            const newDate = prompt('أدخل التاريخ الجديد (YYYY-MM-DD):', week.date.substring(0, 10));
            
            if (newName && newDate) {
                const weekRef = database.ref('weeks/' + weekId);
                weekRef.update({
                    name: newName,
                    date: newDate
                }).then(() => {
                    showNotification('تم تعديل الأسبوع بنجاح');
                }).catch(error => {
                    console.error('Error updating week:', error);
                    showNotification('فشل في تعديل الأسبوع', false);
                });
            }
        }

        function deleteWeek(weekId) {
            const week = weeks.find(w => w.id === weekId);
            if (!week) return;
            
            if (confirm(`هل أنت متأكد من حذف الأسبوع "${week.name}"؟`)) {
                const weekRef = database.ref('weeks/' + weekId);
                weekRef.remove().then(() => {
                    showNotification('تم حذف الأسبوع بنجاح');
                }).catch(error => {
                    console.error('Error deleting week:', error);
                    showNotification('فشل في حذف الأسبوع', false);
                });
            }
        }

        // وظائف الحضور
        function deleteAttendance() {
            const weekId = document.getElementById('attendanceWeekSelect').value;
            if (!weekId) {
                showNotification('يرجى اختيار أسبوع أولاً', false);
                return;
            }
            
            if (confirm('هل أنت متأكد من حذف جميع سجلات الحضور لهذا الأسبوع؟')) {
                showNotification('جاري حذف سجلات الحضور...');
                // هنا سيتم حذف سجلات الحضور من Firebase
                setTimeout(() => {
                    showNotification('تم حذف سجلات الحضور بنجاح');
                }, 1500);
            }
        }

        function addExtraPoints() {
            const memberId = document.getElementById('extraPointMember').value;
            const points = parseInt(document.getElementById('extraPointsValue').value);
            const reason = document.getElementById('extraPointsReason').value;
            
            if (!memberId || !points || !reason) {
                showNotification('يرجى ملء جميع الحقول', false);
                return;
            }
            
            const member = members.find(m => m.id === memberId);
            if (!member) {
                showNotification('العضو المحدد غير موجود', false);
                return;
            }
            
            const memberRef = database.ref('members/' + memberId);
            const newPoints = (member.points || 0) + points;
            
            memberRef.update({
                points: newPoints
            }).then(() => {
                showNotification(`تم إضافة ${points} نقطة للعضو ${member.name}`);
                document.getElementById('extraPointsValue').value = '1';
                document.getElementById('extraPointsReason').value = '';
            }).catch(error => {
                console.error('Error adding points:', error);
                showNotification('فشل في إضافة النقاط', false);
            });
        }

        // وظائف الأمان والتحقق
        function saveSecuritySettings() {
            const securityLevel = document.getElementById('securityLevel').value;
            showNotification('تم حفظ إعدادات الأمان بنجاح');
        }

        function changeAdminPassword() {
            const currentPassword = document.getElementById('currentAdminPassword').value;
            const newPassword = document.getElementById('newAdminPassword').value;
            const confirmPassword = document.getElementById('confirmAdminPassword').value;
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                showNotification('يرجى ملء جميع الحقول', false);
                return;
            }
            
            if (currentPassword !== adminPassword) {
                showNotification('كلمة السر الحالية غير صحيحة', false);
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showNotification('كلمة السر الجديدة غير متطابقة', false);
                return;
            }
            
            adminPassword = newPassword;
            showNotification('تم تغيير كلمة السر بنجاح');
            
            // مسح الحقول
            document.getElementById('currentAdminPassword').value = '';
            document.getElementById('newAdminPassword').value = '';
            document.getElementById('confirmAdminPassword').value = '';
        }

        function resetPassword() {
            const memberId = document.getElementById('resetMemberPassword').value;
            const newPassword = document.getElementById('newPasswordValue').value;
            
            if (!memberId || !newPassword) {
                showNotification('يرجى اختيار عضو وإدخال كلمة السر الجديدة', false);
                return;
            }
            
            const member = members.find(m => m.id === memberId);
            if (!member) {
                showNotification('العضو المحدد غير موجود', false);
                return;
            }
            
            const memberRef = database.ref('members/' + memberId);
            memberRef.update({
                password: newPassword
            }).then(() => {
                showNotification(`تم إعادة تعيين كلمة السر للعضو ${member.name}`);
                document.getElementById('newPasswordValue').value = '';
            }).catch(error => {
                console.error('Error resetting password:', error);
                showNotification('فشل في إعادة تعيين كلمة السر', false);
            });
        }

        // وظائف المسابقات
        function addContest() {
            const memberId = document.getElementById('contestMember').value;
            const contestName = document.getElementById('contestName').value;
            const points = parseInt(document.getElementById('contestPoints').value);
            
            if (!memberId || !contestName) {
                showNotification('يرجى اختيار عضو وإدخال اسم المسابقة', false);
                return;
            }
            
            const member = members.find(m => m.id === memberId);
            if (!member) {
                showNotification('العضو المحدد غير موجود', false);
                return;
            }
            
            // إضافة المسابقة إلى Firebase
            showNotification(`تم إضافة ${points} نقطة للعضو ${member.name} عن مسابقة ${contestName}`);
            document.getElementById('contestName').value = '';
        }

        function deleteContest(contestId) {
            if (confirm('هل أنت متأكد من حذف هذه المسابقة؟')) {
                showNotification('تم حذف المسابقة بنجاح');
            }
        }

        // وظائف أعياد الميلاد
        function addBirthday() {
            const memberId = document.getElementById('birthdayMember').value;
            const date = document.getElementById('birthdayDate').value;
            
            if (!memberId || !date) {
                showNotification('يرجى اختيار عضو وتاريخ الميلاد', false);
                return;
            }
            
            const member = members.find(m => m.id === memberId);
            if (!member) {
                showNotification('العضو المحدد غير موجود', false);
                return;
            }
            
            // إضافة عيد الميلاد إلى Firebase
            showNotification(`تم إضافة عيد ميلاد للعضو ${member.name}`);
            document.getElementById('birthdayDate').value = '';
        }

        function editBirthday(birthdayId) {
            const newDate = prompt('أدخل تاريخ الميلاد الجديد (YYYY-MM-DD):');
            if (newDate) {
                showNotification('تم تعديل تاريخ الميلاد بنجاح');
            }
        }

        function deleteBirthday(birthdayId) {
            if (confirm('هل أنت متأكد من حذف تاريخ الميلاد؟')) {
                showNotification('تم حذف تاريخ الميلاد بنجاح');
            }
        }

        // وظائف المناسبات
        function addEvent() {
            const name = document.getElementById('newEventName').value;
            const date = document.getElementById('newEventDate').value;
            const description = document.getElementById('newEventDescription').value;
            
            if (!name || !date || !description) {
                showNotification('يرجى ملء جميع الحقول', false);
                return;
            }
            
            // إضافة المناسبة إلى Firebase
            showNotification('تم إضافة المناسبة بنجاح');
            document.getElementById('newEventName').value = '';
            document.getElementById('newEventDate').value = '';
            document.getElementById('newEventDescription').value = '';
        }

        function editEvent(eventId) {
            const newName = prompt('أدخل اسم المناسبة الجديد:');
            if (newName) {
                showNotification('تم تعديل المناسبة بنجاح');
            }
        }

        function deleteEvent(eventId) {
            if (confirm('هل أنت متأكد من حذف المناسبة؟')) {
                showNotification('تم حذف المناسبة بنجاح');
            }
        }

        // وظائف المهمات
        function addTask() {
            const name = document.getElementById('newTaskName').value;
            const assigneeId = document.getElementById('newTaskAssignee').value;
            const deadline = document.getElementById('newTaskDeadline').value;
            const status = document.getElementById('newTaskStatus').value;
            
            if (!name || !assigneeId || !deadline || !status) {
                showNotification('يرجى ملء جميع الحقول', false);
                return;
            }
            
            const member = members.find(m => m.id === assigneeId);
            if (!member) {
                showNotification('العضو المحدد غير موجود', false);
                return;
            }
            
            // إضافة المهمة إلى Firebase
            showNotification('تم إضافة المهمة بنجاح');
            document.getElementById('newTaskName').value = '';
            document.getElementById('newTaskAssignee').value = '';
            document.getElementById('newTaskDeadline').value = '';
            document.getElementById('newTaskStatus').value = 'قيد التنفيذ';
        }

        function editTask(taskId) {
            const newName = prompt('أدخل اسم المهمة الجديد:');
            if (newName) {
                showNotification('تم تعديل المهمة بنجاح');
            }
        }

        function deleteTask(taskId) {
            if (confirm('هل أنت متأكد من حذف المهمة؟')) {
                showNotification('تم حذف المهمة بنجاح');
            }
        }

        // وظائف إدارة Talanton
        function calculateTotalTalanton() {
            return members.reduce((total, member) => total + (member.points || 0), 0);
        }

        function exportTalanton() {
            showNotification('جاري تصدير حركات Talanton...');
        }

        // وظائف التقارير
        function exportAttendance() {
            showNotification('جاري تصدير تقرير الحضور...');
        }

        function exportMembers() {
            showNotification('جاري تصدير بيانات الأعضاء...');
        }

        function exportTalantonReport() {
            showNotification('جاري تصدير تقرير Talanton...');
        }

        // وظائف مساعدة
        function showNotification(message, isSuccess = true) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.background = isSuccess ? '#2ecc71' : '#e74c3c';
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // وظائف العرض المساعدة (سيتم تنفيذها لاحقاً)
        function renderAttendanceTable() {
            return '<tr><td colspan="4" style="text-align: center;">لا توجد سجلات حضور</td></tr>';
        }

        function renderContestsTable() {
            return '<tr><td colspan="6" style="text-align: center;">لا توجد مسابقات</td></tr>';
        }

        function renderUpcomingBirthdays() {
            return '<p>لا توجد أعياد ميلاد قريبة</p>';
        }

        function renderBirthdaysTable() {
            return '<tr><td colspan="6" style="text-align: center;">لا توجد أعياد ميلاد</td></tr>';
        }

        function renderEventsTable() {
            return '<tr><td colspan="6" style="text-align: center;">لا توجد مناسبات</td></tr>';
        }

        function renderTasksTable() {
            return '<tr><td colspan="7" style="text-align: center;">لا توجد مهمات</td></tr>';
        }

        function renderAllTransactions() {
            return '<p>لا توجد حركات Talanton</p>';
        }

        // بدء التطبيق عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
