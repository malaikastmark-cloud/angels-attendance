<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Talanton - النظام الإداري</title>
<style>
body {
  font-family: Arial, sans-serif;
  background-color: #121212;
  color: #f0f0f0;
  margin: 0;
}
.container {
  max-width: 500px;
  margin: 50px auto;
  text-align: center;
}
h1 { margin-bottom: 20px; }
select, input, button {
  padding: 10px;
  margin: 8px 0;
  width: 100%;
  border-radius: 6px;
  border: none;
  font-size: 16px;
}
button { background-color: #4CAF50; color: white; cursor: pointer; }
button:hover { background-color: #45a049; }
.msg { margin-top: 10px; font-weight: bold; }

/* Sidebar للأدمن */
.sidebar {
  width: 220px;
  background-color: #1e1e1e;
  height: 100vh;
  position: fixed;
  top: 0;
  left: 0;
  padding-top: 20px;
  display: none;
}
.sidebar button {
  width: 100%;
  padding: 12px;
  margin: 5px 0;
  border: none;
  border-radius: 6px;
  background-color: #2c2c2c;
  color: #f0f0f0;
  cursor: pointer;
  text-align: left;
}
.sidebar button:hover { background-color: #4CAF50; }
.main { margin-left: 0; padding: 20px; transition: margin-left 0.3s; }
.section { display: none; }
table { width: 100%; border-collapse: collapse; margin-bottom: 20px; color: #f0f0f0; }
th, td { border: 1px solid #333; padding: 8px; text-align: center; }
th { background-color: #2c2c2c; }
.returnBtn {
  margin-bottom: 20px;
  background-color: #f44336;
}
.returnBtn:hover {
  background-color: #e53935;
}
</style>
</head>
<body>

<!-- ====== الواجهة الرئيسية للخدام ====== -->
<div class="container" id="userInterface">
  <h1>Talanton</h1>
  <h2>تسجيل الحضور</h2>
  <select id="userSelect">
    <option value="">اختر اسمك</option>
  </select>
  <select id="weekSelect">
    <option value="">اختر الأسبوع</option>
    <option value="week1">الأسبوع 1</option>
    <option value="week2">الأسبوع 2</option>
    <option value="week3">الأسبوع 3</option>
    <option value="week4">الأسبوع 4</option>
  </select>
  <button id="submitAttendance">تسجيل حضور</button>
  <div class="msg" id="attendanceMsg"></div>

  <h2>المتجر</h2>
  <div id="storeContainer"></div>

  <h2>التقارير الخاصة بك</h2>
  <div id="reportContainer"></div>

  <button id="adminEntryBtn">دخول الأدمن</button>
</div>

<!-- ====== تسجيل دخول الأدمن ====== -->
<div class="container" id="adminLogin" style="display:none;">
  <h1>تسجيل دخول الأدمن</h1>
  <input type="password" id="adminPassword" placeholder="أدخل كلمة المرور">
  <button id="loginBtn">دخول</button>
  <div class="msg" id="loginMsg"></div>
</div>

<!-- ====== Sidebar للأدمن ====== -->
<div class="sidebar" id="sidebar">
  <button id="returnBtn" class="returnBtn">العودة للصفحة الرئيسية</button>
  <button data-section="membersSection">إدارة الأعضاء</button>
  <button data-section="attendanceSection">إدارة الحضور</button>
  <button data-section="competitionsSection">إدارة المسابقات</button>
  <button data-section="tasksSection">إدارة المهام</button>
  <button data-section="eventsSection">إدارة المناسبات</button>
  <button data-section="birthdaysSection">إدارة أعياد الميلاد</button>
  <button data-section="storeSection">إدارة المتجر</button>
  <button data-section="settingsSection">إدارة Talanton</button>
</div>

<div class="main" id="mainContent">
  <div id="membersSection" class="section"><h1>إدارة الأعضاء</h1></div>
  <div id="attendanceSection" class="section"><h1>إدارة الحضور</h1></div>
  <div id="competitionsSection" class="section"><h1>إدارة المسابقات</h1></div>
  <div id="tasksSection" class="section"><h1>إدارة المهام</h1></div>
  <div id="eventsSection" class="section"><h1>إدارة المناسبات</h1></div>
  <div id="birthdaysSection" class="section"><h1>إدارة أعياد الميلاد</h1></div>
  <div id="storeSection" class="section"><h1>إدارة المتجر</h1></div>
  <div id="settingsSection" class="section"><h1>إدارة Talanton</h1></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, set, get, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBCQIqdCsxSvhfYOs00AetoVWpFhj4XNAQ",
  authDomain: "angels-attendance.firebaseapp.com",
  databaseURL: "https://angels-attendance-default-rtdb.firebaseio.com",
  projectId: "angels-attendance",
  storageBucket: "angels-attendance.firebasestorage.app",
  messagingSenderId: "157249026489",
  appId: "1:157249026489:web:db2b420203bd81d9a19e68",
  measurementId: "G-2YDPSFPQYT"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ====== واجهة الخدام ======
const userInterface = document.getElementById("userInterface");
const userSelect = document.getElementById("userSelect");
const weekSelect = document.getElementById("weekSelect");
const submitAttendance = document.getElementById("submitAttendance");
const attendanceMsg = document.getElementById("attendanceMsg");
const storeContainer = document.getElementById("storeContainer");
const reportContainer = document.getElementById("reportContainer");

// جلب أسماء الخدام
get(ref(db, "users")).then(snapshot => {
  if(snapshot.exists()){
    const users = snapshot.val();
    const sortedKeys = Object.keys(users).sort((a,b)=>{
      return users[a].name.localeCompare(users[b].name);
    });
    sortedKeys.forEach(key=>{
      const option = document.createElement("option");
      option.value = key;
      option.textContent = users[key].name;
      userSelect.appendChild(option);
    });
  }
});

// تسجيل الحضور
submitAttendance.addEventListener("click", () => {
  const userId = userSelect.value;
  const week = weekSelect.value;
  if(!userId || !week){
    attendanceMsg.textContent = "من فضلك اختر اسمك والأسبوع!";
    return;
  }
  const attendanceRef = ref(db, `attendance/${week}/${userId}`);
  get(attendanceRef).then(snapshot => {
    if(snapshot.exists()){
      attendanceMsg.textContent = "لقد تم تسجيل حضورك مسبقاً لهذا الأسبوع.";
    } else {
      set(attendanceRef, true).then(()=>{
        const userPointsRef = ref(db, `users/${userId}/points`);
        get(userPointsRef).then(snap=>{
          const currentPoints = snap.val() || 0;
          update(ref(db, `users/${userId}`), {points: currentPoints + 1});
        });
        attendanceMsg.textContent = "تم تسجيل حضورك بنجاح ✅";
      });
    }
  });
});

// عرض المتجر
get(ref(db,"store")).then(snapshot=>{
  if(snapshot.exists()){
    const gifts = snapshot.val();
    for(const key in gifts){
      const div = document.createElement("div");
      div.style.border="1px solid #444";
      div.style.padding="8px";
      div.style.margin="5px 0";
      div.textContent = `${gifts[key].name} - نقاط: ${gifts[key].pointsRequired}`;
      storeContainer.appendChild(div);
    }
  }
});

// عرض التقارير + نقاط Talanton للخدام
function loadUserReports(){
  const userId = userSelect.value;
  reportContainer.innerHTML = "";
  if(!userId) return;
  get(ref(db, `users/${userId}`)).then(snapshot=>{
    if(snapshot.exists()){
      const data = snapshot.val();
      reportContainer.innerHTML = `<p>نقاطك الحالية: ${data.points || 0}</p>`;
    }
  });
}
userSelect.addEventListener("change", loadUserReports);

// ====== دخول الأدمن ======
const adminEntryBtn = document.getElementById("adminEntryBtn");
const adminLogin = document.getElementById("adminLogin");
const adminPasswordInput = document.getElementById("adminPassword");
const loginBtn = document.getElementById("loginBtn");
const loginMsg = document.getElementById("loginMsg");
const sidebar = document.getElementById("sidebar");
const mainContent = document.getElementById("mainContent");
const returnBtn = document.getElementById("returnBtn");

const ADMIN_PASSWORD = "123456";

adminEntryBtn.addEventListener("click", ()=>{
  userInterface.style.display = "none";
  adminLogin.style.display = "block";
});

loginBtn.addEventListener("click", () => {
  if(adminPasswordInput.value === ADMIN_PASSWORD){
    adminLogin.style.display = "none";
    sidebar.style.display = "block";
    mainContent.style.marginLeft = "220px";
    showSection("membersSection");
  } else {
    loginMsg.textContent = "كلمة المرور غير صحيحة!";
  }
});

// زر العودة للواجهة الرئيسية
returnBtn.addEventListener("click", ()=>{
  sidebar.style.display = "none";
  mainContent.style.marginLeft = "0";
  const sections = document.querySelectorAll(".section");
  sections.forEach(s => s.style.display = "none");
  userInterface.style.display = "block";
});

// ====== التحكم في عرض Sections ======
function showSection(id){
  const sections = document.querySelectorAll(".section");
  sections.forEach(s => s.style.display = "none");
  document.getElementById(id).style.display = "block";
}
sidebar.querySelectorAll("button[data-section]").forEach(btn => {
  btn.addEventListener("click", () => showSection(btn.dataset.section));
});

</script>
</body>
</html>
