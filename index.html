<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Angels Attendance</title>
<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600&display=swap" rel="stylesheet">
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
  body { margin:0; font-family:'Cairo', sans-serif; background: linear-gradient(135deg,#74ebd5,#ACB6E5); color:#333; }
  header { background:#fff; padding:15px 20px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
  header h1 { margin:0; font-size:1.5rem; color:#3498db;}
  header button { padding:8px 15px; background:#3498db; color:#fff; border:none; border-radius:5px; cursor:pointer; transition:0.3s;}
  header button:hover { background:#2980b9;}
  main { padding:20px; display:flex; gap:20px; flex-wrap:wrap; }
  .card { background:#fff; border-radius:10px; padding:15px; flex:1; min-width:250px; box-shadow:0 4px 10px rgba(0,0,0,0.1); transition:0.3s;}
  .card:hover { transform:translateY(-5px);}
  select, input { width:100%; padding:8px; margin-top:5px; margin-bottom:15px; border-radius:5px; border:1px solid #ccc; }
  button.action-btn { width:100%; padding:10px; background:#2ecc71; color:#fff; border:none; border-radius:5px; cursor:pointer; transition:0.3s;}
  button.action-btn:hover { background:#27ae60; }
  #notification { position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#2ecc71; color:#fff; padding:10px 20px; border-radius:5px; display:none; z-index:999;}
  #adminPanel { display:none; margin-top:20px; }
  table { width:100%; border-collapse:collapse; margin-top:10px;}
  th,td { padding:8px; border-bottom:1px solid #ccc; text-align:right;}
  .top-member-item { display:flex; align-items:center; gap:10px; margin-bottom:5px;}
  .member-img { width:40px; height:40px; border-radius:50%; object-fit:cover;}
  .lang-btn { margin-left:10px; padding:5px 10px; cursor:pointer; border:none; border-radius:5px; background:#3498db; color:#fff; }
</style>
</head>
<body>

<header>
  <h1 id="title">حضور الأعضاء</h1>
  <div>
    <button id="adminLoginBtn">دخول الأدمن</button>
    <button class="lang-btn" onclick="setLang('ar')">AR</button>
    <button class="lang-btn" onclick="setLang('en')">EN</button>
  </div>
</header>

<div id="notification"></div>

<main>
  <!-- تسجيل الحضور -->
  <div class="card">
    <h3 id="attendanceTitle">تسجيل الحضور</h3>
    <label id="memberLabel">اختر العضو</label>
    <select id="selectMember"></select>
    <label id="weekLabel">اختر الأسبوع</label>
    <select id="weekSelect"></select>
    <button class="action-btn" id="markPresent">تسجيل الحضور</button>
  </div>

  <!-- التقارير -->
  <div class="card">
    <h3 id="reportTitle">التقارير</h3>
    <canvas id="attendanceChart"></canvas>
  </div>

  <!-- لوحة الأدمن -->
  <div class="card" id="adminPanel">
    <h3 id="adminTitle">لوحة الأدمن</h3>
    <label id="newMemberLabel">اسم العضو</label>
    <input type="text" id="newMemberName">
    <label id="newMemberImageLabel">رابط الصورة</label>
    <input type="text" id="newMemberImage">
    <button class="action-btn" id="addMemberBtn">إضافة عضو</button>

    <label id="newWeekLabel">اسم الأسبوع</label>
    <input type="text" id="newWeekName">
    <label id="newWeekStartLabel">تاريخ البداية</label>
    <input type="date" id="newWeekStart">
    <label id="newWeekEndLabel">تاريخ النهاية</label>
    <input type="date" id="newWeekEnd">
    <button class="action-btn" id="addWeekBtn">إضافة أسبوع</button>

    <h4 id="membersListTitle">الأعضاء</h4>
    <table id="membersTable">
      <thead><tr><th>#</th><th>صورة</th><th>الاسم</th><th>نقاط</th><th>الإجراءات</th></tr></thead>
      <tbody></tbody>
    </table>

    <h4 id="weeksListTitle">الأسابيع</h4>
    <table id="weeksTable">
      <thead><tr><th>#</th><th>اسم الأسبوع</th><th>من</th><th>إلى</th><th>الإجراءات</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</main>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyBCQIqdCsxSvhfYOs00AetoVWpFhj4XNAQ",
    authDomain: "angels-attendance.firebaseapp.com",
    databaseURL: "https://angels-attendance-default-rtdb.firebaseio.com",
    projectId: "angels-attendance",
    storageBucket: "angels-attendance.firebasestorage.app",
    messagingSenderId: "157249026489",
    appId: "1:157249026489:web:db2b420203bd81d9a19e68",
    measurementId: "G-2YDPSFPQYT"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let members = [], weeks = [], attendanceRecords = [];
  const adminPass = 'admin123';
  let lang = 'ar';

  function showNotification(msg,isSuccess=true){
    const n = document.getElementById('notification');
    n.textContent = msg;
    n.style.background = isSuccess?'#2ecc71':'#e74c3c';
    n.style.display='block';
    setTimeout(()=>{n.style.display='none';},3000);
  }

  function setLang(l){
    lang = l;
    document.getElementById('title').textContent = l==='ar'?'حضور الأعضاء':'Attendance';
    document.getElementById('attendanceTitle').textContent = l==='ar'?'تسجيل الحضور':'Mark Attendance';
    document.getElementById('memberLabel').textContent = l==='ar'?'اختر العضو':'Select Member';
    document.getElementById('weekLabel').textContent = l==='ar'?'اختر الأسبوع':'Select Week';
    document.getElementById('markPresent').textContent = l==='ar'?'تسجيل الحضور':'Mark Attendance';
    document.getElementById('reportTitle').textContent = l==='ar'?'التقارير':'Reports';
    document.getElementById('adminTitle').textContent = l==='ar'?'لوحة الأدمن':'Admin Panel';
    document.getElementById('newMemberLabel').textContent = l==='ar'?'اسم العضو':'Member Name';
    document.getElementById('newMemberImageLabel').textContent = l==='ar'?'رابط الصورة':'Image URL';
    document.getElementById('addMemberBtn').textContent = l==='ar'?'إضافة عضو':'Add Member';
    document.getElementById('newWeekLabel').textContent = l==='ar'?'اسم الأسبوع':'Week Name';
    document.getElementById('newWeekStartLabel').textContent = l==='ar'?'تاريخ البداية':'Start Date';
    document.getElementById('newWeekEndLabel').textContent = l==='ar'?'تاريخ النهاية':'End Date';
    document.getElementById('addWeekBtn').textContent = l==='ar'?'إضافة أسبوع':'Add Week';
    document.getElementById('membersListTitle').textContent = l==='ar'?'الأعضاء':'Members';
    document.getElementById('weeksListTitle').textContent = l==='ar'?'الأسابيع':'Weeks';
  }

  function loadData(){
    db.ref('members').once('value').then(snapshot=>{members=snapshot.val()||[]; populateMembers(); });
    db.ref('weeks').once('value').then(snapshot=>{weeks=snapshot.val()||[]; populateWeeks(); });
    db.ref('attendance').once('value').then(snapshot=>{attendanceRecords=snapshot.val()||[]; updateChart(); });
  }

  function populateMembers(){
    const select = document.getElementById('selectMember');
    select.innerHTML='<option value="">--</option>';
    members.forEach((m,i)=>{ let opt=document.createElement('option'); opt.value=i; opt.textContent=m.name; select.appendChild(opt);});
    const tbody=document.querySelector('#membersTable tbody');
    tbody.innerHTML='';
    members.forEach((m,i)=>{
      let tr=document.createElement('tr');
      tr.innerHTML=`<td>${i+1}</td><td><img src="${m.image}" class="member-img"></td><td>${m.name}</td>
      <td>${attendanceRecords.filter(a=>a.member==i && a.present).length}</td>
      <td></td>`;
      tbody.appendChild(tr);
    });
  }

  function populateWeeks(){
    const select=document.getElementById('weekSelect');
    select.innerHTML='';
    weeks.forEach((w,i)=>{ let opt=document.createElement('option'); opt.value=i; opt.textContent=w.name; select.appendChild(opt);});
    const tbody=document.querySelector('#weeksTable tbody');
    tbody.innerHTML='';
    weeks.forEach((w,i)=>{
      let tr=document.createElement('tr');
      tr.innerHTML=`<td>${i+1}</td><td>${w.name}</td><td>${w.from}</td><td>${w.to}</td><td></td>`;
      tbody.appendChild(tr);
    });
  }

  document.getElementById('markPresent').addEventListener('click',()=>{
    const memberIdx=parseInt(document.getElementById('selectMember').value);
    const weekIdx=parseInt(document.getElementById('weekSelect').value);
    if(isNaN(memberIdx)||isNaN(weekIdx)){ showNotification('اختر العضو والأسبوع',false); return; }
    attendanceRecords.push({member:memberIdx,week:weekIdx,present:true});
    db.ref('attendance').set(attendanceRecords);
    updateChart();
    showNotification('تم تسجيل الحضور');
  });

  document.getElementById('addMemberBtn').addEventListener('click',()=>{
    const name=document.getElementById('newMemberName').value;
    const img=document.getElementById('newMemberImage').value || 'https://ui-avatars.com/api/?name=Member&background=ccc&color=fff';
    if(!name){ showNotification('ادخل اسم العضو',false); return; }
    members.push({name:name,image:img});
    db.ref('members').set(members);
    populateMembers();
  });

  document.getElementById('addWeekBtn').addEventListener('click',()=>{
    const name=document.getElementById('newWeekName').value;
    const from=document.getElementById('newWeekStart').value;
    const to=document.getElementById('newWeekEnd').value;
    if(!name || !from || !to){ showNotification('املأ كل الحقول',false); return; }
    weeks.push({name:name,from:from,to:to});
    db.ref('weeks').set(weeks);
    populateWeeks();
  });

  // Chart
  const ctx=document.getElementById('attendanceChart').getContext('2d');
  const chart=new Chart(ctx,{type:'bar',data:{labels:[],datasets:[{label:'الحضور',data:[],backgroundColor:'#3498db'}]},options:{responsive:true,plugins:{legend:{display:false}}}});
  function updateChart(){
    const weekIdx=parseInt(document.getElementById('weekSelect').value);
    chart.data.labels=members.map(m=>m.name);
    chart.data.datasets[0].data=members.map((m,i)=>attendanceRecords.filter(a=>a.member==i && a.week==weekIdx && a.present).length);
    chart.update();
  }

  document.getElementById('adminLoginBtn').addEventListener('click',()=>{
    const pwd=prompt('كلمة مرور الأدمن');
    if(pwd===adminPass) document.getElementById('adminPanel').style.display='block';
    else showNotification('كلمة المرور خطأ',false);
  });

  window.onload=loadData;
</script>
</body>
</html>
