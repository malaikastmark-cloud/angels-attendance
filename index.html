<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>نظام خدام ملايكة - النسخة النهائية</title>
<link rel="stylesheet" href="style.css">
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<!-- إشعارات -->
<div id="notification" style="display:none;position:fixed;top:10px;right:10px;padding:10px;border-radius:5px;color:white;z-index:1000;"></div>

<!-- الجداول والنماذج كما هي -->
<div id="membersTableDiv"> <!-- جدول الأعضاء -->
<table id="membersTable">
<thead>
<tr>
<th>#</th>
<th>اسم العضو</th>
<th>النقاط</th>
<th>رصيد Talanton</th>
<th>كلمة السر</th>
<th>إجراءات</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<!-- باقي الجداول والنماذج الأخرى كما هي في الكود الأصلي -->

<script>
// إعداد Firebase
const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    databaseURL: "YOUR_DATABASE_URL",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
    appId: "YOUR_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// البيانات المحلية
let members = [];
let weeks = [];
let attendanceRecords = [];
let contests = [];
let birthdays = [];
let events = [];
let tasks = [];
let securityLogs = [];
let currentUser = null;

// --- وظائف Talanton ---
function updateTalantonForAttendance(memberId, points = 1) {
    const member = members.find(m => m.id === memberId);
    if (member) {
        member.talanton = (member.talanton || 0) + points;
        database.ref('members/' + memberId + '/talanton').set(member.talanton);
    }
}

function updateTalantonForContest(memberId, points) {
    updateTalantonForAttendance(memberId, points); // نفس النقاط للـ Talanton
}

function updateTalantonForTask(memberId, points) {
    updateTalantonForAttendance(memberId, points);
}

// --- تحديث جدول الأعضاء ---
function updateMembersTable() {
    const tbody = document.querySelector('#membersTable tbody');
    tbody.innerHTML = '';
    members.forEach((member, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${index + 1}</td>
            <td>${member.name}</td>
            <td>${member.points || 0}</td>
            <td>${member.talanton || 0}</td>
            <td>${member.password}</td>
            <td>
                <!-- أزرار تعديل وحذف -->
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// --- تحديث تقارير المستخدم ---
function updateUserReports() {
    if (!currentUser) return;
    const userAttendance = attendanceRecords.filter(ar => ar.memberId === currentUser.id).length;
    document.getElementById('userTotalAttendance').textContent = userAttendance;
    document.getElementById('userTotalPoints').textContent = currentUser.points || 0;
    document.getElementById('userTalanton').textContent = currentUser.talanton || 0;
    const sortedByPoints = [...members].sort((a, b) => (b.points || 0) - (a.points || 0));
    const userRank = sortedByPoints.findIndex(m => m.id === currentUser.id) + 1;
    document.getElementById('userRank').textContent = userRank;
}

// --- إضافة حضور مع Talanton ---
function addAttendance(memberId, weekId) {
    const newRecordRef = database.ref('attendance').push();
    const record = {
        memberId, weekId, points: 1, date: new Date().toISOString()
    };
    newRecordRef.set(record).then(() => {
        attendanceRecords.push({ id: newRecordRef.key, ...record });
        updateTalantonForAttendance(memberId, 1);
        updateMembersTable();
    });
}

// --- إضافة مسابقة مع Talanton ---
function addContest(memberId, contestName, points) {
    const contestsRef = database.ref('contests').push();
    const contest = { memberId, contestName, points, date: new Date().toISOString() };
    contestsRef.set(contest).then(() => {
        contests.push({ id: contestsRef.key, ...contest });
        updateTalantonForContest(memberId, points);
        updateMembersTable();
    });
}

// --- إضافة مهمة مع Talanton ---
function addTask(memberId, name, deadline, status) {
    const tasksRef = database.ref('tasks').push();
    const task = { assigneeId: memberId, assigneeName: members.find(m=>m.id===memberId).name, name, deadline, status };
    tasksRef.set(task).then(() => {
        tasks.push({ id: tasksRef.key, ...task });
        updateTalantonForTask(memberId, 1);
        updateMembersTable();
    });
}

// --- تصدير بيانات مع Talanton ---
function exportMembersReport() {
    let csvContent = "data:text/csv;charset=utf-8,﻿";
    csvContent += "الرقم,اسم العضو,النقاط,Talanton,كلمة السر\r\n";
    members.forEach((member,index)=>{
        csvContent += `${index+1},${member.name},${member.points||0},${member.talanton||0},${member.password}\r\n`;
    });
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `بيانات_الأعضاء_${new Date().toISOString().slice(0,10)}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    showNotification('تم تصدير بيانات الأعضاء بنجاح');
}

// --- إشعار ---
function showNotification(message, isSuccess=true){
    const notification=document.getElementById('notification');
    notification.textContent=message;
    notification.style.background=isSuccess?'#2ecc71':'#e74c3c';
    notification.style.display='block';
    setTimeout(()=>{notification.style.display='none';},3000);
}

// --- تهيئة التطبيق ---
function initializeApp(){
    // تحميل البيانات من Firebase
    database.ref('members').on('value', snapshot=>{
        members = [];
        snapshot.forEach(s=>{
            members.push({id:s.key,...s.val()});
        });
        updateMembersTable();
    });

    database.ref('attendance').on('value', snapshot=>{
        attendanceRecords = [];
        snapshot.forEach(s=>{
            attendanceRecords.push({id:s.key,...s.val()});
        });
    });

    database.ref('contests').on('value', snapshot=>{
        contests = [];
        snapshot.forEach(s=>{
            contests.push({id:s.key,...s.val()});
        });
    });

    database.ref('tasks').on('value', snapshot=>{
        tasks = [];
        snapshot.forEach(s=>{
            tasks.push({id:s.key,...s.val()});
        });
    });
}

document.addEventListener('DOMContentLoaded', initializeApp);
</script>
</body>
</html>
