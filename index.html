// Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©
let currentMember = null;
let isAdmin = false;
let members = [];
let products = [];
let attendance = [];
let talantonHistory = [];
let events = [];
let weeks = [];
let securityLogs = [];
let tasks = [];
let levels = [];
let notifications = [];
let currentLanguage = 'ar';
let qrScanner = null;

// ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª
const memberLevels = [
    { id: 1, name: 'Ù…Ø¨ØªØ¯Ø¦', minPoints: 0, maxPoints: 100, color: 'level-beginner' },
    { id: 2, name: 'Ù…ØªÙˆØ³Ø·', minPoints: 101, maxPoints: 300, color: 'level-intermediate' },
    { id: 3, name: 'Ù…ØªÙ‚Ø¯Ù…', minPoints: 301, maxPoints: 600, color: 'level-advanced' },
    { id: 4, name: 'Ø®Ø¨ÙŠØ±', minPoints: 601, maxPoints: 1000, color: 'level-expert' },
    { id: 5, name: 'Ø£Ø³Ø·ÙˆØ±Ø©', minPoints: 1001, maxPoints: Infinity, color: 'level-legend' }
];

// ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
const defaultTasks = [
    { id: 1, name: 'Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥Ù†Ø¬ÙŠÙ„', points: 15, type: 'daily', description: 'Ø§Ù‚Ø±Ø£ ÙØµÙ„ Ù…Ù† Ø§Ù„Ø¥Ù†Ø¬ÙŠÙ„' },
    { id: 2, name: 'Ø§Ù„ØµÙ„Ø§Ø©', points: 10, type: 'daily', description: 'ØµÙ„Ø§Ø© Ø§Ù„ØµØ¨Ø§Ø­ Ø£Ùˆ Ø§Ù„Ù…Ø³Ø§Ø¡' },
    { id: 3, name: 'Ø®Ø¯Ù…Ø© Ø§Ù„Ù…Ø¬ØªÙ…Ø¹', points: 50, type: 'weekly', description: 'Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ Ø®Ø¯Ù…Ø© Ø§Ù„Ù…Ø¬ØªÙ…Ø¹' },
    { id: 4, name: 'Ø­Ø¶ÙˆØ± Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹', points: 25, type: 'weekly', description: 'Ø­Ø¶ÙˆØ± Ø§Ø¬ØªÙ…Ø§Ø¹ Ø§Ù„Ø®Ø¯Ø§Ù…' },
    { id: 5, name: 'ØªØ¯Ø±ÙŠØ¨ Ø¬Ø¯ÙŠØ¯', points: 30, type: 'monthly', description: 'Ø¥ÙƒÙ…Ø§Ù„ Ø¯ÙˆØ±Ø© ØªØ¯Ø±ÙŠØ¨ÙŠØ©' }
];

// Ø§Ù„ØªØ±Ø¬Ù…Ø©
const translations = {
    ar: {
        toggle_theme: 'ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹',
        search_placeholder: 'Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ...',
        admin_login: 'Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†',
        qr_scanner: 'Ù…Ø§Ø³Ø­ QR',
        levels_system: 'Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª',
        tasks_activities: 'Ø§Ù„Ù…Ù‡Ø§Ù… ÙˆØ§Ù„Ø£Ù†Ø´Ø·Ø©',
        integrated_calendar: 'Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„',
        notifications: 'Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª',
        available_tasks: 'Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ØªØ§Ø­Ø©',
        top_members: 'Ø£ÙØ¶Ù„ 10 Ø£Ø¹Ø¶Ø§Ø¡',
        select_member: 'Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ù„Ø­Ø¶ÙˆØ±',
        general_stats: 'Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ø§Ù…Ø©',
        total_members: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡',
        present_today: 'Ø§Ù„Ø­Ø§Ø¶Ø±ÙˆÙ† Ø§Ù„ÙŠÙˆÙ…',
        total_talanton: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Talanton',
        weekly_attendance: 'Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ',
        loading_members: 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡...',
        admin_panel: 'Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù†',
        manage_members: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡',
        manage_talanton: 'Ø¥Ø¯Ø§Ø±Ø© Talanton',
        manage_store: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªØ¬Ø±',
        manage_weeks: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹',
        manage_events: 'Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø§Øª',
        manage_birthdays: 'Ø£Ø¹ÙŠØ§Ø¯ Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯',
        manage_security: 'Ø§Ù„Ø£Ù…Ø§Ù†',
        reports: 'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±',
        manage_tasks: 'Ø§Ù„Ù…Ù‡Ø§Ù…',
        manage_notifications: 'Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª',
        add_member: 'Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ Ø¬Ø¯ÙŠØ¯',
        add_product: 'Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬',
        add_week: 'Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¨ÙˆØ¹',
        add_event: 'Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø§Ø³Ø¨Ø©',
        add_birthday: 'Ø¥Ø¶Ø§ÙØ© Ø¹ÙŠØ¯ Ù…ÙŠÙ„Ø§Ø¯',
        email_settings: 'Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯',
        test_emails: 'Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª',
        password: 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±',
        enter_password: 'Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±',
        login: 'Ø¯Ø®ÙˆÙ„',
        logout: 'ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬',
        attendance_registration: 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±',
        fingerprint_instructions: 'Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø¨ØµÙ…Ø© Ø£Ùˆ Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±',
        personal_password: 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø´Ø®ØµÙŠØ©',
        register_attendance: 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±',
        view_profile: 'Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ',
        member_profile: 'Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ',
        talanton_store: 'Ù…ØªØ¬Ø± Talanton',
        generate_report: 'Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ±',
        member_name: 'Ø§Ø³Ù… Ø§Ù„Ø¹Ø¶Ùˆ',
        email: 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ',
        birthdate: 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯',
        initial_talanton: 'Ø±ØµÙŠØ¯ Talanton Ø§Ù„Ø£ÙˆÙ„ÙŠ',
        edit_member: 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø¶Ùˆ',
        talanton_balance: 'Ø±ØµÙŠØ¯ Talanton',
        update_member: 'ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¶Ùˆ',
        product_name: 'Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬',
        price_in_talanton: 'Ø§Ù„Ø³Ø¹Ø± Ø¨Ù€ Talanton',
        description: 'Ø§Ù„ÙˆØµÙ',
        edit_product: 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬',
        update_product: 'ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬',
        manage_points: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ù‚Ø§Ø·',
        select_member: 'Ø§Ø®ØªØ± Ø§Ù„Ø¹Ø¶Ùˆ',
        operation_type: 'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©',
        add_points: 'Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø§Ø·',
        deduct_points: 'Ø®ØµÙ… Ù†Ù‚Ø§Ø·',
        points_amount: 'Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø·',
        reason: 'Ø§Ù„Ø³Ø¨Ø¨',
        execute_operation: 'ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ©',
        event_name: 'Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©',
        event_date: 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©',
        reward_points: 'Ù†Ù‚Ø§Ø· Talanton Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©',
        week_name: 'Ø§Ø³Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹',
        start_date: 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©',
        end_date: 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©',
        qr_instructions: 'ÙˆØ¬Ù‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù†Ø­Ùˆ QR code Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±',
        view_tasks: 'Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ØªØ§Ø­Ø©',
        add_task: 'Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø©',
        task_name: 'Ø§Ø³Ù… Ø§Ù„Ù…Ù‡Ù…Ø©',
        points: 'Ø§Ù„Ù†Ù‚Ø§Ø·',
        task_type: 'Ù†ÙˆØ¹ Ø§Ù„Ù…Ù‡Ù…Ø©',
        daily: 'ÙŠÙˆÙ…ÙŠØ©',
        weekly: 'Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©',
        monthly: 'Ø´Ù‡Ø±ÙŠØ©',
        one_time: 'Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©',
        email_service_id: 'Ù…Ø¹Ø±Ù Ø®Ø¯Ù…Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯',
        email_template_id: 'Ù…Ø¹Ø±Ù Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø¨Ø±ÙŠØ¯',
        email_user_id: 'Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…',
        save_settings: 'Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª'
    },
    en: {
        toggle_theme: 'Toggle Theme',
        search_placeholder: 'Search by name or ID...',
        admin_login: 'Admin Login',
        qr_scanner: 'QR Scanner',
        levels_system: 'Levels System',
        tasks_activities: 'Tasks & Activities',
        integrated_calendar: 'Integrated Calendar',
        notifications: 'Notifications',
        available_tasks: 'Available Tasks',
        top_members: 'Top 10 Members',
        select_member: 'Select Member for Attendance',
        general_stats: 'General Statistics',
        total_members: 'Total Members',
        present_today: 'Present Today',
        total_talanton: 'Total Talanton',
        weekly_attendance: 'Weekly Attendance Rate',
        loading_members: 'Loading members...',
        admin_panel: 'Admin Panel',
        manage_members: 'Manage Members',
        manage_talanton: 'Manage Talanton',
        manage_store: 'Manage Store',
        manage_weeks: 'Manage Weeks',
        manage_events: 'Events',
        manage_birthdays: 'Birthdays',
        manage_security: 'Security',
        reports: 'Reports',
        manage_tasks: 'Tasks',
        manage_notifications: 'Notifications',
        add_member: 'Add New Member',
        add_product: 'Add Product',
        add_week: 'Add Week',
        add_event: 'Add Event',
        add_birthday: 'Add Birthday',
        email_settings: 'Email Settings',
        test_emails: 'Test Notifications',
        password: 'Password',
        enter_password: 'Enter password',
        login: 'Login',
        logout: 'Logout',
        attendance_registration: 'Attendance Registration',
        fingerprint_instructions: 'Press fingerprint or enter password',
        personal_password: 'Personal Password',
        register_attendance: 'Register Attendance',
        view_profile: 'View Profile',
        member_profile: 'Member Profile',
        talanton_store: 'Talanton Store',
        generate_report: 'Generate Report',
        member_name: 'Member Name',
        email: 'Email',
        birthdate: 'Birthdate',
        initial_talanton: 'Initial Talanton',
        edit_member: 'Edit Member',
        talanton_balance: 'Talanton Balance',
        update_member: 'Update Member',
        product_name: 'Product Name',
        price_in_talanton: 'Price in Talanton',
        description: 'Description',
        edit_product: 'Edit Product',
        update_product: 'Update Product',
        manage_points: 'Manage Points',
        select_member: 'Select Member',
        operation_type: 'Operation Type',
        add_points: 'Add Points',
        deduct_points: 'Deduct Points',
        points_amount: 'Points Amount',
        reason: 'Reason',
        execute_operation: 'Execute Operation',
        event_name: 'Event Name',
        event_date: 'Event Date',
        reward_points: 'Reward Points',
        week_name: 'Week Name',
        start_date: 'Start Date',
        end_date: 'End Date',
        qr_instructions: 'Point camera at QR code to register attendance',
        view_tasks: 'View Available Tasks',
        add_task: 'Add Task',
        task_name: 'Task Name',
        points: 'Points',
        task_type: 'Task Type',
        daily: 'Daily',
        weekly: 'Weekly',
        monthly: 'Monthly',
        one_time: 'One Time',
        email_service_id: 'Email Service ID',
        email_template_id: 'Email Template ID',
        email_user_id: 'Email User ID',
        save_settings: 'Save Settings'
    }
};

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
document.addEventListener('DOMContentLoaded', function() {
    initializeFirebase();
    loadTheme();
    loadLanguage();
    setupSearch();
    updateUI();
    loadTasks();
    displayLevels();
    applyTranslations();
    checkUpcomingEvents();
    loadNotifications();
    
    setInterval(checkUpcomingEvents, 3600000); // ÙƒÙ„ Ø³Ø§Ø¹Ø©
});

// Firebase Integration
function initializeFirebase() {
    if (window.firebaseDb) {
        loadDataFromFirebase();
    } else {
        loadDataFromLocalStorage();
    }
}

function saveToFirebase(path, data) {
    if (window.firebaseDb) {
        try {
            const ref = window.firebaseRef(window.firebaseDb, path);
            window.firebaseSet(ref, data);
        } catch (error) {
            console.error('Firebase save error:', error);
            showMessage('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
        }
    }
}

function loadDataFromFirebase() {
    if (!window.firebaseDb) return;
    
    const paths = ['members', 'products', 'attendance', 'talantonHistory', 'events', 'weeks', 'securityLogs', 'tasks', 'notifications'];
    
    paths.forEach(path => {
        try {
            const ref = window.firebaseRef(window.firebaseDb, path);
            window.firebaseOnValue(ref, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    window[path] = Array.isArray(data) ? data : Object.values(data);
                    updateUI();
                }
            });
        } catch (error) {
            console.error(`Firebase load error for ${path}:`, error);
        }
    });
}

function loadDataFromLocalStorage() {
    try {
        members = JSON.parse(localStorage.getItem('members')) || [];
        products = JSON.parse(localStorage.getItem('products')) || [];
        attendance = JSON.parse(localStorage.getItem('attendance')) || [];
        talantonHistory = JSON.parse(localStorage.getItem('talantonHistory')) || [];
        events = JSON.parse(localStorage.getItem('events')) || [];
        weeks = JSON.parse(localStorage.getItem('weeks')) || [];
        securityLogs = JSON.parse(localStorage.getItem('securityLogs')) || [];
        tasks = JSON.parse(localStorage.getItem('tasks')) || [...defaultTasks];
        notifications = JSON.parse(localStorage.getItem('notifications')) || [];

        // Initialize demo data if empty
        if (members.length === 0) {
            initializeDemoData();
        }
    } catch (error) {
        console.error('LocalStorage load error:', error);
        initializeDemoData();
    }
}

function saveData() {
    try {
        if (window.firebaseDb) {
            saveToFirebase('members', members);
            saveToFirebase('products', products);
            saveToFirebase('attendance', attendance);
            saveToFirebase('talantonHistory', talantonHistory);
            saveToFirebase('events', events);
            saveToFirebase('weeks', weeks);
            saveToFirebase('securityLogs', securityLogs);
            saveToFirebase('tasks', tasks);
            saveToFirebase('notifications', notifications);
        } else {
            localStorage.setItem('members', JSON.stringify(members));
            localStorage.setItem('products', JSON.stringify(products));
            localStorage.setItem('attendance', JSON.stringify(attendance));
            localStorage.setItem('talantonHistory', JSON.stringify(talantonHistory));
            localStorage.setItem('events', JSON.stringify(events));
            localStorage.setItem('weeks', JSON.stringify(weeks));
            localStorage.setItem('securityLogs', JSON.stringify(securityLogs));
            localStorage.setItem('tasks', JSON.stringify(tasks));
            localStorage.setItem('notifications', JSON.stringify(notifications));
        }
    } catch (error) {
        console.error('Save data error:', error);
        showMessage('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
    }
}

function initializeDemoData() {
    members = [
        { id: 1, name: 'Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯', password: '1234', email: 'ahmed@example.com', talanton: 250, joinDate: '2024-01-15', birthday: '1995-03-15' },
        { id: 2, name: 'ÙØ§Ø·Ù…Ø© Ø¹Ù„ÙŠ', password: '1234', email: 'fatima@example.com', talanton: 320, joinDate: '2024-01-20', birthday: '1998-07-22' },
        { id: 3, name: 'Ù…Ø­Ù…Ø¯ Ø­Ø³Ù†', password: '1234', email: 'mohamed@example.com', talanton: 180, joinDate: '2024-02-01', birthday: '1997-11-08' },
        { id: 4, name: 'Ø¹Ø§Ø¦Ø´Ø© Ø£Ø­Ù…Ø¯', password: '1234', email: 'aisha@example.com', talanton: 275, joinDate: '2024-02-10', birthday: '1996-05-12' },
        { id: 5, name: 'Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø³Ø§Ù„Ù…', password: '1234', email: 'abdullah@example.com', talanton: 195, joinDate: '2024-02-15', birthday: '1999-09-03' },
        { id: 6, name: 'Ù…Ø±ÙŠÙ… Ø®Ø§Ù„Ø¯', password: '1234', email: 'maryam@example.com', talanton: 340, joinDate: '2024-01-25', birthday: '1994-12-18' },
        { id: 7, name: 'ÙŠÙˆØ³Ù Ø¹Ù…Ø±', password: '1234', email: 'youssef@example.com', talanton: 210, joinDate: '2024-02-05', birthday: '1998-04-27' },
        { id: 8, name: 'Ø²ÙŠÙ†Ø¨ Ù…Ø­Ù…ÙˆØ¯', password: '1234', email: 'zainab@example.com', talanton: 285, joinDate: '2024-01-30', birthday: '1997-08-14' },
        { id: 9, name: 'Ø¹Ù„ÙŠ Ø­Ø³Ø§Ù…', password: '1234', email: 'ali@example.com', talanton: 165, joinDate: '2024-02-12', birthday: '1999-01-09' },
        { id: 10, name: 'Ù†ÙˆØ± Ø§Ù„Ù‡Ø¯Ù‰', password: '1234', email: 'nour@example.com', talanton: 305, joinDate: '2024-01-18', birthday: '1996-10-25' }
    ];

    products = [
        { id: 1, name: 'ÙƒØªØ§Ø¨ Ø¯ÙŠÙ†ÙŠ', price: 50, description: 'ÙƒØªØ§Ø¨ ÙÙŠ Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø±ÙˆØ­ÙŠØ©' },
        { id: 2, name: 'Ù…Ø³Ø¨Ø­Ø©', price: 30, description: 'Ù…Ø³Ø¨Ø­Ø© Ø®Ø´Ø¨ÙŠØ© Ø¬Ù…ÙŠÙ„Ø©' },
        { id: 3, name: 'ØµÙ„ÙŠØ¨ ØµØºÙŠØ±', price: 25, description: 'ØµÙ„ÙŠØ¨ Ù„Ù„ØªØ°ÙƒØ§Ø±' },
        { id: 4, name: 'Ø´Ù‡Ø§Ø¯Ø© ØªÙ‚Ø¯ÙŠØ±', price: 100, description: 'Ø´Ù‡Ø§Ø¯Ø© ØªÙ‚Ø¯ÙŠØ± Ù…Ø·Ø¨ÙˆØ¹Ø©' },
        { id: 5, name: 'Ù‚Ù„Ù… Ù…Ù…ÙŠØ²', price: 40, description: 'Ù‚Ù„Ù… Ø¨ØªØµÙ…ÙŠÙ… Ø®Ø§Øµ' },
        { id: 6, name: 'Ø¯ÙØªØ± Ù…Ù„Ø§Ø­Ø¸Ø§Øª', price: 35, description: 'Ø¯ÙØªØ± Ù„Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©' }
    ];

    weeks = [
        { id: 1, name: 'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø£ÙˆÙ„', startDate: '2024-01-01', endDate: '2024-01-07', reward: 50 },
        { id: 2, name: 'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø«Ø§Ù†ÙŠ', startDate: '2024-01-08', endDate: '2024-01-14', reward: 50 },
        { id: 3, name: 'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø«Ø§Ù„Ø«', startDate: '2024-01-15', endDate: '2024-01-21', reward: 60 }
    ];

    events = [
        { id: 1, name: 'Ø§Ø­ØªÙØ§Ù„ Ø±Ø£Ø³ Ø§Ù„Ø³Ù†Ø©', date: '2024-01-01', description: 'Ø§Ø­ØªÙØ§Ù„ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯', reward: 25 },
        { id: 2, name: 'ÙŠÙˆÙ… Ø§Ù„Ø®Ø¯Ù…Ø©', date: '2024-02-15', description: 'ÙŠÙˆÙ… Ù…Ø®ØµØµ Ù„Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ù…Ø¬ØªÙ…Ø¹ÙŠØ©', reward: 30 }
    ];

    notifications = [
        { id: 1, type: 'info', title: 'Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…', message: 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„Ùƒ Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ Ù†Ø¸Ø§Ù… Talanton', timestamp: new Date().toISOString(), read: false }
    ];

    saveData();
}

// Theme Management
function toggleTheme() {
    const body = document.body;
    const currentTheme = body.getAttribute('data-theme');
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
    const themeIcon = document.getElementById('themeIcon');
    
    body.setAttribute('data-theme', newTheme);
    if (themeIcon) themeIcon.textContent = newTheme === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';
    localStorage.setItem('theme', newTheme);
}

function loadTheme() {
    const savedTheme = localStorage.getItem('theme') || 'light';
    const themeIcon = document.getElementById('themeIcon');
    document.body.setAttribute('data-theme', savedTheme);
    if (themeIcon) themeIcon.textContent = savedTheme === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';
}

// Language Management
function toggleLanguage() {
    currentLanguage = currentLanguage === 'ar' ? 'en' : 'ar';
    document.body.setAttribute('data-language', currentLanguage);
    document.body.setAttribute('dir', currentLanguage === 'ar' ? 'rtl' : 'ltr');
    document.documentElement.setAttribute('lang', currentLanguage);
    
    const languageText = document.getElementById('languageText');
    if (languageText) {
        languageText.textContent = currentLanguage === 'ar' ? 'English' : 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©';
    }
    
    applyTranslations();
    localStorage.setItem('language', currentLanguage);
}

function applyTranslations() {
    document.querySelectorAll('[data-translate]').forEach(element => {
        const key = element.getAttribute('data-translate');
        if (translations[currentLanguage] && translations[currentLanguage][key]) {
            if (element.placeholder !== undefined) {
                element.placeholder = translations[currentLanguage][key];
            } else {
                element.textContent = translations[currentLanguage][key];
            }
        }
    });
}

function loadLanguage() {
    const savedLanguage = localStorage.getItem('language') || 'ar';
    currentLanguage = savedLanguage;
    document.body.setAttribute('data-language', currentLanguage);
    document.body.setAttribute('dir', currentLanguage === 'ar' ? 'rtl' : 'ltr');
    document.documentElement.setAttribute('lang', currentLanguage);
    
    const languageText = document.getElementById('languageText');
    if (languageText) {
        languageText.textContent = currentLanguage === 'ar' ? 'English' : 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©';
    }
}

// Enhanced Search functionality
function setupSearch() {
    const searchInput = document.getElementById('memberSearch');
    const searchResults = document.getElementById('searchResults');
    
    if (!searchInput || !searchResults) return;
    
    searchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        
        if (query.length > 0) {
            const filteredMembers = members.filter(member => 
                member.name.toLowerCase().includes(query) || 
                member.id.toString().includes(query)
            );
            
            if (filteredMembers.length > 0) {
                searchResults.innerHTML = filteredMembers.map(member => `
                    <div class="search-result-item" onclick="selectMemberFromSearch(${member.id})">
                        <strong>${member.name}</strong> - #${member.id} (${member.talanton} Ù†Ù‚Ø·Ø©)
                    </div>
                `).join('');
                searchResults.style.display = 'block';
            } else {
                searchResults.innerHTML = '<div class="search-result-item">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
                searchResults.style.display = 'block';
            }
        } else {
            searchResults.style.display = 'none';
        }
        
        filterMembers(query);
    });

    // Hide search results when clicking outside
    document.addEventListener('click', function(event) {
        if (!searchInput.contains(event.target) && !searchResults.contains(event.target)) {
            searchResults.style.display = 'none';
        }
    });
}

function selectMemberFromSearch(memberId) {
    selectMember(memberId);
    const searchResults = document.getElementById('searchResults');
    const memberSearch = document.getElementById('memberSearch');
    if (searchResults) searchResults.style.display = 'none';
    if (memberSearch) memberSearch.value = '';
}

function filterMembers(query) {
    const memberCards = document.querySelectorAll('.member-card');
    memberCards.forEach(card => {
        const name = card.querySelector('.member-name');
        const number = card.querySelector('.member-number');
        
        if (name && number) {
            const nameText = name.textContent.toLowerCase();
            const numberText = number.textContent;
            
            if (query === '' || nameText.includes(query) || numberText.includes(query)) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        }
    });
}

// Birthday notifications
function checkBirthdays() {
    const today = new Date();
    const todayStr = `${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
    
    const birthdayMembers = members.filter(member => {
        if (member.birthday) {
            const birthday = new Date(member.birthday);
            const birthdayStr = `${String(birthday.getMonth() + 1).padStart(2, '0')}-${String(birthday.getDate()).padStart(2, '0')}`;
            return birthdayStr === todayStr;
        }
        return false;
    });

    const container = document.getElementById('birthdayNotifications');
    if (container) {
        if (birthdayMembers.length > 0) {
            container.innerHTML = birthdayMembers.map(member => `
                <div class="birthday-notification">
                    ğŸ‚ Ø¹ÙŠØ¯ Ù…ÙŠÙ„Ø§Ø¯ Ø³Ø¹ÙŠØ¯ ${member.name}! ğŸ‰
                </div>
            `).join('');
        } else {
            container.innerHTML = '';
        }
    }
}

// Top 10 members display
function displayTopMembers() {
    const sortedMembers = [...members]
        .sort((a, b) => b.talanton - a.talanton)
        .slice(0, 10);

    const container = document.getElementById('topMembersList');
    if (container) {
        container.innerHTML = sortedMembers.map((member, index) => {
            const rankClass = index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : 'rank-other';
            return `
                <div class="top-member-item">
                    <div class="rank-badge ${rankClass}">${index + 1}</div>
                    <div>
                        <strong>${member.name}</strong>
                        <div style="color: var(--warning-color); font-weight: bold;">${member.talanton} Ù†Ù‚Ø·Ø©</div>
                    </div>
                </div>
            `;
        }).join('');
    }
}

// Display members
function displayMembers() {
    const membersList = document.getElementById('membersList');
    if (!membersList) return;
    
    if (members.length === 0) {
        membersList.innerHTML = '<div class="loading" data-translate="loading_members">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡...</div>';
        return;
    }

    membersList.innerHTML = members.map(member => {
        const level = calculateLevel(member.talanton);
        return `
            <div class="member-card" onclick="selectMember(${member.id})">
                <div class="member-number">${member.id}</div>
                <div class="member-name">${member.name}</div>
                <div class="level-badge ${level.color}">${level.name}</div>
                <div class="member-talanton">ğŸ’° ${member.talanton} Talanton</div>
            </div>
        `;
    }).join('');
}

// Levels System
function calculateLevel(points) {
    return memberLevels.find(level => points >= level.minPoints && points <= level.maxPoints) || memberLevels[0];
}

function displayLevels() {
    const levelsGrid = document.getElementById('levelsGrid');
    if (!levelsGrid) return;
    
    levelsGrid.innerHTML = memberLevels.map(level => `
        <div class="member-card">
            <div class="level-badge ${level.color}">${level.name}</div>
            <h3>${level.name}</h3>
            <p>${level.minPoints} - ${level.maxPoints === Infinity ? '+' : level.maxPoints} Ù†Ù‚Ø§Ø·</p>
            <div class="member-talanton">${getLevelBenefits(level.id)}</div>
        </div>
    `).join('');
}

function getLevelBenefits(levelId) {
    const benefits = {
        1: 'ÙˆØµÙˆÙ„ Ø£Ø³Ø§Ø³ÙŠ Ù„Ù„Ù…ÙŠØ²Ø§Øª',
        2: 'Ù…ÙƒØ§ÙØ¢Øª Ø¥Ø¶Ø§ÙÙŠØ© +5%',
        3: 'Ù…ÙƒØ§ÙØ¢Øª Ø¥Ø¶Ø§ÙÙŠØ© +10%',
        4: 'Ù…ÙƒØ§ÙØ¢Øª Ø¥Ø¶Ø§ÙÙŠØ© +15%',
        5: 'Ù…ÙƒØ§ÙØ¢Øª Ø¥Ø¶Ø§ÙÙŠØ© +20% ÙˆÙ‡Ø¯Ø§ÙŠØ§ Ø®Ø§ØµØ©'
    };
    return benefits[levelId] || 'Ù…Ø²Ø§ÙŠØ§ Ø®Ø§ØµØ©';
}

// Tasks System
function loadTasks() {
    if (tasks.length === 0) {
        tasks = [...defaultTasks];
        saveData();
    }
    displayTasks();
}

function displayTasks() {
    const tasksList = document.getElementById('tasksList');
    if (!tasksList) return;
    
    if (tasks.length === 0) {
        tasksList.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</p>';
        return;
    }

    // Ø¹Ø±Ø¶ 3 Ù…Ù‡Ø§Ù… Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© ÙÙ‚Ø· ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    const randomTasks = [...tasks].sort(() => 0.5 - Math.random()).slice(0, 3);
    
    tasksList.innerHTML = randomTasks.map(task => `
        <div class="task-card">
            <h4>${task.name}</h4>
            <p>${task.description}</p>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                <span class="level-badge level-intermediate">+${task.points} Ù†Ù‚Ø§Ø·</span>
                <button class="btn btn-success" onclick="completeTask(${task.id})" ${!currentMember ? 'disabled' : ''}>
                    ${currentMember ? 'Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ù‡Ù…Ø©' : 'Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø£ÙˆÙ„Ø§Ù‹'}
                </button>
            </div>
        </div>
    `).join('');
}

function showAvailableTasks() {
    const availableTasks = document.getElementById('availableTasks');
    if (!availableTasks) return;
    
    availableTasks.innerHTML = tasks.map(task => `
        <div class="task-card">
            <h4>${task.name}</h4>
            <p>${task.description}</p>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                <span class="level-badge level-intermediate">+${task.points} Ù†Ù‚Ø§Ø·</span>
                <button class="btn btn-success" onclick="completeTask(${task.id})" ${!currentMember ? 'disabled' : ''}>
                    ${currentMember ? 'Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ù‡Ù…Ø©' : 'Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø£ÙˆÙ„Ø§Ù‹'}
                </button>
            </div>
        </div>
    `).join('');
    
    showModal('tasksModal');
}

function completeTask(taskId) {
    if (!currentMember) {
        showMessage('ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹', 'warning');
        return;
    }

    const task = tasks.find(t => t.id === taskId);
    if (task) {
        // Check if task was already completed today (for daily tasks)
        if (task.type === 'daily') {
            const today = new Date().toISOString().split('T')[0];
            const todayTaskCompletion = talantonHistory.find(t => 
                t.memberId === currentMember.id && 
                t.reason.includes(task.name) && 
                t.date === today
            );
            
            if (todayTaskCompletion) {
                showMessage('Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„ÙŠÙˆÙ… Ø¨Ø§Ù„ÙØ¹Ù„', 'warning');
                return;
            }
        }

        currentMember.talanton += task.points;
        
        // Add to Talanton history
        talantonHistory.push({
            id: Date.now(),
            memberId: currentMember.id,
            memberName: currentMember.name,
            amount: task.points,
            type: 'add',
            reason: `Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ù‡Ù…Ø©: ${task.name}`,
            date: new Date().toISOString().split('T')[0],
            timestamp: new Date().toISOString()
        });

        // Update member in array
        const memberIndex = members.findIndex(m => m.id === currentMember.id);
        if (memberIndex !== -1) {
            members[memberIndex] = currentMember;
        }

        saveData();
        showMessage(`Ù…Ø¨Ø±ÙˆÙƒ! Ø£ÙƒÙ…Ù„Øª Ø§Ù„Ù…Ù‡Ù…Ø© ÙˆØ­ØµÙ„Øª Ø¹Ù„Ù‰ ${task.points} Ù†Ù‚Ø·Ø©`, 'success');
        closeModal('tasksModal');
        updateUI();
    }
}

// QR Code Scanner
function showQRScanner() {
    showModal('qrScannerModal');
    if (!qrScanner && typeof Html5Qrcode !== 'undefined') {
        qrScanner = new Html5Qrcode("qrReader");
        qrScanner.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: 250 },
            onQRScanSuccess,
            onQRScanError
        ).catch(err => {
            console.error("QR Scanner error:", err);
            showMessage('ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§', 'error');
        });
    }
}

function onQRScanSuccess(decodedText) {
    const memberId = parseInt(decodedText);
    if (memberId && members.find(m => m.id === memberId)) {
        selectMember(memberId);
        closeQRScanner();
    } else {
        showMessage('QR code ØºÙŠØ± ØµØ§Ù„Ø­', 'error');
    }
}

function onQRScanError(error) {
    // ÙŠÙ…ÙƒÙ† ØªØ¬Ø§Ù‡Ù„ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…Ø³Ø­ØŒ Ù„Ø§ Ø¯Ø§Ø¹ÙŠ Ù„Ø¹Ø±Ø¶Ù‡Ø§ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
}

function closeQRScanner() {
    if (qrScanner) {
        qrScanner.stop().then(() => {
            qrScanner = null;
            closeModal('qrScannerModal');
        }).catch(err => {
            console.error("Failed to stop QR scanner", err);
            qrScanner = null;
            closeModal('qrScannerModal');
        });
    } else {
        closeModal('qrScannerModal');
    }
}

// Enhanced Notifications System
function loadNotifications() {
    const notificationCount = notifications.filter(n => !n.read).length;
    const badge = document.getElementById('notificationCount');
    if (badge) {
        badge.textContent = notificationCount;
        badge.style.display = notificationCount > 0 ? 'flex' : 'none';
    }
}

function showNotifications() {
    const notificationsList = document.getElementById('notificationsList');
    if (!notificationsList) return;
    
    if (notifications.length === 0) {
        notificationsList.innerHTML = '<div class="notification-item">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</div>';
    } else {
        notificationsList.innerHTML = notifications.map(notification => `
            <div class="notification-item ${!notification.read ? 'unread' : ''}">
                <div class="notification-title">${notification.title}</div>
                <p>${notification.message}</p>
                <div class="notification-time">${new Date(notification.timestamp).toLocaleString('ar')}</div>
            </div>
        `).join('');
    }
    
    // ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙƒÙ…Ù‚Ø±ÙˆØ¡Ø©
    notifications = notifications.map(n => ({ ...n, read: true }));
    saveData();
    loadNotifications();
    
    showModal('notificationsModal');
}

function addNotification(title, message, type = 'info') {
    const newNotification = {
        id: Date.now(),
        type: type,
        title: title,
        message: message,
        timestamp: new Date().toISOString(),
        read: false
    };
    
    notifications.unshift(newNotification);
    
    // Keep only last 50 notifications
    if (notifications.length > 50) {
        notifications = notifications.slice(0, 50);
    }
    
    saveData();
    loadNotifications();
}

// Email Notifications
function showEmailSettingsModal() {
    const serviceId = document.getElementById('emailServiceId');
    const templateId = document.getElementById('emailTemplateId');
    const userId = document.getElementById('emailUserId');
    
    if (serviceId) serviceId.value = localStorage.getItem('emailServiceId') || '';
    if (templateId) templateId.value = localStorage.getItem('emailTemplateId') || '';
    if (userId) userId.value = localStorage.getItem('emailUserId') || '';
    
    showModal('emailSettingsModal');
}

function saveEmailSettings() {
    const serviceId = document.getElementById('emailServiceId').value.trim();
    const templateId = document.getElementById('emailTemplateId').value.trim();
    const userId = document.getElementById('emailUserId').value.trim();
    
    localStorage.setItem('emailServiceId', serviceId);
    localStorage.setItem('emailTemplateId', templateId);
    localStorage.setItem('emailUserId', userId);
    
    // ØªÙ‡ÙŠØ¦Ø© EmailJS
    if (serviceId && userId && typeof emailjs !== 'undefined') {
        try {
            emailjs.init(userId);
            showMessage('ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', 'success');
        } catch (error) {
            console.error('EmailJS init error:', error);
            showMessage('Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø®Ø¯Ù…Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', 'error');
        }
    } else {
        showMessage('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', 'success');
    }
    
    closeModal('emailSettingsModal');
}

function testEmailNotifications() {
    const serviceId = localStorage.getItem('emailServiceId');
    const templateId = localStorage.getItem('emailTemplateId');
    
    if (!serviceId || !templateId) {
        showMessage('ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£ÙˆÙ„Ø§Ù‹', 'error');
        return;
    }
    
    if (typeof emailjs === 'undefined') {
        showMessage('Ø®Ø¯Ù…Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©', 'error');
        return;
    }
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø§Ø®ØªØ¨Ø§Ø±ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø¯Ù…Ù†
    const adminEmail = 'admin@example.com';
    emailjs.send(serviceId, templateId, {
        to_email: adminEmail,
        subject: 'Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù†Ø¸Ø§Ù… Talanton',
        message: 'Ù‡Ø°Ø§ Ø¨Ø±ÙŠØ¯ Ø§Ø®ØªØ¨Ø§Ø±ÙŠ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.',
        member_name: 'Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…'
    }).then(() => {
        showMessage('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±ÙŠ Ø¨Ù†Ø¬Ø§Ø­', 'success');
    }).catch(error => {
        console.error('Email error:', error);
        showMessage('ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±ÙŠ', 'error');
    });
}

function sendEmailNotification(member, subject, message) {
    const serviceId = localStorage.getItem('emailServiceId');
    const templateId = localStorage.getItem('emailTemplateId');
    
    if (!serviceId || !templateId || !member.email || typeof emailjs === 'undefined') {
        return; // Ù„Ø§ ØªØ±Ø³Ù„ Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø£Ùˆ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù„Ø¯Ù‰ Ø§Ù„Ø¹Ø¶Ùˆ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
    }
    
    emailjs.send(serviceId, templateId, {
        to_email: member.email,
        subject: subject,
        message: message,
        member_name: member.name
    }).then(() => {
        console.log('Email sent successfully to', member.email);
    }).catch(error => {
        console.error('Email error:', error);
    });
}

// Select member for attendance
function selectMember(memberId) {
    currentMember = members.find(m => m.id === memberId);
    if (currentMember) {
        const attendanceTitle = document.getElementById('attendanceTitle');
        if (attendanceTitle) {
            attendanceTitle.textContent = `ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±: ${currentMember.name}`;
        }
        showModal('attendanceModal');
    }
}

// Simulate fingerprint scan
function simulateFingerprint() {
    const icon = document.querySelector('.fingerprint-icon');
    if (icon) {
        icon.style.color = 'var(--success-color)';
        setTimeout(() => {
            showMessage('ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ØµÙ…Ø© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
            markAttendance();
        }, 1500);
    }
}

// Enhanced Mark attendance
function markAttendance() {
    if (!currentMember) {
        showMessage('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø¶Ùˆ', 'error');
        return;
    }

    const password = document.getElementById('memberPassword').value;
    
    if (password && password !== currentMember.password) {
        showMessage('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!', 'error');
        logSecurityEvent('ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„', currentMember.name, 'ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©');
        return;
    }

    const today = new Date().toISOString().split('T')[0];
    const existingAttendance = attendance.find(a => 
        a.memberId === currentMember.id && a.date === today
    );

    if (existingAttendance) {
        showMessage('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±Ùƒ Ø§Ù„ÙŠÙˆÙ… Ù…Ø³Ø¨Ù‚Ø§Ù‹!', 'warning');
        return;
    }

    // Add attendance record
    attendance.push({
        id: Date.now(),
        memberId: currentMember.id,
        memberName: currentMember.name,
        date: today,
        timestamp: new Date().toISOString()
    });

    // Add Talanton reward for attendance
    const attendanceReward = 10;
    currentMember.talanton += attendanceReward;
    const memberIndex = members.findIndex(m => m.id === currentMember.id);
    if (memberIndex !== -1) {
        members[memberIndex] = currentMember;
    }

    // Add to Talanton history
    talantonHistory.push({
        id: Date.now(),
        memberId: currentMember.id,
        memberName: currentMember.name,
        amount: attendanceReward,
        type: 'add',
        reason: 'Ø­Ø¶ÙˆØ± ÙŠÙˆÙ…ÙŠ',
        date: today,
        timestamp: new Date().toISOString()
    });

    logSecurityEvent('ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ù†Ø§Ø¬Ø­', currentMember.name, 'Ø­Ø¶ÙˆØ± ÙŠÙˆÙ…ÙŠ');
    saveData();

    showMessage(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±Ùƒ Ø¨Ù†Ø¬Ø§Ø­! Ø­ØµÙ„Øª Ø¹Ù„Ù‰ ${attendanceReward} Ù†Ù‚Ø§Ø· Talanton`, 'success');
    closeModal('attendanceModal');
    updateUI();
    
    // Reset form
    const memberPasswordInput = document.getElementById('memberPassword');
    if (memberPasswordInput) memberPasswordInput.value = '';
    const fingerprintIcon = document.querySelector('.fingerprint-icon');
    if (fingerprintIcon) fingerprintIcon.style.color = 'var(--primary-color)';
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
    sendEmailNotification(currentMember, 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±Ùƒ', `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentMember.name}ØŒ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±Ùƒ Ø§Ù„ÙŠÙˆÙ… Ø¨Ù†Ø¬Ø§Ø­ ÙˆØ­ØµÙ„Øª Ø¹Ù„Ù‰ ${attendanceReward} Ù†Ù‚Ø§Ø· Talanton. Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${currentMember.talanton} Ù†Ù‚Ø·Ø©.`);
    
    // Ø¥Ø¶Ø§ÙØ© Ø¥Ø´Ø¹Ø§Ø± ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…
    addNotification('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±', `ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± ${currentMember.name} Ø§Ù„ÙŠÙˆÙ… Ø¨Ù†Ø¬Ø§Ø­`);
}

// Show member profile
function showMemberProfile() {
    if (!currentMember) return;

    const memberAttendance = attendance.filter(a => a.memberId === currentMember.id);
    const memberTalantonHistory = talantonHistory.filter(t => t.memberId === currentMember.id);
    const level = calculateLevel(currentMember.talanton);

    const profileTitle = document.getElementById('profileTitle');
    const profileContent = document.getElementById('profileContent');
    
    if (profileTitle) profileTitle.textContent = `Ù…Ù„Ù ${currentMember.name}`;
    if (profileContent) {
        profileContent.innerHTML = `
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number">${currentMember.talanton}</div>
                    <div class="stat-label">Ø±ØµÙŠØ¯ Talanton</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${memberAttendance.length}</div>
                    <div class="stat-label">Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">#${currentMember.id}</div>
                    <div class="stat-label">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${new Date(currentMember.joinDate).toLocaleDateString('ar')}</div>
                    <div class="stat-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</div>
                </div>
            </div>
            <div style="text-align: center; margin: 20px 0;">
                <span class="level-badge ${level.color}">${level.name}</span>
            </div>
            <h3>Ø¢Ø®Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª:</h3>
            <div class="table-container">
                ${memberTalantonHistory.slice(-5).reverse().map(t => `
                    <div style="padding: 15px; border-bottom: 1px solid var(--border-color); background: var(--card-color); margin-bottom: 10px; border-radius: 8px;">
                        <strong style="color: ${t.type === 'add' ? 'var(--success-color)' : 'var(--danger-color)'};">
                            ${t.type === 'add' ? '+' : '-'}${t.amount}
                        </strong> - ${t.reason} 
                        <small style="color: var(--text-color); opacity: 0.7;">(${new Date(t.date).toLocaleDateString('ar')})</small>
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    closeModal('attendanceModal');
    showModal('profileModal');
}

// Show Talanton Store
function showTalantonStore() {
    if (!currentMember) return;

    const memberBalance = document.getElementById('memberBalance');
    const storeItems = document.getElementById('storeItems');
    
    if (memberBalance) {
        memberBalance.textContent = `Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${currentMember.talanton} Ù†Ù‚Ø·Ø© Talanton`;
    }

    if (storeItems) {
        storeItems.innerHTML = products.map(product => `
            <div class="product-card">
                <h3>${product.name}</h3>
                <div class="product-price">${product.price} Ù†Ù‚Ø·Ø©</div>
                <p>${product.description}</p>
                <button class="btn ${currentMember.talanton >= product.price ? 'btn-success' : ''}" 
                        onclick="buyProduct(${product.id})"
                        ${currentMember.talanton < product.price ? 'disabled' : ''}>
                    ${currentMember.talanton >= product.price ? 'Ø´Ø±Ø§Ø¡' : 'Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙŠ'}
                </button>
            </div>
        `).join('');
    }

    closeModal('profileModal');
    showModal('storeModal');
}

// Enhanced Buy product
function buyProduct(productId) {
    const product = products.find(p => p.id === productId);
    if (!product || !currentMember) return;

    if (currentMember.talanton < product.price) {
        showMessage('Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠ Ù„Ø´Ø±Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬!', 'error');
        return;
    }

    if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø´Ø±Ø§Ø¡ ${product.name} Ù…Ù‚Ø§Ø¨Ù„ ${product.price} Ù†Ù‚Ø·Ø©ØŸ`)) {
        return;
    }

    // Deduct Talanton
    currentMember.talanton -= product.price;
    const memberIndex = members.findIndex(m => m.id === currentMember.id);
    if (memberIndex !== -1) {
        members[memberIndex] = currentMember;
    }

    // Add to history
    talantonHistory.push({
        id: Date.now(),
        memberId: currentMember.id,
        memberName: currentMember.name,
        amount: product.price,
        type: 'deduct',
        reason: `Ø´Ø±Ø§Ø¡: ${product.name}`,
        date: new Date().toISOString().split('T')[0],
        timestamp: new Date().toISOString()
    });

    saveData();
    showMessage(`ØªÙ… Ø´Ø±Ø§Ø¡ ${product.name} Ø¨Ù†Ø¬Ø§Ø­!`, 'success');
    showTalantonStore(); // Refresh store
    updateUI();
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
    sendEmailNotification(currentMember, 'ØªÙ…Øª Ø¹Ù…Ù„ÙŠØ© Ø´Ø±Ø§Ø¡', `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentMember.name}ØŒ ØªÙ… Ø´Ø±Ø§Ø¡ ${product.name} Ù…Ù‚Ø§Ø¨Ù„ ${product.price} Ù†Ù‚Ø·Ø© Talanton. Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${currentMember.talanton} Ù†Ù‚Ø·Ø©.`);
    
    // Ø¥Ø¶Ø§ÙØ© Ø¥Ø´Ø¹Ø§Ø± ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…
    addNotification('ØªÙ…Øª Ø¹Ù…Ù„ÙŠØ© Ø´Ø±Ø§Ø¡', `Ù‚Ø§Ù… ${currentMember.name} Ø¨Ø´Ø±Ø§Ø¡ ${product.name}`);
}

// Admin Functions
function showAdminLogin() {
    showModal('adminLoginModal');
}

function adminLogin() {
    const password = document.getElementById('adminPassword').value;
    if (password === 'admin123') {
        isAdmin = true;
        const mainContent = document.getElementById('mainContent');
        const adminPanel = document.getElementById('adminPanel');
        
        if (mainContent) mainContent.style.display = 'none';
        if (adminPanel) adminPanel.style.display = 'block';
        
        closeModal('adminLoginModal');
        loadAdminData();
        logSecurityEvent('Ø¯Ø®ÙˆÙ„ Ø£Ø¯Ù…Ù† Ù†Ø§Ø¬Ø­', 'Admin', 'ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…');
        showMessage('Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù†!', 'success');
        
        // Ø¥Ø¶Ø§ÙØ© Ø¥Ø´Ø¹Ø§Ø±
        addNotification('ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†', 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…');
    } else {
        logSecurityEvent('ÙØ´Ù„ Ø¯Ø®ÙˆÙ„ Ø£Ø¯Ù…Ù†', 'Unknown', 'ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©');
        showMessage('ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©!', 'error');
    }
    document.getElementById('adminPassword').value = '';
}

function logoutAdmin() {
    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
        isAdmin = false;
        currentMember = null;
        const mainContent = document.getElementById('mainContent');
        const adminPanel = document.getElementById('adminPanel');
        
        if (mainContent) mainContent.style.display = 'block';
        if (adminPanel) adminPanel.style.display = 'none';
        
        logSecurityEvent('Ø®Ø±ÙˆØ¬ Ø£Ø¯Ù…Ù†', 'Admin', 'ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…');
        showMessage('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        updateUI();
    }
}

// Utility Functions
function showMessage(message, type = 'info') {
    const messageDiv = document.createElement('div');
    messageDiv.className = `${type}-message`;
    messageDiv.textContent = message;
    
    document.body.appendChild(messageDiv);
    
    setTimeout(() => {
        messageDiv.remove();
    }, 3000);
}

function showModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'block';
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
    }
}

function updateUI() {
    displayMembers();
    displayTopMembers();
    checkBirthdays();
    updateStats();
    displayTasks();
}

function updateStats() {
    const today = new Date().toISOString().split('T')[0];
    const presentToday = attendance.filter(a => a.date === today).length;
    const totalTalanton = members.reduce((sum, member) => sum + member.talanton, 0);
    
    // Calculate weekly attendance rate
    const weekStart = new Date();
    weekStart.setDate(weekStart.getDate() - 7);
    const weekStartStr = weekStart.toISOString().split('T')[0];
    
    const weeklyAttendanceRecords = attendance.filter(a => a.date >= weekStartStr);
    const uniqueMembers = new Set(weeklyAttendanceRecords.map(a => a.memberId)).size;
    const weeklyAttendanceRate = members.length > 0 ? Math.round((uniqueMembers / members.length) * 100) : 0;
    
    const totalMembersEl = document.getElementById('totalMembers');
    const presentTodayEl = document.getElementById('presentToday');
    const totalTalantonEl = document.getElementById('totalTalanton');
    const weeklyAttendanceEl = document.getElementById('weeklyAttendance');
    
    if (totalMembersEl) totalMembersEl.textContent = members.length;
    if (presentTodayEl) presentTodayEl.textContent = presentToday;
    if (totalTalantonEl) totalTalantonEl.textContent = totalTalanton;
    if (weeklyAttendanceEl) weeklyAttendanceEl.textContent = `${weeklyAttendanceRate}%`;
}

function logSecurityEvent(action, user, details) {
    securityLogs.push({
        id: Date.now(),
        action: action,
        user: user,
        details: details,
        timestamp: new Date().toISOString(),
        ip: 'localhost' // In a real app, you'd get the actual IP
    });
    saveData();
}

function checkUpcomingEvents() {
    const today = new Date();
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    
    const upcomingEvents = events.filter(event => {
        const eventDate = new Date(event.date);
        return eventDate.toDateString() === tomorrow.toDateString();
    });
    
    upcomingEvents.forEach(event => {
        addNotification('Ù…Ù†Ø§Ø³Ø¨Ø© Ù‚Ø§Ø¯Ù…Ø©', `ØºØ¯Ø§Ù‹: ${event.name} - ${event.description}`);
    });
}

// Admin panel functions (simplified versions)
function loadAdminData() {
    loadMembersTable();
    updateTalantonMemberSelect();
    updateBirthdayMemberSelect();
    loadStoreProducts();
    loadTalantonHistory();
    loadWeeksList();
    loadEventsList();
    loadBirthdaysList();
    loadSecurityLogs();
}

function loadMembersTable() {
    const table = document.getElementById('membersTable');
    if (!table) return;
    
    table.innerHTML = `
        <table class="table">
            <thead>
                <tr>
                    <th>Ø§Ù„Ø±Ù‚Ù…</th>
                    <th>Ø§Ù„Ø§Ø³Ù…</th>
                    <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
                    <th>Talanton</th>
                    <th>Ø§Ù„Ù…Ø³ØªÙˆÙ‰</th>
                    <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</th>
                    <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</th>
                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody>
                ${members.map(member => {
                    const level = calculateLevel(member.talanton);
                    return `
                        <tr>
                            <td>${member.id}</td>
                            <td>${member.name}</td>
                            <td>${member.email || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                            <td>${member.talanton}</td>
                            <td><span class="level-badge ${level.color}">${level.name}</span></td>
                            <td>${member.birthday ? new Date(member.birthday).toLocaleDateString('ar') : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                            <td>${new Date(member.joinDate).toLocaleDateString('ar')}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-warning" onclick="editMember(${member.id})">ØªØ¹Ø¯ÙŠÙ„</button>
                                    <button class="btn btn-danger" onclick="deleteMember(${member.id})">Ø­Ø°Ù</button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('')}
            </tbody>
        </table>
    `;
}

function showAddMemberModal() {
    showModal('addMemberModal');
}

function addMember(event) {
    event.preventDefault();
    
    const name = document.getElementById('memberName').value.trim();
    const password = document.getElementById('memberPass').value.trim();
    const email = document.getElementById('memberEmail').value.trim();
    const birthday = document.getElementById('memberBirthday').value;
    const initialTalanton = parseInt(document.getElementById('initialTalanton').value) || 0;

    if (!name || !password) {
        showMessage('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'error');
        return;
    }

    const newId = Math.max(...members.map(m => m.id), 0) + 1;
    const newMember = {
        id: newId,
        name: name,
        password: password,
        email: email,
        birthday: birthday,
        talanton: initialTalanton,
        joinDate: new Date().toISOString().split('T')[0]
    };

    members.push(newMember);
    saveData();

    showMessage('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø¶Ùˆ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
    closeModal('addMemberModal');
    loadMembersTable();
    updateUI();
    
    // Reset form
    document.getElementById('memberName').value = '';
    document.getElementById('memberPass').value = '';
    document.getElementById('memberEmail').value = '';
    document.getElementById('memberBirthday').value = '';
    document.getElementById('initialTalanton').value = '0';
}

function showTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });

    // Show selected tab
    const targetTab = document.getElementById(tabName + 'Tab');
    if (targetTab) targetTab.classList.add('active');
    
    // Find and activate the clicked button
    event.target.classList.add('active');
}

// Simplified admin functions (you can expand these as needed)
function loadTalantonHistory() {
    const container = document.getElementById('talantonHistory');
    if (!container) return;
    
    container.innerHTML = `
        <table class="table">
            <thead>
                <tr>
                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th>Ø§Ù„Ø¹Ø¶Ùˆ</th>
                    <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                    <th>Ø§Ù„Ù†ÙˆØ¹</th>
                    <th>Ø§Ù„Ø³Ø¨Ø¨</th>
                </tr>
            </thead>
            <tbody>
                ${talantonHistory.slice(-20).reverse().map(record => `
                    <tr>
                        <td>${new Date(record.date).toLocaleDateString('ar')}</td>
                        <td>${record.memberName}</td>
                        <td style="color: ${record.type === 'add' ? 'var(--success-color)' : 'var(--danger-color)'};">
                            ${record.type === 'add' ? '+' : '-'}${record.amount}
                        </td>
                        <td>${record.type === 'add' ? 'Ø¥Ø¶Ø§ÙØ©' : 'Ø®ØµÙ…'}</td>
                        <td>${record.reason}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

function loadStoreProducts() {
    const container = document.getElementById('storeProducts');
    if (!container) return;
    
    container.innerHTML = products.map(product => `
        <div class="product-card">
            <h3>${product.name}</h3>
            <div class="product-price">${product.price} Ù†Ù‚Ø·Ø©</div>
            <p>${product.description}</p>
            <div class="action-buttons">
                <button class="btn btn-warning" onclick="editProduct(${product.id})">ØªØ¹Ø¯ÙŠÙ„</button>
                <button class="btn btn-danger" onclick="deleteProduct(${product.id})">Ø­Ø°Ù</button>
            </div>
        </div>
    `).join('');
}

function loadWeeksList() {
    const container = document.getElementById('weeksList');
    if (!container) return;
    
    container.innerHTML = `
        <table class="table">
            <thead>
                <tr>
                    <th>Ø§Ø³Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</th>
                    <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</th>
                    <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</th>
                    <th>Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©</th>
                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody>
                ${weeks.map(week => `
                    <tr>
                        <td>${week.name}</td>
                        <td>${new Date(week.startDate).toLocaleDateString('ar')}</td>
                        <td>${new Date(week.endDate).toLocaleDateString('ar')}</td>
                        <td>${week.reward} Ù†Ù‚Ø·Ø©</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-warning" onclick="editWeek(${week.id})">ØªØ¹Ø¯ÙŠÙ„</button>
                                <button class="btn btn-danger" onclick="deleteWeek(${week.id})">Ø­Ø°Ù</button>
                            </div>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

function loadEventsList() {
    const container = document.getElementById('eventsList');
    if (!container) return;
    
    container.innerHTML = `
        <table class="table">
            <thead>
                <tr>
                    <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©</th>
                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th>Ø§Ù„ÙˆØµÙ</th>
                    <th>Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©</th>
                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody>
                ${events.map(event => `
                    <tr>
                        <td>${event.name}</td>
                        <td>${new Date(event.date).toLocaleDateString('ar')}</td>
                        <td>${event.description}</td>
                        <td>${event.reward} Ù†Ù‚Ø·Ø©</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-warning" onclick="editEvent(${event.id})">ØªØ¹Ø¯ÙŠÙ„</button>
                                <button class="btn btn-danger" onclick="deleteEvent(${event.id})">Ø­Ø°Ù</button>
                            </div>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

function loadBirthdaysList() {
    const container = document.getElementById('birthdaysList');
    if (!container) return;
    
    const membersWithBirthdays = members.filter(m => m.birthday);
    
    container.innerHTML = `
        <table class="table">
            <thead>
                <tr>
                    <th>Ø§Ù„Ø§Ø³Ù…</th>
                    <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</th>
                    <th>Ø§Ù„Ø¹Ù…Ø±</th>
                </tr>
            </thead>
            <tbody>
                ${membersWithBirthdays.map(member => {
                    const birthday = new Date(member.birthday);
                    const age = new Date().getFullYear() - birthday.getFullYear();
                    return `
                        <tr>
                            <td>${member.name}</td>
                            <td>${birthday.toLocaleDateString('ar')}</td>
                            <td>${age} Ø³Ù†Ø©</td>
                        </tr>
                    `;
                }).join('')}
            </tbody>
        </table>
    `;
}

function loadSecurityLogs() {
    const container = document.getElementById('securityLogs');
    if (!container) return;
    
    container.innerHTML = `
        <table class="table">
            <thead>
                <tr>
                    <th>Ø§Ù„ÙˆÙ‚Øª</th>
                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                    <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                    <th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
                </tr>
            </thead>
            <tbody>
                ${securityLogs.slice(-20).reverse().map(log => `
                    <tr>
                        <td>${new Date(log.timestamp).toLocaleString('ar')}</td>
                        <td>${log.action}</td>
                        <td>${log.user}</td>
                        <td>${log.details}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

function updateTalantonMemberSelect() {
    const select = document.getElementById('talantonMember');
    if (!select) return;
    
    select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ø¶Ùˆ</option>' + 
        members.map(member => `<option value="${member.id}">${member.name}</option>`).join('');
}

function updateBirthdayMemberSelect() {
    const select = document.getElementById('birthdayMember');
    if (!select) return;
    
    select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ø¶Ùˆ</option>' + 
        members.map(member => `<option value="${member.id}">${member.name}</option>`).join('');
}

function showTalantonModal() {
    updateTalantonMemberSelect();
    showModal('talantonModal');
}

function manageTalanton() {
    const memberId = parseInt(document.getElementById('talantonMember').value);
    const action = document.getElementById('talantonAction').value;
    const amount = parseInt(document.getElementById('talantonAmount').value);
    const reason = document.getElementById('talantonReason').value.trim();

    if (!memberId || !amount || !reason) {
        showMessage('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„', 'error');
        return;
    }

    const member = members.find(m => m.id === memberId);
    if (!member) {
        showMessage('Ø§Ù„Ø¹Ø¶Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
        return;
    }

    if (action === 'add') {
        member.talanton += amount;
    } else {
        if (member.talanton < amount) {
            showMessage('Ø±ØµÙŠØ¯ Ø§Ù„Ø¹Ø¶Ùˆ ØºÙŠØ± ÙƒØ§ÙÙŠ', 'error');
            return;
        }
        member.talanton -= amount;
    }

    // Add to history
    talantonHistory.push({
        id: Date.now(),
        memberId: member.id,
        memberName: member.name,
        amount: amount,
        type: action,
        reason: reason,
        date: new Date().toISOString().split('T')[0],
        timestamp: new Date().toISOString()
    });

    saveData();
    showMessage(`ØªÙ… ${action === 'add' ? 'Ø¥Ø¶Ø§ÙØ©' : 'Ø®ØµÙ…'} ${amount} Ù†Ù‚Ø·Ø© ${action === 'add' ? 'Ø¥Ù„Ù‰' : 'Ù…Ù†'} ${member.name}`, 'success');
    closeModal('talantonModal');
    loadTalantonHistory();
    updateUI();
    
    // Reset form
    document.getElementById('talantonMember').value = '';
    document.getElementById('talantonAmount').value = '';
    document.getElementById('talantonReason').value = '';
}

// Placeholder functions for other admin operations
function editMember(id) { showMessage('Ù…ÙŠØ²Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø³ØªÙƒÙˆÙ† Ù…ØªØ§Ø­Ø© Ù‚Ø±ÙŠØ¨Ø§Ù‹', 'info'); }
function deleteMember(id) { 
    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶ÙˆØŸ')) {
        members = members.filter(m => m.id !== id);
        saveData();
        loadMembersTable();
        updateUI();
        showMessage('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ø¶Ùˆ', 'success');
    }
}
function editProduct(id) { showMessage('Ù…ÙŠØ²Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø³ØªÙƒÙˆÙ† Ù…ØªØ§Ø­Ø© Ù‚Ø±ÙŠØ¨Ø§Ù‹', 'info'); }
function deleteProduct(id) {
    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ')) {
        products = products.filter(p => p.id !== id);
        saveData();
        loadStoreProducts();
        showMessage('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬', 'success');
    }
}
function editWeek(id) { showMessage('Ù…ÙŠØ²Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø³ØªÙƒÙˆÙ† Ù…ØªØ§Ø­Ø© Ù‚Ø±ÙŠØ¨Ø§Ù‹', 'info'); }
function deleteWeek(id) {
    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ØŸ')) {
        weeks = weeks.filter(w => w.id !== id);
        saveData();
        loadWeeksList();
        showMessage('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹', 'success');
    }
}
function editEvent(id) { showMessage('Ù…ÙŠØ²Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø³ØªÙƒÙˆÙ† Ù…ØªØ§Ø­Ø© Ù‚Ø±ÙŠØ¨Ø§Ù‹', 'info'); }
function deleteEvent(id) {
    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©ØŸ')) {
        events = events.filter(e => e.id !== id);
        saveData();
        loadEventsList();
        showMessage('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©', 'success');
    }
}

function showAddProductModal() { showModal('addProductModal'); }
function showAddWeekModal() { showModal('addWeekModal'); }
function showAddEventModal() { showModal('addEventModal'); }
function showAddBirthdayModal() { 
    updateBirthdayMemberSelect();
    showModal('addBirthdayModal'); 
}

function addProduct(event) {
    event.preventDefault();
    
    const name = document.getElementById('productName').value.trim();
    const price = parseInt(document.getElementById('productPrice').value);
    const description = document.getElementById('productDescription').value.trim();

    if (!name || !price) {
        showMessage('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'error');
        return;
    }

    const newId = Math.max(...products.map(p => p.id), 0) + 1;
    products.push({
        id: newId,
        name: name,
        price: price,
        description: description
    });

    saveData();
    showMessage('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
    closeModal('addProductModal');
    loadStoreProducts();
    
    // Reset form
    document.getElementById('productName').value = '';
    document.getElementById('productPrice').value = '';
    document.getElementById('productDescription').value = '';
}

function addWeek(event) {
    event.preventDefault();
    
    const name = document.getElementById('weekName').value.trim();
    const startDate = document.getElementById('weekStartDate').value;
    const endDate = document.getElementById('weekEndDate').value;
    const reward = parseInt(document.getElementById('weekReward').value);

    if (!name || !startDate || !endDate) {
        showMessage('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„', 'error');
        return;
    }

    const newId = Math.max(...weeks.map(w => w.id), 0) + 1;
    weeks.push({
        id: newId,
        name: name,
        startDate: startDate,
        endDate: endDate,
        reward: reward
    });

    saveData();
    showMessage('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
    closeModal('addWeekModal');
    loadWeeksList();
    
    // Reset form
    document.getElementById('weekName').value = '';
    document.getElementById('weekStartDate').value = '';
    document.getElementById('weekEndDate').value = '';
    document.getElementById('weekReward').value = '50';
}

function addEvent(event) {
    event.preventDefault();
    
    const name = document.getElementById('eventName').value.trim();
    const date = document.getElementById('eventDate').value;
    const description = document.getElementById('eventDescription').value.trim();
    const reward = parseInt(document.getElementById('eventReward').value);

    if (!name || !date) {
        showMessage('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'error');
        return;
    }

    const newId = Math.max(...events.map(e => e.id), 0) + 1;
    events.push({
        id: newId,
        name: name,
        date: date,
        description: description,
        reward: reward
    });

    saveData();
    showMessage('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
    closeModal('addEventModal');
    loadEventsList();
    
    // Reset form
    document.getElementById('eventName').value = '';
    document.getElementById('eventDate').value = '';
    document.getElementById('eventDescription').value = '';
    document.getElementById('eventReward').value = '0';
}

function addBirthday() {
    const memberId = parseInt(document.getElementById('birthdayMember').value);
    const birthdayDate = document.getElementById('birthdayDate').value;

    if (!memberId || !birthdayDate) {
        showMessage('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„', 'error');
        return;
    }

    const member = members.find(m => m.id === memberId);
    if (member) {
        member.birthday = birthdayDate;
        saveData();
        showMessage('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¹ÙŠØ¯ Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
        closeModal('addBirthdayModal');
        loadBirthdaysList();
    }
}

function showAddTaskModal() {
    showModal('addTaskModal');
}

function addTask(event) {
    event.preventDefault();
    
    const name = document.getElementById('taskName').value.trim();
    const description = document.getElementById('taskDescription').value.trim();
    const points = parseInt(document.getElementById('taskPoints').value);
    const type = document.getElementById('taskType').value;

    if (!name || points <= 0) {
        showMessage('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­', 'error');
        return;
    }

    const newId = Math.max(...tasks.map(t => t.id), 0) + 1;
    const newTask = {
        id: newId,
        name: name,
        description: description,
        points: points,
        type: type
    };

    tasks.push(newTask);
    saveData();

    showMessage('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
    closeModal('addTaskModal');
    displayTasks();
    
    // Reset form
    document.getElementById('taskName').value = '';
    document.getElementById('taskDescription').value = '';
    document.getElementById('taskPoints').value = '';
    document.getElementById('taskType').value = 'daily';
}

// Export functions (simplified)
function exportData(type, format) {
    let data;
    let filename;
    
    switch(type) {
        case 'members':
            data = members;
            filename = 'members';
            break;
        case 'talanton':
            data = talantonHistory;
            filename = 'talanton_history';
            break;
        case 'products':
            data = products;
            filename = 'products';
            break;
        case 'security':
            data = securityLogs;
            filename = 'security_logs';
            break;
        default:
            showMessage('Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…', 'error');
            return;
    }
    
    if (format === 'json') {
        const dataStr = JSON.stringify(data, null, 2);
        downloadFile(dataStr, `${filename}.json`, 'application/json');
    } else if (format === 'csv') {
        const csv = convertToCSV(data);
        downloadFile(csv, `${filename}.csv`, 'text/csv');
    } else {
        showMessage('ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØµØ¯ÙŠØ± ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… Ø­Ø§Ù„ÙŠØ§Ù‹', 'info');
    }
}

function convertToCSV(data) {
    if (data.length === 0) return '';
    
    const headers = Object.keys(data[0]);
    const csvContent = [
        headers.join(','),
        ...data.map(row => headers.map(header => `"${row[header] || ''}"`).join(','))
    ].join('\n');
    
    return csvContent;
}

function downloadFile(content, filename, contentType) {
    const blob = new Blob([content], { type: contentType });
    const url = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    link.click();
    window.URL.revokeObjectURL(url);
    
    showMessage(`ØªÙ… ØªØµØ¯ÙŠØ± ${filename} Ø¨Ù†Ø¬Ø§Ø­`, 'success');
}

function generateMemberReport() {
    if (!currentMember) return;
    
    const memberAttendance = attendance.filter(a => a.memberId === currentMember.id);
    const memberHistory = talantonHistory.filter(t => t.memberId === currentMember.id);
    
    const report = {
        member: currentMember,
        totalAttendance: memberAttendance.length,
        totalEarned: memberHistory.filter(t => t.type === 'add').reduce((sum, t) => sum + t.amount, 0),
        totalSpent: memberHistory.filter(t => t.type === 'deduct').reduce((sum, t) => sum + t.amount, 0),
        level: calculateLevel(currentMember.talanton),
        recentActivity: memberHistory.slice(-10)
    };
    
    const reportContent = `
ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ø¶Ùˆ: ${report.member.name}
Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ: ${report.member.id}
Ø§Ù„Ù…Ø³ØªÙˆÙ‰: ${report.level.name}
Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${report.member.talanton} Ù†Ù‚Ø·Ø©
Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±: ${report.totalAttendance}
Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…ÙƒØªØ³Ø¨Ø©: ${report.totalEarned}
Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©: ${report.totalSpent}
ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…: ${new Date(report.member.joinDate).toLocaleDateString('ar')}

Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø£Ø®ÙŠØ±:
${report.recentActivity.map(activity => 
    `${new Date(activity.date).toLocaleDateString('ar')}: ${activity.type === 'add' ? '+' : '-'}${activity.amount} - ${activity.reason}`
).join('\n')}
    `;
    
    downloadFile(reportContent, `ØªÙ‚Ø±ÙŠØ±_${report.member.name}.txt`, 'text/plain');
}

function generateMonthlyReport() {
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();
    
    const monthlyAttendance = attendance.filter(a => {
        const date = new Date(a.date);
        return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
    });
    
    const monthlyTalanton = talantonHistory.filter(t => {
        const date = new Date(t.date);
        return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
    });
    
    const report = `
Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ - ${now.toLocaleDateString('ar', { year: 'numeric', month: 'long' })}

Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­Ø¶ÙˆØ±:
- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±: ${monthlyAttendance.length}
- Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø­Ø§Ø¶Ø±ÙŠÙ†: ${new Set(monthlyAttendance.map(a => a.memberId)).size}
- Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±: ${Math.round((new Set(monthlyAttendance.map(a => a.memberId)).size / members.length) * 100)}%

Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ù‚Ø§Ø·:
- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø¶Ø§ÙØ©: ${monthlyTalanton.filter(t => t.type === 'add').reduce((sum, t) => sum + t.amount, 0)}
- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©: ${monthlyTalanton.filter(t => t.type === 'deduct').reduce((sum, t) => sum + t.amount, 0)}
- Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª: ${monthlyTalanton.length}

Ø£ÙØ¶Ù„ 5 Ø£Ø¹Ø¶Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±:
${members.sort((a, b) => b.talanton - a.talanton).slice(0, 5).map((member, index) => 
    `${index + 1}. ${member.name}: ${member.talanton} Ù†Ù‚Ø·Ø©`
).join('\n')}
    `;
    
    downloadFile(report, `Ø§Ù„ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ø´Ù‡Ø±ÙŠ_${now.getFullYear()}_${now.getMonth() + 1}.txt`, 'text/plain');
    showMessage('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ', 'success');
}
