<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù†Ø¸Ø§Ù… Ø­Ø¶ÙˆØ± Talanton â€” ÙƒØ§Ù…Ù„ + Firebase</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --primary:#6366f1; --accent:#8b5cf6; --success:#10b981; --warning:#f59e0b; --danger:#ef4444;
    --light-bg:#f8fafc; --light-surface:#ffffff; --light-card:#f1f5f9; --text-dark:#0f172a;
    --dark-bg:#0b1220; --dark-surface:#0f172a; --dark-card:#111827; --text-light:#e6eef8;
  }
  [data-theme="light"]{ --bg:var(--light-bg); --surface:var(--light-surface); --card:var(--light-card); --text:var(--text-dark); }
  [data-theme="dark"]{ --bg:var(--dark-bg); --surface:var(--dark-surface); --card:var(--dark-card); --text:var(--text-light); }
  html,body{height:100%; margin:0; font-family: "Segoe UI", Tahoma, Arial; background:var(--bg); color:var(--text);}
  .container{max-width:1200px;margin:20px auto;padding:18px;}
  .header{background:linear-gradient(135deg,var(--primary),var(--accent));padding:22px;border-radius:12px;color:white;text-align:center;}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin:14px 0}
  .btn{background:var(--primary);color:white;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
  .btn.secondary{background:#64748b}
  .btn.success{background:var(--success)}
  .btn.warning{background:var(--warning)}
  .btn.danger{background:var(--danger)}
  .card{background:var(--card);padding:18px;border-radius:12px;margin-bottom:16px; color:var(--text); box-shadow:0 6px 18px rgba(0,0,0,0.12)}
  .modal{display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:9999;align-items:center;justify-content:center}
  .modal .content{background:var(--surface);padding:18px;border-radius:12px;min-width:320px;max-width:760px; color:var(--text)}
  .form-group{margin-bottom:12px}
  input, select, textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.1);background:transparent;color:var(--text)}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px;border-bottom:1px solid rgba(0,0,0,0.08);text-align:right}
  th{background:linear-gradient(90deg,var(--primary),var(--accent));color:#fff}
  .notification{position:fixed;top:18px;left:18px;padding:12px 16px;border-radius:8px;color:#fff;z-index:10010}
  .hidden{display:none}
  @media(max-width:800px){ .controls{flex-direction:column} }
</style>
</head>
<body data-theme="light">
  <div class="container">
    <div class="header">
      <h1>ğŸŒŸ Ù†Ø¸Ø§Ù… Ø­Ø¶ÙˆØ± Talanton (Ù…Ø±Ø¨ÙˆØ· Ø¨Ù€ Firebase)</h1>
      <p id="firebaseStatus">ğŸ”´ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¹Ø¯ Ø¨Ù€ Firebase...</p>
    </div>

    <div class="controls">
      <button class="btn" onclick="toggleTheme()">ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹</button>
      <button class="btn" onclick="showAdminLogin()">ğŸ‘‘ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†</button>
      <button class="btn" onclick="showMemberLoginModal()">ğŸ‘¤ Ø¯Ø®ÙˆÙ„ Ø¹Ø¶Ùˆ</button>
      <button class="btn secondary" onclick="generateQRCodes()">ğŸ“± Ø¥Ù†Ø´Ø§Ø¡ QR</button>
    </div>

    <div id="mainContent">
      <div class="card">
        <h2>ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø©</h2>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-top:12px">
          <div class="card" style="background:linear-gradient(90deg,var(--primary),var(--accent));color:white;text-align:center">
            <div id="totalMembers">0</div><div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</div>
          </div>
          <div class="card" style="text-align:center">
            <div id="presentToday">0</div><div>Ø§Ù„Ø­Ø§Ø¶Ø±ÙˆÙ† Ø§Ù„ÙŠÙˆÙ…</div>
          </div>
          <div class="card" style="text-align:center">
            <div id="totalTalanton">0</div><div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Talanton</div>
          </div>
          <div class="card" style="text-align:center">
            <div id="weeklyAttendance">0%</div><div>Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</div>
          </div>
        </div>
      </div>

      <div id="birthdayAlerts"></div>

      <div class="card">
        <h2>ğŸ‘¥ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ù„Ø­Ø¶ÙˆØ±</h2>
        <select id="memberDropdown"></select>
        <div style="margin-top:12px">
          <button class="btn success" onclick="showAttendanceModal()">âœ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±</button>
        </div>
      </div>

      <div class="card">
        <h2>ğŸ“ˆ Ø±Ø³ÙˆÙ… Ø§Ù„Ø­Ø¶ÙˆØ± (Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…)</h2>
        <div style="height:300px">
          <canvas id="attendanceChart"></canvas>
        </div>
      </div>

    </div>

    <!-- Member panel -->
    <div id="memberPanel" class="hidden card">
      <h2>ğŸ‘¤ Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ø¶Ùˆ</h2>
      <div id="memberDashboard"></div>
      <div style="margin-top:12px">
        <button class="btn danger" onclick="logoutMember()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>

    <!-- Admin panel -->
    <div id="adminPanel" class="hidden card">
      <h2>ğŸ‘‘ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù†</h2>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">
        <button class="btn" onclick="showAddMemberModal()">â• Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ</button>
        <button class="btn" onclick="showAddProductModal()">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</button>
        <button class="btn" onclick="showMembersReport()">ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø£Ø¹Ø¶Ø§Ø¡</button>
        <button class="btn" onclick="exportData()">ğŸ’¾ ØªØµØ¯ÙŠØ±</button>
        <button class="btn" onclick="importData()">ğŸ“ Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
      </div>

      <div>
        <h3>ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</h3>
        <div id="membersTable"></div>
      </div>

      <div style="margin-top:16px">
        <h3>ğŸ›’ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªØ¬Ø±</h3>
        <div id="productsTable"></div>
      </div>
    </div>
  </div>

  <!-- Modals (login, add, attendance, purchase) -->
  <div id="adminLoginModal" class="modal">
    <div class="content">
      <h3>ğŸ” Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†</h3>
      <div class="form-group"><input id="adminPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" type="password"></div>
      <div style="display:flex;gap:8px"><button class="btn" onclick="adminLogin()">Ø¯Ø®ÙˆÙ„</button><button class="btn secondary" onclick="closeModal('adminLoginModal')">Ø¥ØºÙ„Ø§Ù‚</button></div>
    </div>
  </div>

  <div id="memberLoginModal" class="modal">
    <div class="content">
      <h3>ğŸ‘¤ Ø¯Ø®ÙˆÙ„ Ø¹Ø¶Ùˆ</h3>
      <div class="form-group"><select id="memberLoginDropdown"></select></div>
      <div class="form-group"><input id="memberLoginPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" type="password"></div>
      <div style="display:flex;gap:8px"><button class="btn" onclick="memberLogin()">Ø¯Ø®ÙˆÙ„</button><button class="btn secondary" onclick="closeModal('memberLoginModal')">Ø¥ØºÙ„Ø§Ù‚</button></div>
    </div>
  </div>

  <div id="addMemberModal" class="modal">
    <div class="content">
      <h3>â• Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ</h3>
      <form id="addMemberForm">
        <div class="form-group"><input id="memberName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø¶Ùˆ" required></div>
        <div class="form-group"><input id="memberPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required></div>
        <div class="form-group"><input id="memberEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"></div>
        <div class="form-group"><input id="memberPhone" placeholder="Ø§Ù„Ù‡Ø§ØªÙ"></div>
        <div class="form-group"><input id="memberBirthday" type="date" placeholder="ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯"></div>
        <div class="form-group"><input id="initialTalanton" type="number" placeholder="Ù†Ù‚Ø§Ø· Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©" value="100"></div>
        <div class="form-group"><select id="memberService"><option value="altar">Ø®Ø¯Ù…Ø© Ø§Ù„Ù…Ø°Ø¨Ø­</option><option value="sunday_school">Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø£Ø­Ø¯</option><option value="youth">Ø®Ø¯Ù…Ø© Ø§Ù„Ø´Ø¨Ø§Ø¨</option><option value="music">Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰</option><option value="media">Ø§Ù„Ø¥Ø¹Ù„Ø§Ù…</option><option value="social">Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©</option><option value="other">Ø£Ø®Ø±Ù‰</option></select></div>
        <div class="form-group"><input id="memberArea" placeholder="Ø§Ù„Ù…Ù†Ø·Ù‚Ø©"></div>
        <div style="display:flex;gap:8px"><button class="btn" type="submit">Ø¥Ø¶Ø§ÙØ©</button><button class="btn secondary" type="button" onclick="closeModal('addMemberModal')">Ø¥ØºÙ„Ø§Ù‚</button></div>
      </form>
    </div>
  </div>

  <div id="addProductModal" class="modal">
    <div class="content">
      <h3>â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</h3>
      <form id="addProductForm">
        <div class="form-group"><input id="productName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" required></div>
        <div class="form-group"><input id="productPrice" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø¨Ø§Ù„Ù†Ù‚Ø§Ø·" required></div>
        <div class="form-group"><input id="productStock" type="number" placeholder="Ø§Ù„Ù…Ø®Ø²ÙˆÙ†" required></div>
        <div class="form-group"><input id="productCategory" placeholder="Ø§Ù„ÙØ¦Ø©"></div>
        <div class="form-group"><textarea id="productDescription" placeholder="Ø§Ù„ÙˆØµÙ"></textarea></div>
        <div style="display:flex;gap:8px"><button class="btn" type="submit">Ø¥Ø¶Ø§ÙØ©</button><button class="btn secondary" type="button" onclick="closeModal('addProductModal')">Ø¥ØºÙ„Ø§Ù‚</button></div>
      </form>
    </div>
  </div>

  <div id="attendanceModal" class="modal">
    <div class="content">
      <h3 id="attendanceTitle">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±</h3>
      <div class="form-group"><input id="memberPassword" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø´Ø®ØµÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></div>
      <div class="form-group">
        <select id="attendanceType"><option value="regular">Ø­Ø¶ÙˆØ± Ø¹Ø§Ø¯ÙŠ</option><option value="late">Ù…ØªØ£Ø®Ø±</option><option value="early">Ù…Ø¨ÙƒØ±</option><option value="makeup">ØªØ¹ÙˆÙŠØ¶ÙŠ</option></select>
      </div>
      <div class="form-group"><textarea id="attendanceNotes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª"></textarea></div>
      <div style="display:flex;gap:8px"><button class="btn success" onclick="markAttendance()">ØªØ³Ø¬ÙŠÙ„</button><button class="btn secondary" onclick="closeModal('attendanceModal')">Ø¥ØºÙ„Ø§Ù‚</button></div>
    </div>
  </div>

  <div id="purchaseModal" class="modal">
    <div class="content">
      <h3 id="purchaseTitle">Ø´Ø±Ø§Ø¡ Ù…Ù†ØªØ¬</h3>
      <div id="purchaseDetails"></div>
      <div style="display:flex;gap:8px;margin-top:12px"><button class="btn success" onclick="confirmPurchase()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø±Ø§Ø¡</button><button class="btn secondary" onclick="closeModal('purchaseModal')">Ø¥Ù„ØºØ§Ø¡</button></div>
    </div>
  </div>

  <!-- Notification container (left) -->
  <div id="notifRoot" style="position:fixed;left:20px;top:20px;z-index:11000"></div>

<script type="module">
/* ========== Firebase init ========== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc,
  onSnapshot, query, orderBy, where, getDoc, setDoc
} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBHso7dhJC7P_akMQQ0oN_8ZMTQqsRoVbY",
  authDomain: "angel-meeting-attendance.firebaseapp.com",
  projectId: "angel-meeting-attendance",
  storageBucket: "angel-meeting-attendance.firebasestorage.app",
  messagingSenderId: "100624957418",
  appId: "1:100624957418:web:291d087797cec9ec79fc93",
  measurementId: "G-2TTXV6CD8F"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ========== State ========== */
let members = [], products = [], attendance = [], talantonHistory = [], tasks = [], occasions = [], weeks = [], settings = {};
let currentMember = null, isAdmin = false, isMemberLoggedIn = false;
let attendanceChart = null;

/* ========== UI helpers ========== */
function showModal(id){ const m=document.getElementById(id); if(m) m.style.display='flex'; }
function closeModal(id){ const m=document.getElementById(id); if(m) m.style.display='none'; }
function showNotification(message, type='info'){
  const root=document.getElementById('notifRoot');
  const n=document.createElement('div');
  n.className='notification';
  n.style.background = type==='success'? '#16a34a' : type==='error'? '#dc2626' : type==='warning'? '#f59e0b' : '#0ea5e9';
  n.textContent = message;
  root.appendChild(n);
  setTimeout(()=> n.remove(), 4500);
}
function toggleTheme(){
  const body=document.body; const cur=body.getAttribute('data-theme')||'light'; const nxt = cur==='light'?'dark':'light'; body.setAttribute('data-theme',nxt);
  showNotification(`ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ ${nxt==='light'?'Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ':'Ø§Ù„Ù„ÙŠÙ„ÙŠ'}`,'success');
}

/* ========== Firestore realtime listeners ========== */
async function initializeRealtime(){
  try{
    const membersQ = query(collection(db,'members'), orderBy('name'));
    onSnapshot(membersQ, snap => {
      members = []; snap.forEach(d=> members.push({ id: d.id, ...d.data() }));
      updateUIComplete();
    });

    const productsQ = query(collection(db,'products'), orderBy('name'));
    onSnapshot(productsQ, snap => {
      products = []; snap.forEach(d=> products.push({ id: d.id, ...d.data() }));
      updateUIComplete();
    });

    const attendanceQ = query(collection(db,'attendance'), orderBy('timestamp','desc'));
    onSnapshot(attendanceQ, snap => {
      attendance = []; snap.forEach(d=> attendance.push({ id: d.id, ...d.data() }));
      updateStats(); updateCharts();
    });

    const talQ = query(collection(db,'talantonHistory'), orderBy('timestamp','desc'));
    onSnapshot(talQ, snap => {
      talantonHistory = []; snap.forEach(d=> talantonHistory.push({ id: d.id, ...d.data() }));
      if(isMemberLoggedIn) loadMemberDashboard();
    });

    const tasksQ = query(collection(db,'tasks'), orderBy('priority','desc'));
    onSnapshot(tasksQ, snap => { tasks=[]; snap.forEach(d=> tasks.push({id:d.id,...d.data()})); });

    const occQ = query(collection(db,'occasions'), orderBy('date','desc'));
    onSnapshot(occQ, snap => { occasions=[]; snap.forEach(d=> occasions.push({id:d.id,...d.data()})); loadTodayOccasions(); });

    const weeksQ = query(collection(db,'weeks'));
    onSnapshot(weeksQ, snap => { weeks=[]; snap.forEach(d=> weeks.push({id:d.id,...d.data()})); });

    const settingsQ = query(collection(db,'settings'));
    onSnapshot(settingsQ, snap => {
      settings = { dailyAttendancePoints:10, taskCompletionPoints:5, birthdayAlertDays:7, maxAbsenceDays:3 };
      snap.forEach(d=> settings = { ...settings, ...d.data() });
      updateUIComplete();
    });

    document.getElementById('firebaseStatus').textContent = 'ğŸŸ¢ Ù…ØªØµÙ„ Ø¨Ù€ Firebase';
  }catch(e){
    console.error('init realtime error', e);
    showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase','error');
  }
}

/* ========== Initial data load (in case onSnapshot didn't fill yet) ========== */
async function initialLoadOnce(){
  await initializeRealtime();
}

/* ========== UI Update functions ========== */
function updateUIComplete(){
  loadMemberDropdown();
  loadMemberLoginDropdown();
  loadStoreDisplay();
  loadLeaderboard();
  loadMembersTable();
  loadProductsTable();
  updateStats();
  checkBirthdays();
  updateCharts();
  if(isAdmin) document.getElementById('adminPanel').classList.remove('hidden');
}

/* statistics */
function updateStats(){
  document.getElementById('totalMembers').textContent = members.length;
  const today = new Date().toISOString().split('T')[0];
  const present = attendance.filter(a => a.date === today).length;
  document.getElementById('presentToday').textContent = present;
  const totalTal = members.reduce((s,m)=> s + (m.talanton||0), 0);
  document.getElementById('totalTalanton').textContent = totalTal;
  const weekStart = new Date(); weekStart.setDate(weekStart.getDate()-6);
  const weekAttendance = attendance.filter(a => new Date(a.date) >= new Date(weekStart.toISOString().split('T')[0]));
  const weeklyRate = members.length>0 ? Math.round((weekAttendance.length / (members.length*7))*100) : 0;
  document.getElementById('weeklyAttendance').textContent = weeklyRate + '%';
}

/* load dropdowns */
function loadMemberDropdown(){
  const sel=document.getElementById('memberDropdown');
  if(!sel) return;
  sel.innerHTML = `<option value="">Ø§Ø®ØªØ± Ø¹Ø¶Ùˆ...</option>` + members.map(m=>`<option value="${m.id}">${m.sequentialNumber||''} ${m.name} (${m.talanton||0})</option>`).join('');
}
function loadMemberLoginDropdown(){
  const sel=document.getElementById('memberLoginDropdown');
  if(!sel) return;
  sel.innerHTML = `<option value="">Ø§Ø®ØªØ± Ø¹Ø¶Ùˆ...</option>` + members.map(m=>`<option value="${m.id}">${m.name}</option>`).join('');
}

/* store display */
function loadStoreDisplay(){
  // Not in main UI to avoid big output, purchase done via admin/member pages - left placeholder
}

/* leaderboard */
function loadLeaderboard(){
  // placeholder for future
}

/* members table (admin) */
function loadMembersTable(){
  const root=document.getElementById('membersTable');
  if(!root) return;
  root.innerHTML = `
    <table>
      <thead><tr><th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Talanton</th><th>Ø§Ù„Ø®Ø¯Ù…Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
      <tbody>
        ${members.map((m,idx)=>`<tr>
          <td>${m.sequentialNumber||idx+1}</td>
          <td>${m.name}</td>
          <td>${m.email||''}</td>
          <td>${m.phone||''}</td>
          <td>${m.talanton||0}</td>
          <td>${m.service||''}</td>
          <td>
            <button onclick="editMember('${m.id}')" class="btn warning">âœï¸</button>
            <button onclick="addTalantonToMember('${m.id}')" class="btn info">ğŸ’°</button>
            <button onclick="deleteMember('${m.id}')" class="btn danger">ğŸ—‘ï¸</button>
          </td>
        </tr>`).join('')}
      </tbody>
    </table>
  `;
}

/* products table (admin) */
function loadProductsTable(){
  const root=document.getElementById('productsTable');
  if(!root) return;
  root.innerHTML = `
    <table>
      <thead><tr><th>#</th><th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</th><th>Ø§Ù„ÙØ¦Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
      <tbody>
        ${products.map((p,idx)=>`<tr>
          <td>${idx+1}</td>
          <td>${p.name}</td>
          <td>${p.price||0}</td>
          <td>${p.stock||0}</td>
          <td>${p.category||''}</td>
          <td>
            <button onclick="editProduct('${p.id}')" class="btn warning">âœï¸</button>
            <button onclick="deleteProduct('${p.id}')" class="btn danger">ğŸ—‘ï¸</button>
          </td>
        </tr>`).join('')}
      </tbody>
    </table>
  `;
}

/* birthdays & occasions */
function checkBirthdays(){
  const root=document.getElementById('birthdayAlerts');
  if(!root) return; root.innerHTML='';
  const today=new Date();
  const alerts = members.filter(m => {
    if(!m.birthday) return false;
    const b = new Date(m.birthday);
    const thisYear = new Date(today.getFullYear(), b.getMonth(), b.getDate());
    const diff = Math.ceil((thisYear - today)/(1000*60*60*24));
    return diff>=0 && diff <= (settings.birthdayAlertDays||7);
  });
  if(alerts.length){
    root.innerHTML = alerts.map(a=>`<div class="card" style="background:linear-gradient(90deg,var(--warning),#f97316)">${a.name} - Ø¹ÙŠØ¯ Ù…ÙŠÙ„Ø§Ø¯ Ø®Ù„Ø§Ù„ Ø£ÙŠØ§Ù…</div>`).join('');
  }
}

/* charts */
function initializeCharts(){
  updateCharts();
}
function updateCharts(){
  const ctx = document.getElementById('attendanceChart');
  if(!ctx) return;
  // destroy existing
  if(attendanceChart){ attendanceChart.destroy(); attendanceChart=null; }
  const labels=[]; const data=[];
  for(let i=6;i>=0;i--){ const d=new Date(); d.setDate(d.getDate()-i); const s=d.toISOString().split('T')[0]; labels.push(d.toLocaleDateString('ar',{weekday:'short'})); data.push(attendance.filter(a=>a.date===s).length); }
  attendanceChart = new Chart(ctx,{ type:'line', data:{ labels, datasets:[{ label:'Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ø¶Ø±ÙŠÙ†', data, tension:0.4, fill:true }] }, options:{responsive:true, maintainAspectRatio:false} });
}

/* quick attendance modal open */
function showAttendanceModal(){
  const sel = document.getElementById('memberDropdown').value;
  if(!sel){ showNotification('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø¶Ùˆ Ø£ÙˆÙ„Ø§Ù‹','warning'); return; }
  currentMember = members.find(m=>m.id===sel);
  if(!currentMember){ showNotification('Ø§Ù„Ø¹Ø¶Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯','error'); return; }
  document.getElementById('attendanceTitle').textContent = `ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±: ${currentMember.name}`;
  showModal('attendanceModal');
}

/* generate QR placeholder */
function generateQRCodes(){ let txt='QR ÙƒÙˆØ¯Ø§Øª Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡:\\n'; members.forEach(m=> txt += `${m.sequentialNumber||'~'}.${m.name} -> QR-${m.id}\\n`); alert(txt); showNotification('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ QR (Ù‚Ø§Ù„Ø¨)'); }

/* ========== CRUD actions ========== */

/* Add member */
document.getElementById('addMemberForm').addEventListener('submit', async function(e){
  e.preventDefault();
  const newMember = {
    name: document.getElementById('memberName').value.trim(),
    password: document.getElementById('memberPass').value.trim(),
    email: document.getElementById('memberEmail').value.trim(),
    phone: document.getElementById('memberPhone').value.trim(),
    birthday: document.getElementById('memberBirthday').value || null,
    talanton: parseInt(document.getElementById('initialTalanton').value) || 0,
    service: document.getElementById('memberService').value || 'other',
    area: document.getElementById('memberArea').value || '',
    joinDate: new Date().toISOString().split('T')[0],
    status: 'active'
  };
  try{
    await addDoc(collection(db,'members'), newMember);
    closeModal('addMemberModal');
    showNotification('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø¶Ùˆ Ø¨Ù†Ø¬Ø§Ø­','success');
  }catch(err){ console.error(err); showNotification('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø¶Ùˆ','error'); }
});

/* Add product */
document.getElementById('addProductForm').addEventListener('submit', async function(e){
  e.preventDefault();
  const newProduct = {
    name: document.getElementById('productName').value.trim(),
    price: parseInt(document.getElementById('productPrice').value) || 0,
    stock: parseInt(document.getElementById('productStock').value) || 0,
    category: document.getElementById('productCategory').value || '',
    description: document.getElementById('productDescription').value || ''
  };
  try{
    await addDoc(collection(db,'products'), newProduct);
    closeModal('addProductModal');
    showNotification('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬','success');
  }catch(err){ console.error(err); showNotification('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬','error'); }
});

/* edit / delete members */
async function editMember(memberId){
  const m = members.find(x=>x.id===memberId);
  if(!m) return;
  const newName = prompt('Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:', m.name);
  if(newName && newName.trim()!==m.name){
    await updateDoc(doc(db,'members',memberId), { name: newName.trim() });
    showNotification('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ø¹Ø¶Ùˆ','success');
  }
}
async function deleteMember(memberId){
  if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¹Ø¶ÙˆØŸ')) return;
  try{ await deleteDoc(doc(db,'members',memberId)); showNotification('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ø¶Ùˆ','success'); }catch(e){ console.error(e); showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù','error'); }
}

/* edit / delete products */
async function editProduct(productId){
  const p = products.find(x=>x.id===productId);
  if(!p) return;
  const newName = prompt('Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯:', p.name);
  if(newName && newName.trim()!==p.name){
    await updateDoc(doc(db,'products',productId), { name: newName.trim() });
    showNotification('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬','success');
  }
}
async function deleteProduct(productId){
  if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ØŸ')) return;
  try{ await deleteDoc(doc(db,'products',productId)); showNotification('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬','success'); }catch(e){ console.error(e); showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù','error'); }
}

/* add talanton to member */
async function addTalantonToMember(memberId){
  const m = members.find(x=>x.id===memberId);
  if(!m) return;
  const points = parseInt(prompt('Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø· Ù„Ù„Ø¥Ø¶Ø§ÙØ©:', '10'));
  const reason = prompt('Ø§Ù„Ø³Ø¨Ø¨:', 'Ø­Ø§ÙØ²');
  if(points && !isNaN(points)){
    await updateDoc(doc(db,'members',memberId), { talanton: (m.talanton||0) + points });
    await addDoc(collection(db,'talantonHistory'), { memberId, memberName:m.name, amount: points, type: 'add', reason, date: new Date().toISOString().split('T')[0], timestamp: new Date().toISOString() });
    showNotification('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ù‚Ø§Ø·','success');
  }
}

/* mark attendance */
async function markAttendance(){
  if(!currentMember){ showNotification('Ø§Ù„Ø¹Ø¶Ùˆ ØºÙŠØ± Ù…Ø­Ø¯Ø¯','warning'); return; }
  const pwd = document.getElementById('memberPassword').value;
  if(pwd && pwd !== currentMember.password){ showNotification('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©','error'); return; }
  const type = document.getElementById('attendanceType').value;
  const notes = document.getElementById('attendanceNotes').value;
  const today = new Date().toISOString().split('T')[0];
  // check existing
  const exists = attendance.find(a=> a.memberId === currentMember.id && a.date === today);
  if(exists){ showNotification('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ… Ù…Ø³Ø¨Ù‚Ù‹Ø§','warning'); return; }
  try{
    const base = settings.dailyAttendancePoints || 10;
    let reward = base;
    if(type === 'early') reward += 5;
    else if(type === 'late') reward -= 3;
    else if(type === 'makeup') reward = Math.floor(reward * 0.7);
    await addDoc(collection(db,'attendance'), { memberId: currentMember.id, memberName: currentMember.name, date: today, type, notes, timestamp: new Date().toISOString() });
    await updateDoc(doc(db,'members', currentMember.id), { talanton: (currentMember.talanton||0) + reward });
    await addDoc(collection(db,'talantonHistory'), { memberId: currentMember.id, memberName: currentMember.name, amount: reward, type: 'add', reason: `Ø­Ø¶ÙˆØ± ${type}`, date: today, timestamp: new Date().toISOString() });
    showNotification(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±. Ø­ØµÙ„Øª Ø¹Ù„Ù‰ ${reward} Ù†Ù‚Ø·Ø©`,'success');
    closeModal('attendanceModal');
    document.getElementById('memberPassword').value=''; document.getElementById('attendanceNotes').value='';
  }catch(e){ console.error(e); showNotification('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±','error'); }
}

/* purchase flow */
let currentProduct = null;
function showPurchaseModal(productId){
  if(!isMemberLoggedIn || !currentMember){ showNotification('Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ ÙƒØ¹Ø¶Ùˆ Ø£ÙˆÙ„Ø§Ù‹','warning'); return; }
  currentProduct = products.find(p=>p.id===productId);
  if(!currentProduct){ showNotification('Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯','error'); return; }
  if(currentProduct.stock <= 0){ showNotification('Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ØªÙˆÙØ±','warning'); return; }
  if((currentMember.talanton||0) < (currentProduct.price||0)){ showNotification('Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ','warning'); return; }
  document.getElementById('purchaseTitle').textContent = `Ø´Ø±Ø§Ø¡: ${currentProduct.name}`;
  document.getElementById('purchaseDetails').innerHTML = `<p>${currentProduct.description||''}</p><p>Ø§Ù„Ø³Ø¹Ø±: ${currentProduct.price} Ù†Ù‚Ø·Ø©</p><p>Ø±ØµÙŠØ¯Ùƒ: ${currentMember.talanton}</p>`;
  showModal('purchaseModal');
}
async function confirmPurchase(){
  if(!currentProduct || !currentMember) return;
  try{
    // re-fetch to avoid race
    const pSnap = await getDoc(doc(db,'products',currentProduct.id));
    const mSnap = await getDoc(doc(db,'members',currentMember.id));
    const pData = pSnap.data(); const mData = mSnap.data();
    if(!pData || !mData){ showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª','error'); return; }
    if(pData.stock <= 0){ showNotification('Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ØªÙˆÙØ±','warning'); return; }
    if((mData.talanton||0) < (pData.price||0)){ showNotification('Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙ','warning'); return; }
    await updateDoc(doc(db,'members', currentMember.id), { talanton: (mData.talanton||0) - pData.price });
    await updateDoc(doc(db,'products', currentProduct.id), { stock: (pData.stock||0) - 1 });
    await addDoc(collection(db,'talantonHistory'), { memberId: currentMember.id, memberName: currentMember.name, amount: pData.price, type: 'subtract', reason:`Ø´Ø±Ø§Ø¡ ${pData.name}`, date: new Date().toISOString().split('T')[0], timestamp: new Date().toISOString() });
    await addDoc(collection(db,'purchases'), { memberId: currentMember.id, memberName: currentMember.name, productId: currentProduct.id, productName: currentProduct.name, price: pData.price, date: new Date().toISOString().split('T')[0], timestamp: new Date().toISOString() });
    showNotification('ØªÙ… Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­','success');
    closeModal('purchaseModal');
  }catch(e){ console.error(e); showNotification('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø´Ø±Ø§Ø¡','error'); }
}

/* authentication flows */
function showAdminLogin(){ showModal('adminLoginModal'); }
function showMemberLoginModal(){ showModal('memberLoginModal'); }
async function adminLogin(){
  const pw = document.getElementById('adminPassword').value;
  if(['admin123','admin','superadmin2024'].includes(pw)){
    isAdmin = true; document.getElementById('adminPanel').classList.remove('hidden'); document.getElementById('mainContent').classList.add('hidden'); closeModal('adminLoginModal'); showNotification('Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø£Ø¯Ù…Ù†','success');
  } else showNotification('ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©','error');
  document.getElementById('adminPassword').value='';
}
async function memberLogin(){
  const id = document.getElementById('memberLoginDropdown').value;
  const pw = document.getElementById('memberLoginPassword').value;
  if(!id){ showNotification('Ø§Ø®ØªØ± Ø¹Ø¶Ùˆ','warning'); return; }
  const m = members.find(x=>x.id===id);
  if(!m){ showNotification('Ø¹Ø¶Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯','error'); return; }
  if(m.password !== pw){ showNotification('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©','error'); return; }
  currentMember = m; isMemberLoggedIn = true;
  document.getElementById('memberPanel').classList.remove('hidden'); document.getElementById('mainContent').classList.add('hidden');
  closeModal('memberLoginModal'); showNotification(`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${m.name}`,'success');
  loadMemberDashboard();
  document.getElementById('memberLoginPassword').value='';
}
function logoutMember(){ if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')){ isMemberLoggedIn=false; currentMember=null; document.getElementById('memberPanel').classList.add('hidden'); document.getElementById('mainContent').classList.remove('hidden'); showNotification('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬','success'); } }
function logoutAdmin(){ if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')){ isAdmin=false; document.getElementById('adminPanel').classList.add('hidden'); document.getElementById('mainContent').classList.remove('hidden'); showNotification('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬','success'); } }

/* member dashboard */
function loadMemberDashboard(){
  if(!currentMember) return;
  const root = document.getElementById('memberDashboard');
  const memberAttendance = attendance.filter(a=>a.memberId === currentMember.id);
  const recentHistory = talantonHistory.filter(h=>h.memberId === currentMember.id).slice(0,5);
  root.innerHTML = `
    <div class="card">
      <h3>${currentMember.name}</h3>
      <p>Ù†Ù‚Ø§Ø·: ${currentMember.talanton||0}</p>
      <p>Ø§Ù„Ø®Ø¯Ù…Ø©: ${currentMember.service||''}</p>
      <p>Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙƒÙ„ÙŠ: ${memberAttendance.length}</p>
      <div style="margin-top:8px">
        <button class="btn" onclick="showMyHistory()">Ø³Ø¬Ù„ Ø§Ù„Ù†Ù‚Ø§Ø·</button>
        <button class="btn" onclick="showMyTasks()">Ù…Ù‡Ø§Ù…ÙŠ</button>
      </div>
    </div>
    <div class="card">
      <h4>Ø¢Ø®Ø± Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</h4>
      ${recentHistory.map(h=>`<div style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.05)">${h.reason} â€” ${h.type==='add'?'+':''}${h.amount}</div>`).join('')}
    </div>
    <div class="card">
      <h4>Ù…ØªØ¬Ø±</h4>
      ${products.map(p=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid rgba(255,255,255,0.02)"><div><strong>${p.name}</strong><div style="opacity:0.8">${p.description||''}</div></div><div><div>${p.price} Ù†Ù‚Ø·Ø©</div><div><button class="btn" onclick="showPurchaseModal('${p.id}')">Ø´Ø±Ø§Ø¡</button></div></div></div>`).join('')}
    </div>
  `;
}

/* reports / misc */
function showMyHistory(){
  if(!currentMember) return;
  const hist = talantonHistory.filter(h=>h.memberId === currentMember.id);
  if(hist.length===0) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª');
  alert(hist.map(h=>`${h.date} | ${h.reason} | ${h.type==='add'?'+':''}${h.amount}`).join('\\n'));
}
function showMyTasks(){ const t = tasks.filter(t=> t.assignedService==='all' || (currentMember && t.assignedService===currentMember.service)); alert(t.length? t.map(x=>x.title).join('\\n') : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù…'); }
function showMembersReport(){ alert(`Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡: ${members.length}\\nØ¥Ø¬Ù…Ø§Ù„ÙŠ Ù†Ù‚Ø§Ø·: ${members.reduce((s,m)=>s+(m.talanton||0),0)}`); }

/* export / import */
function exportData(){
  const data = { members, products, attendance, talantonHistory, tasks, occasions, weeks, settings };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'church_system_backup.json'; a.click();
  showNotification('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª','success');
}
function importData(){
  const input = document.createElement('input'); input.type='file'; input.accept='.json';
  input.onchange = async (e) => {
    const file = e.target.files[0]; if(!file) return;
    const text = await file.text(); try{
      const data = JSON.parse(text);
      if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø¥Ù„Ù‰ Firestore)ØŸ')) return;
      // add collections in a simple manner (could be refined)
      for(const m of (data.members||[])) await addDoc(collection(db,'members'), m);
      for(const p of (data.products||[])) await addDoc(collection(db,'products'), p);
      for(const a of (data.attendance||[])) await addDoc(collection(db,'attendance'), a);
      for(const h of (data.talantonHistory||[])) await addDoc(collection(db,'talantonHistory'), h);
      showNotification('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø¨Ù†Ø¬Ø§Ø­ Ù†Ø³Ø¨ÙŠ)','success');
    }catch(err){ console.error(err); showNotification('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù','error'); }
  };
  input.click();
}

/* utility small features */
function loadTodayOccasions(){ const root=document.getElementById('birthdayAlerts'); /* reuse birthdayAlerts for simple messages */ }

/* Initialize */
window.addEventListener('load', async ()=>{
  document.body.setAttribute('data-theme','light');
  await initialLoadOnce();
  initializeCharts();
});

/* helper getDoc used in confirmPurchase */
import { getDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
</script>
</body>
</html>
