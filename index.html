<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script>
    let weeks = [
        {id:1, name:'الاسبوع الاول', from:'2025-08-29', to:'2025-08-29'}
    ];
    
    let members = [];
    let attendanceRecords = [];
    let rewards = [];
    
    const adminPass = 'admin123';
    
    let db = null;
    let isFirebaseConnected = false;

    function initializeFirebase() {
        try {
            const firebaseConfig = {
                apiKey: "AIzaSyEXAMPLEEXAMPLEEXAMPLEEXAMPLE",
                authDomain: "your-project-id.firebaseapp.com",
                databaseURL: "https://your-project-id-default-rtdb.firebaseio.com/",
                projectId: "your-project-id",
                storageBucket: "your-project-id.appspot.com",
                messagingSenderId: "1234567890",
                appId: "1:1234567890:web:abc123def456"
            };
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            isFirebaseConnected = true;
            document.getElementById('firebaseStatus').textContent = '✓ متصل بقاعدة البيانات';
            document.getElementById('firebaseStatus').className = 'firebase-status firebase-connected';
            loadDataFromFirebase();
        } catch (error) {
            console.error('خطأ في تهيئة Firebase:', error);
            document.getElementById('firebaseStatus').textContent = '✗ غير متصل بقاعدة البيانات';
            document.getElementById('firebaseStatus').className = 'firebase-status firebase-disconnected';
            loadFromLocalStorage();
        }
    }

    async function loadDataFromFirebase() {
        if (!isFirebaseConnected) return;
        showLoading();
        try {
            const snapshot = await db.ref().once('value');
            const data = snapshot.val();
            members = data?.members || [];
            weeks = data?.weeks || weeks;
            attendanceRecords = data?.attendanceRecords || [];
            rewards = data?.rewards || [];
            saveToLocalStorage();
            populateData();
            updateReports();
            hideLoading();
            showNotification('تم تحميل البيانات من السحابة');
        } catch (error) {
            console.error('خطأ في تحميل البيانات من Firebase:', error);
            loadFromLocalStorage();
            hideLoading();
        }
    }

    async function saveToFirebase() {
        if (!isFirebaseConnected) return;
        try {
            await db.ref().set({members, weeks, attendanceRecords, rewards});
            showNotification('تم حفظ البيانات في السحابة');
        } catch (error) {
            console.error('خطأ في حفظ البيانات إلى Firebase:', error);
            showNotification('خطأ في حفظ البيانات إلى السحابة', false);
        }
    }

    function showLoading(){ document.getElementById('loading').style.display='block'; }
    function hideLoading(){ document.getElementById('loading').style.display='none'; }
    function showNotification(msg, success=true){
        const n=document.getElementById('notification');
        n.textContent=msg;
        n.style.background=success?'#2ecc71':'#e74c3c';
        n.style.display='block';
        setTimeout(()=>{n.style.display='none';},3000);
    }
    function saveToLocalStorage(){ localStorage.setItem('angelsAttendance', JSON.stringify({members,weeks,attendanceRecords,rewards})); }
    function loadFromLocalStorage(){
        const data=JSON.parse(localStorage.getItem('angelsAttendance'));
        if(data){ members=data.members||members; weeks=data.weeks||weeks; attendanceRecords=data.attendanceRecords||attendanceRecords; rewards=data.rewards||rewards; }
        populateData(); updateReports();
    }

    // تابع populateData() تابع populateAdminTables() تابع populateAttendanceRecords() ... كل التوابع كما هي من الكود الأصلي
    // فقط استبدل أي saveToFirebase() و loadDataFromFirebase() حسب الدوال الجديدة أعلاه

    // عند بدء التشغيل
    document.addEventListener('DOMContentLoaded', () => { initializeFirebase(); });
</script>
