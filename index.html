<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام حضور خدام الملايكة - Talanton</title>
    <link rel="icon" href="https://public-frontend-cos.metadl.com/mgx/img/favicon.png" type="image/png">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- QR Code Scanner -->
    <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
    <!-- EmailJS -->
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3.2.0/dist/email.min.js"></script>
    <!-- Firebase SDK v9 -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getDatabase, ref, set, get, push, remove, onValue } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';
        import { getAnalytics } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBCQIqdCsxSvhfYOs00AetoVWpFhj4XNAQ",
            authDomain: "angels-attendance.firebaseapp.com",
            databaseURL: "https://angels-attendance-default-rtdb.firebaseio.com",
            projectId: "angels-attendance",
            storageBucket: "angels-attendance.appspot.com",
            messagingSenderId: "157249026489",
            appId: "1:157249026489:web:db2b420203bd81d9a19e68",
            measurementId: "G-2YDPSFPQYT"
        };
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        window.firebaseDb = database;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebaseGet = get;
        window.firebasePush = push;
        window.firebaseRemove = remove;
        window.firebaseOnValue = onValue;
        window.firebaseAuth = auth;
        window.firebaseCreateUser = createUserWithEmailAndPassword;
        window.firebaseSignIn = signInWithEmailAndPassword;
        window.firebaseSignOut = signOut;
    </script>
    <style>
        body {
            background: #f7fafc;
            color: #22223b;
            font-family: 'Cairo', Arial, sans-serif;
            margin: 0;
            padding: 0;
            direction: rtl;
        }
        header {
            background: #22223b;
            color: #fff;
            padding: 1rem;
        }
        h1, h2, h3 {
            margin: 0.5rem 0;
        }
        .stat-card {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 8px #e9ecef;
            padding: 1rem 2rem;
            min-width: 180px;
            text-align: center;
        }
        .stat-label {
            font-size: 1rem;
            color: #575757;
        }
        .stat-number {
            font-size: 1.5rem;
            color: #446;
            font-weight: bold;
        }
        .btn {
            padding: 0.6rem 1.5rem;
            margin: 0.2rem;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            background: #4e54c8;
            color: #fff;
            transition: background 0.2s;
        }
        .btn:hover {
            background: #373a7a;
        }
        .btn-danger {
            background: #c8464e;
        }
        .btn-danger:hover {
            background: #7a2d34;
        }
        .btn-primary {
            background: #4e54c8;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 99;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background: rgba(34,34,59,0.2);
        }
        .modal-content {
            background: #fff;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            position: relative;
        }
        .close {
            color: #c8464e;
            float: left;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            margin-right: 0.5rem;
        }
        .tab-btn {
            padding: 0.5rem 1rem;
            background: #eee;
            border: none;
            margin: 0.2rem;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
            font-weight: bold;
        }
        .tab-btn.active {
            background: #4e54c8;
            color: #fff;
        }
        .tab-content {
            display: none;
            padding: 1rem 0;
        }
        .tab-content.active {
            display: block;
        }
        input, select {
            width: 100%;
            padding: 0.5rem;
            margin: 0.4rem 0 1rem 0;
            border-radius: 5px;
            border: 1px solid #ddd;
            box-sizing: border-box;
            font-size: 1rem;
        }
        #mainContent section {
            margin: 2rem 0;
        }
    </style>
</head>
<body data-theme="light" data-language="ar">
<header>
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem;">
        <h1 style="margin: 0;">نظام حضور خدام الملايكة - Talanton</h1>
        <div>
            <button id="themeIcon" onclick="toggleTheme()" title="تغيير الوضع">🌙</button>
            <button id="languageText" onclick="toggleLanguage()" title="تغيير اللغة">English</button>
            <button onclick="showNotifications()" title="الإشعارات">🔔</button>
            <button onclick="showAdminLogin()" title="لوحة تحكم الأدمن">🛡️</button>
        </div>
    </div>
</header>

<main id="mainContent">
    <section>
        <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
            <div class="stat-card">
                <div class="stat-label">إجمالي الأعضاء</div>
                <div id="totalMembers" class="stat-number">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">الحضور اليوم</div>
                <div id="presentToday" class="stat-number">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">إجمالي نقاط Talanton</div>
                <div id="totalTalanton" class="stat-number">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">نسبة الحضور الأسبوعي</div>
                <div id="weeklyAttendance" class="stat-number">0%</div>
            </div>
        </div>
    </section>

    <section>
        <h2>أعضاء الخدمة</h2>
        <input id="memberSearch" type="text" placeholder="ابحث عن عضو..." style="width: 100%; max-width: 400px; margin: 1rem 0;">
        <div id="membersList" style="display: flex; flex-wrap: wrap; gap: 1rem;"></div>
        <button class="btn btn-primary" onclick="showAddMemberModal()">إضافة عضو جديد</button>
    </section>

    <section>
        <h2>أفضل الأعضاء</h2>
        <div id="topMembersList" style="display: flex; flex-wrap: wrap; gap: 1rem;"></div>
    </section>

    <section>
        <h2>المتجر</h2>
        <button class="btn btn-primary" onclick="showTalantonStore()">فتح المتجر</button>
        <div id="storeItems"></div>
    </section>

    <section>
        <h2>المهام اليومية/الأسبوعية</h2>
        <div id="tasksList"></div>
        <button class="btn btn-primary" onclick="showAvailableTasks()">عرض المهام المتاحة</button>
    </section>
</main>

<!-- لوحة تحكم الأدمن -->
<div id="adminPanel" style="display: none;">
    <div style="margin-bottom: 1rem;">
        <button class="tab-btn active" onclick="showTab('members', this)">الأعضاء</button>
        <button class="tab-btn" onclick="showTab('talanton', this)">النقاط</button>
        <button class="tab-btn" onclick="showTab('store', this)">المتجر</button>
        <button class="tab-btn" onclick="showTab('events', this)">المناسبات</button>
        <button class="tab-btn" onclick="showTab('weeks', this)">الأسابيع</button>
        <button class="tab-btn" onclick="showTab('birthdays', this)">أعياد الميلاد</button>
        <button class="tab-btn" onclick="showTab('security', this)">الأمان</button>
        <button class="tab-btn" onclick="showTab('tasks', this)">المهام</button>
        <button class="tab-btn" onclick="showTab('reports', this)">التقارير</button>
        <button class="btn btn-danger" onclick="logoutAdmin()">تسجيل خروج الأدمن</button>
    </div>
    <div id="membersTab" class="tab-content active">
        <h3>إدارة الأعضاء</h3>
        <div id="membersTable"></div>
    </div>
    <div id="talantonTab" class="tab-content">
        <h3>إدارة نقاط Talanton</h3>
        <button class="btn btn-primary" onclick="showTalantonModal()">إضافة / خصم نقاط</button>
        <div id="talantonHistory"></div>
    </div>
    <div id="storeTab" class="tab-content">
        <h3>إدارة المتجر</h3>
        <button class="btn btn-primary" onclick="showAddProductModal()">إضافة منتج</button>
        <div id="storeProducts"></div>
    </div>
    <div id="eventsTab" class="tab-content">
        <h3>إدارة المناسبات</h3>
        <button class="btn btn-primary" onclick="showAddEventModal()">إضافة مناسبة</button>
        <div id="eventsList"></div>
    </div>
    <div id="weeksTab" class="tab-content">
        <h3>إدارة الأسابيع</h3>
        <button class="btn btn-primary" onclick="showAddWeekModal()">إضافة أسبوع</button>
        <div id="weeksList"></div>
    </div>
    <div id="birthdaysTab" class="tab-content">
        <h3>أعياد الميلاد</h3>
        <button class="btn btn-primary" onclick="showAddBirthdayModal()">إضافة عيد ميلاد</button>
        <div id="birthdaysList"></div>
    </div>
    <div id="securityTab" class="tab-content">
        <div id="securityLogs"></div>
    </div>
    <div id="tasksTab" class="tab-content">
        <h3>إدارة المهام</h3>
        <button class="btn btn-primary" onclick="showAddTaskModal()">إضافة مهمة</button>
        <div id="adminTasksList"></div>
    </div>
    <div id="reportsTab" class="tab-content">
        <h3>التقارير والإحصائيات</h3>
        <div style="display: flex; flex-wrap: wrap; gap: 2rem;">
            <canvas id="attendanceChart" width="400" height="250"></canvas>
            <canvas id="talantonChart" width="400" height="250"></canvas>
            <canvas id="topMembersChart" width="400" height="250"></canvas>
        </div>
        <button class="btn btn-primary" onclick="generateMonthlyReport()">إنشاء تقرير شهري</button>
        <button class="btn btn-primary" onclick="generateMemberReport()">تقرير عضو حالي</button>
        <button class="btn btn-primary" onclick="exportChart('attendanceChart')">تصدير مخطط الحضور</button>
        <button class="btn btn-primary" onclick="exportChart('talantonChart')">تصدير مخطط النقاط</button>
        <button class="btn btn-primary" onclick="exportChart('topMembersChart')">تصدير مخطط أفضل الأعضاء</button>
    </div>
</div>
<!-- مودال إضافة عضو جديد -->
<div id="addMemberModal" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="close" onclick="closeModal('addMemberModal')">&times;</span>
        <h2>إضافة عضو جديد</h2>
        <form onsubmit="addMember(event)">
            <label>اسم العضو</label>
            <input type="text" id="memberName" required>
            <label>رقم العضو</label>
            <input type="text" id="memberNumber" required>
            <label>بريد إلكتروني (اختياري)</label>
            <input type="email" id="memberEmail">
            <button type="submit" class="btn btn-primary">إضافة</button>
        </form>
    </div>
</div>

<!-- مودال تعديل عضو -->
<div id="editMemberModal" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="close" onclick="closeModal('editMemberModal')">&times;</span>
        <h2>تعديل بيانات العضو</h2>
        <form onsubmit="updateMember(event)">
            <input type="hidden" id="editMemberId">
            <label>اسم العضو</label>
            <input type="text" id="editMemberName" required>
            <label>رقم العضو</label>
            <input type="text" id="editMemberNumber" required>
            <label>بريد إلكتروني</label>
            <input type="email" id="editMemberEmail">
            <button type="submit" class="btn btn-primary">تحديث</button>
        </form>
    </div>
</div>

<!-- مودال إضافة منتج جديد للمتجر -->
<div id="addProductModal" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="close" onclick="closeModal('addProductModal')">&times;</span>
        <h2>إضافة منتج جديد</h2>
        <form onsubmit="addProduct(event)">
            <label>اسم المنتج</label>
            <input type="text" id="productName" required>
            <label>سعر Talanton</label>
            <input type="number" id="productPrice" min="1" required>
            <button type="submit" class="btn btn-primary">إضافة</button>
        </form>
    </div>
</div>

<!-- مودال تعديل منتج -->
<div id="editProductModal" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="close" onclick="closeModal('editProductModal')">&times;</span>
        <h2>تعديل بيانات المنتج</h2>
        <form onsubmit="updateProduct(event)">
            <input type="hidden" id="editProductId">
            <label>اسم المنتج</label>
            <input type="text" id="editProductName" required>
            <label>سعر Talanton</label>
            <input type="number" id="editProductPrice" min="1" required>
            <button type="submit" class="btn btn-primary">تحديث</button>
        </form>
    </div>
</div>

<!-- مودال إضافة مناسبة جديدة -->
<div id="addEventModal" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="close" onclick="closeModal('addEventModal')">&times;</span>
        <h2>إضافة مناسبة جديدة</h2>
        <form onsubmit="addEvent(event)">
            <label>اسم المناسبة</label>
            <input type="text" id="eventName" required>
            <label>تاريخ المناسبة</label>
            <input type="date" id="eventDate" required>
            <label>الوصف</label>
            <input type="text" id="eventDescription">
            <label>نقاط المكافأة</label>
            <input type="number" id="eventReward" min="0" value="0">
            <button type="submit" class="btn btn-primary">إضافة</button>
        </form>
    </div>
</div>

<!-- مودال إضافة أسبوع جديد -->
<div id="addWeekModal" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="close" onclick="closeModal('addWeekModal')">&times;</span>
        <h2>إضافة أسبوع جديد</h2>
        <form onsubmit="addWeek(event)">
            <label>اسم الأسبوع</label>
            <input type="text" id="weekName" required>
            <label>تاريخ البداية</label>
            <input type="date" id="weekStartDate" required>
            <label>تاريخ النهاية</label>
            <input type="date" id="weekEndDate" required>
            <label>نقاط المكافأة</label>
            <input type="number" id="weekReward" min="0" value="50">
            <button type="submit" class="btn btn-primary">إضافة</button>
        </form>
    </div>
</div>

<!-- مودال إضافة عيد ميلاد -->
<div id="addBirthdayModal" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="close" onclick="closeModal('addBirthdayModal')">&times;</span>
        <h2>إضافة عيد ميلاد</h2>
        <form onsubmit="addBirthday(); return false;">
            <label>اختر العضو</label>
            <select id="birthdayMember"></select>
            <label>تاريخ الميلاد</label>
            <input type="date" id="birthdayDate" required>
            <button type="submit" class="btn btn-primary">إضافة</button>
        </form>
    </div>
</div>
<script>
// مثال للمتغيرات الأساسية (أكمل بقية المتغيرات كما في مشروعك)
let members = [];
let products = [];
let events = [];
let weeks = [];
let birthdays = [];
let notifications = [];
let tasks = [];

// مثال لدوال عرض/إخفاء المودالات
function showModal(id) {
    document.getElementById(id).style.display = 'block';
}
function closeModal(id) {
    document.getElementById(id).style.display = 'none';
}

// تصحيح showTab لاستقبال (tabName, el)
function showTab(tabName, el) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(tabName + 'Tab').classList.add('active');
    if (el) el.classList.add('active');
    if (tabName === 'reports') loadCharts();
}

// مثال دوال المودالات
function showAddMemberModal() { showModal('addMemberModal'); }
function showAddProductModal() { showModal('addProductModal'); }
function showAddEventModal() { showModal('addEventModal'); }
function showAddWeekModal() { showModal('addWeekModal'); }
function showAddBirthdayModal() { showModal('addBirthdayModal'); }

// مثال على دالة إضافة عضو (عدّل حسب نموذج بياناتك)
function addMember(e) {
    e.preventDefault();
    let name = document.getElementById('memberName').value;
    let number = document.getElementById('memberNumber').value;
    let email = document.getElementById('memberEmail').value;
    let id = Date.now().toString();
    members.push({ id, name, number, email });
    closeModal('addMemberModal');
    renderMembers();
    // أضف هنا حفظ البيانات في Firebase إذا أردت
}

// مثال على دالة تعديل عضو
function updateMember(e) {
    e.preventDefault();
    let id = document.getElementById('editMemberId').value;
    let name = document.getElementById('editMemberName').value;
    let number = document.getElementById('editMemberNumber').value;
    let email = document.getElementById('editMemberEmail').value;
    let member = members.find(m => m.id === id);
    if (member) {
        member.name = name;
        member.number = number;
        member.email = email;
        closeModal('editMemberModal');
        renderMembers();
        // أضف هنا حفظ البيانات في Firebase إذا أردت
    }
}

// مثال لدالة عرض الأعضاء
function renderMembers() {
    let membersDiv = document.getElementById('membersList');
    if (!membersDiv) return;
    membersDiv.innerHTML = members.map(m => `
        <div class="stat-card" style="min-width:170px">
            <div>${m.name}</div>
            <div style="font-size:0.9rem;color:#888">${m.number}</div>
            <button class="btn btn-primary" onclick="editMember('${m.id}')">تعديل</button>
        </div>
    `).join('');
}

// دالة لفتح نافذة تعديل العضو
function editMember(id) {
    let member = members.find(m => m.id === id);
    if (member) {
        document.getElementById('editMemberId').value = member.id;
        document.getElementById('editMemberName').value = member.name;
        document.getElementById('editMemberNumber').value = member.number;
        document.getElementById('editMemberEmail').value = member.email;
        showModal('editMemberModal');
    }
}

// مثال على تهيئة EmailJS بشكل آمن
function safeInitEmailJS() {
    const userId = localStorage.getItem('emailUserId');
    if (userId && userId !== "YOUR_USER_ID") {
        emailjs.init(userId);
    }
}
safeInitEmailJS();

// مثال لحماية حذف منتج
function deleteProduct(productId) {
    if (confirm('هل أنت متأكد من حذف هذا المنتج؟')) {
        const product = products.find(p => p.id === productId);
        products = products.filter(p => p.id !== productId);
        // حفظ البيانات في فيربيز إذا لزم
        // loadStoreProducts();
        // showMessage('تم حذف المنتج بنجاح!', 'success');
        // if (product) addNotification('حذف منتج', `تم حذف المنتج ${product.name} من المتجر`);
    }
}

// مثال تصدير CSV
function exportToCSV(data, fileName) {
    if (data.length === 0) {
        alert('لا توجد بيانات للتصدير');
        return;
    }
    const headers = Object.keys(data[0]).join(',');
    const rows = data.map(obj => Object.values(obj).map(v =>
        `"${String(v).replace(/"/g, '""').replace(/\n/g, ' ')}"`
    ).join(','));
    const csvContent = [headers, ...rows].join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${fileName}-${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    // showMessage('تم تصدير البيانات بنجاح', 'success');
}

// مثال تفعيل اللغة
function loadLanguage() {
    // أضف هنا كود تحميل اللغة من localStorage أو غيره
}
function applyTranslations() {
    // أضف هنا كود تطبيق الترجمة على الصفحة
}

// تهيئة عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    loadLanguage();
    applyTranslations();
    renderMembers(); // عند بدء الصفحة
    // أضف باقي التهيئة حسب حاجتك
});
</script>
</body>
</html>
