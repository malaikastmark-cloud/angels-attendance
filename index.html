<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام حضور خدام الملايكة - Talanton</title>
    <link rel="icon" href="https://public-frontend-cos.metadl.com/mgx/img/favicon.png" type="image/png">
    
    <!-- Chart.js for interactive charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- QR Code Scanner -->
    <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
    <!-- EmailJS for notifications -->
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3.2.0/dist/email.min.js"></script>
    
    <!-- Firebase SDK v9 -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getDatabase, ref, set, get, push, remove, onValue, update } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';
        import { getAnalytics } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBHso7dhJC7P_akMQQ0oN_8ZMTQqsRoVbY",
            authDomain: "angel-meeting-attendance.firebaseapp.com",
            databaseURL: "https://angel-meeting-attendance-default-rtdb.firebaseio.com",
            projectId: "angel-meeting-attendance",
            storageBucket: "angel-meeting-attendance.firebasestorage.app",
            messagingSenderId: "100624957418",
            appId: "1:100624957418:web:291d087797cec9ec79fc93",
            measurementId: "G-2TTXV6CD8F"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);

        // Make Firebase available globally
        window.firebaseDb = database;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebaseGet = get;
        window.firebasePush = push;
        window.firebaseRemove = remove;
        window.firebaseOnValue = onValue;
        window.firebaseUpdate = update;
        window.firebaseAuth = auth;
        window.firebaseCreateUser = createUserWithEmailAndPassword;
        window.firebaseSignIn = signInWithEmailAndPassword;
        window.firebaseSignOut = signOut;
        
        console.log('Firebase initialized successfully');
    </script>
    
    <style>
        /* ... [نفس الستايل السابق] ... */
    </style>
</head>
<body data-theme="light" data-language="ar">
    <!-- ... [نفس الهيكل HTML السابق] ... -->

    <script>
        // البيانات والمتغيرات العالمية
        let currentMember = null;
        let isAdmin = false;
        let members = [];
        let products = [];
        let attendance = [];
        let talantonHistory = [];
        let events = [];
        let weeks = [];
        let securityLogs = [];
        let tasks = [];
        let notifications = [];
        let currentLanguage = 'ar';
        let qrScanner = null;

        // تعريف المستويات
        const memberLevels = [
            { id: 1, name: 'مبتدئ', minPoints: 0, maxPoints: 100, color: 'level-beginner' },
            { id: 2, name: 'متوسط', minPoints: 101, maxPoints: 300, color: 'level-intermediate' },
            { id: 3, name: 'متقدم', minPoints: 301, maxPoints: 600, color: 'level-advanced' },
            { id: 4, name: 'خبير', minPoints: 601, maxPoints: 1000, color: 'level-expert' },
            { id: 5, name: 'أسطورة', minPoints: 1001, maxPoints: Infinity, color: 'level-legend' }
        ];

        // الترجمة
        const translations = {
            ar: {
                toggle_theme: 'تبديل الوضع',
                search_placeholder: 'ابحث بالاسم أو الرقم التسلسلي...',
                admin_login: 'دخول الأدمن',
                qr_scanner: 'ماسح QR',
                top_members: 'أفضل 10 أعضاء',
                select_member: 'اختيار العضو للحضور',
                general_stats: 'إحصائيات عامة',
                total_members: 'إجمالي الأعضاء',
                present_today: 'الحاضرون اليوم',
                total_talanton: 'إجمالي Talanton',
                weekly_attendance: 'نسبة الحضور الأسبوعي',
                loading_members: 'جاري تحميل الأعضاء...',
                // ... باقي الترجمة
            },
            en: {
                toggle_theme: 'Toggle Theme',
                search_placeholder: 'Search by name or ID...',
                admin_login: 'Admin Login',
                qr_scanner: 'QR Scanner',
                top_members: 'Top 10 Members',
                select_member: 'Select Member for Attendance',
                general_stats: 'General Statistics',
                total_members: 'Total Members',
                present_today: 'Present Today',
                total_talanton: 'Total Talanton',
                weekly_attendance: 'Weekly Attendance Rate',
                loading_members: 'Loading members...',
                // ... باقي الترجمة
            }
        };

        // تهيئة التطبيق
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing app...');
            initializeFirebase();
            loadTheme();
            loadLanguage();
            setupSearch();
            applyTranslations();
            
            // تحميل البيانات بعد تهيئة Firebase
            setTimeout(() => {
                loadDataFromFirebase();
            }, 2000);
        });

        // Firebase Integration
        function initializeFirebase() {
            console.log('Initializing Firebase...');
            if (window.firebaseDb) {
                console.log('Firebase is available');
                // loadDataFromFirebase() will be called after timeout
            } else {
                console.log('Firebase not available yet, retrying...');
                setTimeout(initializeFirebase, 1000);
            }
        }

        function loadDataFromFirebase() {
            if (!window.firebaseDb) {
                console.error('Firebase database not available');
                return;
            }

            console.log('Loading data from Firebase...');
            
            const paths = [
                'members', 'products', 'attendance', 
                'talantonHistory', 'events', 'weeks', 
                'securityLogs', 'tasks', 'notifications'
            ];
            
            let loadedCount = 0;
            
            paths.forEach(path => {
                const ref = window.firebaseRef(window.firebaseDb, path);
                window.firebaseOnValue(ref, (snapshot) => {
                    const data = snapshot.val();
                    console.log(`Loaded ${path}:`, data);
                    
                    if (data) {
                        // تحويل البيانات من object إلى array
                        window[path] = Object.values(data);
                    } else {
                        window[path] = [];
                        console.log(`No data found for ${path}`);
                        
                        // إذا كانت members فارغة، ننشئ بيانات تجريبية
                        if (path === 'members' && window[path].length === 0) {
                            initializeDemoData();
                        }
                    }
                    
                    loadedCount++;
                    if (loadedCount === paths.length) {
                        console.log('All data loaded, updating UI...');
                        updateUI();
                    }
                }, (error) => {
                    console.error(`Error loading ${path}:`, error);
                    loadedCount++;
                });
            });
        }

        function initializeDemoData() {
            console.log('Creating demo data...');
            
            const demoMembers = [
                { 
                    id: 1, 
                    name: 'أحمد محمد', 
                    password: '1234', 
                    email: 'ahmed@example.com', 
                    talanton: 250, 
                    joinDate: '2024-01-15', 
                    birthday: '1995-03-15',
                    serialNumber: 'MEM-001'
                },
                { 
                    id: 2, 
                    name: 'فاطمة علي', 
                    password: '1234', 
                    email: 'fatima@example.com', 
                    talanton: 320, 
                    joinDate: '2024-01-20', 
                    birthday: '1998-07-22',
                    serialNumber: 'MEM-002'
                }
            ];

            const demoProducts = [
                { id: 1, name: 'كتاب ديني', price: 50, description: 'كتاب في التربية الروحية' },
                { id: 2, name: 'مسبحة', price: 30, description: 'مسبحة خشبية جميلة' }
            ];

            const demoEvents = [
                { id: 1, name: 'اجتماع أسبوعي', date: '2024-12-20', description: 'الاجتماع الأسبوعي للخدام', reward: 20 }
            ];

            // حفظ البيانات الأولية
            saveToFirebase('members', demoMembers);
            saveToFirebase('products', demoProducts);
            saveToFirebase('events', demoEvents);
            
            console.log('Demo data created successfully');
        }

        function saveToFirebase(path, data) {
            if (!window.firebaseDb) {
                console.error('Cannot save - Firebase not available');
                return;
            }

            try {
                // تحويل array إلى object مع استخدام id كمفاتيح
                const dataObject = {};
                data.forEach(item => {
                    dataObject[item.id] = item;
                });
                
                const ref = window.firebaseRef(window.firebaseDb, path);
                window.firebaseSet(ref, dataObject)
                    .then(() => console.log(`Saved ${path} successfully`))
                    .catch(error => console.error(`Error saving ${path}:`, error));
            } catch (error) {
                console.error(`Error processing data for ${path}:`, error);
            }
        }

        // وظائف الواجهة الأساسية
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            const themeIcon = document.getElementById('themeIcon');
            
            body.setAttribute('data-theme', newTheme);
            themeIcon.textContent = newTheme === 'light' ? '🌙' : '☀️';
            localStorage.setItem('theme', newTheme);
            
            console.log('Theme changed to:', newTheme);
        }

        function toggleLanguage() {
            currentLanguage = currentLanguage === 'ar' ? 'en' : 'ar';
            document.body.setAttribute('data-language', currentLanguage);
            document.body.setAttribute('dir', currentLanguage === 'ar' ? 'rtl' : 'ltr');
            document.documentElement.setAttribute('lang', currentLanguage);
            
            const languageText = document.getElementById('languageText');
            languageText.textContent = currentLanguage === 'ar' ? 'English' : 'العربية';
            
            applyTranslations();
            localStorage.setItem('language', currentLanguage);
            
            console.log('Language changed to:', currentLanguage);
        }

        function applyTranslations() {
            document.querySelectorAll('[data-translate]').forEach(element => {
                const key = element.getAttribute('data-translate');
                if (translations[currentLanguage][key]) {
                    if (element.placeholder) {
                        element.placeholder = translations[currentLanguage][key];
                    } else {
                        element.textContent = translations[currentLanguage][key];
                    }
                }
            });
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            const themeIcon = document.getElementById('themeIcon');
            document.body.setAttribute('data-theme', savedTheme);
            themeIcon.textContent = savedTheme === 'light' ? '🌙' : '☀️';
        }

        function loadLanguage() {
            const savedLanguage = localStorage.getItem('language') || 'ar';
            currentLanguage = savedLanguage;
            document.body.setAttribute('data-language', currentLanguage);
            document.body.setAttribute('dir', currentLanguage === 'ar' ? 'rtl' : 'ltr');
            document.documentElement.setAttribute('lang', currentLanguage);
            
            const languageText = document.getElementById('languageText');
            languageText.textContent = currentLanguage === 'ar' ? 'English' : 'العربية';
        }

        function setupSearch() {
            const searchInput = document.getElementById('memberSearch');
            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                filterMembers(query);
            });
        }

        function filterMembers(query) {
            const memberCards = document.querySelectorAll('.member-card');
            memberCards.forEach(card => {
                const name = card.querySelector('.member-name').textContent.toLowerCase();
                const number = card.querySelector('.member-number').textContent;
                
                if (query === '' || name.includes(query) || number.includes(query)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // وظائف العرض الرئيسية
        function updateUI() {
            console.log('Updating UI with data:', {
                members: members.length,
                products: products.length,
                attendance: attendance.length
            });
            
            displayMembers();
            displayTopMembers();
            checkBirthdays();
            updateStats();
            loadStorePreview();
            populateReportDropdown();
            
            if (isAdmin) {
                loadAdminData();
            }
        }

        function displayMembers() {
            const membersList = document.getElementById('membersList');
            
            if (members.length === 0) {
                membersList.innerHTML = '<div class="loading" data-translate="loading_members">جاري تحميل الأعضاء...</div>';
                return;
            }

            console.log('Displaying members:', members);
            
            membersList.innerHTML = members.map(member => {
                const level = calculateLevel(member.talanton);
                return `
                    <div class="member-card" onclick="selectMember(${member.id})">
                        <div class="member-number">${member.serialNumber || member.id}</div>
                        <div class="member-name">${member.name}</div>
                        <div class="level-badge ${level.color}">${level.name}</div>
                        <div class="member-talanton">💰 ${member.talanton} Talanton</div>
                    </div>
                `;
            }).join('');
        }

        function calculateLevel(points) {
            return memberLevels.find(level => points >= level.minPoints && points <= level.maxPoints) || memberLevels[0];
        }

        function displayTopMembers() {
            const sortedMembers = [...members]
                .sort((a, b) => b.talanton - a.talanton)
                .slice(0, 10);

            const container = document.getElementById('topMembersList');
            container.innerHTML = sortedMembers.map((member, index) => {
                const rankClass = index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : 'rank-other';
                return `
                    <div class="top-member-item">
                        <div class="rank-badge ${rankClass}">${index + 1}</div>
                        <div>
                            <strong>${member.name}</strong>
                            <div style="color: var(--warning-color); font-weight: bold;">${member.talanton} نقطة</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateStats() {
            const today = new Date().toISOString().split('T')[0];
            const todayAttendance = attendance.filter(a => a.date === today).length;
            const totalTalanton = members.reduce((sum, m) => sum + m.talanton, 0);
            
            document.getElementById('totalMembers').textContent = members.length;
            document.getElementById('presentToday').textContent = todayAttendance;
            document.getElementById('totalTalanton').textContent = totalTalanton;
            document.getElementById('weeklyAttendance').textContent = '75%'; // مثال
        }

        // وظائف الأعضاء والحضور
        function selectMember(memberId) {
            console.log('Selecting member:', memberId);
            currentMember = members.find(m => m.id === memberId);
            if (currentMember) {
                document.getElementById('attendanceTitle').textContent = `تسجيل حضور: ${currentMember.name}`;
                showModal('attendanceModal');
            } else {
                console.error('Member not found:', memberId);
                showMessage('العضو غير موجود', 'error');
            }
        }

        function markAttendance() {
            if (!currentMember) {
                showMessage('يرجى اختيار عضو أولاً', 'error');
                return;
            }

            const password = document.getElementById('memberPassword').value;
            
            if (password && password !== currentMember.password) {
                showMessage('كلمة المرور غير صحيحة!', 'error');
                return;
            }

            const today = new Date().toISOString().split('T')[0];
            const existingAttendance = attendance.find(a => 
                a.memberId === currentMember.id && a.date === today
            );

            if (existingAttendance) {
                showMessage('تم تسجيل حضورك اليوم مسبقاً!', 'warning');
                return;
            }

            // إضافة سجل الحضور
            const newAttendance = {
                id: Date.now(),
                memberId: currentMember.id,
                memberName: currentMember.name,
                date: today,
                timestamp: new Date().toISOString()
            };

            attendance.push(newAttendance);
            
            // إضافة نقاط المكافأة
            currentMember.talanton += 10;
            
            // تحديث العضو في المصفوفة
            const memberIndex = members.findIndex(m => m.id === currentMember.id);
            if (memberIndex !== -1) {
                members[memberIndex] = currentMember;
            }

            // إضافة إلى سجل النقاط
            talantonHistory.push({
                id: Date.now(),
                memberId: currentMember.id,
                memberName: currentMember.name,
                amount: 10,
                type: 'add',
                reason: 'حضور يومي',
                date: today,
                timestamp: new Date().toISOString()
            });

            // حفظ البيانات
            saveToFirebase('attendance', attendance);
            saveToFirebase('members', members);
            saveToFirebase('talantonHistory', talantonHistory);

            showMessage('تم تسجيل حضورك بنجاح! حصلت على 10 نقاط Talanton', 'success');
            closeModal('attendanceModal');
            updateUI();
            
            // إعادة تعيين الحقول
            document.getElementById('memberPassword').value = '';
        }

        // وظائف الأدمن
        function showAdminLogin() {
            showModal('adminLoginModal');
        }

        function adminLogin() {
            const password = document.getElementById('adminPassword').value;
            if (password === 'admin123') {
                isAdmin = true;
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                closeModal('adminLoginModal');
                loadAdminData();
                showMessage('مرحباً بك في لوحة تحكم الأدمن!', 'success');
            } else {
                showMessage('كلمة مرور خاطئة!', 'error');
            }
            document.getElementById('adminPassword').value = '';
        }

        function loadAdminData() {
            loadMembersTable();
            updateTalantonMemberSelect();
            updateBirthdayMemberSelect();
            populateReportDropdown();
        }

        function loadMembersTable() {
            const table = document.getElementById('membersTable');
            table.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>الرقم التسلسلي</th>
                            <th>الاسم</th>
                            <th>البريد الإلكتروني</th>
                            <th>Talanton</th>
                            <th>تاريخ الانضمام</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${members.map(member => `
                            <tr>
                                <td>${member.serialNumber || member.id}</td>
                                <td>${member.name}</td>
                                <td>${member.email || 'غير محدد'}</td>
                                <td>${member.talanton}</td>
                                <td>${new Date(member.joinDate).toLocaleDateString('ar')}</td>
                                <td>
                                    <button class="btn btn-warning" onclick="editMember(${member.id})">تعديل</button>
                                    <button class="btn btn-danger" onclick="deleteMember(${member.id})">حذف</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // وظائف المشتركة
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
            messageDiv.textContent = message;
            messageDiv.style.position = 'fixed';
            messageDiv.style.top = '20px';
            messageDiv.style.right = '20px';
            messageDiv.style.zIndex = '10000';
            messageDiv.style.maxWidth = '400px';
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                if (document.body.contains(messageDiv)) {
                    document.body.removeChild(messageDiv);
                }
            }, 4000);
        }

        // جعل الدوال متاحة globally
        window.toggleTheme = toggleTheme;
        window.toggleLanguage = toggleLanguage;
        window.showAdminLogin = showAdminLogin;
        window.adminLogin = adminLogin;
        window.selectMember = selectMember;
        window.markAttendance = markAttendance;
        window.showModal = showModal;
        window.closeModal = closeModal;
        window.showMessage = showMessage;

        // إغلاق المودالات بالنقر خارجها
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        };

        console.log('All functions initialized successfully');

    </script>
</body>
</html>
