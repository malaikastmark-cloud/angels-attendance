<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>اجتماع خدام ملايكة</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- Add Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;}
body{background: linear-gradient(135deg,#fceabb,#f8b500);min-height:100vh;padding:20px;}
.container{max-width:1200px;margin:0 auto;background:rgba(255,255,255,0.95);border-radius:15px;box-shadow:0 10px 20px rgba(0,0,0,0.2);padding:20px;}
header{background:#3498db;color:white;padding:15px;text-align:center;border-radius:10px;position:relative;}
header::before{content:"🧚‍♂️";position:absolute;left:10px;top:10px;font-size:1.5rem;}
header::after{content:"✨";position:absolute;right:10px;top:10px;font-size:1.5rem;}
h1{font-size:2rem;}
.tab-content{display:none;padding:20px;}
.tab-content.active{display:block;}
table{width:100%;border-collapse:collapse;margin-top:15px;background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 5px 15px rgba(0,0,0,0.1);}
th,td{padding:10px;text-align:center;border-bottom:1px solid #ddd;}
th{background:#3498db;color:white;}
tr:nth-child(even){background:#f9f9f9;}
tr:hover{background:#f1f1f1;}
.btn{padding:8px 15px;border:none;border-radius:5px;cursor:pointer;font-weight:bold;margin:5px;}
.btn-primary{background:#2ecc71;color:white;}
.btn-primary:hover{background:#27ae60;}
.btn-success{background:#3498db;color:white;}
.btn-success:hover{background:#2980b9;}
.btn-danger{background:#e74c3c;color:white;}
.btn-danger:hover{background:#c0392b;}
.btn-warning{background:#f39c12;color:white;}
.btn-warning:hover{background:#e67e22;}
.btn-info{background:#9b59b6;color:white;}
.btn-info:hover{background:#8e44ad;}
.controls{margin:10px 0;display:flex;gap:10px;flex-wrap:wrap;}
select,input{padding:5px;border-radius:5px;border:1px solid #ccc;}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:1000;}
.modal-content{background:white;padding:20px;border-radius:10px;width:400px;max-width:90%;}
.tabs{display:flex;gap:5px;margin-bottom:10px;}
.tabs .tab{padding:8px 15px;cursor:pointer;border-radius:5px;background:#f0f0f0;}
.tabs .tab.active{background:#3498db;color:white;}
.summary-card{background:#fff;border-radius:10px;padding:15px;text-align:center;box-shadow:0 5px 15px rgba(0,0,0,0.1);margin:10px;flex:1;min-width:200px;}
.summary-card h3{color:#3498db;margin-bottom:10px;font-size:1.2rem;}
.summary-value{font-size:2.5rem;font-weight:bold;color:#2ecc71;margin:10px 0;}
.summary-subtitle{color:#7f8c8d;font-size:0.9rem;}
.card-container{display:flex;gap:15px;flex-wrap:wrap;margin-top:15px;}
.loading{display:none;text-align:center;margin:20px 0;}
.loading-spinner{width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto;}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
.medal{font-size:1.5rem;margin-left:5px;}
.medal-gold{color:gold;}
.medal-silver{color:silver;}
.medal-bronze{color:#cd7f32;}
.top-members-list{margin-top:20px;background:white;border-radius:10px;padding:15px;box-shadow:0 5px 15px rgba(0,0,0,0.1);}
.top-members-list h3{color:#3498db;margin-bottom:15px;text-align:center;}
.top-member-item{display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid #eee;align-items:center;}
.top-member-item:last-child{border-bottom:none;}
.top-member-name{font-weight:bold;}
.top-member-points{background:#3498db;color:white;padding:5px 10px;border-radius:15px;font-weight:bold;}
.report-section{margin-bottom:30px;}
.report-section h3{color:#3498db;margin-bottom:15px;padding-bottom:5px;border-bottom:2px solid #3498db;}
.notification{position:fixed;top:20px;right:20px;background:#2ecc71;color:white;padding:15px;border-radius:5px;box-shadow:0 5px 15px rgba(0,0,0,0.2);z-index:1000;display:none;}
.member-img{width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid #3498db;}
.reward-badge{background:gold;color:#333;padding:3px 8px;border-radius:10px;font-size:0.8rem;margin-left:5px;font-weight:bold;}
.export-buttons{display:flex;gap:10px;margin:15px 0;}
.member-stats{display:flex;align-items:center;gap:10px;}
.member-stat-item{background:#f8f9fa;padding:10px;border-radius:8px;text-align:center;flex:1;}
.member-stat-value{font-size:1.5rem;font-weight:bold;color:#3498db;}
.member-stat-label{font-size:0.8rem;color:#7f8c8d;}
</style>
</head>
<body>
<div class="container">
    <header>
        <h1>🌟 اجتماع خدام ملايكة</h1>
        <p>الحضور يساوي نقطة</p>
    </header>

    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <p>جاري تحميل البيانات...</p>
    </div>

    <div class="notification" id="notification"></div>

    <div class="tab-content active" id="userAttendance">
        <div class="controls">
            <label>اختر اسمك: </label>
            <select id="selectMember"></select>
            <label>اختر الأسبوع: </label>
            <select id="weekSelect"></select>
        </div>
        <div class="controls">
            <button class="btn btn-primary" id="markPresent">تسجيل الحضور</button>
        </div>
        <table>
            <thead><tr><th>#</th><th>الصورة</th><th>اسم العضو</th><th>الأسبوع</th><th>الحضور</th><th>النقاط</th></tr></thead>
            <tbody id="attendanceTableBody"></tbody>
        </table>
        <div class="controls">
            <span>الحضور هذا الأسبوع: <span id="attendanceCount">0</span>/<span id="totalMembers">0</span></span>
            <span>النقاط: <span id="totalPoints">0</span></span>
        </div>
    </div>

    <div class="controls" style="margin-top:20px;">
        <button class="btn btn-success" id="adminLoginBtn">تسجيل دخول الأدمن</button>
    </div>

    <div class="modal" id="adminLoginModal">
        <div class="modal-content">
            <h2>تسجيل دخول الأدمن</h2>
            <input type="password" id="adminPassword" placeholder="كلمة السر">
            <div class="controls">
                <button class="btn btn-danger" id="cancelAdminLogin">إلغاء</button>
                <button class="btn btn-success" id="confirmAdminLogin">دخول</button>
            </div>
        </div>
    </div>

    <div class="tab-content" id="adminTabs" style="display:none;">
        <div class="tabs">
            <div class="tab active" data-tab="members">إدارة الأعضاء</div>
            <div class="tab" data-tab="weeks">إدارة الأسابيع</div>
            <div class="tab" data-tab="attendance">إدارة الحضور</div>
            <div class="tab" data-tab="reports">التقارير</div>
        </div>

        <div class="tab-content active" id="members">
            <h2>إدارة الأعضاء</h2>
            <div class="controls">
                <input type="text" id="newMemberName" placeholder="اسم العضو">
                <input type="text" id="newMemberImage" placeholder="رابط الصورة (اختياري)">
                <button class="btn btn-primary" id="addMemberBtn">إضافة عضو</button>
            </div>
            <table id="membersTable">
                <thead><tr><th>#</th><th>الصورة</th><th>اسم العضو</th><th>النقاط</th><th>المكافآت</th><th>تعديل</th><th>حذف</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="tab-content" id="weeks">
            <h2>إدارة الأسابيع</h2>
            <div class="controls">
                <input type="text" id="newWeekName" placeholder="اسم الأسبوع">
                <input type="date" id="newWeekStart">
                <input type="date" id="newWeekEnd">
                <button class="btn btn-primary" id="addWeekBtn">إضافة أسبوع</button>
            </div>
            <table id="weeksTable">
                <thead><tr><th>#</th><th>اسم الأسبوع</th><th>من</th><th>إلى</th><th>تعديل</th><th>حذف</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="tab-content" id="attendance">
            <h2>إدارة تسجيلات الحضور</h2>
            <div class="controls">
                <label>اختر أسبوع: </label>
                <select id="deleteWeekSelect"></select>
                <button class="btn btn-danger" id="deleteAttendanceBtn">حذف كل حضور هذا الأسبوع</button>
            </div>
            <table id="attendanceTable">
                <thead><tr><th>#</th><th>العضو</th><th>الأسبوع</th><th>تاريخ التسجيل</th><th>حذف</th></tr></thead>
                <tbody id="attendanceRecordsBody"></tbody>
            </table>
        </div>

        <div class="tab-content" id="reports">
            <h2>التقارير والإحصائيات</h2>
            
            <div class="export-buttons">
                <button class="btn btn-info" id="printReportBtn"><i class="fas fa-print"></i> طباعة التقرير</button>
                <button class="btn btn-success" id="exportExcelBtn"><i class="fas fa-file-excel"></i> تصدير لإكسل</button>
            </div>
            
            <div class="report-section">
                <h3>📊 إحصائيات عامة</h3>
                <div class="card-container">
                    <div class="summary-card">
                        <h3>إجمالي الحضور</h3>
                        <div class="summary-value" id="reportAttendance">0</div>
                        <div class="summary-subtitle">حضور جميع الأسابيع</div>
                    </div>
                    <div class="summary-card">
                        <h3>النقاط الممنوحة</h3>
                        <div class="summary-value" id="reportPoints">0</div>
                        <div class="summary-subtitle">مجموع النقاط</div>
                    </div>
                    <div class="summary-card">
                        <h3>عدد الأعضاء</h3>
                        <div class="summary-value" id="reportMembers">0</div>
                        <div class="summary-subtitle">إجمالي الأعضاء المسجلين</div>
                    </div>
                    <div class="summary-card">
                        <h3>عدد الأسابيع</h3>
                        <div class="summary-value" id="reportWeeks">0</div>
                        <div class="summary-subtitle">إجمالي الأسابيع</div>
                    </div>
                </div>
            </div>

            <div class="report-section">
                <h3>🏆 الـ 10 الأوائل في الحضور</h3>
                <div class="top-members-list" id="topMembersList">
                    <p>جاري تحميل البيانات...</p>
                </div>
            </div>

            <div class="report-section">
                <h3>📈 نسبة الحضور للأسبوع الحالي</h3>
                <canvas id="attendanceChart" style="margin-top:20px;max-height:300px;"></canvas>
            </div>

            <div class="report-section">
                <h3>👥 إحصائيات الأعضاء</h3>
                <div id="membersStatsContainer"></div>
            </div>
        </div>
    </div>
</div>

<script>
// ====== إعدادات Firebase - يجب استبدالها بإعداداتك ======
const firebaseConfig = {
    apiKey: "AIzaSyBCQIqdCsxSvhfYOs00AetoVWpFhj4XNAQ",
    authDomain: "angels-attendance.firebaseapp.com",
    databaseURL: "https://angels-attendance-default-rtdb.firebaseio.com",
    projectId: "angels-attendance",
    storageBucket: "angels-attendance.firebasestorage.app",
    messagingSenderId: "157249026489",
    appId: "1:157249026489:web:db2b420203bd81d9a19e68"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// بيانات التطبيق
let members = [];
let weeks = [];
let attendanceRecords = [];
let rewards = [];

// كلمة السر الجديدة
const adminPass = 'admin123';

// وظائف Firebase
function showLoading() {
    document.getElementById('loading').style.display = 'block';
}

function hideLoading() {
    document.getElementById('loading').style.display = 'none';
}

function showNotification(message, isSuccess = true) {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.style.background = isSuccess ? '#2ecc71' : '#e74c3c';
    notification.style.display = 'block';
    
    setTimeout(() => {
        notification.style.display = 'none';
    }, 3000);
}

function loadData() {
    showLoading();
    const dataRef = database.ref('angelsAttendance');
    
    dataRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            members = data.members || [];
            weeks = data.weeks || [];
            attendanceRecords = data.attendanceRecords || [];
            rewards = data.rewards || [];
        } else {
            // البيانات الأولية إذا لم توجد بيانات
            members = [
                {id:1,name:'🧒 Mary Karam', image: 'https://ui-avatars.com/api/?name=Mary+Karam&background=3498db&color=fff'},
                {id:2,name:'👦 Eman Makin', image: 'https://ui-avatars.com/api/?name=Eman+Makin&background=2ecc71&color=fff'},
                {id:3,name:'👧 Rizk Gerges', image: 'https://ui-avatars.com/api/?name=Rizk+Gerges&background=e74c3c&color=fff'}
            ];
            weeks = [{id:1,name:'الاسبوع الاول',from:'2025-08-29',to:'2025-08-29'}];
            attendanceRecords = [];
            rewards = [];
            saveData();
        }
        populateData();
        updateReports();
        hideLoading();
    }, (error) => {
        console.error('Error loading data:', error);
        hideLoading();
        alert('حدث خطأ في تحميل البيانات. تأكد من اتصال الإنترنت.');
    });
}

function saveData() {
    showLoading();
    const dataRef = database.ref('angelsAttendance');
    dataRef.set({
        members: members,
        weeks: weeks,
        attendanceRecords: attendanceRecords,
        rewards: rewards
    }).then(() => {
        hideLoading();
    }).catch((error) => {
        console.error('Error saving data:', error);
        hideLoading();
        alert('حدث خطأ في حفظ البيانات. تأكد من اتصال الإنترنت.');
    });
}

// بقية الوظائف كما هي مع تعديل بسيط
function populateData(){
    const selectMember=document.getElementById('selectMember');
    selectMember.innerHTML='';
    members.forEach(m=>{
        let o=document.createElement('option'); 
        o.value=m.id; 
        o.textContent=m.name; 
        selectMember.appendChild(o);
    });

    const weekSelect=document.getElementById('weekSelect');
    weekSelect.innerHTML='';
    weeks.forEach(w=>{let o=document.createElement('option'); o.value=w.id; o.textContent=w.name; weekSelect.appendChild(o);});

    // تعبئة قائمة الأسابيع في إدارة الحضور
    const deleteWeekSelect=document.getElementById('deleteWeekSelect');
    deleteWeekSelect.innerHTML='';
    weeks.forEach(w=>{let o=document.createElement('option'); o.value=w.id; o.textContent=w.name; deleteWeekSelect.appendChild(o);});

    const tbody=document.getElementById('attendanceTableBody'); 
    tbody.innerHTML='';
    
    const selectedWeekId = document.getElementById('weekSelect').value;
    const selectedWeek = weeks.find(w => w.id == selectedWeekId);
    
    members.forEach((m,i)=>{
        // التحقق من وجود سجل حضور لهذا العضو في هذا الأسبوع
        const attendanceRecord = attendanceRecords.find(ar => 
            ar.memberId === m.id && ar.weekId == selectedWeekId
        );
        
        const isPresent = attendanceRecord ? attendanceRecord.present : false;
        
        let tr=document.createElement('tr'); 
        tr.dataset.member=m.id;
        tr.innerHTML=`
            <td>${i+1}</td>
            <td><img src="${m.image || 'https://ui-avatars.com/api/?name=Member&background=ccc&color=fff'}" class="member-img" alt="${m.name}"></td>
            <td>${m.name}</td>
            <td>${selectedWeek ? selectedWeek.name : ''}</td>
            <td class="attendance-value">${isPresent ? '1' : '0'}</td>
            <td class="points">${isPresent ? '1' : '0'}</td>
        `;
        tbody.appendChild(tr);
    });
    
    document.getElementById('totalMembers').textContent=members.length;
    updateAttendanceStats();
    populateAdminTables();
    populateAttendanceRecords(); // تحديث سجلات الحضور
}

function populateAdminTables(){
    const membersTbody=document.querySelector('#membersTable tbody');
    membersTbody.innerHTML='';
    members.forEach((m,i)=>{
        // حساب النقاط الإجمالية لكل عضو
        const totalPoints = attendanceRecords.filter(ar => 
            ar.memberId === m.id && ar.present
        ).length;
        
        // الحصول على مكافآت العضو
        const memberRewards = rewards.filter(r => r.memberId === m.id);
        const rewardsText = memberRewards.map(r => r.title).join(', ') || 'لا يوجد';
        
        let tr=document.createElement('tr');
        tr.innerHTML=`
            <td>${i+1}</td>
            <td><img src="${m.image || 'https://ui-avatars.com/api/?name=Member&background=ccc&color=fff'}" class="member-img" alt="${m.name}"></td>
            <td>${m.name}</td>
            <td>${totalPoints}</td>
            <td>${rewardsText}</td>
            <td><button class='btn btn-primary editMember'>تعديل</button></td>
            <td><button class='btn btn-danger deleteMember'>حذف</button></td>
        `;
        membersTbody.appendChild(tr);
    });
    const weeksTbody=document.querySelector('#weeksTable tbody');
    weeksTbody.innerHTML='';
    weeks.forEach((w,i)=>{
        let tr=document.createElement('tr');
        tr.innerHTML=`<td>${i+1}</td><td>${w.name}</td><td>${w.from}</td><td>${w.to}</td><td><button class='btn btn-primary editWeek'>تعديل</button></td><td><button class='btn btn-danger deleteWeek'>حذف</button></td>`;
        weeksTbody.appendChild(tr);
    });
}

// عرض سجلات الحضور
function populateAttendanceRecords() {
    const tbody = document.querySelector('#attendanceRecordsBody');
    tbody.innerHTML = '';
    
    attendanceRecords.forEach((record, index) => {
        const member = members.find(m => m.id === record.memberId);
        const week = weeks.find(w => w.id == record.weekId);
        
        if (member && week) {
            let tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${index + 1}</td>
                <td>${member.name}</td>
                <td>${week.name}</td>
                <td>${new Date(record.date).toLocaleString('ar-EG')}</td>
                <td><button class='btn btn-danger deleteAttendance' data-index='${index}'>حذف</button></td>
            `;
            tbody.appendChild(tr);
        }
    });
}

function updateAttendanceStats(){
    const selectedWeekId = document.getElementById('weekSelect').value;
    let count=0;
    let totalPoints=0;
    
    // حساب الحضور لهذا الأسبوع فقط
    const weekAttendance = attendanceRecords.filter(ar => 
        ar.weekId == selectedWeekId && ar.present
    );
    
    count = weekAttendance.length;
    totalPoints = count;
    
    document.getElementById('attendanceCount').textContent=count;
    document.getElementById('totalPoints').textContent=totalPoints;
    updateChart();
}

// تحديث التقارير
function updateReports() {
    // الإحصائيات العامة
    const totalAttendance = attendanceRecords.filter(ar => ar.present).length;
    const totalPoints = totalAttendance;
    
    document.getElementById('reportAttendance').textContent = totalAttendance;
    document.getElementById('reportPoints').textContent = totalPoints;
    document.getElementById('reportMembers').textContent = members.length;
    document.getElementById('reportWeeks').textContent = weeks.length;
    
    // الـ 10 الأوائل
    updateTopMembers();
    
    // إحصائيات الأعضاء
    updateMembersStats();
}

// تحديث قائمة الـ 10 الأوائل
function updateTopMembers() {
    // حساب النقاط لكل عضو
    const memberPoints = members.map(member => {
        const points = attendanceRecords.filter(ar => 
            ar.memberId === member.id && ar.present
        ).length;
        return { name: member.name, points: points, image: member.image };
    });
    
    // ترتيب تنازلي حسب النقاط
    memberPoints.sort((a, b) => b.points - a.points);
    
    // أخذ أول 10 فقط
    const top10 = memberPoints.slice(0, 10);
    
    // عرض النتائج
    const topMembersList = document.getElementById('topMembersList');
    topMembersList.innerHTML = '';
    
    if (top10.length === 0) {
        topMembersList.innerHTML = '<p>لا توجد بيانات حتى الآن</p>';
        return;
    }
    
    top10.forEach((member, index) => {
        const item = document.createElement('div');
        item.className = 'top-member-item';
        
        let medal = '';
        if (index === 0) medal = '<span class="medal medal-gold">🥇</span>';
        else if (index === 1) medal = '<span class="medal medal-silver">🥈</span>';
        else if (index === 2) medal = '<span class="medal medal-bronze">🥉</span>';
        
        item.innerHTML = `
            <div style="display:flex;align-items:center;gap:10px;">
                <img src="${member.image || 'https://ui-avatars.com/api/?name=Member&background=ccc&color=fff'}" class="member-img" alt="${member.name}">
                <div class="top-member-name">${medal} ${member.name}</div>
            </div>
            <div class="top-member-points">${member.points} نقطة</div>
        `;
        topMembersList.appendChild(item);
    });
}

// تحديث إحصائيات الأعضاء
function updateMembersStats() {
    const container = document.getElementById('membersStatsContainer');
    container.innerHTML = '';
    
    // حساب إجمالي الأسابيع
    const totalWeeks = weeks.length;
    
    members.forEach(member => {
        // حساب حضور العضو
        const memberAttendance = attendanceRecords.filter(ar => 
            ar.memberId === member.id && ar.present
        ).length;
        
        // حساب نسبة الحضور
        const attendancePercentage = totalWeeks > 0 ? Math.round((memberAttendance / totalWeeks) * 100) : 0;
        
        const statsDiv = document.createElement('div');
        statsDiv.className = 'member-stats';
        statsDiv.innerHTML = `
            <img src="${member.image || 'https://ui-avatars.com/api/?name=Member&background=ccc&color=fff'}" class="member-img" alt="${member.name}">
            <div style="flex:1">
                <h4>${member.name}</h4>
                <div style="display:flex;gap:10px;margin-top:5px;">
                    <div class="member-stat-item">
                        <div class="member-stat-value">${memberAttendance}</div>
                        <div class="member-stat-label">حضور</div>
                    </div>
                    <div class="member-stat-item">
                        <div class="member-stat-value">${attendancePercentage}%</div>
                        <div class="member-stat-label">نسبة</div>
                    </div>
                    <div class="member-stat-item">
                        <div class="member-stat-value">${memberAttendance}</div>
                        <div class="member-stat-label">نقاط</div>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(statsDiv);
    });
}

// نظام المكافآت
function checkForRewards(memberId) {
    const points = attendanceRecords.filter(ar => 
        ar.memberId === memberId && ar.present
    ).length;
    
    // مكافآت افتراضية
    const rewardLevels = [
        { points: 5, title: "ميدالية برونزية 🥉" },
        { points: 10, title: "ميدالية فضية 🥈" },
        { points: 15, title: "ميدالية ذهبية 🥇" },
        { points: 20, title: "كأس التميز 🏆" }
    ];
    
    rewardLevels.forEach(reward => {
        // التحقق إذا وصل العضو لهذه النقاط ولم يحصل على المكافأة بعد
        if (points >= reward.points) {
            const hasReward = rewards.some(r => 
                r.memberId === memberId && r.pointsRequired === reward.points
            );
            
            if (!hasReward) {
                // منح المكافأة
                rewards.push({
                    memberId: memberId,
                    pointsRequired: reward.points,
                    title: reward.title,
                    date: new Date().toISOString()
                });
                
                // إشعار بالمكافأة
                const member = members.find(m => m.id === memberId);
                showNotification(`مبروك! ${member.name} حصل على ${reward.title}`, true);
            }
        }
    });
}

// طباعة التقرير
function printReport() {
    const printContent = document.getElementById('reports').innerHTML;
    const originalContent = document.body.innerHTML;
    
    document.body.innerHTML = printContent;
    window.print();
    document.body.innerHTML = originalContent;
    
    // إعادة تحميل البيانات بعد الطباعة
    populateData();
}

// تصدير لإكسل
function exportToExcel() {
    // تحضير البيانات
    const data = [];
    
    // عناوين الأعمدة
    data.push(['الاسم', 'النقاط', 'نسبة الحضور', 'المكافآت']);
    
    // بيانات الأعضاء
    const totalWeeks = weeks.length;
    
    members.forEach(member => {
        const points = attendanceRecords.filter(ar => 
            ar.memberId === member.id && ar.present
        ).length;
        
        const attendancePercentage = totalWeeks > 0 ? Math.round((points / totalWeeks) * 100) : 0;
        
        const memberRewards = rewards.filter(r => r.memberId === member.id);
        const rewardsText = memberRewards.map(r => r.title).join(', ') || 'لا يوجد';
        
        data.push([member.name, points, `${attendancePercentage}%`, rewardsText]);
    });
    
    // إنشاء workbook
    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'تقرير الحضور');
    
    // التحميل
    XLSX.writeFile(wb, 'تقرير_الحضور.xlsx');
}

// إضافة أعضاء
function addMember(name, image = ''){
    const id=members.length?Math.max(...members.map(m=>m.id))+1:1;
    members.push({id, name, image: image || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=3498db&color=fff`});
    saveData();
    populateData();
}

// إضافة أسابيع
function addWeek(name,from,to){
    const id=weeks.length?Math.max(...weeks.map(w=>w.id))+1:1;
    weeks.push({id,name,from,to}); 
    saveData(); 
    populateData();
}

// تسجيل الحضور للعضو المحدد
function markAttendance() {
    const memberId = parseInt(document.getElementById('selectMember').value);
    const weekId = parseInt(document.getElementById('weekSelect').value);
    
    if (!memberId || !weekId) {
        alert('يجب اختيار العضو والأسبوع أولاً');
        return;
    }
    
    const index = attendanceRecords.findIndex(ar => 
        ar.memberId === memberId && ar.weekId == weekId
    );
    
    if (index !== -1) {
        // إذا كان موجوداً بالفعل، لا نفعل شيئاً (لا نسمح بالتسجيل المتكرر)
        showNotification('لقد تم تسجيل حضور هذا العضو already في هذا الأسبوع', false);
    } else {
        // إضافة سجل جديد
        attendanceRecords.push({
            memberId: memberId,
            weekId: weekId,
            present: true,
            date: new Date().toISOString()
        });
        
        // التحقق من المكافآت
        checkForRewards(memberId);
        
        saveData();
        populateData();
        showNotification('تم تسجيل الحضور بنجاح!', true);
    }
}

// حذف تسجيل حضور محدد
function deleteAttendanceRecord(index) {
    if (confirm('هل تريد حذف تسجيل الحضور هذا؟')) {
        attendanceRecords.splice(index, 1);
        saveData();
        populateAttendanceRecords();
        populateData(); // تحديث الجدول الرئيسي
    }
}

// حذف كل الحضور لأسبوع محدد
function deleteAllWeekAttendance() {
    const weekId = parseInt(document.getElementById('deleteWeekSelect').value);
    
    if (!weekId) {
        alert('يجب اختيار أسبوع أولاً');
        return;
    }
    
    if (confirm(`هل تريد حذف كل تسجيلات الحضور للأسبوع المحدد؟ هذا الإجراء لا يمكن التراجع عنه!`)) {
        attendanceRecords = attendanceRecords.filter(ar => ar.weekId != weekId);
        saveData();
        populateAttendanceRecords();
        populateData(); // تحديث الجدول الرئيسي
        alert('تم حذف جميع تسجيلات الحضور لهذا الأسبوع');
    }
}

// تبويبات الأدمن
document.querySelectorAll('#adminTabs .tab').forEach(tab=>{
    tab.addEventListener('click',()=>{
        document.querySelectorAll('#adminTabs .tab').forEach(t=>t.classList.remove('active'));
        document.querySelectorAll('#adminTabs .tab-content').forEach(c=>c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');
        
        // إذا كان تبويب إدارة الحضور، قم بتحديث البيانات
        if (tab.dataset.tab === 'attendance') {
            populateAttendanceRecords();
        }
        // إذا كان تبويب التقارير، قم بتحديث التقارير
        else if (tab.dataset.tab === 'reports') {
            updateReports();
        }
    });
});

// تسجيل دخول الأدمن
document.getElementById('adminLoginBtn').addEventListener('click',()=>{document.getElementById('adminLoginModal').style.display='flex';});
document.getElementById('cancelAdminLogin').addEventListener('click',()=>{document.getElementById('adminLoginModal').style.display='none';});
document.getElementById('confirmAdminLogin').addEventListener('click',()=>{
    const pwd=document.getElementById('adminPassword').value;
    if(pwd===adminPass){
        document.getElementById('adminLoginModal').style.display='none';
        document.getElementById('adminTabs').style.display='block';
    }
    else alert('كلمة السر خطأ!');
});

// تعديل وحذف أعضاء
document.addEventListener('click',e=>{
    if(e.target.classList.contains('editMember')){
        const tr=e.target.closest('tr');
        const idx=tr.rowIndex-1;
        const newName=prompt('عدل اسم العضو:',members[idx].name);
        const newImage=prompt('عدل رابط الصورة (اتركه فارغاً إذا لا تريد تغييره):',members[idx].image);
        if(newName){
            members[idx].name=newName;
            if(newImage) members[idx].image=newImage;
            saveData(); 
            populateData();
        }
    }
    if(e.target.classList.contains('deleteMember')){
        if(confirm('هل تريد حذف العضو؟')){
            const tr=e.target.closest('tr'); const idx=tr.rowIndex-1;
            
            // حذف سجلات الحضور الخاصة بهذا العضو أولاً
            attendanceRecords = attendanceRecords.filter(ar => ar.memberId !== members[idx].id);
            
            // حذف مكافآت العضو
            rewards = rewards.filter(r => r.memberId !== members[idx].id);
            
            members.splice(idx,1); 
            saveData(); 
            populateData();
        }
    }
    if(e.target.classList.contains('editWeek')){
        const tr=e.target.closest('tr'); const idx=tr.rowIndex-1;
        const newName=prompt('عدل اسم الأسبوع:',weeks[idx].name);
        const newFrom=prompt('عدل تاريخ البداية:',weeks[idx].from);
        const newTo=prompt('عدل تاريخ النهاية:',weeks[idx].to);
        if(newName && newFrom && newTo){weeks[idx]={...weeks[idx],name:newName,from:newFrom,to:newTo}; saveData(); populateData();}
    }
    if(e.target.classList.contains('deleteWeek')){
        if(confirm('هل تريد حذف الأسبوع؟')){
            const tr=e.target.closest('tr'); const idx=tr.rowIndex-1;
            
            // حذف سجلات الحضور الخاصة بهذا الأسبوع أولاً
            attendanceRecords = attendanceRecords.filter(ar => ar.weekId != weeks[idx].id);
            
            weeks.splice(idx,1); 
            saveData(); 
            populateData();
        }
    }
    
    // النقر على أزرار حذف الحضور
    if(e.target.classList.contains('deleteAttendance')){
        const index = parseInt(e.target.dataset.index);
        deleteAttendanceRecord(index);
    }
});

// رسم بياني
const ctx=document.getElementById('attendanceChart').getContext('2d');
let chart=new Chart(ctx,{type:'bar',data:{labels:members.map(m=>m.name),datasets:[{label:'الحضور',data:Array(members.length).fill(0),backgroundColor:['#3498db','#2ecc71','#f39c12']}]},options:{responsive:true,plugins:{legend:{display:false}}}});
function updateChart(){
    const selectedWeekId = document.getElementById('weekSelect').value;
    
    const data = members.map(member => {
        const record = attendanceRecords.find(ar => 
            ar.memberId === member.id && ar.weekId == selectedWeekId
        );
        return record && record.present ? 1 : 0;
    });
    
    chart.data.labels=members.map(m=>m.name);
    chart.data.datasets[0].data=data;
    chart.update();
}

// أحداث الأزرار
document.getElementById('markPresent').addEventListener('click', markAttendance);
document.getElementById('deleteAttendanceBtn').addEventListener('click', deleteAllWeekAttendance);
document.getElementById('printReportBtn').addEventListener('click', printReport);
document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);

document.getElementById('addMemberBtn').addEventListener('click',()=>{
    const name=document.getElementById('newMemberName').value;
    const image=document.getElementById('newMemberImage').value;
    if(!name){alert('ادخل اسم العضو');return;}
    addMember(name, image); 
    document.getElementById('newMemberName').value='';
    document.getElementById('newMemberImage').value='';
});
document.getElementById('addWeekBtn').addEventListener('click',()=>{
    const name=document.getElementById('newWeekName').value;
    const from=document.getElementById('newWeekStart').value;
    const to=document.getElementById('newWeekEnd').value;
    if(!name||!from||!to){alert('املأ كل الحقول');return;}
    addWeek(name,from,to);
    document.getElementById('newWeekName').value=''; 
    document.getElementById('newWeekStart').value=''; 
    document.getElementById('newWeekEnd').value='';
});

// تحديث البيانات عند تغيير الأسبوع
document.getElementById('weekSelect').addEventListener('change', populateData);

// تحميل البيانات عند بدء التشغيل
loadData();
</script>
</body>
</html>
