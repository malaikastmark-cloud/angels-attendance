<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Angels Attendance</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body{font-family:Tahoma,sans-serif;background:#f4f6f8;color:#333;margin:0;padding:0}
  header{background:#3498db;color:#fff;padding:15px;text-align:center;font-size:22px;font-weight:bold}
  .container{padding:20px;max-width:1200px;margin:auto}
  .card{background:#fff;padding:15px;margin:15px 0;border-radius:10px;box-shadow:0 2px 5px rgba(0,0,0,0.1)}
  h2,h3{margin-top:0}
  button{padding:8px 12px;border:none;border-radius:5px;cursor:pointer}
  .btn-primary{background:#3498db;color:#fff}
  .btn-danger{background:#e74c3c;color:#fff}
  .btn-logout{background:#e67e22;color:#fff;float:right}
  select,input{padding:6px;border-radius:5px;border:1px solid #ccc;margin-right:10px}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px;text-align:center;border-bottom:1px solid #ddd}
  .hidden{display:none}
  .charts-container{display:flex;flex-wrap:wrap;gap:20px;margin-top:20px}
  canvas{background:#fff;padding:10px;border-radius:10px;flex:1 1 400px}
</style>
</head>
<body>
<header>
  Angels Attendance
  <button id="logoutBtn" class="btn-logout hidden">تسجيل خروج</button>
</header>
<div class="container">

<!-- شاشة تسجيل حضور العضو -->
<div id="memberInterface" class="card">
  <h2>تسجيل الحضور</h2>
  <select id="memberSelect"><option value="">اختر الاسم</option></select>
  <select id="weekSelect"><option value="">اختر الأسبوع</option></select>
  <button class="btn-primary" onclick="markAttendance()">تسجيل الحضور</button>
  <p id="memberMessage" style="margin-top:10px;color:green;font-weight:bold"></p>
</div>

<!-- شاشة تسجيل الدخول للادمن -->
<div id="adminLogin" class="card">
  <h2>تسجيل الدخول للمدير</h2>
  <input type="password" id="adminPassword" placeholder="كلمة المرور"/>
  <button class="btn-primary" onclick="adminLogin()">دخول</button>
  <p id="loginMsg" style="color:red"></p>
</div>

<!-- واجهة المدير -->
<div id="adminInterface" class="hidden">
  <h2>لوحة التحكم</h2>

  <div class="card">
    <h3>إضافة عضو جديد</h3>
    <input type="text" id="newMemberName" placeholder="اسم العضو"/>
    <button class="btn-primary" onclick="addNewMember()">إضافة عضو</button>
  </div>

  <div class="card">
    <h3>قائمة الأعضاء</h3>
    <table>
      <thead><tr><th>م</th><th>الاسم</th><th>حضور</th><th>حذف</th></tr></thead>
      <tbody id="membersList"></tbody>
    </table>
  </div>

  <div class="card">
    <h3>إضافة أسبوع جديد</h3>
    <input type="text" id="newWeekName" placeholder="اسم الأسبوع"/>
    <button class="btn-primary" onclick="addNewWeek()">إضافة أسبوع</button>
  </div>

  <div class="card">
    <h3>قائمة الأسابيع</h3>
    <table>
      <thead><tr><th>م</th><th>اسم الأسبوع</th><th>حذف</th></tr></thead>
      <tbody id="weeksList"></tbody>
    </table>
  </div>

  <div class="charts-container">
    <canvas id="attendanceChart"></canvas>
    <canvas id="pointsChart"></canvas>
  </div>
</div>

</div>

<script>
// Firebase
const firebaseConfig = {
  apiKey: "AIzaSyBCQIqdCsxSvhfYOs00AetoVWpFhj4XNAQ",
  authDomain: "angels-attendance.firebaseapp.com",
  databaseURL: "https://angels-attendance-default-rtdb.firebaseio.com",
  projectId: "angels-attendance",
  storageBucket: "angels-attendance.appspot.com",
  messagingSenderId: "157249026489",
  appId: "1:157249026489:web:db2b420203bd81d9a19e68"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// بيانات محلية
let members = [], weeks = [], attendanceRecords = [];

// تحميل البيانات من Firebase
function loadData(){
  db.ref('members').on('value',snap=>{members = snap.val()||[];populateMembers();updateCharts()})
  db.ref('weeks').on('value',snap=>{weeks = snap.val()||[];populateWeeks()})
  db.ref('attendanceRecords').on('value',snap=>{attendanceRecords = snap.val()||[];updateCharts()})
}

// تسجيل حضور
function markAttendance(){
  const memberId = document.getElementById('memberSelect').value;
  const weekId = document.getElementById('weekSelect').value;
  if(!memberId||!weekId){document.getElementById('memberMessage').textContent='اختر الاسم والأسبوع';return;}
  // تحقق إن لم يتم تسجيل الحضور مسبقاً
  const exist = attendanceRecords.find(a=>a.memberId==memberId && a.weekId==weekId);
  if(exist){document.getElementById('memberMessage').textContent='تم تسجيل الحضور مسبقاً';return;}
  const newRecord = {memberId, weekId, present:true};
  attendanceRecords.push(newRecord);
  db.ref('attendanceRecords').set(attendanceRecords);
  document.getElementById('memberMessage').textContent='تم تسجيل الحضور بنجاح';
  setTimeout(()=>{document.getElementById('memberMessage').textContent=''},3000);
  updateCharts();
}

// واجهة الادمن
function adminLogin(){
  const pwd = document.getElementById('adminPassword').value;
  if(pwd==='admin123'){
    document.getElementById('adminLogin').classList.add('hidden');
    document.getElementById('memberInterface').classList.add('hidden');
    document.getElementById('adminInterface').classList.remove('hidden');
    document.getElementById('logoutBtn').classList.remove('hidden');
    loadData();
  } else {document.getElementById('loginMsg').textContent='كلمة المرور خاطئة';}
}
document.getElementById('logoutBtn').addEventListener('click',()=>{
  document.getElementById('adminInterface').classList.add('hidden');
  document.getElementById('memberInterface').classList.remove('hidden');
  document.getElementById('adminLogin').classList.remove('hidden');
  document.getElementById('logoutBtn').classList.add('hidden');
})

// إضافة عضو
function addNewMember(){
  const name = document.getElementById('newMemberName').value;
  if(!name) return;
  const newMember = {id:Date.now().toString(),name};
  members.push(newMember);
  db.ref('members').set(members);
  document.getElementById('newMemberName').value='';
}

// حذف عضو
function deleteMember(id){
  members = members.filter(m=>m.id!==id);
  db.ref('members').set(members);
  attendanceRecords = attendanceRecords.filter(a=>a.memberId!==id);
  db.ref('attendanceRecords').set(attendanceRecords);
  updateCharts();
}

// إضافة أسبوع
function addNewWeek(){
  const name = document.getElementById('newWeekName').value;
  if(!name) return;
  const newWeek = {id:Date.now().toString(),name};
  weeks.push(newWeek);
  db.ref('weeks').set(weeks);
  document.getElementById('newWeekName').value='';
}

// حذف أسبوع
function deleteWeek(id){
  weeks = weeks.filter(w=>w.id!==id);
  db.ref('weeks').set(weeks);
  attendanceRecords = attendanceRecords.filter(a=>a.weekId!==id);
  db.ref('attendanceRecords').set(attendanceRecords);
  updateCharts();
}

// تعبئة القوائم
function populateMembers(){
  const memberSelect = document.getElementById('memberSelect');
  const membersList = document.getElementById('membersList');
  memberSelect.innerHTML='<option value="">اختر الاسم</option>';
  membersList.innerHTML='';
  members.forEach((m,i)=>{
    memberSelect.innerHTML+=`<option value="${m.id}">${m.name}</option>`;
    membersList.innerHTML+=`<tr><td>${i+1}</td><td>${m.name}</td><td>${attendanceRecords.filter(a=>a.memberId===m.id && a.present).length}</td><td><button class="btn-danger" onclick="deleteMember('${m.id}')">حذف</button></td></tr>`;
  })
}

function populateWeeks(){
  const weekSelect = document.getElementById('weekSelect');
  const weeksList = document.getElementById('weeksList');
  weekSelect.innerHTML='<option value="">اختر الأسبوع</option>';
  weeksList.innerHTML='';
  weeks.forEach((w,i)=>{
    weekSelect.innerHTML+=`<option value="${w.id}">${w.name}</option>`;
    weeksList.innerHTML+=`<tr><td>${i+1}</td><td>${w.name}</td><td><button class="btn-danger" onclick="deleteWeek('${w.id}')">حذف</button></td></tr>`;
  })
}

// المخططات
let attendanceChartInstance=null, pointsChartInstance=null;
function updateCharts(){
  populateMembers();
  populateWeeks();
  const labels = members.map(m=>m.name);
  const attendanceCounts = members.map(m=>attendanceRecords.filter(a=>a.memberId===m.id && a.present).length);
  const pointsCounts = attendanceCounts.map(c=>c*10);

  const ctx1=document.getElementById('attendanceChart').getContext('2d');
  if(attendanceChartInstance) attendanceChartInstance.destroy();
  attendanceChartInstance=new Chart(ctx1,{
    type:'bar',
    data:{labels, datasets:[{label:'عدد الحضور', data:attendanceCounts, backgroundColor:'#3498db'}]},
    options:{responsive:true, plugins:{legend:{display:false}}}
  });

  const ctx2=document.getElementById('pointsChart').getContext('2d');
  if(pointsChartInstance) pointsChartInstance.destroy();
  pointsChartInstance=new Chart(ctx2,{
    type:'line',
    data:{labels, datasets:[{label:'النقاط', data:pointsCounts, borderColor:'#2ecc71', fill:false}]},
    options:{responsive:true, plugins:{legend:{display:true}}}
  });
}

</script>
</body>
</html>
