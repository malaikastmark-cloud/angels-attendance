<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Angels Attendance</title>
<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600&display=swap" rel="stylesheet">
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<style>
    * { font-family: 'Cairo', sans-serif; box-sizing: border-box; margin:0; padding:0; }
    body { background: #f0f4f8; color:#333; }
    header { background: #3498db; color:white; padding:15px 20px; text-align:center; font-size:1.5em; font-weight:600; }
    .container { max-width:1200px; margin:20px auto; padding:20px; background:white; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.1); }
    label { display:block; margin:10px 0 5px; font-weight:600; }
    select, input { width:100%; padding:10px; border-radius:8px; border:1px solid #ccc; margin-bottom:15px; }
    button { padding:10px 20px; border:none; border-radius:8px; background:#2ecc71; color:white; font-weight:600; cursor:pointer; transition:0.3s; }
    button:hover { background:#27ae60; }
    .admin-login { float:right; background:#e67e22; }
    .admin-login:hover { background:#d35400; }
    table { width:100%; border-collapse:collapse; margin-top:20px; }
    th, td { border:1px solid #ddd; padding:10px; text-align:center; }
    th { background:#3498db; color:white; }
    .member-img { width:40px; height:40px; border-radius:50%; object-fit:cover; }
    .notification { position:fixed; top:20px; right:20px; background:#2ecc71; color:white; padding:15px 20px; border-radius:10px; display:none; z-index:1000; box-shadow:0 4px 15px rgba(0,0,0,0.2); }
    .tab { display:inline-block; padding:10px 20px; cursor:pointer; background:#bdc3c7; border-radius:8px 8px 0 0; margin-right:5px; }
    .tab.active { background:#3498db; color:white; }
    .tab-content { display:none; padding:20px; border-top:3px solid #3498db; }
    .tab-content.active { display:block; }
    .top-member-item { display:flex; justify-content:space-between; align-items:center; padding:8px; border-bottom:1px solid #eee; }
    .top-member-item img { width:35px; height:35px; border-radius:50%; object-fit:cover; }
</style>
</head>
<body>

<header>
  Angels Attendance
  <button id="adminLoginBtn" class="admin-login">دخول الأدمن</button>
</header>

<div class="container" id="userInterface">
  <label for="selectMember">اختر اسمك / Choose Name</label>
  <select id="selectMember"><option value="">-- اختر --</option></select>

  <label for="weekSelect">اختر الأسبوع / Choose Week</label>
  <select id="weekSelect"></select>

  <button id="markPresent">تسجيل الحضور / Mark Attendance</button>
</div>

<div class="container notification" id="notification"></div>

<!-- Admin Modal -->
<div id="adminLoginModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center;">
  <div style="background:white; padding:30px; border-radius:12px; width:300px; text-align:center;">
    <h3>تسجيل دخول الأدمن</h3>
    <input type="password" id="adminPassword" placeholder="كلمة السر / Password">
    <div style="margin-top:15px;">
      <button id="confirmAdminLogin">دخول / Login</button>
      <button id="cancelAdminLogin" style="background:#e74c3c;">إلغاء / Cancel</button>
    </div>
  </div>
</div>

<div class="container" id="adminTabs" style="display:none;">
  <div id="tabsMenu">
    <span class="tab active" data-tab="membersTab">الأعضاء / Members</span>
    <span class="tab" data-tab="weeksTab">الأسابيع / Weeks</span>
    <span class="tab" data-tab="attendanceTab">الحضور / Attendance</span>
    <span class="tab" data-tab="reportsTab">التقارير / Reports</span>
  </div>

  <div id="membersTab" class="tab-content active">
    <h3>إدارة الأعضاء / Manage Members</h3>
    <input type="text" id="newMemberName" placeholder="اسم العضو / Name">
    <input type="text" id="newMemberImage" placeholder="رابط الصورة / Image URL">
    <button id="addMemberBtn">إضافة عضو / Add Member</button>
    <table id="membersTable">
      <thead><tr><th>#</th><th>صورة</th><th>الاسم</th><th>نقاط</th><th>مكافآت</th><th>تعديل</th><th>حذف</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="weeksTab" class="tab-content">
    <h3>إدارة الأسابيع / Manage Weeks</h3>
    <input type="text" id="newWeekName" placeholder="اسم الأسبوع / Week Name">
    <input type="date" id="newWeekStart">
    <input type="date" id="newWeekEnd">
    <button id="addWeekBtn">إضافة أسبوع / Add Week</button>
    <table id="weeksTable">
      <thead><tr><th>#</th><th>الاسم</th><th>من</th><th>إلى</th><th>تعديل</th><th>حذف</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="attendanceTab" class="tab-content">
    <h3>سجلات الحضور / Attendance Records</h3>
    <table id="attendanceRecordsTable">
      <thead><tr><th>#</th><th>العضو</th><th>الأسبوع</th><th>التاريخ</th><th>حذف</th></tr></thead>
      <tbody id="attendanceRecordsBody"></tbody>
    </table>
  </div>

  <div id="reportsTab" class="tab-content">
    <h3>التقارير / Reports</h3>
    <canvas id="attendanceChart" style="height:250px;"></canvas>
    <h4>Top 10</h4>
    <div id="topMembersList"></div>
  </div>
</div>

<script>
const adminPass = 'admin123';
let members = [];
let weeks = [];
let attendanceRecords = [];
let rewards = [];

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyBCQIqdCsxSvhfYOs00AetoVWpFhj4XNAQ",
  authDomain: "angels-attendance.firebaseapp.com",
  databaseURL: "https://angels-attendance-default-rtdb.firebaseio.com",
  projectId: "angels-attendance",
  storageBucket: "angels-attendance.firebasestorage.app",
  messagingSenderId: "157249026489",
  appId: "1:157249026489:web:db2b420203bd81d9a19e68",
  measurementId: "G-2YDPSFPQYT"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Notification
function showNotification(msg, success=true){
  const notif = document.getElementById('notification');
  notif.textContent = msg;
  notif.style.background = success ? '#2ecc71' : '#e74c3c';
  notif.style.display='block';
  setTimeout(()=>{notif.style.display='none'},3000);
}

// Load Data
function loadData(){
  db.ref('/members').once('value').then(snapshot => { members = snapshot.val() || []; populateMembers(); populateSelects(); updateReports(); });
  db.ref('/weeks').once('value').then(snapshot => { weeks = snapshot.val() || []; populateWeeks(); populateSelects(); updateReports(); });
  db.ref('/attendance').once('value').then(snapshot => { attendanceRecords = snapshot.val() || []; updateReports(); });
  db.ref('/rewards').once('value').then(snapshot => { rewards = snapshot.val() || []; });
}

// Populate selects
function populateSelects(){
  const memberSel = document.getElementById('selectMember');
  memberSel.innerHTML = '<option value="">-- اختر --</option>';
  members.forEach((m,i)=>{ const opt=document.createElement('option'); opt.value=i; opt.textContent=m.name; memberSel.appendChild(opt); });
  const weekSel = document.getElementById('weekSelect');
  weekSel.innerHTML=''; weeks.forEach((w,i)=>{ const opt=document.createElement('option'); opt.value=i; opt.textContent=w.name; weekSel.appendChild(opt); });
}

// Admin Tabs
document.querySelectorAll('.tab').forEach(tab=>{
  tab.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById(tab.dataset.tab).classList.add('active');
  });
});

// Admin Login
document.getElementById('adminLoginBtn').addEventListener('click',()=>{ document.getElementById('adminLoginModal').style.display='flex'; });
document.getElementById('cancelAdminLogin').addEventListener('click',()=>{ document.getElementById('adminLoginModal').style.display='none'; });
document.getElementById('confirmAdminLogin').addEventListener('click',()=>{
  const pwd = document.getElementById('adminPassword').value;
  if(pwd===adminPass){
    document.getElementById('adminLoginModal').style.display='none';
    document.getElementById('adminTabs').style.display='block';
    document.getElementById('userInterface').style.display='none';
    document.getElementById('adminLoginBtn').style.display='none';
    showNotification('تم تسجيل دخول الأدمن بنجاح');
  } else alert('كلمة السر خطأ!');
});

// Add Member
document.getElementById('addMemberBtn').addEventListener('click',()=>{
  const name=document.getElementById('newMemberName').value;
  const image=document.getElementById('newMemberImage').value || '';
  if(!name){alert('ادخل اسم العضو'); return;}
  const id = members.length ? Math.max(...members.map(m=>m.id))+1 : 1;
  const member={id,name,image};
  members.push(member);
  db.ref('/members').set(members);
  populateMembers(); populateSelects();
  document.getElementById('newMemberName').value=''; document.getElementById('newMemberImage').value='';
  showNotification('تم إضافة العضو');
});

// Add Week
document.getElementById('addWeekBtn').addEventListener('click',()=>{
  const name=document.getElementById('newWeekName').value;
  const from=document.getElementById('newWeekStart').value;
  const to=document.getElementById('newWeekEnd').value;
  if(!name || !from || !to){alert('املأ كل الحقول'); return;}
  const id = weeks.length ? Math.max(...weeks.map(w=>w.id))+1 : 1;
  weeks.push({id,name,from,to});
  db.ref('/weeks').set(weeks);
  populateWeeks(); populateSelects();
  document.getElementById('newWeekName').value=''; document.getElementById('newWeekStart').value=''; document.getElementById('newWeekEnd').value='';
  showNotification('تم إضافة الأسبوع');
});

// Mark Attendance
document.getElementById('markPresent').addEventListener('click',()=>{
  const memberIndex = document.getElementById('selectMember').value;
  const weekIndex = document.getElementById('weekSelect').value;
  if(memberIndex===''){alert('اختر العضو'); return;}
  if(weekIndex===''){alert('اختر الأسبوع'); return;}
  const member = members[memberIndex];
  const week = weeks[weekIndex];
  attendanceRecords.push({memberId:member.id,weekId:week.id,date:new Date().toISOString()});
  db.ref('/attendance').set(attendanceRecords);
  showNotification(`تم تسجيل حضور ${member.name}`);
  updateReports();
});

// Populate Tables
function populateMembers(){
  const tbody=document.querySelector('#membersTable tbody');
  tbody.innerHTML='';
  members.forEach((m,i)=>{
    const totalPoints = attendanceRecords.filter(ar=>ar.memberId===m.id).length;
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${i+1}</td>
      <td><img src="${m.image}" class="member-img"></td>
      <td>${m.name}</td>
      <td>${totalPoints}</td>
      <td></td>
      <td><button onclick="editMember(${i})">تعديل</button></td>
      <td><button onclick="deleteMember(${i})">حذف</button></td>
    `;
    tbody.appendChild(tr);
  });
}
function populateWeeks(){
  const tbody=document.querySelector('#weeksTable tbody');
  tbody.innerHTML='';
  weeks.forEach((w,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${i+1}</td>
      <td>${w.name}</td>
      <td>${w.from}</td>
      <td>${w.to}</td>
      <td><button onclick="editWeek(${i})">تعديل</button></td>
      <td><button onclick="deleteWeek(${i})">حذف</button></td>
    `;
    tbody.appendChild(tr);
  });
}

// Edit/Delete Member & Week
function editMember(idx){
  const name=prompt('عدل الاسم',members[idx].name);
  if(name){ members[idx].name=name; db.ref('/members').set(members); populateMembers(); populateSelects(); showNotification('تم تعديل العضو'); } 
}
function deleteMember(idx){
  if(confirm('هل تريد حذف العضو؟')){ members.splice(idx,1); db.ref('/members').set(members); populateMembers(); populateSelects(); showNotification('تم الحذف'); }
}
function editWeek(idx){
  const name=prompt('عدل اسم الأسبوع',weeks[idx].name);
  if(name){ weeks[idx].name=name; db.ref('/weeks').set(weeks); populateWeeks(); populateSelects(); showNotification('تم تعديل الأسبوع'); }
}
function deleteWeek(idx){
  if(confirm('هل تريد حذف الأسبوع؟')){ weeks.splice(idx,1); db.ref('/weeks').set(weeks); populateWeeks(); populateSelects(); showNotification('تم الحذف'); }
}

// Reports
const ctx=document.getElementById('attendanceChart').getContext('2d');
let chart=new Chart(ctx,{type:'bar',data:{labels:[],datasets:[{label:'الحضور',data:[],backgroundColor:'#3498db'}]},options:{responsive:true,plugins:{legend:{display:false}}}});
function updateReports(){
  const labels=members.map(m=>m.name);
  const data=members.map(m=>attendanceRecords.filter(ar=>ar.memberId===m.id).length);
  chart.data.labels=labels; chart.data.datasets[0].data=data; chart.update();
  const top10=members.map(m=>({name:m.name,points:attendanceRecords.filter(ar=>ar.memberId===m.id).length}))
                    .sort((a,b)=>b.points-a.points).slice(0,10);
  const topDiv=document.getElementById('topMembersList'); topDiv.innerHTML='';
  top10.forEach(t=>{
    const div=document.createElement('div'); div.className='top-member-item';
    div.innerHTML=`<span>${t.name}</span><span>${t.points} نقطة</span>`;
    topDiv.appendChild(div);
  });
}

document.addEventListener('DOMContentLoaded',loadData);
</script>
</body>
</html>
