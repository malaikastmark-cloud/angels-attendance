<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>اجتماع خدام ملايكة</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Add Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;}
body{background: linear-gradient(135deg,#fceabb,#f8b500);min-height:100vh;padding:20px;}
.container{max-width:1200px;margin:0 auto;background:rgba(255,255,255,0.95);border-radius:15px;box-shadow:0 10px 20px rgba(0,0,0,0.2);padding:20px;}
header{background:#3498db;color:white;padding:15px;text-align:center;border-radius:10px;position:relative;}
header::before{content:"🧚‍♂️";position:absolute;left:10px;top:10px;font-size:1.5rem;}
header::after{content:"✨";position:absolute;right:10px;top:10px;font-size:1.5rem;}
h1{font-size:2rem;}
.tab-content{display:none;padding:20px;}
.tab-content.active{display:block;}
table{width:100%;border-collapse:collapse;margin-top:15px;background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 5px 15px rgba(0,0,0,0.1);}
th,td{padding:10px;text-align:center;border-bottom:1px solid #ddd;}
th{background:#3498db;color:white;}
tr:nth-child(even){background:#f9f9f9;}
tr:hover{background:#f1f1f1;}
.btn{padding:8px 15px;border:none;border-radius:5px;cursor:pointer;font-weight:bold;margin:5px;}
.btn-primary{background:#2ecc71;color:white;}
.btn-primary:hover{background:#27ae60;}
.btn-success{background:#3498db;color:white;}
.btn-success:hover{background:#2980b9;}
.btn-danger{background:#e74c3c;color:white;}
.btn-danger:hover{background:#c0392b;}
.controls{margin:10px 0;display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;}
select,input{padding:5px;border-radius:5px;border:1px solid #ccc;}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;}
.modal-content{background:white;padding:20px;border-radius:10px;width:400px;max-width:90%;}
.tabs{display:flex;gap:5px;margin-bottom:10px;}
.tabs .tab{padding:8px 15px;cursor:pointer;border-radius:5px;background:#f0f0f0;}
.tabs .tab.active{background:#3498db;color:white;}
.summary-card{background:#fff;border-radius:10px;padding:15px;text-align:center;box-shadow:0 5px 15px rgba(0,0,0,0.1);}
.summary-card h3{color:#3498db;margin-bottom:10px;}
.summary-value{font-size:2rem;font-weight:bold;color:#2ecc71;}
.card-container{display:flex;gap:15px;flex-wrap:wrap;margin-top:15px;}
.loading{display:none;text-align:center;margin:20px 0;}
.loading-spinner{width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto;}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
</style>
</head>
<body>
<div class="container">
    <header>
        <h1>🌟 اجتماع خدام ملايكة</h1>
        <p>الحضور يساوي نقطة</p>
    </header>

    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <p>جاري تحميل البيانات...</p>
    </div>

    <div class="tab-content active" id="userAttendance">
        <div class="controls">
            <label>اختر اسمك: </label>
            <select id="selectMember"></select>
            <label>اختر الأسبوع: </label>
            <select id="weekSelect"></select>
        </div>
        <div class="controls">
            <button class="btn btn-success" id="adminLoginBtn">تسجيل دخول الأدمن</button>
            <button class="btn btn-primary" id="markPresent">تسجيل الحضور</button>
        </div>
        <table>
            <thead><tr><th>#</th><th>اسم العضو</th><th>الحضور</th><th>النقاط</th></tr></thead>
            <tbody id="attendanceTableBody"></tbody>
        </table>
        <div class="controls">
            <span>الحضور هذا الأسبوع: <span id="attendanceCount">0</span>/<span id="totalMembers">0</span></span>
            <span>النقاط: <span id="totalPoints">0</span></span>
        </div>
    </div>

    <div class="modal" id="adminLoginModal">
        <div class="modal-content">
            <h2>تسجيل دخول الأدمن</h2>
            <input type="password" id="adminPassword" placeholder="كلمة السر">
            <div class="controls">
                <button class="btn btn-danger" id="cancelAdminLogin">إلغاء</button>
                <button class="btn btn-success" id="confirmAdminLogin">دخول</button>
            </div>
        </div>
    </div>

    <div class="tab-content" id="adminTabs" style="display:none;">
        <div class="tabs">
            <div class="tab active" data-tab="members">إدارة الأعضاء</div>
            <div class="tab" data-tab="weeks">إدارة الأسابيع</div>
            <div class="tab" data-tab="reports">التقارير</div>
        </div>

        <div class="tab-content active" id="members">
            <h2>إدارة الأعضاء</h2>
            <div class="controls">
                <input type="text" id="newMemberName" placeholder="اسم العضو">
                <button class="btn btn-primary" id="addMemberBtn">إضافة عضو</button>
            </div>
            <table id="membersTable">
                <thead><tr><th>#</th><th>اسم العضو</th><th>النقاط</th><th>تعديل</th><th>حذف</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="tab-content" id="weeks">
            <h2>إدارة الأسابيع</h2>
            <div class="controls">
                <input type="text" id="newWeekName" placeholder="اسم الأسبوع">
                <input type="date" id="newWeekStart">
                <input type="date" id="newWeekEnd">
                <button class="btn btn-primary" id="addWeekBtn">إضافة أسبوع</button>
            </div>
            <table id="weeksTable">
                <thead><tr><th>#</th><th>اسم الأسبوع</th><th>من</th><th>إلى</th><th>تعديل</th><th>حذف</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="tab-content" id="reports">
            <h2>التقارير</h2>
            <div class="card-container">
                <div class="summary-card"><h3>إجمالي الحضور</h3><div class="summary-value" id="reportAttendance">0</div></div>
                <div class="summary-card"><h3>النقاط الممنوحة</h3><div class="summary-value极" id="reportPoints">0</div></div>
            </div>
            <canvas id="attendanceChart" style="margin-top:20px;"></canvas>
        </div>
    </div>
</div>

<script>
// ====== إعدادات Firebase - يجب استبدالها بإعداداتك ======
const firebaseConfig = {
    apiKey: "AIzaSyBCQIqdCsxSvhfYOs00Aeto极WpFhj4XNAQ",
    authDomain: "angels-attendance.firebaseapp.com",
    databaseURL: "https://angels-attendance-default-rtdb.firebaseio.com",
    projectId: "angels-attendance",
    storageBucket: "angels-attendance.firebasestorage.app",
    messagingSenderId: "157249026489",
    appId: "1:157249026489:web:db2b420203bd81d9a19e68"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// بيانات التطبيق
let members = [];
let weeks = [];

// وظائف Firebase
function showLoading() {
    document.getElementById('loading').style.display = 'block';
}

function hideLoading() {
    document.getElementById('loading').style.display = 'none';
}

function loadData() {
    showLoading();
    const data极f = database.ref('angelsAttendance');
    
    dataRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            members = data.members || [];
            weeks = data.weeks || [];
        } else {
            // البيانات الأولية إذا لم توجد بيانات
            members = [{id:1,name:'🧒 Mary Karam'},{id:2,name:'👦 Eman Makin'},{id:3,name:'👧 Rizk Gerges'}];
            weeks = [{id:1,name:'الاسبوع الاول',from:'2025-08-29',to:'2025-08-29'}];
            saveData();
        }
        populateData();
        hideLoading();
    }, (error) => {
        console.error('Error loading data:', error);
        hideLoading();
        alert('حدث خطأ في تحميل البيانات. تأكد من اتصال الإنترنت.');
    });
}

function saveData() {
    showLoading();
    const dataRef = database.ref('angelsAttendance');
    dataRef.set({
        members: members,
        weeks: weeks
    }).then(() => {
        hideLoading();
    }).catch((error) => {
        console.error('Error saving data:', error);
        hideLoading();
        alert('حدث خطأ في حفظ البيانات. تأكد من اتصال الإنترنت.');
    });
}

// بقية الوظائف كما هي مع تعديل بسيط
function populateData(){
    const selectMember=document.getElementById('selectMember');
    selectMember.innerHTML='';
    members.forEach(m=>{let o=document.createElement('option'); o.value=m.id; o.textContent=m.name; selectMember.appendChild(o);});

    const weekSelect=document.getElementById('weekSelect');
    weekSelect.innerHTML='';
    weeks.forEach(w=>{let o=document.createElement极('option'); o.value=w.id; o.textContent=w.name; weekSelect.appendChild(o);});

    const tbody=document.getElementById('attendanceTableBody'); tbody.innerHTML='';
    members.forEach((m,i)=>{
        let tr=document.createElement('tr'); tr.dataset.member=m.id;
        tr.innerHTML=`<td>${i+1}</td><td>${m.name}</td><td><input type="checkbox" class="attendance-check"></td><td class="points">0</td>`;
        tbody.appendChild(tr);
    });
    document.getElementById('totalMembers').textContent=members.length;
    populateAdminTables();
}

function populateAdminTables(){
    const membersTbody=document.querySelector('#membersTable tbody');
    membersTbody.innerHTML='';
    members.forEach((m,i)=>{
        let tr=document.createElement('tr');
        tr.innerHTML=`<极>${i+1}</td><td>${m.name}</td><td>0</td><td><button class='btn btn-primary editMember'>تعديل</button></td><td><button class='btn btn-danger deleteMember'>حذف</button></td>`;
        membersTbody.appendChild(tr);
    });
    const weeksTbody=document.querySelector('#weeksTable tbody');
    weeks极body.innerHTML='';
    weeks.forEach((w,i)=>{
        let tr=document.createElement('tr');
        tr.innerHTML=`<td>${i+1}</td><td>${w.name}</td><td>${w.from}</td><td>${w.to}</td><td><button class='btn btn-primary editWeek'>تعديل</button></td><td><button class='btn btn-danger deleteWeek'>حذف</button></td>`;
        weeksTbody.appendChild(tr);
    });
}

function updateAttendanceStats(){
    let count=0;
    let totalPoints=0;
    document.querySelectorAll('.attendance-check').forEach(cb=>{
        const pointsTd=cb.closest('tr').querySelector('.points');
        if(cb.checked){pointsTd.textContent='1'; count++; totalPoints+=1;} else pointsTd.textContent='0';
    });
    document.getElementById('attendanceCount').textContent=count;
    document.getElementById('totalPoints').textContent=totalPoints;
    document.getElementById('reportAttendance').textContent=count;
    document.getElementById('reportPoints').textContent=totalPoints;
    updateChart();
}

// إضافة أعضاء
function addMember(name){
    const id=members.length?Math.max(...members.map(m=>m.id))+1:1;
    members.push({id,name});
    saveData(); populateData();
}

// إضافة أسابيع
function addWeek(name,from,to){
    const id=weeks.length?Math.max(...weeks.map(w=>w.id))+1:1;
    weeks.push({id,name,from,to}); saveData(); populateData();
}

// تبويبات الأدمن
document.querySelectorAll('#adminTabs .tab').forEach(tab=>{
    tab.addEventListener('click',()=>{
        document.querySelectorAll('#adminTabs .tab').forEach(t=>t.classList.remove('active'));
        document.querySelectorAll('#adminTabs .tab-content').forEach(c=>c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');
    });
});

// تسجيل دخول الأدمن
const adminPass='1234';
document.getElementById('adminLoginBtn').addEventListener('click',()=>{document.getElementById('adminLoginModal').style.display='flex';});
document.getElementById('cancelAdminLogin').addEventListener('click',()=>{document.getElementById('adminLoginModal').style.display='none';});
document.getElementById('confirmAdminLogin').addEventListener('click',()=>{
    const pwd=document.getElementById('adminPassword').value;
    if(pwd===adminPass){document.getElementById('adminLoginModal').style.display='none';document.getElementById('adminTabs').style.display='block';}
    else alert('كلمة السر خطأ!');
});

// تعديل وحذف أعضاء
document.addEventListener('click',e=>{
    if(e.target.classList.contains('editMember')){
        const tr=e.target.closest('tr');
        const idx=tr.rowIndex-1; // zero based
        const newName=prompt('عدل اسم العضو:',members[idx].name);
        if(newName){members[idx极name=newName; saveData(); populateData();}
    }
    if(e.target.classList.contains('deleteMember')){
        if(confirm('هل تريد حذف العضو؟')){
            const tr=e.target.closest('tr'); const idx=tr.rowIndex-1;
            members.splice(idx,1); saveData(); populateData();
        }
    }
    if(e.target.classList.contains('editWeek')){
        const tr=e.target.closest('tr'); const idx=tr.rowIndex-1;
        const newName=prompt('عدل اسم الأسبوع:',weeks[idx].name);
        const newFrom=prompt('عدل تاريخ البداية:',weeks[idx].from);
        const newTo=prompt('عدل تاريخ النهاية:',weeks[idx].to);
        if(newName && newFrom && newTo){weeks[idx]={...weeks[idx],name:newName,from:newFrom,to:newTo}; saveData(); populateData();}
    }
    if(e.target.classList.contains('deleteWeek')){
        if(confirm('هل تريد حذف الأسبوع؟')){
            const tr=e.target.closest('tr'); const idx=tr.rowIndex-1;
            weeks.splice(idx,1); saveData(); populateData();
        }
    }
});

// رسم بياني
const ctx=document.getElementById('attendanceChart').getContext('2d');
let chart=new Chart(ctx,{type:'bar',data:{labels:members.map(m=>m.name),datasets:[{label:'الحضور',data:Array(members.length).fill(0),backgroundColor:['#3498db','#2ecc71','#f39c12']}]},options:{responsive:true,plugins:{legend:{display:false}}}});
function updateChart(){
    chart.data.labels=members.map(m=>m.name);
    chart.data.datasets[0].data=Array.from(document.querySelectorAll('.attendance-check')).map(cb=>cb.checked?1:0);
    chart.update();
}

// أحداث الأزرار
document.getElementById('markPresent').addEventListener('click',updateAttendanceStats);
document.getElementById('addMemberBtn').addEventListener('click',()=>{
    const name=document.getElementById('newMemberName').value;
    if(!name){alert('ادخل اسم العضو');return;}
    addMember(name); document.getElementById('newMemberName').value='';
});
document.getElementById('addWeekBtn').addEventListener('click',()=>{
    const name=document.getElementById('newWeekName').value;
    const from=document.getElementById('newWeek极tart').value;
    const to=document.getElementById('newWeekEnd').value;
    if(!name||!from||!极){alert('املأ كل الحقول');return;}
    addWeek(name,from,to);
    document.getElementById('newWeekName').value=''; document.getElementById('newWeekStart').value=''; document.getElementById('newWeekEnd').value='';
});

// تحميل البيانات عند بدء التشغيل
loadData();
</script>
</body>
</html>
