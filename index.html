<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Angels Attendance</title>
<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600&display=swap" rel="stylesheet">
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    /* --- General Styles --- */
    body {
        font-family: 'Cairo', sans-serif;
        margin: 0;
        padding: 0;
        background: url('https://images.unsplash.com/photo-1612831455541-33b0e4c26f10?auto=format&fit=crop&w=1950&q=80') no-repeat center center fixed;
        background-size: cover;
        color: #fff;
    }
    h2 { text-align:center; margin-top:20px; }
    .container { max-width:1200px; margin:auto; padding:20px; background: rgba(0,0,0,0.6); border-radius:15px; }
    button { cursor:pointer; border:none; border-radius:5px; padding:8px 15px; margin:5px; font-weight:bold; }
    .btn-primary { background:#3498db; color:#fff; }
    .btn-danger { background:#e74c3c; color:#fff; }
    .btn-success { background:#2ecc71; color:#fff; }

    /* --- Layout --- */
    .flex { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    select, input { padding:8px; border-radius:5px; border:none; }
    table { width:100%; border-collapse: collapse; margin-top:15px; }
    table, th, td { border:1px solid #fff; }
    th, td { padding:10px; text-align:center; }
    .tab-content { display:none; }
    .tab-content.active { display:block; }

    /* --- Notification --- */
    #notification { position:fixed; top:20px; right:20px; padding:15px 20px; border-radius:10px; display:none; font-weight:bold; z-index:1000; }

    /* --- Member Stats Cards --- */
    .member-card { background: rgba(255,255,255,0.1); padding:10px; margin:10px 0; border-radius:10px; display:flex; align-items:center; gap:10px; }
    .member-card img { width:50px; height:50px; border-radius:50%; }

    /* --- Admin Tabs --- */
    .tabs { display:flex; gap:5px; margin-bottom:10px; }
    .tab { padding:10px 15px; background:#555; cursor:pointer; border-radius:5px; }
    .tab.active { background:#3498db; }
</style>
</head>
<body>

<div class="container">
<h2>Angels Attendance</h2>

<!-- User Section -->
<div id="userSection">
    <div class="flex">
        <select id="selectMember">
            <option value="">-- اختر اسمك --</option>
        </select>
        <select id="weekSelect">
            <option value="">-- اختر الأسبوع --</option>
        </select>
        <button class="btn btn-success" id="markPresent">تسجيل الحضور</button>
        <button class="btn btn-primary" id="adminLoginBtn">دخول الأدمن</button>
    </div>
</div>

<!-- Admin Tabs -->
<div id="adminTabs" style="display:none;">
    <div class="tabs">
        <div class="tab active" data-tab="membersTab">الأعضاء</div>
        <div class="tab" data-tab="weeksTab">الأسابيع</div>
        <div class="tab" data-tab="tasksTab">المهام والمسابقات</div>
        <div class="tab" data-tab="reportsTab">التقارير</div>
    </div>

    <!-- Members Tab -->
    <div id="membersTab" class="tab-content active">
        <h3>إدارة الأعضاء</h3>
        <div class="flex">
            <input type="text" id="newMemberName" placeholder="اسم العضو">
            <input type="text" id="newMemberImage" placeholder="رابط الصورة (اختياري)">
            <button class="btn btn-success" id="addMemberBtn">إضافة عضو</button>
        </div>
        <table id="membersTable">
            <thead>
                <tr><th>#</th><th>الصورة</th><th>الاسم</th><th>النقاط</th><th>تعديل</th><th>حذف</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Weeks Tab -->
    <div id="weeksTab" class="tab-content">
        <h3>إدارة الأسابيع</h3>
        <div class="flex">
            <input type="text" id="newWeekName" placeholder="اسم الأسبوع">
            <input type="date" id="newWeekStart">
            <input type="date" id="newWeekEnd">
            <button class="btn btn-success" id="addWeekBtn">إضافة أسبوع</button>
        </div>
        <table id="weeksTable">
            <thead>
                <tr><th>#</th><th>اسم الأسبوع</th><th>من</th><th>إلى</th><th>تعديل</th><th>حذف</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Tasks Tab -->
    <div id="tasksTab" class="tab-content">
        <h3>المهام والمسابقات</h3>
        <p>هنا ستتم إدارة المسابقات والمهام المرتبطة بالنقاط (سيتم ربطها مباشرة مع قاعدة البيانات).</p>
    </div>

    <!-- Reports Tab -->
    <div id="reportsTab" class="tab-content">
        <h3>التقارير</h3>
        <div id="membersStatsContainer"></div>
        <canvas id="attendanceChart"></canvas>
    </div>
</div>

<div id="notification"></div>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
import { getDatabase, ref, set, push, get, onValue, remove, child, update } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBCQIqdCsxSvhfYOs00AetoVWpFhj4XNAQ",
  authDomain: "angels-attendance.firebaseapp.com",
  databaseURL: "https://angels-attendance-default-rtdb.firebaseio.com",
  projectId: "angels-attendance",
  storageBucket: "angels-attendance.firebasestorage.app",
  messagingSenderId: "157249026489",
  appId: "1:157249026489:web:db2b420203bd81d9a19e68",
  measurementId: "G-2YDPSFPQYT"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let members = [];
let weeks = [];
let attendanceRecords = [];

const adminPass = 'admin123';

/* --- Notification --- */
function showNotification(msg, success=true){
    const n = document.getElementById('notification');
    n.textContent = msg;
    n.style.background = success ? '#2ecc71' : '#e74c3c';
    n.style.display = 'block';
    setTimeout(()=>{ n.style.display='none'; }, 3000);
}

/* --- Load Data from Realtime DB --- */
async function loadData(){
    // Members
    const membersSnap = await get(ref(db,'members'));
    members = membersSnap.exists() ? Object.values(membersSnap.val()) : [];
    // Weeks
    const weeksSnap = await get(ref(db,'weeks'));
    weeks = weeksSnap.exists() ? Object.values(weeksSnap.val()) : [];
    // Attendance
    const attSnap = await get(ref(db,'attendance'));
    attendanceRecords = attSnap.exists() ? Object.values(attSnap.val()) : [];
    populateData();
}

/* --- Populate Member & Week Selects --- */
function populateData(){
    const selectMember = document.getElementById('selectMember');
    selectMember.innerHTML = '<option value="">-- اختر اسمك --</option>';
    members.forEach(m=>{
        const opt = document.createElement('option'); opt.value=m.id; opt.textContent=m.name; selectMember.appendChild(opt);
    });
    const weekSelect = document.getElementById('weekSelect');
    weekSelect.innerHTML = '<option value="">-- اختر الأسبوع --</option>';
    weeks.forEach(w=>{
        const opt = document.createElement('option'); opt.value=w.id; opt.textContent=w.name; weekSelect.appendChild(opt);
    });

    populateMembersTable();
    populateWeeksTable();
    updateReports();
}

/* --- Populate Members Table --- */
function populateMembersTable(){
    const tbody = document.querySelector('#membersTable tbody'); tbody.innerHTML='';
    members.forEach((m,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i+1}</td>
        <td><img src="${m.image || 'https://ui-avatars.com/api/?name=Member&background=ccc&color=fff'}" width="40" height="40"></td>
        <td>${m.name}</td>
        <td>${calculatePoints(m.id)}</td>
        <td><button class='btn btn-primary editMember' data-id='${m.id}'>تعديل</button></td>
        <td><button class='btn btn-danger deleteMember' data-id='${m.id}'>حذف</button></td>`;
        tbody.appendChild(tr);
    });
}

/* --- Populate Weeks Table --- */
function populateWeeksTable(){
    const tbody = document.querySelector('#weeksTable tbody'); tbody.innerHTML='';
    weeks.forEach((w,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i+1}</td>
        <td>${w.name}</td>
        <td>${w.from}</td>
        <td>${w.to}</td>
        <td><button class='btn btn-primary editWeek' data-id='${w.id}'>تعديل</button></td>
        <td><button class='btn btn-danger deleteWeek' data-id='${w.id}'>حذف</button></td>`;
        tbody.appendChild(tr);
    });
}

/* --- Calculate Points --- */
function calculatePoints(memberId){
    return attendanceRecords.filter(a=>a.memberId===memberId).length;
}

/* --- Event Listeners --- */
document.getElementById('markPresent').addEventListener('click', async()=>{
    const memberId = parseInt(document.getElementById('selectMember').value);
    const weekId = parseInt(document.getElementById('weekSelect').value);
    if(!memberId || !weekId){ alert('اختر العضو والأسبوع'); return; }
    const exists = attendanceRecords.find(a=>a.memberId===memberId && a.weekId===weekId);
    if(exists){ showNotification('تم تسجيل الحضور بالفعل',false); return; }
    const newRecord = { memberId, weekId, date:new Date().toISOString() };
    const newRef = push(ref(db,'attendance')); await set(newRef,newRecord);
    attendanceRecords.push({...newRecord,id:newRef.key});
    populateData(); showNotification('تم تسجيل الحضور');
});

/* --- Add Member --- */
document.getElementById('addMemberBtn').addEventListener('click', async()=>{
    const name=document.getElementById('newMemberName').value;
    const image=document.getElementById('newMemberImage').value;
    if(!name){ alert('ادخل اسم العضو'); return; }
    const id = members.length ? Math.max(...members.map(m=>m.id))+1 : 1;
    const newMember={id,name,image};
    const newRef=push(ref(db,'members')); await set(newRef,newMember);
    members.push({...newMember,id:newRef.key});
    populateData(); document.getElementById('newMemberName').value=''; document.getElementById('newMemberImage').value=''; showNotification('تم إضافة العضو');
});

/* --- Add Week --- */
document.getElementById('addWeekBtn').addEventListener('click', async()=>{
    const name=document.getElementById('newWeekName').value;
    const from=document.getElementById('newWeekStart').value;
    const to=document.getElementById('newWeekEnd').value;
    if(!name || !from || !to){ alert('املأ كل الحقول'); return; }
    const id = weeks.length ? Math.max(...weeks.map(w=>w.id))+1 : 1;
    const newWeek={id,name,from,to};
    const newRef=push(ref(db,'weeks')); await set(newRef,newWeek);
    weeks.push({...newWeek,id:newRef.key});
    populateData(); document.getElementById('newWeekName').value=''; document.getElementById('newWeekStart').value=''; document.getElementById('newWeekEnd').value=''; showNotification('تم إضافة الأسبوع');
});

/* --- Admin Login --- */
document.getElementById('adminLoginBtn').addEventListener('click', ()=>{
    const pwd = prompt('ادخل كلمة السر للأدمن');
    if(pwd===adminPass){ document.getElementById('adminTabs').style.display='block'; document.getElementById('userSection').style.display='none'; showNotification('تم تسجيل دخول الأدمن'); }
    else{ alert('كلمة السر خطأ'); }
});

/* --- Tab Switching --- */
document.querySelectorAll('.tab').forEach(tab=>{
    tab.addEventListener('click',()=>{
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');
    });
});

/* --- Load Data on Start --- */
document.addEventListener('DOMContentLoaded', loadData);
</script>

</body>
</html>
