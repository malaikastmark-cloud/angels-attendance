<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام حضور خدام ملايكة</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* أنماط CSS الحالية تبقى كما هي */
        /* ... (كل أنماط CSS السابقة) ... */
        
        /* إضافة أنماط جديدة */
        .back-btn {
            position: absolute;
            left: 20px;
            top: 20px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            cursor: pointer;
            font-weight: bold;
            display: none;
        }
        
        .reward-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            text-align: center;
            display: none;
            animation: pop 0.5s;
        }
        
        @keyframes pop {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        .reward-title {
            font-size: 2rem;
            color: #e74c3c;
            margin-bottom: 15px;
        }
        
        .reward-desc {
            font-size: 1.2rem;
            margin-bottom: 20px;
        }
        
        .member-detail-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .member-detail-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .detail-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .detail-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .detail-stat {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .detail-chart {
            margin: 20px 0;
            height: 200px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <button class="back-btn" id="backToMain"><i class="fas fa-arrow-left"></i> العودة</button>
            <h1>🌟 اجتماع خدام ملايكة</h1>
            <p>الحضور يساوي نقطة</p>
        </header>

        <!-- باقي المحتوى يبقى كما هو -->
        <!-- ... (كل المحتوى السابق) ... -->

        <!-- إضافة نافذة المكافآت -->
        <div class="reward-popup" id="rewardPopup">
            <div class="reward-title">🎉 مبروك! 🎉</div>
            <div class="reward-desc" id="rewardDesc">لقد حصلت على مكافأة جديدة!</div>
            <button class="btn btn-primary" id="closeReward">موافق</button>
        </div>

        <!-- إضافة نافذة تفاصيل العضو -->
        <div class="member-detail-modal" id="memberDetailModal">
            <div class="member-detail-content">
                <div class="detail-header">
                    <img id="detailImage" src="" class="member-img" alt="">
                    <h2 id="detailName"></h2>
                </div>
                
                <div class="detail-stats">
                    <div class="detail-stat">
                        <div class="member-stat-value" id="detailPoints">0</div>
                        <div class="member-stat-label">النقاط الكلية</div>
                    </div>
                    <div class="detail-stat">
                        <div class="member-stat-value" id="detailAttendance">0</div>
                        <div class="member-stat-label">أيام الحضور</div>
                    </div>
                    <div class="detail-stat">
                        <div class="member-stat-value" id="detailPercentage">0%</div>
                        <div class="member-stat-label">نسبة الحضور</div>
                    </div>
                </div>
                
                <h3>المكافآت المكتسبة</h3>
                <ul id="detailRewardsList"></ul>
                
                <h3>توزيع الحضور</h3>
                <div class="detail-chart">
                    <canvas id="memberChart"></canvas>
                </div>
                
                <button class="btn btn-danger" id="closeDetail">إغلاق</button>
            </div>
        </div>
    </div>

    <script>
        // بيانات التطبيق (تبقى كما هي)
        let members = [
            {id:1, name:'🧒 Mary Karam', image: 'https://ui-avatars.com/api/?name=Mary+Karam&background=3498db&color=fff'},
            {id:2, name:'👦 Eman Makin', image: 'https://ui-avatars.com/api/?name=Eman+Makin&background=2ecc71&color=fff'},
            {id:3, name:'👧 Rizk Gerges', image: 'https://ui-avatars.com/api/?name=Rizk+Gerges&background=e74c3c&color=fff'}
        ];
        
        let weeks = [
            {id:1, name:'الاسبوع الاول', from:'2025-08-29', to:'2025-08-29'}
        ];
        
        let attendanceRecords = [];
        let rewards = [];
        
        // كلمة السر
        const adminPass = 'admin123';
        
        // إضافة متغير للرسم البياني للأعضاء
        let memberChart = null;
        
        // وظائف المساعدة (تبقى كما هي مع إضافة وظائف جديدة)
        
        // وظيفة للعودة للواجهة الرئيسية
        function backToMain() {
            document.getElementById('adminTabs').style.display = 'none';
            document.getElementById('userAttendance').style.display = 'block';
            document.getElementById('adminLoginBtn').style.display = 'block';
            document.getElementById('backToMain').style.display = 'none';
        }
        
        // وظيفة لعرض مكافأة جديدة
        function showRewardPopup(memberId, rewardTitle) {
            const member = members.find(m => m.id === memberId);
            document.getElementById('rewardDesc').textContent = `مبروك ${member.name}! لقد حصلت على ${rewardTitle}`;
            document.getElementById('rewardPopup').style.display = 'block';
        }
        
        // وظيفة لعرض تفاصيل العضو
        function showMemberDetails(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            
            // حساب النقاط والإحصائيات
            const totalPoints = attendanceRecords.filter(ar => 
                ar.memberId === memberId && ar.present
            ).length;
            
            const totalWeeks = weeks.length;
            const attendancePercentage = totalWeeks > 0 ? Math.round((totalPoints / totalWeeks) * 100) : 0;
            
            // تعبئة البيانات
            document.getElementById('detailImage').src = member.image;
            document.getElementById('detailName').textContent = member.name;
            document.getElementById('detailPoints').textContent = totalPoints;
            document.getElementById('detailAttendance').textContent = totalPoints;
            document.getElementById('detailPercentage').textContent = `${attendancePercentage}%`;
            
            // تعبئة المكافآت
            const rewardsList = document.getElementById('detailRewardsList');
            rewardsList.innerHTML = '';
            
            const memberRewards = rewards.filter(r => r.memberId === memberId);
            if (memberRewards.length === 0) {
                rewardsList.innerHTML = '<li>لا توجد مكافآت حتى الآن</li>';
            } else {
                memberRewards.forEach(reward => {
                    const li = document.createElement('li');
                    li.textContent = `${reward.title} (تم الحصول عليها في ${new Date(reward.date).toLocaleDateString('ar-EG')})`;
                    rewardsList.appendChild(li);
                });
            }
            
            // إعداد الرسم البياني
            setupMemberChart(memberId);
            
            // عرض النافذة
            document.getElementById('memberDetailModal').style.display = 'flex';
        }
        
        // إعداد الرسم البياني للعضو
        function setupMemberChart(memberId) {
            const ctx = document.getElementById('memberChart').getContext('2d');
            
            // إذا كان هناك رسم بياني موجود، قم بتدميره أولاً
            if (memberChart) {
                memberChart.destroy();
            }
            
            // تجهيز بيانات الحضور لكل أسبوع
            const labels = weeks.map(w => w.name);
            const data = weeks.map(week => {
                const record = attendanceRecords.find(ar => 
                    ar.memberId === memberId && ar.weekId == week.id && ar.present
                );
                return record ? 1 : 0;
            });
            
            // إنشاء الرسم البياني
            memberChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'الحضور',
                        data: data,
                        backgroundColor: '#3498db'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1,
                            ticks: {
                                stepSize: 1,
                                callback: function(value) {
                                    return value === 1 ? 'حاضر' : 'غائب';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // تعديل وظيفة checkForRewards لإظهار النافذة المنبثقة
        function checkForRewards(memberId) {
            const points = attendanceRecords.filter(ar => 
                ar.memberId === memberId && ar.present
            ).length;
            
            // مكافآت افتراضية
            const rewardLevels = [
                { points: 5, title: "ميدالية برونزية 🥉" },
                { points: 10, title: "ميدالية فضية 🥈" },
                { points: 15, title: "ميدالية ذهبية 🥇" },
                { points: 20, title: "كأس التميز 🏆" }
            ];
            
            rewardLevels.forEach(reward => {
                // التحقق إذا وصل العضو لهذه النقاط ولم يحصل على المكافأة بعد
                if (points >= reward.points) {
                    const hasReward = rewards.some(r => 
                        r.memberId === memberId && r.pointsRequired === reward.points
                    );
                    
                    if (!hasReward) {
                        // منح المكافأة
                        rewards.push({
                            memberId: memberId,
                            pointsRequired: reward.points,
                            title: reward.title,
                            date: new Date().toISOString()
                        });
                        
                        // إظهار نافذة المكافأة
                        showRewardPopup(memberId, reward.title);
                    }
                }
            });
        }
        
        // تعديل وظيفة populateAdminTables لإضافة زر التفاصيل
        function populateAdminTables(){
            const membersTbody = document.querySelector('#membersTable tbody');
            membersTbody.innerHTML = '';
            members.forEach((m, i) => {
                // حساب النقاط الإجمالية لكل عضو
                const totalPoints = attendanceRecords.filter(ar => 
                    ar.memberId === m.id && ar.present
                ).length;
                
                // الحصول على مكافآت العضو
                const memberRewards = rewards.filter(r => r.memberId === m.id);
                const rewardsText = memberRewards.map(r => r.title).join(', ') || 'لا يوجد';
                
                let tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${i+1}</td>
                    <td><img src="${m.image || 'https://ui-avatars.com/api/?name=Member&background=ccc&color=fff'}" class="member-img" alt="${m.name}"></td>
                    <td>${m.name}</td>
                    <td>${totalPoints}</td>
                    <td>${rewardsText}</td>
                    <td><button class='btn btn-info viewMember' data-id="${m.id}">تفاصيل</button></td>
                    <td><button class='btn btn-primary editMember'>تعديل</button></td>
                    <td><button class='btn btn-danger deleteMember'>حذف</button></td>
                `;
                membersTbody.appendChild(tr);
            });
            
            // باقي الكود يبقى كما هو
            // ...
        }
        
        // أحداث جديدة للأزرار المضافة
        document.getElementById('backToMain').addEventListener('click', backToMain);
        document.getElementById('closeReward').addEventListener('click', () => {
            document.getElementById('rewardPopup').style.display = 'none';
        });
        
        document.getElementById('closeDetail').addEventListener('click', () => {
            document.getElementById('memberDetailModal').style.display = 'none';
        });
        
        // إضافة حدث النقر على أزرار التفاصيل
        document.addEventListener('click', e => {
            if (e.target.classList.contains('viewMember')) {
                const memberId = parseInt(e.target.dataset.id);
                showMemberDetails(memberId);
            }
        });
        
        // تعديل حدث تسجيل دخول الأدمن لإظهار زر العودة
        document.getElementById('confirmAdminLogin').addEventListener('click', () => {
            const pwd = document.getElementById('adminPassword').value;
            if (pwd === adminPass) {
                document.getElementById('adminLoginModal').style.display = 'none';
                document.getElementById('adminTabs').style.display = 'block';
                document.getElementById('userAttendance').style.display = 'none';
                document.getElementById('adminLoginBtn').style.display = 'none';
                document.getElementById('backToMain').style.display = 'block';
                showNotification('تم تسجيل دخول الأدمن بنجاح');
            } else {
                alert('كلمة السر خطأ!');
            }
        });
        
        // باقي الكود يبقى كما هو
        // ...
        
        // تحميل البيانات عند بدء التشغيل
        document.addEventListener('DOMContentLoaded', () => {
            loadFromLocalStorage();
        });
    </script>
</body>
</html>
