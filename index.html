<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام خدام ملايكة</title>
    <script type="module">
        // Firebase Initialization
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
        import { getDatabase, ref, set, update, push, get, child, remove } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-database.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBHso7dhJC7P_akMQQ0oN_8ZMTQqsRoVbY",
            authDomain: "angel-meeting-attendance.firebaseapp.com",
            projectId: "angel-meeting-attendance",
            storageBucket: "angel-meeting-attendance.appspot.com",
            messagingSenderId: "100624957418",
            appId: "1:100624957418:web:291d087797cec79fc93",
            measurementId: "G-2TTXV6CD8F"
        };
        
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        let members = [];
        let weeks = [];
        let attendanceRecords = [];
        let contests = [];
        let birthdays = [];
        let events = [];
        let tasks = [];
        let securityLogs = [];
        let currentUser = null;

        // Initialize App
        async function initializeAppData() {
            await fetchMembers();
            await fetchWeeks();
            await fetchAttendance();
            await fetchContests();
            await fetchBirthdays();
            await fetchEvents();
            await fetchTasks();
            await fetchSecurityLogs();
            updateReports();
            updateUserReports();
        }

        async function fetchMembers() {
            const snapshot = await get(ref(database, 'members'));
            members = snapshot.exists() ? Object.entries(snapshot.val()).map(([id, data]) => ({ id, ...data })) : [];
        }

        async function fetchWeeks() {
            const snapshot = await get(ref(database, 'weeks'));
            weeks = snapshot.exists() ? Object.entries(snapshot.val()).map(([id, data]) => ({ id, ...data })) : [];
        }

        async function fetchAttendance() {
            const snapshot = await get(ref(database, 'attendance'));
            attendanceRecords = snapshot.exists() ? Object.entries(snapshot.val()).map(([id, data]) => ({ id, ...data })) : [];
        }

        async function fetchContests() {
            const snapshot = await get(ref(database, 'contests'));
            contests = snapshot.exists() ? Object.entries(snapshot.val()).map(([id, data]) => ({ id, ...data })) : [];
        }

        async function fetchBirthdays() {
            const snapshot = await get(ref(database, 'birthdays'));
            birthdays = snapshot.exists() ? Object.entries(snapshot.val()).map(([id, data]) => ({ id, ...data })) : [];
        }

        async function fetchEvents() {
            const snapshot = await get(ref(database, 'events'));
            events = snapshot.exists() ? Object.entries(snapshot.val()).map(([id, data]) => ({ id, ...data })) : [];
        }

        async function fetchTasks() {
            const snapshot = await get(ref(database, 'tasks'));
            tasks = snapshot.exists() ? Object.entries(snapshot.val()).map(([id, data]) => ({ id, ...data })) : [];
        }

        async function fetchSecurityLogs() {
            const snapshot = await get(ref(database, 'securityLogs'));
            securityLogs = snapshot.exists() ? Object.entries(snapshot.val()).map(([id, data]) => ({ id, ...data })) : [];
        }

        // --- Utility Functions ---
        function showNotification(message, isSuccess = true) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.background = isSuccess ? '#2ecc71' : '#e74c3c';
            notification.style.display = 'block';
            setTimeout(() => { notification.style.display = 'none'; }, 3000);
        }

        function daysUntilBirthday(birthdayDate) {
            const today = new Date();
            const nextBirthday = new Date(birthdayDate);
            nextBirthday.setFullYear(today.getFullYear());
            if (nextBirthday < today) nextBirthday.setFullYear(today.getFullYear() + 1);
            return Math.ceil((nextBirthday - today) / (1000 * 60 * 60 * 24));
        }

        // --- Attendance Functions ---
        async function addAttendance(memberId, weekId) {
            if (!memberId || !weekId) return showNotification('يرجى اختيار العضو والأسبوع', false);
            const newRef = push(ref(database, 'attendance'));
            await set(newRef, { memberId, weekId, points: 1, date: new Date().toISOString() });
            showNotification('تم تسجيل الحضور');
            await fetchAttendance();
            updateAttendanceRecordsTable();
            updateReports();
        }

        function updateAttendanceRecordsTable() {
            const tbody = document.getElementById('attendanceRecordsBody');
            tbody.innerHTML = '';
            if (attendanceRecords.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">لا توجد سجلات حضور حتى الآن</td></tr>`;
                return;
            }
            attendanceRecords.forEach((record, index) => {
                const member = members.find(m => m.id === record.memberId) || { name: 'عضو محذوف' };
                const week = weeks.find(w => w.id === record.weekId) || { name: 'أسبوع محذوف' };
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="checkbox" class="attendance-checkbox" data-id="${record.id}"></td>
                    <td>${index + 1}</td>
                    <td>${member.name}</td>
                    <td>${week.name}</td>
                    <td>${record.points || 1}</td>
                    <td>${new Date(record.date).toLocaleString('ar-EG')}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function deleteSelectedAttendance() {
            const checkboxes = document.querySelectorAll('.attendance-checkbox:checked');
            if (checkboxes.length === 0) return showNotification('اختر سجلات للحذف', false);
            if (!confirm(`هل تريد حذف ${checkboxes.length} سجل حضور؟`)) return;

            for (let checkbox of checkboxes) {
                await remove(ref(database, 'attendance/' + checkbox.dataset.id));
            }
            showNotification('تم حذف السجلات');
            await fetchAttendance();
            updateAttendanceRecordsTable();
            updateReports();
        }

        // --- Contest Functions ---
        async function addContest(memberId, contestName, points) {
            if (!memberId || !contestName || !points) return showNotification('يرجى ملء البيانات', false);
            const memberRef = ref(database, 'members/' + memberId);
            const snapshot = await get(memberRef);
            if (!snapshot.exists()) return showNotification('العضو غير موجود', false);
            const newPoints = (snapshot.val().points || 0) + points;
            await update(memberRef, { points: newPoints });
            const newContestRef = push(ref(database, 'contests'));
            await set(newContestRef, { memberId, contestName, points, date: new Date().toISOString() });
            showNotification(`تم إضافة ${points} نقطة لـ ${snapshot.val().name}`);
            await fetchMembers();
            await fetchContests();
            updateContestsTable();
            updateReports();
        }

        async function deleteContest(id) {
            if (!confirm('هل تريد حذف المسابقة وخصم النقاط؟')) return;
            const contestRef = ref(database, 'contests/' + id);
            const snapshot = await get(contestRef);
            if (!snapshot.exists()) return;
            const contest = snapshot.val();
            const memberRef = ref(database, 'members/' + contest.memberId);
            const memberSnapshot = await get(memberRef);
            if (memberSnapshot.exists()) {
                const newPoints = Math.max(0, (memberSnapshot.val().points || 0) - contest.points);
                await update(memberRef, { points: newPoints });
            }
            await remove(contestRef);
            showNotification('تم حذف المسابقة وخصم النقاط');
            await fetchMembers();
            await fetchContests();
            updateContestsTable();
            updateReports();
        }

        function updateContestsTable() {
            const tbody = document.querySelector('#contestsTable tbody');
            tbody.innerHTML = '';
            if (contests.length === 0) return tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">لا توجد مسابقات حتى الآن</td></tr>`;
            contests.forEach((contest, index) => {
                const member = members.find(m => m.id === contest.memberId) || { name: 'عضو محذوف' };
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${member.name}</td>
                    <td>${contest.contestName}</td>
                    <td>${contest.points}</td>
                    <td>${new Date(contest.date).toLocaleDateString('ar-EG')}</td>
                    <td><button onclick="deleteContest('${contest.id}')" class="btn btn-danger">حذف</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- Birthday Functions ---
        async function addBirthday(memberId, date) {
            if (!memberId || !date) return showNotification('اختر العضو وتاريخ الميلاد', false);
            const member = members.find(m => m.id === memberId);
            if (!member) return showNotification('العضو غير موجود', false);
            const newBirthdayRef = push(ref(database, 'birthdays'));
            await set(newBirthdayRef, { memberId, date });
            showNotification(`تم إضافة عيد ميلاد لـ ${member.name}`);
            await fetchBirthdays();
            updateBirthdaysTable();
        }

        async function editBirthday(id) {
            const birthdayRef = ref(database, 'birthdays/' + id);
            const snapshot = await get(birthdayRef);
            if (!snapshot.exists()) return;
            const newDate = prompt('عدل تاريخ الميلاد:', snapshot.val().date);
            if (!newDate) return;
            await update(birthdayRef, { date: newDate });
            showNotification('تم تعديل تاريخ الميلاد');
            await fetchBirthdays();
            updateBirthdaysTable();
        }

        async function deleteBirthday(id) {
            if (!confirm('هل تريد حذف تاريخ الميلاد؟')) return;
            await remove(ref(database, 'birthdays/' + id));
            showNotification('تم حذف تاريخ الميلاد');
            await fetchBirthdays();
            updateBirthdaysTable();
        }

        function updateBirthdaysTable() {
            const tbody = document.querySelector('#birthdaysTable tbody');
            tbody.innerHTML = '';
            if (birthdays.length === 0) return tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">لا توجد أعياد ميلاد مسجلة</td></tr>`;
            birthdays.forEach((birthday, index) => {
                const member = members.find(m => m.id === birthday.memberId) || { name: 'عضو محذوف' };
                const daysLeft = daysUntilBirthday(birthday.date);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${member.name}</td>
                    <td>${new Date(birthday.date).toLocaleDateString('ar-EG')}</td>
                    <td>${daysLeft} يوم</td>
                    <td><button onclick="editBirthday('${birthday.id}')" class="btn btn-primary">تعديل</button></td>
                    <td><button onclick="deleteBirthday('${birthday.id}')" class="btn btn-danger">حذف</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- User Reports & Ranking ---
        function updateUserReports() {
            if (!currentUser) return;
            const userAttendance = attendanceRecords.filter(ar => ar.memberId === currentUser.id).length;
            document.getElementById('userTotalAttendance').textContent = userAttendance;
            document.getElementById('userTotalPoints').textContent = currentUser.points || 0;

            // ترتيب حسب النقاط
            const sortedByPoints = [...members].sort((a, b) => (b.points || 0) - (a.points || 0));
            const userRank = sortedByPoints.findIndex(m => m.id === currentUser.id) + 1;
            document.getElementById('userRank').textContent = userRank;

            const totalWeeks = weeks.length;
            const attendanceRate = totalWeeks > 0 ? Math.round((userAttendance / totalWeeks) * 100) : 0;
            document.getElementById('userPerformance').textContent = `${attendanceRate}%`;
        }

        // --- Security Functions (Reset Password for All or Individual) ---
        async function resetPassword(memberId = null, newPassword) {
            if (!newPassword) return showNotification('ادخل كلمة السر الجديدة', false);
            if (memberId) {
                const memberRef = ref(database, 'members/' + memberId);
                await update(memberRef, { password: newPassword });
            } else {
                for (let member of members) {
                    const memberRef = ref(database, 'members/' + member.id);
                    await update(memberRef, { password: newPassword });
                }
            }
            showNotification('تم إعادة تعيين كلمة السر');
            await fetchMembers();
        }

        // --- Reports & Charts Updates ---
        function updateReports() {
            document.getElementById('reportAttendance').textContent = attendanceRecords.length;
            document.getElementById('reportPoints').textContent = members.reduce((sum, m) => sum + (m.points || 0), 0);
            document.getElementById('reportMembers').textContent = members.length;
            document.getElementById('reportWeeks').textContent = weeks.length;
        }

        // --- Initialize ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeAppData();
        });

    </script>
    <style>
        body { font-family: Arial, sans-serif; direction: rtl; text-align: right; background-color: #f2f2f2; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; background: #fff; }
        th, td { border: 1px solid #ddd; padding: 8px; }
        th { background-color: #3498db; color: white; }
        .btn { padding: 5px 10px; cursor: pointer; border: none; border-radius: 4px; }
        .btn-danger { background-color: #e74c3c; color: #fff; }
        .btn-primary { background-color: #3498db; color: #fff; }
        #notification { display:none; position: fixed; top: 10px; right: 50%; transform: translateX(50%); padding: 10px 20px; border-radius: 5px; color: #fff; z-index: 1000; }
    </style>
</head>
<body>
    <h1>نظام حضور وخدمة الملايكة</h1>
    <div id="notification"></div>

    <!-- User Reports -->
    <h2>تقاريري الشخصية</h2>
    <p>عدد الحضور: <span id="userTotalAttendance">0</span></p>
    <p>النقاط الكلية: <span id="userTotalPoints">0</span></p>
    <p>ترتيبي بين الأعضاء: <span id="userRank">0</span></p>
    <p>نسبة الأداء: <span id="userPerformance">0%</span></p>

    <!-- Attendance Records -->
    <h2>سجلات الحضور</h2>
    <table id="attendanceRecordsTable">
        <thead>
            <tr>
                <th>اختيار</th>
                <th>م</th>
                <th>العضو</th>
                <th>الأسبوع</th>
                <th>النقاط</th>
                <th>التاريخ</th>
            </tr>
        </thead>
        <tbody id="attendanceRecordsBody">
            <tr><td colspan="6" style="text-align:center;">جار التحميل...</td></tr>
        </tbody>
    </table>
    <button onclick="deleteSelectedAttendance()" class="btn btn-danger">حذف المحدد</button>

    <!-- Contests -->
    <h2>المسابقات</h2>
    <table id="contestsTable">
        <thead>
            <tr>
                <th>م</th>
                <th>العضو</th>
                <th>المسابقة</th>
                <th>النقاط</th>
                <th>التاريخ</th>
                <th>تحكم</th>
            </tr>
        </thead>
        <tbody>
            <tr><td colspan="6" style="text-align:center;">جار التحميل...</td></tr>
        </tbody>
    </table>

    <!-- Birthdays -->
    <h2>أعياد الميلاد</h2>
    <table id="birthdaysTable">
        <thead>
            <tr>
                <th>م</th>
                <th>العضو</th>
                <th>تاريخ الميلاد</th>
                <th>عدد الأيام المتبقية</th>
                <th>تعديل</th>
                <th>حذف</th>
            </tr>
        </thead>
        <tbody>
            <tr><td colspan="6" style="text-align:center;">جار التحميل...</td></tr>
        </tbody>
    </table>

    <!-- Reports Summary -->
    <h2>ملخص النظام</h2>
    <p>إجمالي سجلات الحضور: <span id="reportAttendance">0</span></p>
    <p>إجمالي النقاط: <span id="reportPoints">0</span></p>
    <p>عدد الأعضاء: <span id="reportMembers">0</span></p>
    <p>عدد الأسابيع: <span id="reportWeeks">0</span></p>

</body>
</html>
