// Utility Functions
function calculateLevel(points) {
    for (let level of memberLevels) {
        if (points >= level.minPoints && points <= level.maxPoints) {
            return level;
        }
    }
    return memberLevels[0];
}

function getServiceName(service) {
    const services = {
        altar: 'ุฎุฏูุฉ ุงููุฐุจุญ',
        sunday_school: 'ูุฏุฑุณุฉ ุงูุฃุญุฏ',
        youth: 'ุฎุฏูุฉ ุงูุดุจุงุจ',
        music: 'ุงูุฃูุญุงู ูุงูููุณููู',
        media: 'ุงูุฅุนูุงู',
        social: 'ุงูุฎุฏูุฉ ุงูุงุฌุชูุงุนูุฉ',
        other: 'ุฃุฎุฑู'
    };
    return services[service] || 'ุบูุฑ ูุญุฏุฏ';
}

function checkBirthdays() {
    const today = new Date();
    const todayStr = `${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
    
    const birthdayMembers = members.filter(member => {
        if (!member.birthday) return false;
        const birthday = new Date(member.birthday);
        const birthdayStr = `${String(birthday.getMonth() + 1).padStart(2, '0')}-${String(birthday.getDate()).padStart(2, '0')}`;
        return birthdayStr === todayStr;
    });

    const alertsDiv = document.getElementById('birthdayAlerts');
    if (birthdayMembers.length > 0) {
        alertsDiv.innerHTML = `
            <div class="card" style="background: linear-gradient(135deg, var(--warning), #d97706); color: white;">
                <h2>๐ ุฃุนูุงุฏ ูููุงุฏ ุงูููู</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                    ${birthdayMembers.map(member => `
                        <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.2rem; margin-bottom: 5px;">๐ ${member.name}</div>
                            <div style="opacity: 0.9;">ุนูุฏ ูููุงุฏ ุณุนูุฏ!</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    } else {
        alertsDiv.innerHTML = '';
    }
}

function initCharts() {
    try {
        const ctx = document.getElementById('attendanceChart');
        if (!ctx) return;

        const last7Days = [];
        const attendanceCounts = [];
        
        for (let i = 6; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            const dateStr = date.toISOString().split('T')[0];
            const count = attendance.filter(a => a.date === dateStr).length;
            
            last7Days.push(date.toLocaleDateString('ar', { weekday: 'short', month: 'short', day: 'numeric' }));
            attendanceCounts.push(count);
        }

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: last7Days,
                datasets: [{
                    label: 'ุงูุญุถูุฑ ุงููููู',
                    data: attendanceCounts,
                    borderColor: 'rgb(99, 102, 241)',
                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('ุฎุทุฃ ูู ุฅูุดุงุก ุงูุฑุณู ุงูุจูุงูู:', error);
    }
}

// Modal Functions
function showModal(modalId) {
    document.getElementById(modalId).style.display = 'block';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// Theme Toggle
function toggleTheme() {
    const currentTheme = document.body.getAttribute('data-theme');
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
    
    document.body.setAttribute('data-theme', newTheme);
    document.getElementById('themeIcon').textContent = newTheme === 'light' ? '๐' : 'โ๏ธ';
    
    localStorage.setItem('theme', newTheme);
    showNotification(`ุชู ุชูุนูู ุงููุถุน ${newTheme === 'light' ? 'ุงููุงุชุญ' : 'ุงูุฏุงูู'}`, 'success');
}

// Notification System
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = 'notification';
    notification.textContent = message;
    
    const colors = {
        success: 'linear-gradient(135deg, var(--success), #059669)',
        error: 'linear-gradient(135deg, var(--danger), #dc2626)',
        warning: 'linear-gradient(135deg, var(--warning), #d97706)',
        info: 'linear-gradient(135deg, var(--info), #1d4ed8)'
    };
    
    notification.style.background = colors[type] || colors.info;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 4000);
}

// Export Functions
function exportExcel() {
    try {
        const wb = XLSX.utils.book_new();
        
        // Members sheet
        const membersData = members.map(member => ({
            'ุงูุฑูู': member.sequentialNumber,
            'ุงูุงุณู': member.name,
            'ุงูุจุฑูุฏ': member.email || '',
            'ุงููุงุชู': member.phone || '',
            'ุงูููุงุท': member.talanton || 0,
            'ุงููุณุชูู': calculateLevel(member.talanton || 0).name,
            'ุงูุฎุฏูุฉ': getServiceName(member.service),
            'ุงูููุทูุฉ': member.area || '',
            'ุชุงุฑูุฎ ุงูุงูุถูุงู': member.joinDate || ''
        }));
        
        const membersWS = XLSX.utils.json_to_sheet(membersData);
        XLSX.utils.book_append_sheet(wb, membersWS, 'ุงูุฃุนุถุงุก');
        
        // Attendance sheet
        const attendanceData = attendance.slice(0, 1000).map(record => ({
            'ุงูุชุงุฑูุฎ': record.date,
            'ุงุณู ุงูุนุถู': record.memberName,
            'ููุน ุงูุญุถูุฑ': getAttendanceTypeName(record.type),
            'ุงูููุงุญุธุงุช': record.notes || ''
        }));
        
        const attendanceWS = XLSX.utils.json_to_sheet(attendanceData);
        XLSX.utils.book_append_sheet(wb, attendanceWS, 'ุงูุญุถูุฑ');
        
        // Products sheet
        const productsData = products.map(product => ({
            'ุงุณู ุงูููุชุฌ': product.name,
            'ุงูุณุนุฑ': product.price,
            'ุงููุฎุฒูู': product.stock,
            'ุงููุฆุฉ': product.category,
            'ุงููุตู': product.description
        }));
        
        const productsWS = XLSX.utils.json_to_sheet(productsData);
        XLSX.utils.book_append_sheet(wb, productsWS, 'ุงูููุชุฌุงุช');
        
        XLSX.writeFile(wb, `church_system_export_${new Date().toISOString().split('T')[0]}.xlsx`);
        showNotification('ุชู ุชุตุฏูุฑ ุงูุจูุงูุงุช ุจูุฌุงุญ!', 'success');
        
    } catch (error) {
        console.error('ุฎุทุฃ ูู ุงูุชุตุฏูุฑ:', error);
        showNotification('ุฎุทุฃ ูู ุชุตุฏูุฑ ุงูุจูุงูุงุช', 'error');
    }
}

function generateQR() {
    showNotification('ุชู ุชูุนูู ููุฒุฉ QR ููุฏุงุช!', 'success');
}

function showProfile() {
    if (!currentMember) return;
    showNotification(`ุนุฑุถ ููู ${currentMember.name}`, 'info');
}

function showTasks() {
    if (!currentMember) return;
    showNotification(`ุนุฑุถ ููุงู ${currentMember.name}`, 'info');
}

function showMyProfile() {
    if (!currentMember) return;
    showNotification(`ูููู ุงูุดุฎุตูุ ${currentMember.name}`, 'info');
}

function showMyTasks() {
    if (!currentMember) return;
    const memberTasks = tasks.filter(t => t.assignedService === 'all' || t.assignedService === currentMember.service);
    showNotification(`ูุฏูู ${memberTasks.length} ูููุฉ ูุชุงุญุฉ`, 'info');
}

function showMyHistory() {
    if (!currentMember) return;
    const memberHistory = talantonHistory.filter(h => h.memberId === currentMember.id);
    showNotification(`ูุฏูู ${memberHistory.length} ูุนุงููุฉ ูู ุงูุชุงุฑูุฎ`, 'info');
}

function showFullReport() {
    showNotification('ุชู ุชูุนูู ุงูุชูุฑูุฑ ุงูุดุงูู!', 'success');
}

// Close modals when clicking outside
window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
    }
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        document.querySelectorAll('.modal').forEach(modal => {
            modal.style.display = 'none';
        });
    }
    
    if (e.ctrlKey && e.key === 'Enter') {
        const quickInput = document.getElementById('quickInput');
        if (quickInput && quickInput.value) {
            quickAttendance();
        }
    }
});

// Auto-save every 30 seconds
setInterval(() => {
    if (members.length > 0) {
        saveLocal();
        console.log('๐พ ุชู ุงูุญูุธ ุงูุชููุงุฆู');
    }
}, 30000);

console.log('โ ุชู ุชุญููู ุฌููุน ูุธุงุฆู ุงููุธุงู ุจูุฌุงุญ!');
