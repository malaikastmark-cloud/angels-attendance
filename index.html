<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Angels Attendance</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin:0;
    background: linear-gradient(120deg, #f6d365, #fda085);
}
.container {
    margin-top: 30px;
}
.header {
    display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;
}
.header h1 {color:#fff;}
.card {border-radius:15px; box-shadow:0 5px 20px rgba(0,0,0,0.2);}
.member-img {width:40px;height:40px;border-radius:50%;}
.btn {border-radius:10px;}
#notification {
    position:fixed; top:10px; right:10px; padding:10px 20px; color:#fff; display:none; border-radius:10px; z-index:1000;
}
.nav-tabs .nav-link.active {background:#3498db; color:#fff;}
.nav-tabs .nav-link {color:#3498db;}
.language-switch {cursor:pointer; margin-left:10px; color:#fff; text-decoration:underline;}
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1 id="pageTitle">نظام الحضور</h1>
        <div>
            <span class="language-switch" onclick="switchLanguage()">English</span>
            <button id="adminLoginBtn" class="btn btn-light">دخول الأدمن</button>
        </div>
    </div>

    <!-- User Panel -->
    <div id="userPanel">
        <div class="card p-3 mb-3">
            <div class="row g-3 align-items-center">
                <div class="col-md-4">
                    <select id="selectMember" class="form-select">
                        <option value="">-- اختر اسمك --</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <select id="weekSelect" class="form-select">
                        <option value="">-- اختر الأسبوع --</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <button id="markPresent" class="btn btn-primary w-100">تسجيل الحضور</button>
                </div>
            </div>
        </div>

        <canvas id="attendanceChart" height="100"></canvas>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" style="display:none;">
        <ul class="nav nav-tabs mb-3" id="adminTabs">
            <li class="nav-item">
                <a class="nav-link active" data-tab="membersTab" href="#">الأعضاء</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-tab="weeksTab" href="#">الأسابيع</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-tab="attendanceTab" href="#">الحضور</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-tab="reportsTab" href="#">التقارير</a>
            </li>
        </ul>

        <!-- Members Tab -->
        <div id="membersTab" class="tab-content active">
            <div class="card p-3 mb-3">
                <div class="row g-3 align-items-center">
                    <div class="col-md-5"><input type="text" id="newMemberName" class="form-control" placeholder="اسم العضو"></div>
                    <div class="col-md-5"><input type="text" id="newMemberImage" class="form-control" placeholder="رابط الصورة (اختياري)"></div>
                    <div class="col-md-2"><button id="addMemberBtn" class="btn btn-success w-100">إضافة عضو</button></div>
                </div>
            </div>
            <table class="table table-striped">
                <thead><tr><th>#</th><th>الصورة</th><th>الاسم</th><th>إجمالي النقاط</th><th>المكافآت</th><th>تعديل</th><th>حذف</th></tr></thead>
                <tbody id="membersTableBody"></tbody>
            </table>
        </div>

        <!-- Weeks Tab -->
        <div id="weeksTab" class="tab-content" style="display:none;">
            <div class="card p-3 mb-3">
                <div class="row g-3 align-items-center">
                    <div class="col-md-4"><input type="text" id="newWeekName" class="form-control" placeholder="اسم الأسبوع"></div>
                    <div class="col-md-3"><input type="date" id="newWeekStart" class="form-control"></div>
                    <div class="col-md-3"><input type="date" id="newWeekEnd" class="form-control"></div>
                    <div class="col-md-2"><button id="addWeekBtn" class="btn btn-success w-100">إضافة أسبوع</button></div>
                </div>
            </div>
            <table class="table table-striped">
                <thead><tr><th>#</th><th>الاسم</th><th>من</th><th>إلى</th><th>تعديل</th><th>حذف</th></tr></thead>
                <tbody id="weeksTableBody"></tbody>
            </table>
        </div>

        <!-- Attendance Tab -->
        <div id="attendanceTab" class="tab-content" style="display:none;">
            <table class="table table-striped">
                <thead><tr><th>#</th><th>العضو</th><th>الأسبوع</th><th>تاريخ</th><th>حذف</th></tr></thead>
                <tbody id="attendanceRecordsBody"></tbody>
            </table>
        </div>

        <!-- Reports Tab -->
        <div id="reportsTab" class="tab-content" style="display:none;">
            <h4>Top 10</h4>
            <div id="topMembersList"></div>
        </div>
    </div>
</div>

<div id="notification"></div>

<script>
/* Firebase Realtime Database Configuration */
const firebaseConfig = {
    apiKey: "AIzaSyBCQIqdCsxSvhfYOs00AetoVWpFhj4XNAQ",
    authDomain: "angels-attendance.firebaseapp.com",
    databaseURL: "https://angels-attendance-default-rtdb.firebaseio.com",
    projectId: "angels-attendance",
    storageBucket: "angels-attendance.firebasestorage.app",
    messagingSenderId: "157249026489",
    appId: "1:157249026489:web:db2b420203bd81d9a19e68",
    measurementId: "G-2YDPSFPQYT"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* بيانات وهمية */
let members = [];
let weeks = [];
let attendanceRecords = [];
let rewards = [];

/* الإشعارات */
function showNotification(message) {
    const n = document.getElementById('notification');
    n.textContent = message;
    n.style.display = 'block';
    setTimeout(()=>{n.style.display='none';}, 3000);
}

/* توليد صورة افتراضية */
function getAvatar(name) {
    return `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=3498db&color=fff`;
}

/* تحميل البيانات */
function loadData() {
    db.ref('members').once('value', snapshot=>{members=snapshot.val()||[]; populateMembers(); populateMemberSelect();});
    db.ref('weeks').once('value', snapshot=>{weeks=snapshot.val()||[]; populateWeeks(); populateWeekSelect();});
    db.ref('attendance').once('value', snapshot=>{attendanceRecords=snapshot.val()||[]; populateAttendance(); updateChart(); updateTop10();});
}

/* حفظ البيانات */
function saveData(path, data) {
    db.ref(path).set(data);
}

/* إضافة عضو */
document.getElementById('addMemberBtn').addEventListener('click', ()=>{
    const name=document.getElementById('newMemberName').value.trim();
    const img=document.getElementById('newMemberImage').value.trim()||getAvatar(name);
    if(!name){alert('ادخل اسم العضو'); return;}
    const id=members.length?Math.max(...members.map(m=>m.id))+1:1;
    members.push({id,name,image:img,points:0});
    saveData('members', members);
    populateMembers(); populateMemberSelect();
    showNotification('تم إضافة العضو');
    document.getElementById('newMemberName').value=''; document.getElementById('newMemberImage').value='';
});

/* إضافة أسبوع */
document.getElementById('addWeekBtn').addEventListener('click', ()=>{
    const name=document.getElementById('newWeekName').value.trim();
    const from=document.getElementById('newWeekStart').value;
    const to=document.getElementById('newWeekEnd').value;
    if(!name||!from||!to){alert('املأ كل الحقول'); return;}
    const id=weeks.length?Math.max(...weeks.map(w=>w.id))+1:1;
    weeks.push({id,name,from,to});
    saveData('weeks', weeks);
    populateWeeks(); populateWeekSelect();
    showNotification('تم إضافة الأسبوع');
    document.getElementById('newWeekName').value=''; document.getElementById('newWeekStart').value=''; document.getElementById('newWeekEnd').value='';
});

/* اختيار عضو وأسبوع وتسجيل حضور */
document.getElementById('markPresent').addEventListener('click', ()=>{
    const memberId=parseInt(document.getElementById('selectMember').value);
    const weekId=parseInt(document.getElementById('weekSelect').value);
    if(!memberId||!weekId){alert('اختر العضو والأسبوع'); return;}
    const exists=attendanceRecords.find(ar=>ar.memberId===memberId && ar.weekId===weekId);
    if(exists){showNotification('تم تسجيل الحضور مسبقاً'); return;}
    attendanceRecords.push({memberId,weekId,date:new Date().toISOString()});
    saveData('attendance', attendanceRecords);
    showNotification('تم تسجيل الحضور');
    populateAttendance(); updateChart(); updateTop10();
});

/* Populate Members Table & Select */
function populateMembers(){
    const tbody=document.getElementById('membersTableBody');
    tbody.innerHTML='';
    members.forEach((m,i)=>{
        let tr=document.createElement('tr');
        tr.innerHTML=`<td>${i+1}</td>
        <td><img src="${m.image}" class="member-img"></td>
        <td>${m.name}</td>
        <td>${m.points||0}</td>
        <td>${m.rewards||''}</td>
        <td><button class="btn btn-primary btn-sm" onclick="editMember(${i})">تعديل</button></td>
        <td><button class="btn btn-danger btn-sm" onclick="deleteMember(${i})">حذف</button></td>`;
        tbody.appendChild(tr);
    });
}
function populateMemberSelect(){
    const sel=document.getElementById('selectMember');
    sel.innerHTML='<option value="">-- اختر اسمك --</option>';
    members.forEach(m=>{let o=document.createElement('option'); o.value=m.id; o.textContent=m.name; sel.appendChild(o);});
}

/* Populate Weeks Table & Select */
function populateWeeks(){
    const tbody=document.getElementById('weeksTableBody');
    tbody.innerHTML='';
    weeks.forEach((w,i)=>{
        let tr=document.createElement('tr');
        tr.innerHTML=`<td>${i+1}</td><td>${w.name}</td><td>${w.from}</td><td>${w.to}</td>
        <td><button class="btn btn-primary btn-sm" onclick="editWeek(${i})">تعديل</button></td>
        <td><button class="btn btn-danger btn-sm" onclick="deleteWeek(${i})">حذف</button></td>`;
        tbody.appendChild(tr);
    });
}
function populateWeekSelect(){
    const sel=document.getElementById('weekSelect');
    sel.innerHTML='<option value="">-- اختر الأسبوع --</option>';
    weeks.forEach(w=>{let o=document.createElement('option'); o.value=w.id; o.textContent=w.name; sel.appendChild(o);});
}

/* Attendance Records */
function populateAttendance(){
    const tbody=document.getElementById('attendanceRecordsBody');
    tbody.innerHTML='';
    attendanceRecords.forEach((ar,i)=>{
        const member=members.find(m=>m.id===ar.memberId);
        const week=weeks.find(w=>w.id===ar.weekId);
        if(member&&week){
            let tr=document.createElement('tr');
            tr.innerHTML=`<td>${i+1}</td><td>${member.name}</td><td>${week.name}</td><td>${new Date(ar.date).toLocaleString()}</td>
            <td><button class="btn btn-danger btn-sm" onclick="deleteAttendance(${i})">حذف</button></td>`;
            tbody.appendChild(tr);
        }
    });
}

/* Delete Functions */
function deleteMember(i){if(confirm('هل تريد حذف العضو؟')){members.splice(i,1);saveData('members',members);populateMembers();populateMemberSelect();}}
function deleteWeek(i){if(confirm('هل تريد حذف الأسبوع؟')){weeks.splice(i,1);saveData('weeks',weeks);populateWeeks();populateWeekSelect();}}
function deleteAttendance(i){attendanceRecords.splice(i,1);saveData('attendance',attendanceRecords);populateAttendance();}
function editMember(i){const name=prompt('اسم جديد',members[i].name); if(name){members[i].name=name; saveData('members',members); populateMembers(); populateMemberSelect();}}
function editWeek(i){const name=prompt('اسم جديد',weeks[i].name); if(name){weeks[i].name=name; saveData('weeks',weeks); populateWeeks(); populateWeekSelect();}}

/* Chart */
const ctx=document.getElementById('attendanceChart').getContext('2d');
let chart=new Chart(ctx,{type:'bar',data:{labels:[],datasets:[{label:'الحضور',data:[],backgroundColor:'#3498db'}]},options:{responsive:true}});
function updateChart(){chart.data.labels=members.map(m=>m.name);chart.data.datasets[0].data=members.map(m=>attendanceRecords.filter(a=>a.memberId===m.id).length);chart.update();}

/* Top 10 */
function updateTop10(){
    const top10=members.map(m=>({name:m.name,points:attendanceRecords.filter(a=>a.memberId===m.id).length})).sort((a,b)=>b.points-a.points).slice(0,10);
    const container=document.getElementById('topMembersList'); container.innerHTML='';
    top10.forEach((m,i)=>{let div=document.createElement('div'); div.textContent=`${i+1}. ${m.name} - ${m.points} نقاط`; container.appendChild(div);});
}

/* Admin Tabs */
document.querySelectorAll('#adminTabs .nav-link').forEach(a=>{
    a.addEventListener('click', e=>{
        e.preventDefault();
        document.querySelectorAll('#adminTabs .nav-link').forEach(n=>n.classList.remove('active'));
        a.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(c=>c.style.display='none');
        document.getElementById(a.dataset.tab).style.display='block';
    });
});

/* Admin Login */
document.getElementById('adminLoginBtn').addEventListener('click', ()=>{
    const pass=prompt('كلمة سر الأدمن'); if(pass==='admin'){document.getElementById('adminPanel').style.display='block'; showNotification('تم الدخول كأدمن');}else{alert('كلمة السر خاطئة');}
});

/* Language Switch */
let currentLang='ar';
function switchLanguage(){
    if(currentLang==='ar'){currentLang='en'; document.getElementById('pageTitle').textContent='Attendance System'; document.getElementById('markPresent').textContent='Mark Attendance'; document.getElementById('adminLoginBtn').textContent='Admin Login';}else{currentLang='ar'; document.getElementById('pageTitle').textContent='نظام الحضور'; document.getElementById('markPresent').textContent='تسجيل الحضور'; document.getElementById('adminLoginBtn').textContent='دخول الأدمن';}
}

/* Init */
loadData();
</script>
</body>
</html>
