<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <title>نظام حضور المجموعة - Talanton</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <!-- TailwindCSS CDN -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Cairo', Arial, sans-serif; }
    .rtl { direction: rtl; }
    .ltr { direction: ltr; }
    .modal-bg { background: rgba(0,0,0,0.45); }
  </style>
</head>
<body class="bg-gray-50 rtl">
  <div class="max-w-6xl mx-auto py-6 px-4">
    <!-- Header -->
    <header class="flex justify-between items-center mb-8">
      <h1 class="text-3xl font-bold text-indigo-700">نظام حضور المجموعة <span class="text-green-500">Talanton</span></h1>
      <button onclick="showAdminPanel()" class="bg-indigo-700 text-white rounded px-4 py-2 hover:bg-indigo-900">لوحة تحكم الأدمن</button>
    </header>

    <!-- تسجيل الحضور -->
    <section class="bg-white rounded-xl shadow p-6 mb-6">
      <div class="flex flex-col md:flex-row gap-4 items-center">
        <select id="memberSelect" class="w-full md:w-1/3 border p-2 rounded text-gray-700">
          <option value="">اختر اسمك</option>
        </select>
        <button onclick="registerAttendance()" class="bg-green-500 text-white px-6 py-2 rounded hover:bg-green-700">تسجيل الحضور</button>
        <div id="attendanceMsg" class="text-green-700 font-bold"></div>
      </div>
    </section>

    <!-- رصيد TALANTON والتوب 10 -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
      <section class="bg-white rounded-xl shadow p-6 flex flex-col items-center">
        <h2 class="font-semibold text-xl mb-2">رصيدك</h2>
        <div class="text-4xl font-extrabold text-indigo-700 mb-2"><span id="talantonBalance">0</span> <span class="text-green-500">Talanton</span></div>
        <button onclick="showStore()" class="bg-indigo-700 text-white rounded px-4 py-2 hover:bg-indigo-900">دخول المتجر</button>
      </section>
      <!-- Top 10 -->
      <section class="bg-white rounded-xl shadow p-6 col-span-2">
        <h2 class="font-semibold text-xl mb-4">أفضل 10 أعضاء</h2>
        <div id="top10List" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-3 gap-2"></div>
      </section>
    </div>

    <!-- تقارير حضور -->
    <section class="bg-white rounded-xl shadow p-6 mb-6">
      <h2 class="font-semibold text-xl mb-4">تقارير الحضور</h2>
      <canvas id="attendanceChart" height="110"></canvas>
    </section>

    <!-- المتجر -->
    <section id="storeCard" class="bg-white rounded-xl shadow p-6 mb-6 hidden">
      <h2 class="font-semibold text-xl mb-4">المتجر</h2>
      <div id="storeProducts" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      <button onclick="hideStore()" class="mt-6 bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400">رجوع</button>
      <div id="storeMsg" class="mt-2 text-red-600"></div>
    </section>

    <!-- لوحة الأدمن (ستظهر كنافذة منبثقة) -->
    <div id="adminPanel" class="hidden fixed inset-0 modal-bg flex items-center justify-center z-50">
      <div class="bg-white rounded-xl shadow p-8 w-full max-w-3xl relative overflow-y-auto max-h-[90vh]">
        <button onclick="hideAdminPanel()" class="absolute top-2 left-2 bg-red-100 text-red-600 px-2 py-1 rounded">X</button>
        <h2 class="font-bold text-2xl mb-4 text-indigo-700">لوحة تحكم الأدمن</h2>
        <div class="mb-4 flex flex-wrap gap-2">
          <button onclick="showAdminTab('members')" class="bg-indigo-700 text-white px-3 py-1 rounded">الأعضاء</button>
          <button onclick="showAdminTab('attendance')" class="bg-green-600 text-white px-3 py-1 rounded">الحضور</button>
          <button onclick="showAdminTab('events')" class="bg-yellow-600 text-white px-3 py-1 rounded">المناسبات</button>
          <button onclick="showAdminTab('weeks')" class="bg-blue-500 text-white px-3 py-1 rounded">الأسابيع</button>
          <button onclick="showAdminTab('tasks')" class="bg-purple-600 text-white px-3 py-1 rounded">المهام</button>
          <button onclick="showAdminTab('store')" class="bg-pink-600 text-white px-3 py-1 rounded">المتجر</button>
          <button onclick="showAdminTab('reports')" class="bg-gray-600 text-white px-3 py-1 rounded">التقارير</button>
        </div>
        <div id="adminContent"></div>
      </div>
    </div>
  </div>

  <!-- سكريبت: منطق الموقع وربط Firebase -->
  <script>
    // إعدادات Firebase الخاصة بك (يمكنك إبقاءها كما هي إن كنت تستخدم نفس المشروع السابق)
    const firebaseConfig = {
      apiKey: "AIzaSyBCQIqdCsxSvhfYOs00AetoVWpFhj4XNAQ",
      authDomain: "angels-attendance.firebaseapp.com",
      databaseURL: "https://angels-attendance-default-rtdb.firebaseio.com",
      projectId: "angels-attendance",
      storageBucket: "angels-attendance.appspot.com",
      messagingSenderId: "157249026489",
      appId: "1:157249026489:web:db2b420203bd81d9a19e68"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // متغيرات عامة
    let members = [];
    let products = [];
    let attendance = {}; // memberId: {date: true}
    let currentMember = null;

    // تحميل الأعضاء
    function loadMembers() {
      db.ref("members").on("value", snap => {
        members = [];
        snap.forEach(child => members.push({id:child.key, ...child.val()}));
        renderMemberSelect();
        renderTop10();
      });
    }
    // تحميل المنتجات
    function loadProducts() {
      db.ref("products").on("value", snap => {
        products = [];
        snap.forEach(child => products.push({id:child.key, ...child.val()}));
      });
    }
    // تحميل الحضور
    function loadAttendance() {
      db.ref("attendance").on("value", snap => {
        attendance = snap.val() || {};
        renderAttendanceChart();
        renderTop10();
      });
    }

    // === واجهة المستخدم ===
    function renderMemberSelect() {
      let sel = document.getElementById('memberSelect');
      if(!sel) return;
      sel.innerHTML = '<option value="">اختر اسمك</option>' + 
        members.map(m=>`<option value="${m.id}">${m.name}</option>`).join('');
    }
    function registerAttendance() {
      let memberId = document.getElementById('memberSelect').value;
      if (!memberId) return alert("اختر اسمك أولاً!");
      let today = new Date().toISOString().slice(0,10);
      db.ref(`attendance/${memberId}/${today}`).set(true, err=>{
        if (!err) {
          db.ref(`members/${memberId}/talanton`).transaction(t=> (t||0)+1);
          document.getElementById('attendanceMsg').innerText = "تم تسجيل حضورك وحصلت على نقطة Talanton!";
          setTimeout(()=>document.getElementById('attendanceMsg').innerText="", 2000);
          showTalanton(memberId);
        }
      });
    }
    function showTalanton(memberId) {
      let member = members.find(m=>m.id===memberId);
      if (!member) return;
      document.getElementById('talantonBalance').innerText = member.talanton || 0;
      currentMember = member;
    }
    document.getElementById('memberSelect').addEventListener('change', function() {
      let memberId = this.value;
      if (memberId) showTalanton(memberId);
      else currentMember = null;
      document.getElementById('storeCard').classList.add('hidden');
    });

    // المتجر
    function showStore() {
      if (!currentMember) return alert("اختر اسمك أولاً");
      let storeDiv = document.getElementById('storeProducts');
      storeDiv.innerHTML = products.map(p=>
        `<div class="shadow bg-gray-50 rounded p-4 flex flex-col items-center">
          <div class="font-bold text-lg mb-2">${p.name}</div>
          <div class="text-indigo-700 font-bold mb-2">${p.price} <span class="text-green-500">Talanton</span></div>
          <button class="bg-green-600 text-white rounded px-3 py-1 hover:bg-green-800" onclick="buyProduct('${p.id}')">شراء</button>
        </div>`
      ).join('');
      document.getElementById('storeCard').classList.remove('hidden');
    }
    function hideStore() {
      document.getElementById('storeCard').classList.add('hidden');
    }
    function buyProduct(id) {
      let prod = products.find(p=>p.id===id);
      if (!prod) return;
      if ((currentMember.talanton||0) < prod.price) {
        document.getElementById('storeMsg').innerText = "رصيدك لا يكفي!";
        setTimeout(()=>document.getElementById('storeMsg').innerText="",2000);
        return;
      }
      db.ref(`members/${currentMember.id}/talanton`).transaction(t=>(t||0)-prod.price);
      db.ref(`purchases/${currentMember.id}`).push({productId:id, date: new Date().toISOString()});
      document.getElementById('storeMsg').innerText = "تم الشراء!";
      setTimeout(()=>document.getElementById('storeMsg').innerText="",1500);
      loadMembers();
    }

    // Top 10
    function renderTop10() {
      let sorted = [...members].sort((a,b)=>(b.talanton||0)-(a.talanton||0)).slice(0,10);
      let topDiv = document.getElementById('top10List');
      topDiv.innerHTML = sorted.map((m,i)=>`
        <div class="bg-white border rounded p-3 flex items-center gap-2 shadow-sm">
          <span class="bg-indigo-600 text-white rounded-full w-7 h-7 flex items-center justify-center">${i+1}</span>
          <span class="flex-1 font-medium">${m.name}</span>
          <span class="font-bold text-green-600">${m.talanton||0} Talanton</span>
        </div>
      `).join('');
    }

    // رسم بياني للحضور
    function renderAttendanceChart() {
      let data = [];
      let labels = [];
      members.forEach(m=>{
        let att = attendance[m.id] ? Object.keys(attendance[m.id]).length : 0;
        data.push(att);
        labels.push(m.name);
      });
      let ctx = document.getElementById('attendanceChart').getContext('2d');
      if (window.attChart) window.attChart.destroy();
      window.attChart = new Chart(ctx, {
        type: 'bar',
        data: { labels: labels, datasets: [{label:'عدد مرات الحضور', data: data, backgroundColor:'#6366f1'}]},
        options: { responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
      });
    }

    // لوحة تحكم الأدمن
    function showAdminPanel() {
      document.getElementById('adminPanel').classList.remove('hidden');
      showAdminTab('members');
    }
    function hideAdminPanel() {
      document.getElementById('adminPanel').classList.add('hidden');
    }
    function showAdminTab(tab) {
      let c = document.getElementById('adminContent');
      if (tab==='members') {
        c.innerHTML = `
        <div class="mb-3 flex gap-2">
          <input id="newMemberName" class="border p-2 rounded" placeholder="اسم العضو الجديد">
          <button onclick="addMember()" class="bg-green-700 text-white px-3 py-1 rounded">إضافة</button>
        </div>
        <table class="w-full text-center border"><thead>
          <tr class="bg-indigo-50"><th>الاسم</th><th>Talanton</th><th>إجراءات</th></tr>
        </thead><tbody>
          ${members.map(m=>`
            <tr class="border-b">
              <td>${m.name}</td>
              <td>${m.talanton||0}</td>
              <td>
                <button onclick="editMemberPrompt('${m.id}')" class="bg-yellow-500 text-white px-2 py-1 rounded">تعديل</button>
                <button onclick="deleteMember('${m.id}')" class="bg-red-600 text-white px-2 py-1 rounded">حذف</button>
              </td>
            </tr>
          `).join('')}
        </tbody></table>`;
      } else if (tab==='store') {
        c.innerHTML = `
        <div class="mb-3 flex gap-2">
          <input id="newProductName" class="border p-2 rounded" placeholder="اسم المنتج">
          <input id="newProductPrice" type="number" min="1" class="border p-2 rounded" placeholder="سعر Talanton">
          <button onclick="addProduct()" class="bg-green-700 text-white px-3 py-1 rounded">إضافة</button>
        </div>
        <table class="w-full text-center border"><thead>
          <tr class="bg-pink-50"><th>المنتج</th><th>السعر</th><th>إجراءات</th></tr>
        </thead><tbody>
          ${products.map(p=>`
            <tr class="border-b">
              <td>${p.name}</td>
              <td>${p.price}</td>
              <td>
                <button onclick="deleteProduct('${p.id}')" class="bg-red-600 text-white px-2 py-1 rounded">حذف</button>
              </td>
            </tr>
          `).join('')}
        </tbody></table>`;
      }
      // يمكنك تطوير باقي التبويبات بنفس الطريقة (attendance, events, weeks, tasks, reports)
      else {
        c.innerHTML = `<div class="text-gray-500">تطوير لاحق ...</div>`;
      }
    }
    // أعضاء الأدمن
    function addMember() {
      let name = document.getElementById('newMemberName').value.trim();
      if (!name) return;
      db.ref('members').push({name: name, talanton: 0});
      document.getElementById('newMemberName').value = "";
    }
    function editMemberPrompt(id) {
      let member = members.find(m=>m.id===id);
      let name = prompt("تعديل الاسم:", member.name);
      if (name) db.ref('members/'+id).update({name});
    }
    function deleteMember(id) {
      if (confirm('تأكيد حذف العضو؟')) db.ref('members/'+id).remove();
    }
    // متجر الأدمن
    function addProduct() {
      let name = document.getElementById('newProductName').value.trim();
      let price = parseInt(document.getElementById('newProductPrice').value);
      if (!name || !price) return;
      db.ref('products').push({name: name, price: price});
      document.getElementById('newProductName').value = "";
      document.getElementById('newProductPrice').value = "";
    }
    function deleteProduct(id) {
      if (confirm('تأكيد حذف المنتج؟')) db.ref('products/'+id).remove();
    }

    // تحميل عند بدء الصفحة
    window.onload = function() {
      loadMembers();
      loadProducts();
      loadAttendance();
    };
  </script>
</body>
</html>
