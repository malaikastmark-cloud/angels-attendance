<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>اجتماع خدام ملايكة</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Add Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;}
body{background: linear-gradient(135deg,#fceabb,#f8b500);min-height:100vh;padding:20px;}
.container{max-width:1200px;margin:0 auto;background:rgba(255,255,255,0.95);border-radius:15px;box-shadow:0 10px 20px rgba(0,0,0,0.2);padding:20px;}
header{background:#3498db;color:white;padding:15px;text-align:center;border-radius:10px;position:relative;}
header::before{content:"🧚‍♂️";position:absolute;left:10px;top:10px;font-size:1.5rem;}
header::after{content:"✨";position:absolute;right:10px;top:10px;font-size:1.5rem;}
h1{font-size:2rem;}
.tab-content{display:none;padding:20px;}
.tab-content.active{display:block;}
table{width:100%;border-collapse:collapse;margin-top:15px;background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 5px 15px rgba(0,0,0,0.1);}
th,td{padding:10px;text-align:center;border-bottom:1px solid #ddd;}
th{background:#3498db;color:white;}
tr:nth-child(even){background:#f9f9f9;}
tr:hover{background:#f1f1f1;}
.btn{padding:8px 15px;border:none;border-radius:5px;cursor:pointer;font-weight:bold;margin:5px;}
.btn-primary{background:#2ecc71;color:white;}
.btn-primary:hover{background:#27ae60;}
.btn-success{background:#3498db;color:white;}
.btn-success:hover{background:#2980b9;}
.btn-danger{background:#e74c3c;color:white;}
.btn-danger:hover{background:#c0392b;}
.controls{margin:10px 0;display:flex;gap:10px;flex-wrap:wrap;}
select,input{padding:5px;border-radius:5px;border:1px solid #ccc;}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;}
.modal-content{background:white;padding:20px;border-radius:10px;width:400px;max-width:90%;}
.tabs{display:flex;gap:5px;margin-bottom:10px;}
.tabs .tab{padding:8px 15px;cursor:pointer;border-radius:5px;background:#f0f0f0;}
.tabs .tab.active{background:#3498db;color:white;}
.summary-card{background:#fff;border-radius:10px;padding:15px;text-align:center;box-shadow:0 5px 15px rgba(0,0,0,0.1);}
.summary-card h3{color:#3498db;margin-bottom:10px;}
.summary-value{font-size:2rem;font-weight:bold;color:#2ecc71;}
.card-container{display:flex;gap:15px;flex-wrap:wrap;margin-top:15px;}
.loading{display:none;text-align:center;margin:20px 0;}
.loading-spinner{width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto;}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
</style>
</head>
<body>
<div class="container">
    <header>
        <h1>🌟 اجتماع خدام ملايكة</h1>
        <p>الحضور يساوي نقطة</p>
    </header>

    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <p>جاري تحميل البيانات...</p>
    </div>

    <div class="tab-content active" id="userAttendance">
        <div class="controls">
            <label>اختر اسمك: </label>
            <select id="selectMember"></select>
            <label>اختر الأسبوع: </label>
            <select id="weekSelect"></select>
        </div>
        <div class="controls">
            <button class="btn btn-primary" id="markPresent">تسجيل الحضور</button>
        </div>
        <table>
            <thead><tr><th>#</th><th>اسم العضو</th><th>الأسبوع</th><th>الحضور</th><th>النقاط</th></tr></thead>
            <tbody id="attendanceTableBody"></tbody>
        </table>
        <div class="controls">
            <span>الحضور هذا الأسبوع: <span id="attendanceCount">0</span>/<span id="totalMembers">0</span></span>
            <span>النقاط: <span id="totalPoints">0</span></span>
        </div>
    </div>

    <div class="controls" style="margin-top:20px;">
        <button class="btn btn-success" id="adminLoginBtn">تسجيل دخول الأدمن</button>
    </div>

    <div class="modal" id="adminLoginModal">
        <div class="modal-content">
            <h2>تسجيل دخول الأدمن</h2>
            <input type="password" id="adminPassword" placeholder="كلمة السر">
            <div class="controls">
                <button class="btn btn-danger" id="cancelAdminLogin">إلغاء</button>
                <button class="btn btn-success" id="confirmAdminLogin">دخول</button>
            </div>
        </div>
    </div>

    <div class="tab-content" id="adminTabs" style="display:none;">
        <div class="tabs">
            <div class="tab active" data-tab="members">إدارة الأعضاء</div>
            <div class="tab" data-tab="weeks">إدارة الأسابيع</div>
            <div class="tab" data-tab="attendance">إدارة الحضور</div>
            <div class="tab" data-tab="reports">التقارير</div>
        </div>

        <div class="tab-content active" id="members">
            <h2>إدارة الأعضاء</h2>
            <div class="controls">
                <input type="text" id="newMemberName" placeholder="اسم العضو">
                <button class="btn btn-primary" id="addMemberBtn">إضافة عضو</button>
            </div>
            <table id="membersTable">
                <thead><tr><th>#</th><th>اسم العضو</th><th>النقاط</th><th>تعديل</th><th>حذف</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="tab-content" id="weeks">
            <h2>إدارة الأسابيع</h2>
            <div class="controls">
                <input type="text" id="newWeekName" placeholder="اسم الأسبوع">
                <input type="date" id="newWeekStart">
                <input type="date" id="newWeekEnd">
                <button class="btn btn-primary" id="addWeekBtn">إضافة أسبوع</button>
            </div>
            <table id="weeksTable">
                <thead><tr><th>#</th><th>اسم الأسبوع</th><th>من</th><th>إلى</th><th>تعديل</th><th>حذف</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="tab-content" id="attendance">
            <h2>إدارة تسجيلات الحضور</h2>
            <div class="controls">
                <label>اختر أسبوع: </label>
                <select id="deleteWeekSelect"></select>
                <button class="btn btn-danger" id="deleteAttendanceBtn">حذف كل حضور هذا الأسبوع</button>
            </div>
            <table id="attendanceTable">
                <thead><tr><th>#</th><th>العضو</th><th>الأسبوع</th><th>تاريخ التسجيل</th><th>حذف</th></tr></thead>
                <tbody id="attendanceRecordsBody"></tbody>
            </table>
        </div>

        <div class="tab-content" id="reports">
            <h2>التقارير</h2>
            <div class="card-container">
                <div class="summary-card"><h3>إجمالي الحضور</h3><div class="summary-value" id="reportAttendance">0</div></div>
                <div class="summary-card"><h3>النقاط الممنوحة</h3><div class="summary-value" id="reportPoints">0</div></div>
            </div>
            <canvas id="attendanceChart" style="margin-top:20px;"></canvas>
        </div>
    </div>
</div>

<script>
// ====== إعدادات Firebase - يجب استبدالها بإعداداتك ======
const firebaseConfig = {
    apiKey: "AIzaSyBCQIqdCsxSvhfYOs00AetoVWpFhj4XNAQ",
    authDomain: "angels-attendance.firebaseapp.com",
    databaseURL: "https://angels-attendance-default-rtdb.firebaseio.com",
    projectId: "angels-attendance",
    storageBucket: "angels-attendance.firebasestorage.app",
    messagingSenderId: "157249026489",
    appId: "1:157249026489:web:db2b420203bd81d9a19e68"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// بيانات التطبيق
let members = [];
let weeks = [];
let attendanceRecords = [];

// وظائف Firebase
function showLoading() {
    document.getElementById('loading').style.display = 'block';
}

function hideLoading() {
    document.getElementById('loading').style.display = 'none';
}

function loadData() {
    showLoading();
    const dataRef = database.ref('angelsAttendance');
    
    dataRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            members = data.members || [];
            weeks = data.weeks || [];
            attendanceRecords = data.attendanceRecords || [];
        } else {
            // البيانات الأولية إذا لم توجد بيانات
            members = [{id:1,name:'🧒 Mary Karam'},{id:2,name:'👦 Eman Makin'},{id:3,name:'👧 Rizk Gerges'}];
            weeks = [{id:1,name:'الاسبوع الاول',from:'2025-08-29',to:'2025-08-29'}];
            attendanceRecords = [];
            saveData();
        }
        populateData();
        hideLoading();
    }, (error) => {
        console.error('Error loading data:', error);
        hideLoading();
        alert('حدث خطأ في تحميل البيانات. تأكد من اتصال الإنترنت.');
    });
}

function saveData() {
    showLoading();
    const dataRef = database.ref('angelsAttendance');
    dataRef.set({
        members: members,
        weeks: weeks,
        attendanceRecords: attendanceRecords
    }).then(() => {
        hideLoading();
    }).catch((error) => {
        console.error('Error saving data:', error);
        hideLoading();
        alert('حدث خطأ في حفظ البيانات. تأكد من اتصال الإنترنت.');
    });
}

// بقية الوظائف كما هي مع تعديل بسيط
function populateData(){
    const selectMember=document.getElementById('selectMember');
    selectMember.innerHTML='';
    members.forEach(m=>{let o=document.createElement('option'); o.value=m.id; o.textContent=m.name; selectMember.appendChild(o);});

    const weekSelect=document.getElementById('weekSelect');
    weekSelect.innerHTML='';
    weeks.forEach(w=>{let o=document.createElement('option'); o.value=w.id; o.textContent=w.name; weekSelect.appendChild(o);});

    // تعبئة قائمة الأسابيع في إدارة الحضور
    const deleteWeekSelect=document.getElementById('deleteWeekSelect');
    deleteWeekSelect.innerHTML='';
    weeks.forEach(w=>{let o=document.createElement('option'); o.value=w.id; o.textContent=w.name; deleteWeekSelect.appendChild(o);});

    const tbody=document.getElementById('attendanceTableBody'); 
    tbody.innerHTML='';
    
    const selectedWeekId = document.getElementById('weekSelect').value;
    const selectedWeek = weeks.find(w => w.id == selectedWeekId);
    
    members.forEach((m,i)=>{
        // التحقق من وجود سجل حضور لهذا العضو في هذا الأسبوع
        const attendanceRecord = attendanceRecords.find(ar => 
            ar.memberId === m.id && ar.weekId == selectedWeekId
        );
        
        const isPresent = attendanceRecord ? attendanceRecord.present : false;
        
        let tr=document.createElement('tr'); 
        tr.dataset.member=m.id;
        tr.innerHTML=`
            <td>${i+1}</td>
            <td>${m.name}</td>
            <td>${selectedWeek ? selectedWeek.name : ''}</td>
            <td class="attendance-value">${isPresent ? '1' : '0'}</td>
            <td class="points">${isPresent ? '1' : '0'}</td>
        `;
        tbody.appendChild(tr);
    });
    
    document.getElementById('totalMembers').textContent=members.length;
    updateAttendanceStats();
    populateAdminTables();
    populateAttendanceRecords(); // تحديث سجلات الحضور
}

function populateAdminTables(){
    const membersTbody=document.querySelector('#membersTable tbody');
    membersTbody.innerHTML='';
    members.forEach((m,i)=>{
        // حساب النقاط الإجمالية لكل عضو
        const totalPoints = attendanceRecords.filter(ar => 
            ar.memberId === m.id && ar.present
        ).length;
        
        let tr=document.createElement('tr');
        tr.innerHTML=`<td>${i+1}</td><td>${m.name}</td><td>${totalPoints}</td><td><button class='btn btn-primary editMember'>تعديل</button></td><td><button class='btn btn-danger deleteMember'>حذف</button></td>`;
        membersTbody.appendChild(tr);
    });
    const weeksTbody=document.querySelector('#weeksTable tbody');
    weeksTbody.innerHTML='';
    weeks.forEach((w,i)=>{
        let tr=document.createElement('tr');
        tr.innerHTML=`<td>${i+1}</td><td>${w.name}</td><td>${w.from}</td><td>${w.to}</td><td><button class='btn btn-primary editWeek'>تعديل</button></td><td><button class='btn btn-danger deleteWeek'>حذف</button></td>`;
        weeksTbody.appendChild(tr);
    });
}

// عرض سجلات الحضور
function populateAttendanceRecords() {
    const tbody = document.querySelector('#attendanceRecordsBody');
    tbody.innerHTML = '';
    
    attendanceRecords.forEach((record, index) => {
        const member = members.find(m => m.id === record.memberId);
        const week = weeks.find(w => w.id == record.weekId);
        
        if (member && week) {
            let tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${index + 1}</td>
                <td>${member.name}</td>
                <td>${week.name}</td>
                <td>${new Date(record.date).toLocaleString('ar-EG')}</td>
                <td><button class='btn btn-danger deleteAttendance' data-index='${index}'>حذف</button></td>
            `;
            tbody.appendChild(tr);
        }
    });
}

function updateAttendanceStats(){
    const selectedWeekId = document.getElementById('weekSelect').value;
    let count=0;
    let totalPoints=0;
    
    // حساب الحضور لهذا الأسبوع فقط
    const weekAttendance = attendanceRecords.filter(ar => 
        ar.weekId == selectedWeekId && ar.present
    );
    
    count = weekAttendance.length;
    totalPoints = count;
    
    document.getElementById('attendanceCount').textContent=count;
    document.getElementById('totalPoints').textContent=totalPoints;
    document.getElementById('reportAttendance').textContent=count;
    document.getElementById('reportPoints').textContent=totalPoints;
    updateChart();
}

// إضافة أعضاء
function addMember(name){
    const id=members.length?Math.max(...members.map(m=>m.id))+1:1;
    members.push({id,name});
    saveData();
    populateData();
}

// إضافة أسابيع
function addWeek(name,from,to){
    const id=weeks.length?Math.max(...weeks.map(w=>w.id))+1:1;
    weeks.push({id,name,from,to}); 
    saveData(); 
    populateData();
}

// تسجيل الحضور للعضو المحدد
function markAttendance() {
    const memberId = parseInt(document.getElementById('selectMember').value);
    const weekId = parseInt(document.getElementById('weekSelect').value);
    
    if (!memberId || !weekId) {
        alert('يجب اختيار العضو والأسبوع أولاً');
        return;
    }
    
    const index = attendanceRecords.findIndex(ar => 
        ar.memberId === memberId && ar.weekId == weekId
    );
    
    if (index !== -1) {
        // إذا كان موجوداً بالفعل، لا نفعل شيئاً (لا نسمح بالتسجيل المتكرر)
        alert('لقد تم تسجيل حضور هذا العضو already في هذا الأسبوع');
    } else {
        // إضافة سجل جديد
        attendanceRecords.push({
            memberId: memberId,
            weekId: weekId,
            present: true,
            date: new Date().toISOString()
        });
        
        saveData();
        populateData();
        alert('تم تسجيل الحضور بنجاح!');
    }
}

// حذف تسجيل حضور محدد
function deleteAttendanceRecord(index) {
    if (confirm('هل تريد حذف تسجيل الحضور هذا؟')) {
        attendanceRecords.splice(index, 1);
        saveData();
        populateAttendanceRecords();
        populateData(); // تحديث الجدول الرئيسي
    }
}

// حذف كل الحضور لأسبوع محدد
function deleteAllWeekAttendance() {
    const weekId = parseInt(document.getElementById('deleteWeekSelect').value);
    
    if (!weekId) {
        alert('يجب اختيار أسبوع أولاً');
        return;
    }
    
    if (confirm(`هل تريد حذف كل تسجيلات الحضور للأسبوع المحدد؟ هذا الإجراء لا يمكن التراجع عنه!`)) {
        attendanceRecords = attendanceRecords.filter(ar => ar.weekId != weekId);
        saveData();
        populateAttendanceRecords();
        populateData(); // تحديث الجدول الرئيسي
        alert('تم حذف جميع تسجيلات الحضور لهذا الأسبوع');
    }
}

// تبويبات الأدمن
document.querySelectorAll('#adminTabs .tab').forEach(tab=>{
    tab.addEventListener('click',()=>{
        document.querySelectorAll('#adminTabs .tab').forEach(t=>t.classList.remove('active'));
        document.querySelectorAll('#adminTabs .tab-content').forEach(c=>c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');
        
        // إذا كان تبويب إدارة الحضور، قم بتحديث البيانات
        if (tab.dataset.tab === 'attendance') {
            populateAttendanceRecords();
        }
    });
});

// تسجيل دخول الأدمن
const adminPass='1234';
document.getElementById('adminLoginBtn').addEventListener('click',()=>{document.getElementById('adminLoginModal').style.display='flex';});
document.getElementById('cancelAdminLogin').addEventListener('click',()=>{document.getElementById('adminLoginModal').style.display='none';});
document.getElementById('confirmAdminLogin').addEventListener('click',()=>{
    const pwd=document.getElementById('adminPassword').value;
    if(pwd===adminPass){
        document.getElementById('adminLoginModal').style.display='none';
        document.getElementById('adminTabs').style.display='block';
    }
    else alert('كلمة السر خطأ!');
});

// تعديل وحذف أعضاء
document.addEventListener('click',e=>{
    if(e.target.classList.contains('editMember')){
        const tr=e.target.closest('tr');
        const idx=tr.rowIndex-1;
        const newName=prompt('عدل اسم العضو:',members[idx].name);
        if(newName){members[idx].name=newName; saveData(); populateData();}
    }
    if(e.target.classList.contains('deleteMember')){
        if(confirm('هل تريد حذف العضو؟')){
            const tr=e.target.closest('tr'); const idx=tr.rowIndex-1;
            
            // حذف سجلات الحضور الخاصة بهذا العضو أولاً
            attendanceRecords = attendanceRecords.filter(ar => ar.memberId !== members[idx].id);
            
            members.splice(idx,1); 
            saveData(); 
            populateData();
        }
    }
    if(e.target.classList.contains('editWeek')){
        const tr=e.target.closest('tr'); const idx=tr.rowIndex-1;
        const newName=prompt('عدل اسم الأسبوع:',weeks[idx].name);
        const newFrom=prompt('عدل تاريخ البداية:',weeks[idx].from);
        const newTo=prompt('عدل تاريخ النهاية:',weeks[idx].to);
        if(newName && newFrom && newTo){weeks[idx]={...weeks[idx],name:newName,from:newFrom,to:newTo}; saveData(); populateData();}
    }
    if(e.target.classList.contains('deleteWeek')){
        if(confirm('هل تريد حذف الأسبوع؟')){
            const tr=e.target.closest('tr'); const idx=tr.rowIndex-1;
            
            // حذف سجلات الحضور الخاصة بهذا الأسبوع أولاً
            attendanceRecords = attendanceRecords.filter(ar => ar.weekId != weeks[idx].id);
            
            weeks.splice(idx,1); 
            saveData(); 
            populateData();
        }
    }
    
    // النقر على أزرار حذف الحضور
    if(e.target.classList.contains('deleteAttendance')){
        const index = parseInt(e.target.dataset.index);
        deleteAttendanceRecord(index);
    }
});

// رسم بياني
const ctx=document.getElementById('attendanceChart').getContext('2d');
let chart=new Chart(ctx,{type:'bar',data:{labels:members.map(m=>m.name),datasets:[{label:'الحضور',data:Array(members.length).fill(0),backgroundColor:['#3498db','#2ecc71','#f39c12']}]},options:{responsive:true,plugins:{legend:{display:false}}}});
function updateChart(){
    const selectedWeekId = document.getElementById('weekSelect').value;
    
    const data = members.map(member => {
        const record = attendanceRecords.find(ar => 
            ar.memberId === member.id && ar.weekId == selectedWeekId
        );
        return record && record.present ? 1 : 0;
    });
    
    chart.data.labels=members.map(m=>m.name);
    chart.data.datasets[0].data=data;
    chart.update();
}

// أحداث الأزرار
document.getElementById('markPresent').addEventListener('click', markAttendance);
document.getElementById('deleteAttendanceBtn').addEventListener('click', deleteAllWeekAttendance);

document.getElementById('addMemberBtn').addEventListener('click',()=>{
    const name=document.getElementById('newMemberName').value;
    if(!name){alert('ادخل اسم العضو');return;}
    addMember(name); document.getElementById('newMemberName').value='';
});
document.getElementById('addWeekBtn').addEventListener('click',()=>{
    const name=document.getElementById('newWeekName').value;
    const from=document.getElementById('newWeekStart').value;
    const to=document.getElementById('newWeekEnd').value;
    if(!name||!from||!to){alert('املأ كل الحقول');return;}
    addWeek(name,from,to);
    document.getElementById('newWeekName').value=''; document.getElementById('newWeekStart').value=''; document.getElementById('newWeekEnd').value='';
});

// تحديث البيانات عند تغيير الأسبوع
document.getElementById('weekSelect').addEventListener('change', populateData);

// تحميل البيانات عند بدء التشغيل
loadData();
</script>
</body>
</html>
