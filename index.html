
<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <title>نظام حضور الملائكة</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; direction: rtl; }
        .firebase-status { margin-bottom: 10px; padding:5px; display:inline-block; }
        .firebase-connected { color: #2ecc71; }
        .firebase-disconnected { color: #e74c3c; }
        .member-img { width: 40px; height: 40px; border-radius: 50%; }
        .btn { padding:5px 10px; margin:2px; cursor:pointer; border:none; border-radius:4px; }
        .btn-primary { background:#3498db; color:white; }
        .btn-danger { background:#e74c3c; color:white; }
        #notification { position:fixed; top:10px; left:50%; transform:translateX(-50%); padding:10px 20px; color:white; display:none; border-radius:5px; z-index:1000; }
        table { border-collapse: collapse; width:100%; margin-top:10px; }
        table, th, td { border: 1px solid #ccc; }
        th, td { padding:5px; text-align:center; }
        #adminTabs { display:none; margin-top:10px; }
        .tab { display:inline-block; padding:5px 10px; background:#ddd; margin:2px; cursor:pointer; border-radius:4px; }
        .tab.active { background:#3498db; color:white; }
        .tab-content { display:none; margin-top:10px; }
        .tab-content.active { display:block; }
        #loading { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); z-index:999; color:white; text-align:center; padding-top:20%; font-size:24px; }
        .top-member-item { display:flex; justify-content:space-between; margin-bottom:5px; align-items:center; }
        .medal { font-size:18px; }
        .member-stats { display:flex; gap:10px; margin-bottom:10px; align-items:center; }
        .member-stat-item { text-align:center; }
        .member-stat-value { font-weight:bold; }
        .member-stat-label { font-size:12px; color:#555; }
    </style>
</head>
<body>

<h2>نظام حضور الملائكة</h2>
<div id="firebaseStatus" class="firebase-status">جارٍ الاتصال بقاعدة البيانات...</div>

<div id="notification"></div>
<div id="loading">جاري التحميل...</div>

<!-- واجهة المستخدم -->
<div id="userAttendance">
    <select id="selectMember"></select>
    <select id="weekSelect"></select>
    <button class="btn btn-primary" id="markPresent">تسجيل الحضور</button>
    <br>
    <span>عدد الحضور: <span id="attendanceCount">0</span></span> |
    <span>النقاط: <span id="totalPoints">0</span></span>
    <canvas id="attendanceChart" style="max-width:600px;margin-top:10px;"></canvas>
</div>

<!-- تسجيل دخول الأدمن -->
<button id="adminLoginBtn" class="btn btn-primary">دخول الأدمن</button>
<div id="adminLoginModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center;">
    <div style="background:white; padding:20px; border-radius:8px; width:300px; text-align:center;">
        <h3>تسجيل دخول الأدمن</h3>
        <input type="password" id="adminPassword" placeholder="كلمة السر" style="width:90%; padding:5px;">
        <br><br>
        <button id="confirmAdminLogin" class="btn btn-primary">دخول</button>
        <button id="cancelAdminLogin" class="btn btn-danger">إلغاء</button>
    </div>
</div>

<!-- تبويبات الأدمن -->
<div id="adminTabs">
    <div class="tab active" data-tab="attendance">إدارة الحضور</div>
    <div class="tab" data-tab="members">الأعضاء</div>
    <div class="tab" data-tab="weeks">الأسابيع</div>
    <div class="tab" data-tab="reports">التقارير</div>

    <div id="attendance" class="tab-content active">
        <button class="btn btn-danger" id="deleteAttendanceBtn">حذف كل حضور الأسبوع</button>
        <table>
            <thead><tr><th>#</th><th>العضو</th><th>الأسبوع</th><th>تاريخ التسجيل</th><th>حذف</th></tr></thead>
            <tbody id="attendanceRecordsBody"></tbody>
        </table>
    </div>

    <div id="members" class="tab-content">
        <input type="text" id="newMemberName" placeholder="اسم العضو">
        <input type="text" id="newMemberImage" placeholder="رابط الصورة">
        <button class="btn btn-primary" id="addMemberBtn">إضافة عضو</button>
        <table id="membersTable">
            <thead><tr><th>#</th><th>صورة</th><th>الاسم</th><th>النقاط</th><th>المكافآت</th><th>تعديل</th><th>حذف</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="weeks" class="tab-content">
        <input type="text" id="newWeekName" placeholder="اسم الأسبوع">
        <input type="date" id="newWeekStart">
        <input type="date" id="newWeekEnd">
        <button class="btn btn-primary" id="addWeekBtn">إضافة أسبوع</button>
        <table id="weeksTable">
            <thead><tr><th>#</th><th>الاسم</th><th>من</th><th>إلى</th><th>تعديل</th><th>حذف</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="reports" class="tab-content">
        <h3>التقارير</h3>
        <div>إجمالي الحضور: <span id="reportAttendance">0</span></div>
        <div>إجمالي النقاط: <span id="reportPoints">0</span></div>
        <div>عدد الأعضاء: <span id="reportMembers">0</span></div>
        <div>عدد الأسابيع: <span id="reportWeeks">0</span></div>
        <div id="topMembersList"></div>
        <div id="membersStatsContainer"></div>
        <button class="btn btn-primary" id="printReportBtn">طباعة التقرير</button>
        <button class="btn btn-primary" id="exportExcelBtn">تصدير لإكسل</button>
    </div>
</div>

<script>
    // ======= الإعدادات =======
    let members = [];
    let weeks = [];
    let attendanceRecords = [];
    let rewards = [];
    const adminPass = 'admin123';
    let db = null;

    function initializeFirebase() {
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        document.getElementById('firebaseStatus').textContent = '✓ متصل بقاعدة البيانات';
        document.getElementById('firebaseStatus').className = 'firebase-status firebase-connected';
        loadDataFromFirebase();
    }

    async function loadDataFromFirebase() {
        document.getElementById('loading').style.display = 'block';
        try {
            const membersSnapshot = await db.collection('members').get();
            const weeksSnapshot = await db.collection('weeks').get();
            const attendanceSnapshot = await db.collection('attendance').get();
            const rewardsSnapshot = await db.collection('rewards').get();

            members = membersSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            weeks = weeksSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            attendanceRecords = attendanceSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            rewards = rewardsSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));

            populateData();
            updateReports();
            document.getElementById('loading').style.display = 'none';
            showNotification('تم تحميل البيانات من Firebase');
        } catch(err) {
            console.error(err);
            document.getElementById('firebaseStatus').textContent = '✗ خطأ في تحميل البيانات';
            document.getElementById('firebaseStatus').className = 'firebase-status firebase-disconnected';
            document.getElementById('loading').style.display = 'none';
        }
    }

    async function saveToFirebase() {
        try {
            // حفظ الأعضاء
            for (const member of members) {
                if(member.id.startsWith("temp")) continue;
                await db.collection('members').doc(member.id).set({name:member.name, image:member.image});
            }
            // حفظ الأسابيع
            for (const week of weeks) {
                await db.collection('weeks').doc(week.id).set({name:week.name, from:week.from, to:week.to});
            }
            // حفظ الحضور
            for (const record of attendanceRecords) {
                await db.collection('attendance').doc(record.id || db.collection('attendance').doc().id).set(record);
            }
            // حفظ المكافآت
            for (const reward of rewards) {
                await db.collection('rewards').doc(reward.id || db.collection('rewards').doc().id).set(reward);
            }
            showNotification('تم حفظ البيانات في Firebase');
        } catch(err) {
            console.error(err);
            showNotification('خطأ في حفظ البيانات', false);
        }
    }

    function showNotification(message, success=true){
        const n = document.getElementById('notification');
        n.textContent = message;
        n.style.background = success ? '#2ecc71' : '#e74c3c';
        n.style.display='block';
        setTimeout(()=> n.style.display='none',3000);
    }

    // ======= باقي الوظائف populateData, markAttendance, addMember, addWeek, edit/delete, chart, reports =======
    // يمكنك نسخ جميع وظائف populateData و updateReports و markAttendance و addMember و addWeek و updateChart و checkForRewards من النسخة السابقة، مع تعديل الحفظ ليكون دائمًا عبر Firebase فقط.

    document.addEventListener('DOMContentLoaded', () => { initializeFirebase(); });
</script>
</body>
</html>
