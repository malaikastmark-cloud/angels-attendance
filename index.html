<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Angels Attendance</title>
<style>
/* ===================== ستايل الصفحة ===================== */
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f5f5f5; }
header { background:#3498db; color:#fff; padding:15px; text-align:center; }
.container { padding:20px; max-width:1200px; margin:auto; }
button { padding:5px 10px; margin:2px; cursor:pointer; }
.member-img { width:40px; height:40px; border-radius:50%; }
.calendar-day { display:inline-block; width:30px; height:30px; margin:2px; text-align:center; line-height:30px; border:1px solid #ccc; }
.calendar-day.today { background:#3498db; color:#fff; }
.calendar-day.event { background:#2ecc71; color:#fff; }
.task-completed { text-decoration: line-through; }
.badge { padding:3px 6px; border-radius:3px; background:#3498db; color:#fff; font-size:12px; }
.firebase-status { padding:5px 10px; display:inline-block; margin-bottom:10px; border-radius:5px; }
.firebase-connected { background:#2ecc71; color:#fff; }
.notification { position:fixed; bottom:10px; right:10px; padding:10px 20px; color:#fff; border-radius:5px; display:none; z-index:999; }
.tab { padding:10px 15px; background:#ddd; display:inline-block; cursor:pointer; margin-right:2px; border-radius:5px; }
.tab.active { background:#3498db; color:#fff; }
.tab-content { display:none; margin-top:20px; }
.tab-content.active { display:block; }
.admin-only { display:none; }
.admin-mode .admin-only { display:inline-block; }
</style>
</head>
<body>
<header>
    <h1>نظام حضور Angels</h1>
    <span id="firebaseStatus" class="firebase-status"></span>
    <button id="adminLoginBtn">تسجيل دخول الأدمن</button>
    <button id="adminLogoutBtn" style="display:none;">تسجيل خروج الأدمن</button>
</header>

<div class="container">
    <!-- إشعارات -->
    <div id="notification" class="notification"></div>

    <!-- تبويبات -->
    <div id="tabs">
        <div class="tab active" data-tab="userAttendance">تسجيل الحضور</div>
        <div class="tab admin-tab" data-tab="adminPanel">لوحة الأدمن</div>
    </div>

    <!-- المحتوى -->
    <div id="userAttendance" class="tab-content active">
        <h3>تسجيل الحضور</h3>
        <select id="selectMember">
            <option value="">-- اختر اسمك --</option>
        </select>
        <select id="weekSelect"></select>
        <button id="markPresent">تسجيل حضور</button>
        <table border="1" style="margin-top:10px;width:100%">
            <thead>
                <tr><th>#</th><th>صورة</th><th>الاسم</th><th>الأسبوع</th><th>حضور</th><th>نقاط</th><th class="admin-only">إنجاز</th></tr>
            </thead>
            <tbody id="attendanceTableBody"></tbody>
        </table>
        <p>عدد الأعضاء: <span id="totalMembers">0</span></p>
        <p>الحضور هذا الأسبوع: <span id="attendanceCount">0</span></p>
        <p>مجموع النقاط: <span id="totalPoints">0</span></p>
    </div>

    <div id="adminPanel" class="tab-content">
        <h3>لوحة الأدمن</h3>
        <!-- إدارة الأعضاء -->
        <h4>الأعضاء</h4>
        <input type="text" id="newMemberName" placeholder="اسم العضو">
        <input type="text" id="newMemberImage" placeholder="رابط الصورة">
        <button id="addMemberBtn">إضافة عضو</button>
        <table border="1" style="margin-top:10px;width:100%">
            <thead><tr><th>#</th><th>صورة</th><th>الاسم</th><th>تعديل</th><th>حذف</th></tr></thead>
            <tbody id="membersList"></tbody>
        </table>

        <!-- إدارة الأسابيع -->
        <h4>الأسابيع</h4>
        <input type="text" id="newWeekName" placeholder="اسم الأسبوع">
        <input type="date" id="newWeekStart">
        <input type="date" id="newWeekEnd">
        <button id="addWeekBtn">إضافة أسبوع</button>
        <table border="1" style="margin-top:10px;width:100%">
            <thead><tr><th>#</th><th>الاسم</th><th>من</th><th>إلى</th><th>تعديل</th><th>حذف</th></tr></thead>
            <tbody id="weeksList"></tbody>
        </table>
    </div>
</div>

<!-- نموذج تسجيل دخول الأدمن -->
<div id="adminLoginModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;">
    <div style="background:#fff;padding:20px;border-radius:10px;">
        <h3>تسجيل دخول الأدمن</h3>
        <input type="password" id="adminPassword" placeholder="كلمة السر">
        <button id="confirmAdminLogin">تسجيل دخول</button>
        <button id="cancelAdminLogin">إلغاء</button>
    </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// ======= إعداد Firebase =======
const firebaseConfig = {
  apiKey: "AIzaSyBCQIqdCsxSvhfYOs00AetoVWpFhj4XNAQ",
  authDomain: "angels-attendance.firebaseapp.com",
  databaseURL: "https://angels-attendance-default-rtdb.firebaseio.com",
  projectId: "angels-attendance",
  storageBucket: "angels-attendance.firebasestorage.app",
  messagingSenderId: "157249026489",
  appId: "1:157249026489:web:db2b420203bd81d9a19e68"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ======= بيانات افتراضية =======
let members = [];
let weeks = [];
let attendanceRecords = [];
let rewards = [];
let isAdmin = false;
const adminPass = 'admin123';

// ======= وظائف مساعدة =======
function showNotification(msg, success=true){
    const notif = document.getElementById('notification');
    notif.textContent = msg;
    notif.style.background = success?'#2ecc71':'#e74c3c';
    notif.style.display = 'block';
    setTimeout(()=>{notif.style.display='none'},3000);
}

// ======= تحميل البيانات من Firebase =======
function loadData(){
    db.ref('members').once('value').then(snap=>{members=snap.val()||[];populateMembersList();populateData();});
    db.ref('weeks').once('value').then(snap=>{weeks=snap.val()||[];populateWeeksList();populateData();});
    db.ref('attendanceRecords').once('value').then(snap=>{attendanceRecords=snap.val()||[];populateData();updateReports();});
    db.ref('rewards').once('value').then(snap=>{rewards=snap.val()||[];updateTasksUI();updateLeaderboard();});
    document.getElementById('firebaseStatus').textContent='✓ متصل بـ Firebase';
}

// ======= حفظ البيانات =======
function saveData(refName, data){
    db.ref(refName).set(data);
}

// ======= تهيئة الصفحة =======
document.addEventListener('DOMContentLoaded', ()=>{
    loadData();
    setupEventListeners();
});

// ======= إعداد المستمعين =======
function setupEventListeners(){
    document.getElementById('adminLoginBtn').addEventListener('click',()=>{document.getElementById('adminLoginModal').style.display='flex';});
    document.getElementById('cancelAdminLogin').addEventListener('click',()=>{document.getElementById('adminLoginModal').style.display='none';});
    document.getElementById('confirmAdminLogin').addEventListener('click',()=>{
        const pwd=document.getElementById('adminPassword').value;
        if(pwd===adminPass){setAdminMode(true);document.getElementById('adminLoginModal').style.display='none';showNotification('تم تسجيل دخول الأدمن');}
        else alert('كلمة السر خطأ!');
    });
    document.getElementById('adminLogoutBtn').addEventListener('click',()=>{setAdminMode(false);});
    document.getElementById('markPresent').addEventListener('click',markAttendance);
    document.getElementById('addMemberBtn').addEventListener('click',addNewMember);
    document.getElementById('addWeekBtn').addEventListener('click',addNewWeek);
    document.querySelectorAll('.tab').forEach(tab=>{
        tab.addEventListener('click',()=>{
            if(tab.classList.contains('admin-tab') && !isAdmin){showNotification('يجب تسجيل دخول الأدمن للوصول',false);return;}
            document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(tab.dataset.tab).classList.add('active');
        });
    });
}

// ======= لوحة الأدمن =======
function setAdminMode(mode){
    isAdmin=mode;
    if(mode){
        document.body.classList.add('admin-mode');
        document.getElementById('adminLoginBtn').style.display='none';
        document.getElementById('adminLogoutBtn').style.display='inline-block';
    }else{
        document.body.classList.remove('admin-mode');
        document.getElementById('adminLoginBtn').style.display='inline-block';
        document.getElementById('adminLogoutBtn').style.display='none';
        document.querySelector('[data-tab="userAttendance"]').click();
    }
}

// ======= تعبئة البيانات في الجدول =======
function populateData(){
    const selectMember=document.getElementById('selectMember');
    if(selectMember){
        selectMember.innerHTML='<option value="">-- اختر اسمك --</option>';
        members.forEach(m=>{
            const option=document.createElement('option');
            option.value=m.id; option.textContent=m.name; selectMember.appendChild(option);
        });
    }

    const weekSelect=document.getElementById('weekSelect');
    if(weekSelect){
        weekSelect.innerHTML='';
        weeks.forEach(w=>{
            const option=document.createElement('option');
            option.value=w.id; option.textContent=w.name; weekSelect.appendChild(option);
        });
    }

    const tbody=document.getElementById('attendanceTableBody');
    if(tbody){
        tbody.innerHTML='';
        const selectedWeekId=parseInt(document.getElementById('weekSelect').value)||0;
        members.forEach((m,i)=>{
            const attendanceRecord=attendanceRecords.find(ar=>ar.memberId===m.id && ar.weekId===selectedWeekId);
            const isPresent=attendanceRecord?attendanceRecord.present:false;
            const tr=document.createElement('tr');
            tr.dataset.member=m.id;
            tr.innerHTML=`<td>${i+1}</td><td><img src="${m.image||'https://ui-avatars.com/api/?name=Member&background=ccc&color=fff'}" class="member-img"></td><td>${m.name}</td><td>${weeks.find(w=>w.id===selectedWeekId)?.name||''}</td><td class="attendance-value">${isPresent?'1':'0'}</td><td class="points">${isPresent?'1':'0'}</td><td class="admin-only"><span class="badge badge-primary">0 إنجاز</span></td>`;
            tbody.appendChild(tr);
        });
    }
}

// ======= تسجيل الحضور =======
function markAttendance(){
    const memberId=parseInt(document.getElementById('selectMember').value);
    const weekId=parseInt(document.getElementById('weekSelect').value);
    if(!memberId || !weekId){alert('اختر العضو والأسبوع'); return;}
    const exists=attendanceRecords.find(ar=>ar.memberId===memberId && ar.weekId===weekId);
    if(exists){showNotification('تم تسجيل الحضور مسبقًا',false); return;}
    const record={memberId,weekId,present:true,date:new Date().toISOString()};
    attendanceRecords.push(record); saveData('attendanceRecords',attendanceRecords);
    showNotification('تم تسجيل الحضور');
    populateData(); updateReports();
}

// ======= إضافة عضو جديد =======
function addNewMember(){
    const name=document.getElementById('newMemberName').value.trim();
    const image=document.getElementById('newMemberImage').value.trim();
    if(!name){alert('أدخل اسم العضو'); return;}
    const id=members.length?members[members.length-1].id+1:1;
    const member={id,name,image};
    members.push(member); saveData('members',members);
    showNotification('تم إضافة العضو'); populateMembersList(); populateData();
}

// ======= إضافة أسبوع جديد =======
function addNewWeek(){
    const name=document.getElementById('newWeekName').value.trim();
    const start=document.getElementById('newWeekStart').value;
    const end=document.getElementById('newWeekEnd').value;
    if(!name || !start || !end){alert('أكمل جميع البيانات'); return;}
    const id=weeks.length?weeks[weeks.length-1].id+1:1;
    const week={id,name,start,end};
    weeks.push(week); saveData('weeks',weeks); showNotification('تم إضافة الأسبوع'); populateWeeksList(); populateData();
}

// ======= تحديث الجداول =======
function populateMembersList(){
    const tbody=document.getElementById('membersList'); tbody.innerHTML='';
    members.forEach((m,i)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${i+1}</td><td><img src="${m.image}" class="member-img"></td><td>${m.name}</td><td><button onclick="editMember(${m.id})">تعديل</button></td><td><button onclick="deleteMember(${m.id})">حذف</button></td>`;
        tbody.appendChild(tr);
    });
}
function populateWeeksList(){
    const tbody=document.getElementById('weeksList'); tbody.innerHTML='';
    weeks.forEach((w,i)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${i+1}</td><td>${w.name}</td><td>${w.start}</td><td>${w.end}</td><td><button onclick="editWeek(${w.id})">تعديل</button></td><td><button onclick="deleteWeek(${w.id})">حذف</button></td>`;
        tbody.appendChild(tr);
    });
}

// ======= تحديث تقارير الحضور =======
function updateReports(){
    const selectedWeekId=parseInt(document.getElementById('weekSelect').value)||0;
    const total=document.getElementById('totalMembers');
    const attendance=document.getElementById('attendanceCount');
    const points=document.getElementById('totalPoints');
    if(total) total.textContent=members.length;
    if(attendance) attendance.textContent=attendanceRecords.filter(ar=>ar.weekId===selectedWeekId && ar.present).length;
    if(points) points.textContent=attendanceRecords.filter(ar=>ar.present).length;
}

// ======= تعديل وحذف الأعضاء والأسابيع =======
function editMember(id){const m=members.find(x=>x.id===id);const n=prompt('اسم جديد',m.name);if(n){m.name=n;saveData('members',members);populateMembersList();populateData();}}
function deleteMember(id){if(confirm('هل تريد حذف العضو؟')){members=members.filter(x=>x.id!==id);saveData('members',members);populateMembersList();populateData();}}
function editWeek(id){const w=weeks.find(x=>x.id===id);const n=prompt('اسم جديد',w.name);if(n){w.name=n;saveData('weeks',weeks);populateWeeksList();populateData();}}
function deleteWeek(id){if(confirm('هل تريد حذف الأسبوع؟')){weeks=weeks.filter(x=>x.id!==id);saveData('weeks',weeks);populateWeeksList();populateData();}}

// ======= مهام إضافية Placeholder =======
function updateTasksUI(){/* يمكنك إضافة واجهة المهام */ }
function updateLeaderboard(){/* يمكنك إضافة لوحة المتصدرين */ }

</script>
</body>
</html>
