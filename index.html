<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Angels Attendance</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
body { font-family: Arial, sans-serif; direction: rtl; margin:0; padding:0; background:#f4f4f4; }
.container { max-width: 1000px; margin:auto; padding:20px; background:#fff; }
.hidden { display:none; }
button { padding:5px 10px; margin:5px 0; cursor:pointer; }
input, select { padding:5px; margin:5px 0; width:100%; }
h2 { margin-top:0; }
.table { width:100%; border-collapse:collapse; margin:10px 0; }
.table th, .table td { border:1px solid #ddd; padding:5px; text-align:center; }
.table th { background:#eee; }
</style>
</head>
<body>
<div class="container">

<!-- واجهة العضو -->
<div id="memberView">
  <h2>تسجيل الحضور</h2>
  <label>اختر اسمك:</label>
  <select id="memberSelect"></select>

  <label>اختر الأسبوع:</label>
  <select id="weekSelect"></select>

  <button onclick="markAttendance()">تسجيل الحضور</button>
</div>

<hr>

<!-- واجهة تسجيل دخول المدير -->
<div id="adminLoginView">
  <h2>تسجيل دخول المدير</h2>
  <input type="password" id="adminPassword" placeholder="أدخل كلمة المرور">
  <button onclick="loginAdmin()">تسجيل الدخول</button>
</div>

<!-- واجهة المدير -->
<div id="adminView" class="hidden">
  <h2>لوحة تحكم المدير</h2>
  <button onclick="logoutAdmin()">تسجيل خروج</button>

  <h3>الأعضاء</h3>
  <table class="table">
    <thead><tr><th>#</th><th>الاسم</th><th>تعديل</th><th>حذف</th></tr></thead>
    <tbody id="membersListAdmin"></tbody>
  </table>
  <input type="text" id="newMemberName" placeholder="اسم العضو">
  <button onclick="addNewMember()">إضافة عضو</button>

  <h3>الأسابيع</h3>
  <table class="table">
    <thead><tr><th>#</th><th>الاسم</th><th>من</th><th>إلى</th><th>تعديل</th><th>حذف</th></tr></thead>
    <tbody id="weeksListAdmin"></tbody>
  </table>
  <input type="text" id="newWeekName" placeholder="اسم الأسبوع">
  <input type="date" id="newWeekFrom">
  <input type="date" id="newWeekTo">
  <button onclick="addNewWeek()">إضافة أسبوع</button>

  <h3>سجلات الحضور</h3>
  <table class="table">
    <thead><tr><th>العضو</th><th>الأسبوع</th><th>الحالة</th></tr></thead>
    <tbody id="attendanceRecordsAdmin"></tbody>
  </table>
</div>

</div>

<script>
// إعداد Firebase
const firebaseConfig = {
  apiKey: "AIzaSyBCQIqdCsxSvhfYOs00AetoVWpFhj4XNAQ",
  authDomain: "angels-attendance.firebaseapp.com",
  databaseURL: "https://angels-attendance-default-rtdb.firebaseio.com",
  projectId: "angels-attendance",
  storageBucket: "angels-attendance.appspot.com",
  messagingSenderId: "157249026489",
  appId: "1:157249026489:web:db2b420203bd81d9a19e68"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let members = [];
let weeks = [];
let attendanceRecords = [];

// تحميل البيانات
function loadData() {
  db.ref('members').on('value', snap => {
    members = snap.val() ? Object.values(snap.val()) : [];
    populateMemberSelect();
    populateAdminMembers();
    populateAdminAttendance();
  });
  db.ref('weeks').on('value', snap => {
    weeks = snap.val() ? Object.values(snap.val()) : [];
    populateWeekSelect();
    populateAdminWeeks();
    populateAdminAttendance();
  });
  db.ref('attendanceRecords').on('value', snap => {
    attendanceRecords = snap.val() ? Object.values(snap.val()) : [];
    populateAdminAttendance();
  });
}

// واجهة العضو
function populateMemberSelect() {
  const sel = document.getElementById('memberSelect');
  sel.innerHTML = '';
  members.forEach(m => { const opt = document.createElement('option'); opt.value = m.id; opt.textContent = m.name; sel.appendChild(opt); });
}
function populateWeekSelect() {
  const sel = document.getElementById('weekSelect');
  sel.innerHTML = '';
  weeks.forEach(w => { const opt = document.createElement('option'); opt.value = w.id; opt.textContent = w.name; sel.appendChild(opt); });
}

function markAttendance() {
  const memberId = document.getElementById('memberSelect').value;
  const weekId = document.getElementById('weekSelect').value;
  if(!memberId || !weekId) { alert('اختر اسمك والأسبوع'); return; }

  const already = attendanceRecords.find(a=>a.memberId===memberId && a.weekId===weekId);
  if(already) { alert('تم تسجيل الحضور مسبقاً'); return; }

  const record = { memberId, weekId, present:true, timestamp:new Date().toISOString() };
  const newKey = db.ref('attendanceRecords').push().key;
  db.ref('attendanceRecords/'+newKey).set(record);
  alert('تم تسجيل الحضور بنجاح');
}

// تسجيل دخول المدير
function loginAdmin() {
  const pwd = document.getElementById('adminPassword').value;
  if(pwd==='admin123') {
    document.getElementById('adminView').classList.remove('hidden');
    document.getElementById('adminLoginView').classList.add('hidden');
    document.getElementById('memberView').classList.add('hidden');
  } else { alert('كلمة المرور غير صحيحة'); }
}
function logoutAdmin() {
  document.getElementById('adminView').classList.add('hidden');
  document.getElementById('adminLoginView').classList.remove('hidden');
  document.getElementById('memberView').classList.remove('hidden');
}

// واجهة المدير - الأعضاء
function populateAdminMembers() {
  const tbody = document.getElementById('membersListAdmin');
  tbody.innerHTML = '';
  members.forEach((m,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${m.name}</td>
      <td><button onclick="editMember('${m.id}')">تعديل</button></td>
      <td><button onclick="deleteMember('${m.id}')">حذف</button></td>`;
    tbody.appendChild(tr);
  });
}
function addNewMember() {
  const name = document.getElementById('newMemberName').value;
  if(!name) { alert('ادخل اسم العضو'); return; }
  const id = Date.now().toString();
  db.ref('members/'+id).set({id,name});
  document.getElementById('newMemberName').value='';
}
function editMember(id) {
  const name = prompt('عدل اسم العضو:', members.find(m=>m.id===id)?.name || '');
  if(name) db.ref('members/'+id+'/name').set(name);
}
function deleteMember(id) {
  if(confirm('هل تريد حذف العضو؟')) db.ref('members/'+id).remove();
}

// واجهة المدير - الأسابيع
function populateAdminWeeks() {
  const tbody = document.getElementById('weeksListAdmin');
  tbody.innerHTML = '';
  weeks.forEach((w,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${w.name}</td><td>${w.from}</td><td>${w.to}</td>
      <td><button onclick="editWeek('${w.id}')">تعديل</button></td>
      <td><button onclick="deleteWeek('${w.id}')">حذف</button></td>`;
    tbody.appendChild(tr);
  });
}
function addNewWeek() {
  const name=document.getElementById('newWeekName').value;
  const from=document.getElementById('newWeekFrom').value;
  const to=document.getElementById('newWeekTo').value;
  if(!name||!from||!to){ alert('ادخل بيانات الأسبوع'); return;}
  const id = Date.now().toString();
  db.ref('weeks/'+id).set({id,name,from,to});
  document.getElementById('newWeekName').value='';
  document.getElementById('newWeekFrom').value='';
  document.getElementById('newWeekTo').value='';
}
function editWeek(id) {
  const w = weeks.find(w=>w.id===id);
  if(!w) return;
  const name = prompt('عدل اسم الأسبوع:', w.name);
  const from = prompt('من تاريخ:', w.from);
  const to = prompt('إلى تاريخ:', w.to);
  if(name && from && to) db.ref('weeks/'+id).set({id,name,from,to});
}
function deleteWeek(id) { if(confirm('هل تريد حذف الأسبوع؟')) db.ref('weeks/'+id).remove(); }

// واجهة المدير - الحضور
function populateAdminAttendance() {
  const tbody = document.getElementById('attendanceRecordsAdmin');
  tbody.innerHTML = '';
  attendanceRecords.forEach(a=>{
    const member = members.find(m=>m.id===a.memberId)?.name || 'غير معروف';
    const week = weeks.find(w=>w.id===a.weekId)?.name || 'غير معروف';
    const tr = document.createElement('tr');
    tr.innerHTML=`<td>${member}</td><td>${week}</td><td>${a.present?'حاضر':'غائب'}</td>`;
    tbody.appendChild(tr);
  });
}

// تحميل البيانات
loadData();
</script>
</body>
</html>
