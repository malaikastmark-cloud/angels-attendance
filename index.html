<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø­Ø¶ÙˆØ± Ø®Ø¯Ø§Ù… Ù…Ù„Ø§ÙŠÙƒØ©</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Ø£Ù†Ù…Ø§Ø· CSS Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ */
        /* ... (ÙƒÙ„ Ø£Ù†Ù…Ø§Ø· CSS Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©) ... */
        
        /* Ø¥Ø¶Ø§ÙØ© Ø£Ù†Ù…Ø§Ø· Ø¬Ø¯ÙŠØ¯Ø© */
        .back-btn {
            position: absolute;
            left: 20px;
            top: 20px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            cursor: pointer;
            font-weight: bold;
            display: none;
        }
        
        .reward-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            text-align: center;
            display: none;
            animation: pop 0.5s;
        }
        
        @keyframes pop {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        .reward-title {
            font-size: 2rem;
            color: #e74c3c;
            margin-bottom: 15px;
        }
        
        .reward-desc {
            font-size: 1.2rem;
            margin-bottom: 20px;
        }
        
        .member-detail-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .member-detail-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .detail-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .detail-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .detail-stat {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .detail-chart {
            margin: 20px 0;
            height: 200px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <button class="back-btn" id="backToMain"><i class="fas fa-arrow-left"></i> Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
            <h1>ğŸŒŸ Ø§Ø¬ØªÙ…Ø§Ø¹ Ø®Ø¯Ø§Ù… Ù…Ù„Ø§ÙŠÙƒØ©</h1>
            <p>Ø§Ù„Ø­Ø¶ÙˆØ± ÙŠØ³Ø§ÙˆÙŠ Ù†Ù‚Ø·Ø©</p>
        </header>

        <!-- Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ -->
        <!-- ... (ÙƒÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø³Ø§Ø¨Ù‚) ... -->

        <!-- Ø¥Ø¶Ø§ÙØ© Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª -->
        <div class="reward-popup" id="rewardPopup">
            <div class="reward-title">ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! ğŸ‰</div>
            <div class="reward-desc" id="rewardDesc">Ù„Ù‚Ø¯ Ø­ØµÙ„Øª Ø¹Ù„Ù‰ Ù…ÙƒØ§ÙØ£Ø© Ø¬Ø¯ÙŠØ¯Ø©!</div>
            <button class="btn btn-primary" id="closeReward">Ù…ÙˆØ§ÙÙ‚</button>
        </div>

        <!-- Ø¥Ø¶Ø§ÙØ© Ù†Ø§ÙØ°Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ø¶Ùˆ -->
        <div class="member-detail-modal" id="memberDetailModal">
            <div class="member-detail-content">
                <div class="detail-header">
                    <img id="detailImage" src="" class="member-img" alt="">
                    <h2 id="detailName"></h2>
                </div>
                
                <div class="detail-stats">
                    <div class="detail-stat">
                        <div class="member-stat-value" id="detailPoints">0</div>
                        <div class="member-stat-label">Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„ÙƒÙ„ÙŠØ©</div>
                    </div>
                    <div class="detail-stat">
                        <div class="member-stat-value" id="detailAttendance">0</div>
                        <div class="member-stat-label">Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±</div>
                    </div>
                    <div class="detail-stat">
                        <div class="member-stat-value" id="detailPercentage">0%</div>
                        <div class="member-stat-label">Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±</div>
                    </div>
                </div>
                
                <h3>Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª Ø§Ù„Ù…ÙƒØªØ³Ø¨Ø©</h3>
                <ul id="detailRewardsList"></ul>
                
                <h3>ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø¶ÙˆØ±</h3>
                <div class="detail-chart">
                    <canvas id="memberChart"></canvas>
                </div>
                
                <button class="btn btn-danger" id="closeDetail">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
        </div>
    </div>

    <script>
        // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ)
        let members = [
            {id:1, name:'ğŸ§’ Mary Karam', image: 'https://ui-avatars.com/api/?name=Mary+Karam&background=3498db&color=fff'},
            {id:2, name:'ğŸ‘¦ Eman Makin', image: 'https://ui-avatars.com/api/?name=Eman+Makin&background=2ecc71&color=fff'},
            {id:3, name:'ğŸ‘§ Rizk Gerges', image: 'https://ui-avatars.com/api/?name=Rizk+Gerges&background=e74c3c&color=fff'}
        ];
        
        let weeks = [
            {id:1, name:'Ø§Ù„Ø§Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø§ÙˆÙ„', from:'2025-08-29', to:'2025-08-29'}
        ];
        
        let attendanceRecords = [];
        let rewards = [];
        
        // ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±
        const adminPass = 'admin123';
        
        // Ø¥Ø¶Ø§ÙØ© Ù…ØªØºÙŠØ± Ù„Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ù„Ù„Ø£Ø¹Ø¶Ø§Ø¡
        let memberChart = null;
        
        // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© (ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© ÙˆØ¸Ø§Ø¦Ù Ø¬Ø¯ÙŠØ¯Ø©)
        
        // ÙˆØ¸ÙŠÙØ© Ù„Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        function backToMain() {
            document.getElementById('adminTabs').style.display = 'none';
            document.getElementById('userAttendance').style.display = 'block';
            document.getElementById('adminLoginBtn').style.display = 'block';
            document.getElementById('backToMain').style.display = 'none';
        }
        
        // ÙˆØ¸ÙŠÙØ© Ù„Ø¹Ø±Ø¶ Ù…ÙƒØ§ÙØ£Ø© Ø¬Ø¯ÙŠØ¯Ø©
        function showRewardPopup(memberId, rewardTitle) {
            const member = members.find(m => m.id === memberId);
            document.getElementById('rewardDesc').textContent = `Ù…Ø¨Ø±ÙˆÙƒ ${member.name}! Ù„Ù‚Ø¯ Ø­ØµÙ„Øª Ø¹Ù„Ù‰ ${rewardTitle}`;
            document.getElementById('rewardPopup').style.display = 'block';
        }
        
        // ÙˆØ¸ÙŠÙØ© Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ø¶Ùˆ
        function showMemberDetails(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            const totalPoints = attendanceRecords.filter(ar => 
                ar.memberId === memberId && ar.present
            ).length;
            
            const totalWeeks = weeks.length;
            const attendancePercentage = totalWeeks > 0 ? Math.round((totalPoints / totalWeeks) * 100) : 0;
            
            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            document.getElementById('detailImage').src = member.image;
            document.getElementById('detailName').textContent = member.name;
            document.getElementById('detailPoints').textContent = totalPoints;
            document.getElementById('detailAttendance').textContent = totalPoints;
            document.getElementById('detailPercentage').textContent = `${attendancePercentage}%`;
            
            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª
            const rewardsList = document.getElementById('detailRewardsList');
            rewardsList.innerHTML = '';
            
            const memberRewards = rewards.filter(r => r.memberId === memberId);
            if (memberRewards.length === 0) {
                rewardsList.innerHTML = '<li>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙƒØ§ÙØ¢Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</li>';
            } else {
                memberRewards.forEach(reward => {
                    const li = document.createElement('li');
                    li.textContent = `${reward.title} (ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„ÙŠÙ‡Ø§ ÙÙŠ ${new Date(reward.date).toLocaleDateString('ar-EG')})`;
                    rewardsList.appendChild(li);
                });
            }
            
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
            setupMemberChart(memberId);
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø§ÙØ°Ø©
            document.getElementById('memberDetailModal').style.display = 'flex';
        }
        
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ù„Ù„Ø¹Ø¶Ùˆ
        function setupMemberChart(memberId) {
            const ctx = document.getElementById('memberChart').getContext('2d');
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ù…ÙˆØ¬ÙˆØ¯ØŒ Ù‚Ù… Ø¨ØªØ¯Ù…ÙŠØ±Ù‡ Ø£ÙˆÙ„Ø§Ù‹
            if (memberChart) {
                memberChart.destroy();
            }
            
            // ØªØ¬Ù‡ÙŠØ² Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ù„ÙƒÙ„ Ø£Ø³Ø¨ÙˆØ¹
            const labels = weeks.map(w => w.name);
            const data = weeks.map(week => {
                const record = attendanceRecords.find(ar => 
                    ar.memberId === memberId && ar.weekId == week.id && ar.present
                );
                return record ? 1 : 0;
            });
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
            memberChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ø§Ù„Ø­Ø¶ÙˆØ±',
                        data: data,
                        backgroundColor: '#3498db'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1,
                            ticks: {
                                stepSize: 1,
                                callback: function(value) {
                                    return value === 1 ? 'Ø­Ø§Ø¶Ø±' : 'ØºØ§Ø¦Ø¨';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // ØªØ¹Ø¯ÙŠÙ„ ÙˆØ¸ÙŠÙØ© checkForRewards Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
        function checkForRewards(memberId) {
            const points = attendanceRecords.filter(ar => 
                ar.memberId === memberId && ar.present
            ).length;
            
            // Ù…ÙƒØ§ÙØ¢Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            const rewardLevels = [
                { points: 5, title: "Ù…ÙŠØ¯Ø§Ù„ÙŠØ© Ø¨Ø±ÙˆÙ†Ø²ÙŠØ© ğŸ¥‰" },
                { points: 10, title: "Ù…ÙŠØ¯Ø§Ù„ÙŠØ© ÙØ¶ÙŠØ© ğŸ¥ˆ" },
                { points: 15, title: "Ù…ÙŠØ¯Ø§Ù„ÙŠØ© Ø°Ù‡Ø¨ÙŠØ© ğŸ¥‡" },
                { points: 20, title: "ÙƒØ£Ø³ Ø§Ù„ØªÙ…ÙŠØ² ğŸ†" }
            ];
            
            rewardLevels.forEach(reward => {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙˆØµÙ„ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆÙ„Ù… ÙŠØ­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ø¨Ø¹Ø¯
                if (points >= reward.points) {
                    const hasReward = rewards.some(r => 
                        r.memberId === memberId && r.pointsRequired === reward.points
                    );
                    
                    if (!hasReward) {
                        // Ù…Ù†Ø­ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©
                        rewards.push({
                            memberId: memberId,
                            pointsRequired: reward.points,
                            title: reward.title,
                            date: new Date().toISOString()
                        });
                        
                        // Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©
                        showRewardPopup(memberId, reward.title);
                    }
                }
            });
        }
        
        // ØªØ¹Ø¯ÙŠÙ„ ÙˆØ¸ÙŠÙØ© populateAdminTables Ù„Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„ØªÙØ§ØµÙŠÙ„
        function populateAdminTables(){
            const membersTbody = document.querySelector('#membersTable tbody');
            membersTbody.innerHTML = '';
            members.forEach((m, i) => {
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© Ù„ÙƒÙ„ Ø¹Ø¶Ùˆ
                const totalPoints = attendanceRecords.filter(ar => 
                    ar.memberId === m.id && ar.present
                ).length;
                
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙƒØ§ÙØ¢Øª Ø§Ù„Ø¹Ø¶Ùˆ
                const memberRewards = rewards.filter(r => r.memberId === m.id);
                const rewardsText = memberRewards.map(r => r.title).join(', ') || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
                
                let tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${i+1}</td>
                    <td><img src="${m.image || 'https://ui-avatars.com/api/?name=Member&background=ccc&color=fff'}" class="member-img" alt="${m.name}"></td>
                    <td>${m.name}</td>
                    <td>${totalPoints}</td>
                    <td>${rewardsText}</td>
                    <td><button class='btn btn-info viewMember' data-id="${m.id}">ØªÙØ§ØµÙŠÙ„</button></td>
                    <td><button class='btn btn-primary editMember'>ØªØ¹Ø¯ÙŠÙ„</button></td>
                    <td><button class='btn btn-danger deleteMember'>Ø­Ø°Ù</button></td>
                `;
                membersTbody.appendChild(tr);
            });
            
            // Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ
            // ...
        }
        
        // Ø£Ø­Ø¯Ø§Ø« Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø¶Ø§ÙØ©
        document.getElementById('backToMain').addEventListener('click', backToMain);
        document.getElementById('closeReward').addEventListener('click', () => {
            document.getElementById('rewardPopup').style.display = 'none';
        });
        
        document.getElementById('closeDetail').addEventListener('click', () => {
            document.getElementById('memberDetailModal').style.display = 'none';
        });
        
        // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙØ§ØµÙŠÙ„
        document.addEventListener('click', e => {
            if (e.target.classList.contains('viewMember')) {
                const memberId = parseInt(e.target.dataset.id);
                showMemberDetails(memberId);
            }
        });
        
        // ØªØ¹Ø¯ÙŠÙ„ Ø­Ø¯Ø« ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù† Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø©
        document.getElementById('confirmAdminLogin').addEventListener('click', () => {
            const pwd = document.getElementById('adminPassword').value;
            if (pwd === adminPass) {
                document.getElementById('adminLoginModal').style.display = 'none';
                document.getElementById('adminTabs').style.display = 'block';
                document.getElementById('userAttendance').style.display = 'none';
                document.getElementById('adminLoginBtn').style.display = 'none';
                document.getElementById('backToMain').style.display = 'block';
                showNotification('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù† Ø¨Ù†Ø¬Ø§Ø­');
            } else {
                alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø·Ø£!');
            }
        });
        
        // Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ
        // ...
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
        document.addEventListener('DOMContentLoaded', () => {
            loadFromLocalStorage();
        });
    </script>
</body>
</html>
